import{c as er,g as tr,m as fn,H as be,n as ui,a as ir,V as Te,I as Ti,i as Si}from"./index.9d88289b.js";var dn={exports:{}};(function(e){//! openseadragon 3.1.0
//! Built on 2022-06-07
//! Git commit: v3.1.0-1-c1c380f
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function h(t){return new h.Viewer(t)}(function(t){t.version={versionStr:"3.1.0",major:parseInt("3",10),minor:parseInt("1",10),revision:parseInt("0",10)};var c={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},g=Object.prototype.toString,m=Object.prototype.hasOwnProperty;t.isFunction=function(y){return t.type(y)==="function"},t.isArray=Array.isArray||function(y){return t.type(y)==="array"},t.isWindow=function(y){return y&&typeof y=="object"&&"setInterval"in y},t.type=function(y){return y==null?String(y):c[g.call(y)]||"object"},t.isPlainObject=function(y){if(!y||h.type(y)!=="object"||y.nodeType||t.isWindow(y)||y.constructor&&!m.call(y,"constructor")&&!m.call(y.constructor.prototype,"isPrototypeOf"))return!1;var a;for(var i in y)a=i;return a===void 0||m.call(y,a)},t.isEmptyObject=function(y){for(var a in y)return!1;return!0},t.freezeObject=function(y){return Object.freeze?t.freezeObject=Object.freeze:t.freezeObject=function(a){return a},t.freezeObject(y)},t.supportsCanvas=function(){var y=document.createElement("canvas");return!!(t.isFunction(y.getContext)&&y.getContext("2d"))}(),t.isCanvasTainted=function(y){var a=!1;try{y.getContext("2d").getImageData(0,0,1,1)}catch{a=!0}return a},t.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),t.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),t.supportsEventListenerOptions=function(){var y=0;if(t.supportsAddEventListener)try{var a={get capture(){return y++,!1},get once(){return y++,!1},get passive(){return y++,!1}};window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch{y=0}return y>=3}(),t.getCurrentPixelDensityRatio=function(){if(t.supportsCanvas){var y=document.createElement("canvas").getContext("2d"),a=window.devicePixelRatio||1,i=y.webkitBackingStorePixelRatio||y.mozBackingStorePixelRatio||y.msBackingStorePixelRatio||y.oBackingStorePixelRatio||y.backingStorePixelRatio||1;return Math.max(a,1)/i}else return 1},t.pixelDensityRatio=t.getCurrentPixelDensityRatio()})(h),function(t){t.extend=function(){var i,r,o,n,s,l,u=arguments[0]||{},d=arguments.length,f=!1,p=1;for(typeof u=="boolean"&&(f=u,u=arguments[1]||{},p=2),typeof u!="object"&&!h.isFunction(u)&&(u={}),d===p&&(u=this,--p);p<d;p++)if(i=arguments[p],i!==null||i!==void 0)for(r in i)o=u[r],n=i[r],u!==n&&(f&&n&&(h.isPlainObject(n)||(s=h.isArray(n)))?(s?(s=!1,l=o&&h.isArray(o)?o:[]):l=o&&h.isPlainObject(o)?o:{},u[r]=h.extend(f,l,n)):n!==void 0&&(u[r]=n));return u};var c=function(){if(typeof navigator!="object")return!1;var i=navigator.userAgent;return typeof i!="string"?!1:i.indexOf("iPhone")!==-1||i.indexOf("iPad")!==-1||i.indexOf("iPod")!==-1};t.extend(t,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:c(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,opacity:1,preload:!1,compositeOperation:null,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,useCanvas:!0,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},SIGNAL:"----seadragon----",delegate:function(i,r){return function(){var o=arguments;return o===void 0&&(o=[]),r.apply(i,o)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(i){return t._viewers.get(this.getElement(i))},getElement:function(i){return typeof i=="string"&&(i=document.getElementById(i)),i},getElementPosition:function(i){var r=new t.Point,o,n;for(i=t.getElement(i),o=t.getElementStyle(i).position==="fixed",n=a(i,o);n;)r.x+=i.offsetLeft,r.y+=i.offsetTop,o&&(r=r.plus(t.getPageScroll())),i=n,o=t.getElementStyle(i).position==="fixed",n=a(i,o);return r},getElementOffset:function(i){i=t.getElement(i);var r=i&&i.ownerDocument,o,n,s={top:0,left:0};return r?(o=r.documentElement,typeof i.getBoundingClientRect!="undefined"&&(s=i.getBoundingClientRect()),n=r===r.window?r:r.nodeType===9?r.defaultView||r.parentWindow:!1,new t.Point(s.left+(n.pageXOffset||o.scrollLeft)-(o.clientLeft||0),s.top+(n.pageYOffset||o.scrollTop)-(o.clientTop||0))):new t.Point},getElementSize:function(i){return i=t.getElement(i),new t.Point(i.clientWidth,i.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(i){return i=t.getElement(i),i.currentStyle}:function(i){return i=t.getElement(i),window.getComputedStyle(i,"")},getCssPropertyWithVendorPrefix:function(i){var r={};return t.getCssPropertyWithVendorPrefix=function(o){if(r[o]!==void 0)return r[o];var n=document.createElement("div").style,s=null;if(n[o]!==void 0)s=o;else for(var l=["Webkit","Moz","MS","O","webkit","moz","ms","o"],u=t.capitalizeFirstLetter(o),d=0;d<l.length;d++){var f=l[d]+u;if(n[f]!==void 0){s=f;break}}return r[o]=s,s},t.getCssPropertyWithVendorPrefix(i)},capitalizeFirstLetter:function(i){return i.charAt(0).toUpperCase()+i.slice(1)},positiveModulo:function(i,r){var o=i%r;return o<0&&(o+=r),o},pointInElement:function(i,r){i=t.getElement(i);var o=t.getElementOffset(i),n=t.getElementSize(i);return r.x>=o.x&&r.x<o.x+n.x&&r.y<o.y+n.y&&r.y>=o.y},getMousePosition:function(i){if(typeof i.pageX=="number")t.getMousePosition=function(r){var o=new t.Point;return o.x=r.pageX,o.y=r.pageY,o};else if(typeof i.clientX=="number")t.getMousePosition=function(r){var o=new t.Point;return o.x=r.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,o.y=r.clientY+document.body.scrollTop+document.documentElement.scrollTop,o};else throw new Error("Unknown event mouse position, no known technique.");return t.getMousePosition(i)},getPageScroll:function(){var i=document.documentElement||{},r=document.body||{};if(typeof window.pageXOffset=="number")t.getPageScroll=function(){return new t.Point(window.pageXOffset,window.pageYOffset)};else if(r.scrollLeft||r.scrollTop)t.getPageScroll=function(){return new t.Point(document.body.scrollLeft,document.body.scrollTop)};else if(i.scrollLeft||i.scrollTop)t.getPageScroll=function(){return new t.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new t.Point(0,0);return t.getPageScroll()},setPageScroll:function(i){if(typeof window.scrollTo!="undefined")t.setPageScroll=function(n){window.scrollTo(n.x,n.y)};else{var r=t.getPageScroll();if(r.x===i.x&&r.y===i.y)return;document.body.scrollLeft=i.x,document.body.scrollTop=i.y;var o=t.getPageScroll();if(o.x!==r.x&&o.y!==r.y){t.setPageScroll=function(n){document.body.scrollLeft=n.x,document.body.scrollTop=n.y};return}if(document.documentElement.scrollLeft=i.x,document.documentElement.scrollTop=i.y,o=t.getPageScroll(),o.x!==r.x&&o.y!==r.y){t.setPageScroll=function(n){document.documentElement.scrollLeft=n.x,document.documentElement.scrollTop=n.y};return}t.setPageScroll=function(n){}}t.setPageScroll(i)},getWindowSize:function(){var i=document.documentElement||{},r=document.body||{};if(typeof window.innerWidth=="number")t.getWindowSize=function(){return new t.Point(window.innerWidth,window.innerHeight)};else if(i.clientWidth||i.clientHeight)t.getWindowSize=function(){return new t.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(r.clientWidth||r.clientHeight)t.getWindowSize=function(){return new t.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return t.getWindowSize()},makeCenteredNode:function(i){i=t.getElement(i);var r=[t.makeNeutralElement("div"),t.makeNeutralElement("div"),t.makeNeutralElement("div")];return t.extend(r[0].style,{display:"table",height:"100%",width:"100%"}),t.extend(r[1].style,{display:"table-row"}),t.extend(r[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),r[0].appendChild(r[1]),r[1].appendChild(r[2]),r[2].appendChild(i),r[0]},makeNeutralElement:function(i){var r=document.createElement(i),o=r.style;return o.background="transparent none",o.border="none",o.margin="0px",o.padding="0px",o.position="static",r},now:function(){return Date.now?t.now=Date.now:t.now=function(){return new Date().getTime()},t.now()},makeTransparentImage:function(i){var r=t.makeNeutralElement("img");return r.src=i,r},setElementOpacity:function(i,r,o){var n,s;i=t.getElement(i),o&&!t.Browser.alpha&&(r=Math.round(r)),t.Browser.opacity?i.style.opacity=r<1?r:"":r<1?(n=Math.round(100*r),s="alpha(opacity="+n+")",i.style.filter=s):i.style.filter=""},setElementTouchActionNone:function(i){i=t.getElement(i),typeof i.style.touchAction!="undefined"?i.style.touchAction="none":typeof i.style.msTouchAction!="undefined"&&(i.style.msTouchAction="none")},setElementPointerEvents:function(i,r){i=t.getElement(i),typeof i.style!="undefined"&&typeof i.style.pointerEvents!="undefined"&&(i.style.pointerEvents=r)},setElementPointerEventsNone:function(i){t.setElementPointerEvents(i,"none")},addClass:function(i,r){if(i=t.getElement(i),!i.className)i.setAttribute("class",r);else if((" "+i.className+" ").indexOf(" "+r+" ")===-1){let o=i.className+" "+r;i.setAttribute("class",o)}},indexOf:function(i,r,o){return Array.prototype.indexOf?this.indexOf=function(n,s,l){return n.indexOf(s,l)}:this.indexOf=function(n,s,l){var u,d=l||0,f;if(!n)throw new TypeError;if(f=n.length,f===0||d>=f)return-1;for(d<0&&(d=f-Math.abs(d)),u=d;u<f;u++)if(n[u]===s)return u;return-1},this.indexOf(i,r,o)},removeClass:function(i,r){var o,n=[],s;for(i=t.getElement(i),o=i.className.split(/\s+/),s=0;s<o.length;s++)o[s]&&o[s]!==r&&n.push(o[s]);i.className=n.join(" ")},normalizeEventListenerOptions:function(i){var r;return typeof i!="undefined"?typeof i=="boolean"?r=t.supportsEventListenerOptions?{capture:i}:i:r=t.supportsEventListenerOptions?i:typeof i.capture!="undefined"?i.capture:!1:r=t.supportsEventListenerOptions?{capture:!1}:!1,r},addEvent:function(){if(t.supportsAddEventListener)return function(i,r,o,n){n=t.normalizeEventListenerOptions(n),i=t.getElement(i),i.addEventListener(r,o,n)};if(document.documentElement.attachEvent&&document.attachEvent)return function(i,r,o){i=t.getElement(i),i.attachEvent("on"+r,o)};throw new Error("No known event model.")}(),removeEvent:function(){if(t.supportsRemoveEventListener)return function(i,r,o,n){n=t.normalizeEventListenerOptions(n),i=t.getElement(i),i.removeEventListener(r,o,n)};if(document.documentElement.detachEvent&&document.detachEvent)return function(i,r,o){i=t.getElement(i),i.detachEvent("on"+r,o)};throw new Error("No known event model.")}(),cancelEvent:function(i){i.preventDefault()},eventIsCanceled:function(i){return i.defaultPrevented},stopEvent:function(i){i.stopPropagation()},createCallback:function(i,r){var o=[],n;for(n=2;n<arguments.length;n++)o.push(arguments[n]);return function(){var s=o.concat([]),l;for(l=0;l<arguments.length;l++)s.push(arguments[l]);return r.apply(i,s)}},getUrlParameter:function(i){var r=y[i];return r||null},getUrlProtocol:function(i){var r=i.match(/^([a-z]+:)\/\//i);return r===null?window.location.protocol:r[1].toLowerCase()},createAjaxRequest:function(i){var r;try{r=!!new ActiveXObject("Microsoft.XMLHTTP")}catch{r=!1}if(r)window.XMLHttpRequest?t.createAjaxRequest=function(o){return o?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest}:t.createAjaxRequest=function(){return new ActiveXObject("Microsoft.XMLHTTP")};else if(window.XMLHttpRequest)t.createAjaxRequest=function(){return new XMLHttpRequest};else throw new Error("Browser doesn't support XMLHttpRequest.");return t.createAjaxRequest(i)},makeAjaxRequest:function(i,r,o){var n,s,l,u;t.isPlainObject(i)&&(r=i.success,o=i.error,n=i.withCredentials,s=i.headers,l=i.responseType||null,u=i.postData||null,i=i.url);var d=t.getUrlProtocol(i),f=t.createAjaxRequest(d==="file:");if(!t.isFunction(r))throw new Error("makeAjaxRequest requires a success callback");f.onreadystatechange=function(){f.readyState===4&&(f.onreadystatechange=function(){},f.status>=200&&f.status<300||f.status===0&&d!=="http:"&&d!=="https:"?r(f):t.isFunction(o)?o(f):t.console.error("AJAX request returned %d: %s",f.status,i))};var p=u?"POST":"GET";try{if(f.open(p,i,!0),l&&(f.responseType=l),s)for(var v in s)Object.prototype.hasOwnProperty.call(s,v)&&s[v]&&f.setRequestHeader(v,s[v]);n&&(f.withCredentials=!0),f.send(u)}catch(w){t.console.error("%s while making AJAX request: %s",w.name,w.message),f.onreadystatechange=function(){},t.isFunction(o)&&o(f,w)}return f},jsonp:function(i){var r,o=i.url,n=document.head||document.getElementsByTagName("head")[0]||document.documentElement,s=i.callbackName||"openseadragon"+t.now(),l=window[s],u="$1"+s+"$2",d=i.param||"callback",f=i.callback;o=o.replace(/(=)\?(&|$)|\?\?/i,u),o+=(/\?/.test(o)?"&":"?")+d+"="+s,window[s]=function(p){if(l)window[s]=l;else try{delete window[s]}catch{}f&&t.isFunction(f)&&f(p)},r=document.createElement("script"),(i.async!==void 0||i.async!==!1)&&(r.async="async"),i.scriptCharset&&(r.charset=i.scriptCharset),r.src=o,r.onload=r.onreadystatechange=function(p,v){(v||!r.readyState||/loaded|complete/.test(r.readyState))&&(r.onload=r.onreadystatechange=null,n&&r.parentNode&&n.removeChild(r),r=void 0)},n.insertBefore(r,n.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(i){if(window.DOMParser)t.parseXml=function(r){var o=null,n;return n=new DOMParser,o=n.parseFromString(r,"text/xml"),o};else if(window.ActiveXObject)t.parseXml=function(r){var o=null;return o=new ActiveXObject("Microsoft.XMLDOM"),o.async=!1,o.loadXML(r),o};else throw new Error("Browser doesn't support XML DOM.");return t.parseXml(i)},parseJSON:function(i){return t.parseJSON=window.JSON.parse,t.parseJSON(i)},imageFormatSupported:function(i){return i=i||"",!!m[i.toLowerCase()]},setImageFormatsSupported:function(i){t.extend(m,i)}});var g=function(i){};t.console=window.console||{log:g,debug:g,info:g,warn:g,error:g,assert:g},t.Browser={vendor:t.BROWSERS.UNKNOWN,version:0,alpha:!0};var m={bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1},y={};(function(){var i=navigator.appVersion,r=navigator.userAgent,o;switch(navigator.appName){case"Microsoft Internet Explorer":!!window.attachEvent&&!!window.ActiveXObject&&(t.Browser.vendor=t.BROWSERS.IE,t.Browser.version=parseFloat(r.substring(r.indexOf("MSIE")+5,r.indexOf(";",r.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(r.indexOf("Edge")>=0?(t.Browser.vendor=t.BROWSERS.EDGE,t.Browser.version=parseFloat(r.substring(r.indexOf("Edge")+5))):r.indexOf("Edg")>=0?(t.Browser.vendor=t.BROWSERS.CHROMEEDGE,t.Browser.version=parseFloat(r.substring(r.indexOf("Edg")+4))):r.indexOf("Firefox")>=0?(t.Browser.vendor=t.BROWSERS.FIREFOX,t.Browser.version=parseFloat(r.substring(r.indexOf("Firefox")+8))):r.indexOf("Safari")>=0?(t.Browser.vendor=r.indexOf("Chrome")>=0?t.BROWSERS.CHROME:t.BROWSERS.SAFARI,t.Browser.version=parseFloat(r.substring(r.substring(0,r.indexOf("Safari")).lastIndexOf("/")+1,r.indexOf("Safari")))):(o=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),o.exec(r)!==null&&(t.Browser.vendor=t.BROWSERS.IE,t.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":t.Browser.vendor=t.BROWSERS.OPERA,t.Browser.version=parseFloat(i);break}var n=window.location.search.substring(1),s=n.split("&"),l,u,d;for(d=0;d<s.length;d++)if(l=s[d],u=l.indexOf("="),u>0){var f=l.substring(0,u),p=l.substring(u+1);try{y[f]=decodeURIComponent(p)}catch{t.console.error("Ignoring malformed URL parameter: %s=%s",f,p)}}t.Browser.alpha=!(t.Browser.vendor===t.BROWSERS.CHROME&&t.Browser.version<2),t.Browser.opacity=!0,t.Browser.vendor===t.BROWSERS.IE&&t.Browser.version<11&&t.console.error("Internet Explorer versions < 11 are not supported by OpenSeadragon")})(),function(i){var r=i.requestAnimationFrame||i.mozRequestAnimationFrame||i.webkitRequestAnimationFrame||i.msRequestAnimationFrame,o=i.cancelAnimationFrame||i.mozCancelAnimationFrame||i.webkitCancelAnimationFrame||i.msCancelAnimationFrame;if(r&&o)t.requestAnimationFrame=function(){return r.apply(i,arguments)},t.cancelAnimationFrame=function(){return o.apply(i,arguments)};else{var n=[],s=[],l=0,u;t.requestAnimationFrame=function(d){return n.push([++l,d]),u||(u=setInterval(function(){if(n.length){var f=t.now(),p=s;for(s=n,n=p;s.length;)s.shift()[1](f)}else clearInterval(u),u=void 0},1e3/50)),l},t.cancelAnimationFrame=function(d){var f,p;for(f=0,p=n.length;f<p;f+=1)if(n[f][0]===d){n.splice(f,1);return}for(f=0,p=s.length;f<p;f+=1)if(s[f][0]===d){s.splice(f,1);return}}}}(window);function a(i,r){return r&&i!==document.body?document.body:i.offsetParent}}(h),function(t,c){e.exports?e.exports=c():t.OpenSeadragon=c()}(er,function(){return h}),function(t){var c={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(c.supportsFullScreen=!0,c.getFullScreenElement=function(){return document.fullscreenElement},c.requestFullScreen=function(g){return g.requestFullscreen()},c.exitFullScreen=function(){document.exitFullscreen()},c.fullScreenEventName="fullscreenchange",c.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(c.supportsFullScreen=!0,c.getFullScreenElement=function(){return document.msFullscreenElement},c.requestFullScreen=function(g){return g.msRequestFullscreen()},c.exitFullScreen=function(){document.msExitFullscreen()},c.fullScreenEventName="MSFullscreenChange",c.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(c.supportsFullScreen=!0,c.getFullScreenElement=function(){return document.webkitFullscreenElement},c.requestFullScreen=function(g){return g.webkitRequestFullscreen()},c.exitFullScreen=function(){document.webkitExitFullscreen()},c.fullScreenEventName="webkitfullscreenchange",c.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(c.supportsFullScreen=!0,c.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},c.requestFullScreen=function(g){return g.webkitRequestFullScreen()},c.exitFullScreen=function(){document.webkitCancelFullScreen()},c.fullScreenEventName="webkitfullscreenchange",c.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(c.supportsFullScreen=!0,c.getFullScreenElement=function(){return document.mozFullScreenElement},c.requestFullScreen=function(g){return g.mozRequestFullScreen()},c.exitFullScreen=function(){document.mozCancelFullScreen()},c.fullScreenEventName="mozfullscreenchange",c.fullScreenErrorEventName="mozfullscreenerror"),c.isFullScreen=function(){return c.getFullScreenElement()!==null},c.cancelFullScreen=function(){t.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),c.exitFullScreen()},t.extend(t,c)}(h),function(t){t.EventSource=function(){this.events={}},t.EventSource.prototype={addOnceHandler:function(c,g,m,y){var a=this;y=y||1;var i=0,r=function(o){i++,i===y&&a.removeHandler(c,r),g(o)};this.addHandler(c,r,m)},addHandler:function(c,g,m){var y=this.events[c];y||(this.events[c]=y=[]),g&&t.isFunction(g)&&(y[y.length]={handler:g,userData:m||null})},removeHandler:function(c,g){var m=this.events[c],y=[],a;if(!!m&&t.isArray(m)){for(a=0;a<m.length;a++)m[a].handler!==g&&y.push(m[a]);this.events[c]=y}},numberOfHandlers:function(c){var g=this.events[c];return g?g.length:0},removeAllHandlers:function(c){if(c)this.events[c]=[];else for(var g in this.events)this.events[g]=[]},getHandler:function(c){var g=this.events[c];return!g||!g.length?null:(g=g.length===1?[g[0]]:Array.apply(null,g),function(m,y){var a,i=g.length;for(a=0;a<i;a++)g[a]&&(y.eventSource=m,y.userData=g[a].userData,g[a].handler(y))})},raiseEvent:function(c,g){var m=this.getHandler(c);m&&(g||(g={}),m(this,g))}}}(h),function(t){var c={};t.MouseTracker=function(S){var T=arguments;t.isPlainObject(S)||(S={element:T[0],clickTimeThreshold:T[1],clickDistThreshold:T[2]}),this.hash=Math.random(),this.element=t.getElement(S.element),this.clickTimeThreshold=S.clickTimeThreshold||t.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=S.clickDistThreshold||t.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=S.dblClickTimeThreshold||t.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=S.dblClickDistThreshold||t.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=S.userData||null,this.stopDelay=S.stopDelay||50,this.preProcessEventHandler=S.preProcessEventHandler||null,this.contextMenuHandler=S.contextMenuHandler||null,this.enterHandler=S.enterHandler||null,this.leaveHandler=S.leaveHandler||null,this.exitHandler=S.exitHandler||null,this.overHandler=S.overHandler||null,this.outHandler=S.outHandler||null,this.pressHandler=S.pressHandler||null,this.nonPrimaryPressHandler=S.nonPrimaryPressHandler||null,this.releaseHandler=S.releaseHandler||null,this.nonPrimaryReleaseHandler=S.nonPrimaryReleaseHandler||null,this.moveHandler=S.moveHandler||null,this.scrollHandler=S.scrollHandler||null,this.clickHandler=S.clickHandler||null,this.dblClickHandler=S.dblClickHandler||null,this.dragHandler=S.dragHandler||null,this.dragEndHandler=S.dragEndHandler||null,this.pinchHandler=S.pinchHandler||null,this.stopHandler=S.stopHandler||null,this.keyDownHandler=S.keyDownHandler||null,this.keyUpHandler=S.keyUpHandler||null,this.keyHandler=S.keyHandler||null,this.focusHandler=S.focusHandler||null,this.blurHandler=S.blurHandler||null;var O=this;c[this.hash]={click:function(M){w(O,M)},dblclick:function(M){C(O,M)},keydown:function(M){b(O,M)},keyup:function(M){P(O,M)},keypress:function(M){R(O,M)},focus:function(M){A(O,M)},blur:function(M){W(O,M)},contextmenu:function(M){$(O,M)},wheel:function(M){X(O,M)},mousewheel:function(M){re(O,M)},DOMMouseScroll:function(M){re(O,M)},MozMousePixelScroll:function(M){re(O,M)},losecapture:function(M){ne(O,M)},mouseenter:function(M){G(O,M)},mouseleave:function(M){D(O,M)},mouseover:function(M){k(O,M)},mouseout:function(M){H(O,M)},mousedown:function(M){F(O,M)},mouseup:function(M){K(O,M)},mousemove:function(M){J(O,M)},touchstart:function(M){ce(O,M)},touchend:function(M){ue(O,M)},touchmove:function(M){de(O,M)},touchcancel:function(M){fe(O,M)},gesturestart:function(M){L(O,M)},gesturechange:function(M){U(O,M)},gotpointercapture:function(M){N(O,M)},lostpointercapture:function(M){j(O,M)},pointerenter:function(M){G(O,M)},pointerleave:function(M){D(O,M)},pointerover:function(M){k(O,M)},pointerout:function(M){H(O,M)},pointerdown:function(M){F(O,M)},pointerup:function(M){K(O,M)},pointermove:function(M){J(O,M)},pointercancel:function(M){x(O,M)},pointerupcaptured:function(M){V(O,M)},pointermovecaptured:function(M){ie(O,M)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,t.MouseTracker.havePointerEvents&&t.setElementPointerEvents(this.element,"auto"),this.exitHandler&&t.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),S.startDisabled||this.setTracking(!0)},t.MouseTracker.prototype={destroy:function(){i(this),this.element=null,c[this.hash]=null,delete c[this.hash]},isTracking:function(){return c[this.hash].tracking},setTracking:function(S){return S?a(this):i(this),this},getActivePointersListByType:function(S){var T=c[this.hash],O,M=T.activePointersLists.length,Q;for(O=0;O<M;O++)if(T.activePointersLists[O].type===S)return T.activePointersLists[O];return Q=new t.MouseTracker.GesturePointList(S),T.activePointersLists.push(Q),Q},getActivePointerCount:function(){var S=c[this.hash],T,O=S.activePointersLists.length,M=0;for(T=0;T<O;T++)M+=S.activePointersLists[T].getLength();return M},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var g=function(){try{return window.self!==window.top}catch{return!0}}();function m(S){try{return S.addEventListener&&S.removeEventListener}catch{return!1}}t.MouseTracker.gesturePointVelocityTracker=function(){var S=[],T=0,O=0,M=function(we,ve){return we.hash.toString()+ve.type+ve.id.toString()},Q=function(){var we,ve=S.length,Ee,Ce,We=t.now(),xi,Ci,bi;for(xi=We-O,O=We,we=0;we<ve;we++)Ee=S[we],Ce=Ee.gPoint,Ce.direction=Math.atan2(Ce.currentPos.y-Ee.lastPos.y,Ce.currentPos.x-Ee.lastPos.x),Ci=Ee.lastPos.distanceTo(Ce.currentPos),Ee.lastPos=Ce.currentPos,bi=1e3*Ci/(xi+1),Ce.speed=.75*bi+.25*Ce.speed},se=function(we,ve){var Ee=M(we,ve);S.push({guid:Ee,gPoint:ve,lastPos:ve.currentPos}),S.length===1&&(O=t.now(),T=window.setInterval(Q,50))},pe=function(we,ve){var Ee=M(we,ve),Ce,We=S.length;for(Ce=0;Ce<We;Ce++)if(S[Ce].guid===Ee){S.splice(Ce,1),We--,We===0&&window.clearInterval(T);break}};return{addPoint:se,removePoint:pe}}(),t.MouseTracker.captureElement=document,t.MouseTracker.wheelEventName=t.Browser.vendor===t.BROWSERS.IE&&t.Browser.version>8||"onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",t.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",t.MouseTracker.wheelEventName],t.MouseTracker.wheelEventName==="DOMMouseScroll"&&t.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(t.MouseTracker.havePointerEvents=!0,t.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),t.MouseTracker.havePointerCapture=function(){var S=document.createElement("div");return t.isFunction(S.setPointerCapture)&&t.isFunction(S.releasePointerCapture)}(),t.MouseTracker.havePointerCapture&&t.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(t.MouseTracker.havePointerEvents=!1,t.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),t.MouseTracker.mousePointerId="legacy-mouse",t.MouseTracker.havePointerCapture=function(){var S=document.createElement("div");return t.isFunction(S.setCapture)&&t.isFunction(S.releaseCapture)}(),t.MouseTracker.havePointerCapture&&t.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&t.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&t.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),t.MouseTracker.GesturePointList=function(S){this._gPoints=[],this.type=S,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},t.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(S){return this._gPoints.push(S)},removeById:function(S){var T,O=this._gPoints.length;for(T=0;T<O;T++)if(this._gPoints[T].id===S){this._gPoints.splice(T,1);break}return this._gPoints.length},getByIndex:function(S){return S<this._gPoints.length?this._gPoints[S]:null},getById:function(S){var T,O=this._gPoints.length;for(T=0;T<O;T++)if(this._gPoints[T].id===S)return this._gPoints[T];return null},getPrimary:function(S){var T,O=this._gPoints.length;for(T=0;T<O;T++)if(this._gPoints[T].isPrimary)return this._gPoints[T];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(t.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function y(S){var T=c[S.hash],O,M,Q,se,pe,we=T.activePointersLists.length;for(O=0;O<we;O++)if(Q=T.activePointersLists[O],Q.getLength()>0){for(pe=[],se=Q.asArray(),M=0;M<se.length;M++)pe.push(se[M]);for(M=0;M<pe.length;M++)I(S,Q,pe[M])}for(O=0;O<we;O++)T.activePointersLists.pop();T.sentDragEvent=!1}function a(S){var T=c[S.hash],O,M;if(!T.tracking){for(M=0;M<t.MouseTracker.subscribeEvents.length;M++)O=t.MouseTracker.subscribeEvents[M],t.addEvent(S.element,O,T[O],O===t.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);y(S),T.tracking=!0}}function i(S){var T=c[S.hash],O,M;if(T.tracking){for(M=0;M<t.MouseTracker.subscribeEvents.length;M++)O=t.MouseTracker.subscribeEvents[M],t.removeEvent(S.element,O,T[O],!1);y(S),T.tracking=!1}}function r(S,T){var O=c[S.hash];if(T==="pointerevent")return{upName:"pointerup",upHandler:O.pointerupcaptured,moveName:"pointermove",moveHandler:O.pointermovecaptured};if(T==="mouse")return{upName:"pointerup",upHandler:O.pointerupcaptured,moveName:"pointermove",moveHandler:O.pointermovecaptured};if(T==="touch")return{upName:"touchend",upHandler:O.touchendcaptured,moveName:"touchmove",moveHandler:O.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function o(S,T){var O;if(t.MouseTracker.havePointerCapture)if(t.MouseTracker.havePointerEvents)try{S.element.setPointerCapture(T.id)}catch{t.console.warn("setPointerCapture() called on invalid pointer ID");return}else S.element.setCapture(!0);else O=r(S,t.MouseTracker.havePointerEvents?"pointerevent":T.type),g&&m(window.top)&&t.addEvent(window.top,O.upName,O.upHandler,!0),t.addEvent(t.MouseTracker.captureElement,O.upName,O.upHandler,!0),t.addEvent(t.MouseTracker.captureElement,O.moveName,O.moveHandler,!0);q(S,T,!0)}function n(S,T){var O,M,Q;if(t.MouseTracker.havePointerCapture)if(t.MouseTracker.havePointerEvents){if(M=S.getActivePointersListByType(T.type),Q=M.getById(T.id),!Q||!Q.captured)return;try{S.element.releasePointerCapture(T.id)}catch{}}else S.element.releaseCapture();else O=r(S,t.MouseTracker.havePointerEvents?"pointerevent":T.type),g&&m(window.top)&&t.removeEvent(window.top,O.upName,O.upHandler,!0),t.removeEvent(t.MouseTracker.captureElement,O.moveName,O.moveHandler,!0),t.removeEvent(t.MouseTracker.captureElement,O.upName,O.upHandler,!0);q(S,T,!1)}function s(S){return t.MouseTracker.havePointerEvents?S.pointerId:t.MouseTracker.mousePointerId}function l(S){return t.MouseTracker.havePointerEvents?S.pointerType||(t.Browser.vendor===t.BROWSERS.IE?"mouse":""):"mouse"}function u(S){return t.MouseTracker.havePointerEvents?S.isPrimary:!0}function d(S){return t.getMousePosition(S)}function f(S,T){return p(d(S),T)}function p(S,T){var O=t.getElementOffset(T);return S.minus(O)}function v(S,T){return new t.Point((S.x+T.x)/2,(S.y+T.y)/2)}function w(S,T){var O={originalEvent:T,eventType:"click",pointerType:"mouse",isEmulated:!1};B(S,O),O.preventDefault&&!O.defaultPrevented&&t.cancelEvent(T),O.stopPropagation&&t.stopEvent(T)}function C(S,T){var O={originalEvent:T,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};B(S,O),O.preventDefault&&!O.defaultPrevented&&t.cancelEvent(T),O.stopPropagation&&t.stopEvent(T)}function b(S,T){var O=null,M={originalEvent:T,eventType:"keydown",pointerType:"",isEmulated:!1};B(S,M),S.keyDownHandler&&!M.preventGesture&&!M.defaultPrevented&&(O={eventSource:S,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:M.preventDefault||M.defaultPrevented,userData:S.userData},S.keyDownHandler(O)),(O&&O.preventDefault||M.preventDefault&&!M.defaultPrevented)&&t.cancelEvent(T),M.stopPropagation&&t.stopEvent(T)}function P(S,T){var O=null,M={originalEvent:T,eventType:"keyup",pointerType:"",isEmulated:!1};B(S,M),S.keyUpHandler&&!M.preventGesture&&!M.defaultPrevented&&(O={eventSource:S,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:M.preventDefault||M.defaultPrevented,userData:S.userData},S.keyUpHandler(O)),(O&&O.preventDefault||M.preventDefault&&!M.defaultPrevented)&&t.cancelEvent(T),M.stopPropagation&&t.stopEvent(T)}function R(S,T){var O=null,M={originalEvent:T,eventType:"keypress",pointerType:"",isEmulated:!1};B(S,M),S.keyHandler&&!M.preventGesture&&!M.defaultPrevented&&(O={eventSource:S,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:M.preventDefault||M.defaultPrevented,userData:S.userData},S.keyHandler(O)),(O&&O.preventDefault||M.preventDefault&&!M.defaultPrevented)&&t.cancelEvent(T),M.stopPropagation&&t.stopEvent(T)}function A(S,T){var O={originalEvent:T,eventType:"focus",pointerType:"",isEmulated:!1};B(S,O),S.focusHandler&&!O.preventGesture&&S.focusHandler({eventSource:S,originalEvent:T,userData:S.userData})}function W(S,T){var O={originalEvent:T,eventType:"blur",pointerType:"",isEmulated:!1};B(S,O),S.blurHandler&&!O.preventGesture&&S.blurHandler({eventSource:S,originalEvent:T,userData:S.userData})}function $(S,T){var O=null,M={originalEvent:T,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};B(S,M),S.contextMenuHandler&&!M.preventGesture&&!M.defaultPrevented&&(O={eventSource:S,position:p(d(T),S.element),originalEvent:M.originalEvent,preventDefault:M.preventDefault||M.defaultPrevented,userData:S.userData},S.contextMenuHandler(O)),(O&&O.preventDefault||M.preventDefault&&!M.defaultPrevented)&&t.cancelEvent(T),M.stopPropagation&&t.stopEvent(T)}function X(S,T){he(S,T,T)}function re(S,T){var O={target:T.target||T.srcElement,type:"wheel",shiftKey:T.shiftKey||!1,clientX:T.clientX,clientY:T.clientY,pageX:T.pageX?T.pageX:T.clientX,pageY:T.pageY?T.pageY:T.clientY,deltaMode:T.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};t.MouseTracker.wheelEventName==="mousewheel"?O.deltaY=-T.wheelDelta/t.DEFAULT_SETTINGS.pixelsPerWheelLine:O.deltaY=T.detail,he(S,O,T)}function he(S,T,O){var M=0,Q,se=null;M=T.deltaY<0?1:-1,Q={originalEvent:T,eventType:"wheel",pointerType:"mouse",isEmulated:T!==O},B(S,Q),S.scrollHandler&&!Q.preventGesture&&!Q.defaultPrevented&&(se={eventSource:S,pointerType:"mouse",position:f(T,S.element),scroll:M,shift:T.shiftKey,isTouchEvent:!1,originalEvent:O,preventDefault:Q.preventDefault||Q.defaultPrevented,userData:S.userData},S.scrollHandler(se)),Q.stopPropagation&&t.stopEvent(O),(se&&se.preventDefault||Q.preventDefault&&!Q.defaultPrevented)&&t.cancelEvent(O)}function ne(S,T){var O={id:t.MouseTracker.mousePointerId,type:"mouse"},M={originalEvent:T,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};B(S,M),T.target===S.element&&q(S,O,!1),M.stopPropagation&&t.stopEvent(T)}function ce(S,T){var O,M,Q=T.changedTouches.length,se,pe=S.getActivePointersListByType("touch");O=t.now(),pe.getLength()>T.touches.length-Q&&t.console.warn("Tracked touch contact count doesn't match event.touches.length");var we={originalEvent:T,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(B(S,we),M=0;M<Q;M++)se={id:T.changedTouches[M].identifier,type:"touch",isPrimary:pe.getLength()===0,currentPos:d(T.changedTouches[M]),currentTime:O},ee(S,we,se),ae(S,we,se,0),q(S,se,!0);we.preventDefault&&!we.defaultPrevented&&t.cancelEvent(T),we.stopPropagation&&t.stopEvent(T)}function ue(S,T){var O,M,Q=T.changedTouches.length,se;O=t.now();var pe={originalEvent:T,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(B(S,pe),M=0;M<Q;M++)se={id:T.changedTouches[M].identifier,type:"touch",currentPos:d(T.changedTouches[M]),currentTime:O},ge(S,pe,se,0),q(S,se,!1),le(S,pe,se);pe.preventDefault&&!pe.defaultPrevented&&t.cancelEvent(T),pe.stopPropagation&&t.stopEvent(T)}function de(S,T){var O,M,Q=T.changedTouches.length,se;O=t.now();var pe={originalEvent:T,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(B(S,pe),M=0;M<Q;M++)se={id:T.changedTouches[M].identifier,type:"touch",currentPos:d(T.changedTouches[M]),currentTime:O},me(S,pe,se);pe.preventDefault&&!pe.defaultPrevented&&t.cancelEvent(T),pe.stopPropagation&&t.stopEvent(T)}function fe(S,T){var O=T.changedTouches.length,M,Q,se={originalEvent:T,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(B(S,se),M=0;M<O;M++)Q={id:T.changedTouches[M].identifier,type:"touch"},ye(S,se,Q);se.stopPropagation&&t.stopEvent(T)}function L(S,T){return t.eventIsCanceled(T)||T.preventDefault(),!1}function U(S,T){return t.eventIsCanceled(T)||T.preventDefault(),!1}function N(S,T){var O={originalEvent:T,eventType:"gotpointercapture",pointerType:l(T),isEmulated:!1};B(S,O),T.target===S.element&&q(S,{id:T.pointerId,type:l(T)},!0),O.stopPropagation&&t.stopEvent(T)}function j(S,T){var O={originalEvent:T,eventType:"lostpointercapture",pointerType:l(T),isEmulated:!1};B(S,O),T.target===S.element&&q(S,{id:T.pointerId,type:l(T)},!1),O.stopPropagation&&t.stopEvent(T)}function G(S,T){var O={id:s(T),type:l(T),isPrimary:u(T),currentPos:d(T),currentTime:t.now()},M={originalEvent:T,eventType:"pointerenter",pointerType:O.type,isEmulated:!1};B(S,M),ee(S,M,O)}function D(S,T){var O={id:s(T),type:l(T),isPrimary:u(T),currentPos:d(T),currentTime:t.now()},M={originalEvent:T,eventType:"pointerleave",pointerType:O.type,isEmulated:!1};B(S,M),le(S,M,O)}function k(S,T){var O={id:s(T),type:l(T),isPrimary:u(T),currentPos:d(T),currentTime:t.now()},M={originalEvent:T,eventType:"pointerover",pointerType:O.type,isEmulated:!1};B(S,M),Z(S,M,O),M.preventDefault&&!M.defaultPrevented&&t.cancelEvent(T),M.stopPropagation&&t.stopEvent(T)}function H(S,T){var O={id:s(T),type:l(T),isPrimary:u(T),currentPos:d(T),currentTime:t.now()},M={originalEvent:T,eventType:"pointerout",pointerType:O.type,isEmulated:!1};B(S,M),oe(S,M,O),M.preventDefault&&!M.defaultPrevented&&t.cancelEvent(T),M.stopPropagation&&t.stopEvent(T)}function F(S,T){var O={id:s(T),type:l(T),isPrimary:u(T),currentPos:d(T),currentTime:t.now()},M=t.MouseTracker.havePointerEvents&&O.type==="touch"&&t.Browser.vendor!==t.BROWSERS.IE,Q={originalEvent:T,eventType:"pointerdown",pointerType:O.type,isEmulated:!1};B(S,Q),ae(S,Q,O,T.button),Q.preventDefault&&!Q.defaultPrevented&&t.cancelEvent(T),Q.stopPropagation&&t.stopEvent(T),Q.shouldCapture&&(M?q(S,O,!0):o(S,O))}function K(S,T){te(S,T)}function V(S,T){var O=S.getActivePointersListByType(l(T));O.getById(T.pointerId)&&te(S,T),t.stopEvent(T)}function te(S,T){var O;O={id:s(T),type:l(T),isPrimary:u(T),currentPos:d(T),currentTime:t.now()};var M={originalEvent:T,eventType:"pointerup",pointerType:O.type,isEmulated:!1};B(S,M),ge(S,M,O,T.button),M.preventDefault&&!M.defaultPrevented&&t.cancelEvent(T),M.stopPropagation&&t.stopEvent(T),M.shouldReleaseCapture&&(T.target===S.element?n(S,O):q(S,O,!1))}function J(S,T){Y(S,T)}function ie(S,T){var O=S.getActivePointersListByType(l(T));O.getById(T.pointerId)&&Y(S,T),t.stopEvent(T)}function Y(S,T){var O={id:s(T),type:l(T),isPrimary:u(T),currentPos:d(T),currentTime:t.now()},M={originalEvent:T,eventType:"pointermove",pointerType:O.type,isEmulated:!1};B(S,M),me(S,M,O),M.preventDefault&&!M.defaultPrevented&&t.cancelEvent(T),M.stopPropagation&&t.stopEvent(T)}function x(S,T){var O={id:T.pointerId,type:l(T)},M={originalEvent:T,eventType:"pointercancel",pointerType:O.type,isEmulated:!1};B(S,M),ye(S,M,O),M.stopPropagation&&t.stopEvent(T)}function E(S,T){return T.speed=0,T.direction=0,T.contactPos=T.currentPos,T.contactTime=T.currentTime,T.lastPos=T.currentPos,T.lastTime=T.currentTime,S.add(T)}function I(S,T,O){var M,Q=T.getById(O.id);return Q?(Q.captured&&(t.console.warn("stopTrackingPointer() called on captured pointer"),n(S,Q)),T.removeContact(),M=T.removeById(O.id)):M=T.getLength(),M}function z(S,T){switch(T.eventType){case"pointermove":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!S.hasGestureHandlers,T.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break;case"pointerdown":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!S.hasGestureHandlers,T.stopPropagation=!1;break;case"pointerup":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!S.hasGestureHandlers,T.stopPropagation=!1;break;case"wheel":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!S.hasScrollHandler,T.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":T.isStoppable=!0,T.isCancelable=!1,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break;case"click":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!!S.clickHandler,T.preventGesture=!1,T.stopPropagation=!1;break;case"dblclick":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!!S.dblClickHandler,T.preventGesture=!1,T.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:T.isStoppable=!1,T.isCancelable=!1,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break}}function B(S,T){T.eventSource=S,T.eventPhase=T.originalEvent&&typeof T.originalEvent.eventPhase!="undefined"?T.originalEvent.eventPhase:0,T.defaultPrevented=t.eventIsCanceled(T.originalEvent),T.shouldCapture=!1,T.shouldReleaseCapture=!1,T.userData=S.userData,z(S,T),S.preProcessEventHandler&&S.preProcessEventHandler(T)}function q(S,T,O){var M=S.getActivePointersListByType(T.type),Q=M.getById(T.id);Q?O&&!Q.captured?(Q.captured=!0,M.captureCount++):!O&&Q.captured&&(Q.captured=!1,M.captureCount--,M.captureCount<0&&(M.captureCount=0,t.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):t.console.warn("updatePointerCaptured() called on untracked pointer")}function ee(S,T,O){var M=S.getActivePointersListByType(O.type),Q;Q=M.getById(O.id),Q?(Q.insideElement=!0,Q.lastPos=Q.currentPos,Q.lastTime=Q.currentTime,Q.currentPos=O.currentPos,Q.currentTime=O.currentTime,O=Q):(O.captured=!1,O.insideElementPressed=!1,O.insideElement=!0,E(M,O)),S.enterHandler&&S.enterHandler({eventSource:S,pointerType:O.type,position:p(O.currentPos,S.element),buttons:M.buttons,pointers:S.getActivePointerCount(),insideElementPressed:O.insideElementPressed,buttonDownAny:M.buttons!==0,isTouchEvent:O.type==="touch",originalEvent:T.originalEvent,userData:S.userData})}function le(S,T,O){var M=S.getActivePointersListByType(O.type),Q,se;Q=M.getById(O.id),Q?(Q.captured?(Q.insideElement=!1,Q.lastPos=Q.currentPos,Q.lastTime=Q.currentTime,Q.currentPos=O.currentPos,Q.currentTime=O.currentTime):I(S,M,Q),O=Q):(O.captured=!1,O.insideElementPressed=!1),(S.leaveHandler||S.exitHandler)&&(se={eventSource:S,pointerType:O.type,position:O.currentPos&&p(O.currentPos,S.element),buttons:M.buttons,pointers:S.getActivePointerCount(),insideElementPressed:O.insideElementPressed,buttonDownAny:M.buttons!==0,isTouchEvent:O.type==="touch",originalEvent:T.originalEvent,userData:S.userData},S.leaveHandler&&S.leaveHandler(se),S.exitHandler&&S.exitHandler(se))}function Z(S,T,O){var M,Q;M=S.getActivePointersListByType(O.type),Q=M.getById(O.id),Q?O=Q:(O.captured=!1,O.insideElementPressed=!1),S.overHandler&&S.overHandler({eventSource:S,pointerType:O.type,position:p(O.currentPos,S.element),buttons:M.buttons,pointers:S.getActivePointerCount(),insideElementPressed:O.insideElementPressed,buttonDownAny:M.buttons!==0,isTouchEvent:O.type==="touch",originalEvent:T.originalEvent,userData:S.userData})}function oe(S,T,O){var M,Q;M=S.getActivePointersListByType(O.type),Q=M.getById(O.id),Q?O=Q:(O.captured=!1,O.insideElementPressed=!1),S.outHandler&&S.outHandler({eventSource:S,pointerType:O.type,position:O.currentPos&&p(O.currentPos,S.element),buttons:M.buttons,pointers:S.getActivePointerCount(),insideElementPressed:O.insideElementPressed,buttonDownAny:M.buttons!==0,isTouchEvent:O.type==="touch",originalEvent:T.originalEvent,userData:S.userData})}function ae(S,T,O,M){var Q=c[S.hash],se=S.getActivePointersListByType(O.type),pe;if(typeof T.originalEvent.buttons!="undefined"?se.buttons=T.originalEvent.buttons:M===0?se.buttons|=1:M===1?se.buttons|=4:M===2?se.buttons|=2:M===3?se.buttons|=8:M===4?se.buttons|=16:M===5&&(se.buttons|=32),M!==0){T.shouldCapture=!1,T.shouldReleaseCapture=!1,S.nonPrimaryPressHandler&&!T.preventGesture&&!T.defaultPrevented&&(T.preventDefault=!0,S.nonPrimaryPressHandler({eventSource:S,pointerType:O.type,position:p(O.currentPos,S.element),button:M,buttons:se.buttons,isTouchEvent:O.type==="touch",originalEvent:T.originalEvent,userData:S.userData}));return}pe=se.getById(O.id),pe?(pe.insideElementPressed=!0,pe.insideElement=!0,pe.originalTarget=T.originalEvent.target,pe.contactPos=O.currentPos,pe.contactTime=O.currentTime,pe.lastPos=pe.currentPos,pe.lastTime=pe.currentTime,pe.currentPos=O.currentPos,pe.currentTime=O.currentTime,O=pe):(O.captured=!1,O.insideElementPressed=!0,O.insideElement=!0,O.originalTarget=T.originalEvent.target,E(se,O)),se.addContact(),!T.preventGesture&&!T.defaultPrevented?(T.shouldCapture=!0,T.shouldReleaseCapture=!1,T.preventDefault=!0,(S.dragHandler||S.dragEndHandler||S.pinchHandler)&&t.MouseTracker.gesturePointVelocityTracker.addPoint(S,O),se.contacts===1?S.pressHandler&&!T.preventGesture&&S.pressHandler({eventSource:S,pointerType:O.type,position:p(O.contactPos,S.element),buttons:se.buttons,isTouchEvent:O.type==="touch",originalEvent:T.originalEvent,userData:S.userData}):se.contacts===2&&S.pinchHandler&&O.type==="touch"&&(Q.pinchGPoints=se.asArray(),Q.lastPinchDist=Q.currentPinchDist=Q.pinchGPoints[0].currentPos.distanceTo(Q.pinchGPoints[1].currentPos),Q.lastPinchCenter=Q.currentPinchCenter=v(Q.pinchGPoints[0].currentPos,Q.pinchGPoints[1].currentPos))):(T.shouldCapture=!1,T.shouldReleaseCapture=!1)}function ge(S,T,O,M){var Q=c[S.hash],se=S.getActivePointersListByType(O.type),pe,we,ve,Ee=!1,Ce;if(typeof T.originalEvent.buttons!="undefined"?se.buttons=T.originalEvent.buttons:M===0?se.buttons^=-2:M===1?se.buttons^=-5:M===2?se.buttons^=-3:M===3?se.buttons^=-9:M===4?se.buttons^=-17:M===5&&(se.buttons^=-33),T.shouldCapture=!1,M!==0){T.shouldReleaseCapture=!1,S.nonPrimaryReleaseHandler&&!T.preventGesture&&!T.defaultPrevented&&(T.preventDefault=!0,S.nonPrimaryReleaseHandler({eventSource:S,pointerType:O.type,position:p(O.currentPos,S.element),button:M,buttons:se.buttons,isTouchEvent:O.type==="touch",originalEvent:T.originalEvent,userData:S.userData}));return}ve=se.getById(O.id),ve?(se.removeContact(),ve.captured&&(Ee=!0),ve.lastPos=ve.currentPos,ve.lastTime=ve.currentTime,ve.currentPos=O.currentPos,ve.currentTime=O.currentTime,ve.insideElement||I(S,se,ve),pe=ve.currentPos,we=ve.currentTime):(O.captured=!1,O.insideElementPressed=!1,O.insideElement=!0,E(se,O),ve=O),!T.preventGesture&&!T.defaultPrevented&&(Ee?(T.shouldReleaseCapture=!0,T.preventDefault=!0,(S.dragHandler||S.dragEndHandler||S.pinchHandler)&&t.MouseTracker.gesturePointVelocityTracker.removePoint(S,ve),se.contacts===0?(S.releaseHandler&&pe&&S.releaseHandler({eventSource:S,pointerType:ve.type,position:p(pe,S.element),buttons:se.buttons,insideElementPressed:ve.insideElementPressed,insideElementReleased:ve.insideElement,isTouchEvent:ve.type==="touch",originalEvent:T.originalEvent,userData:S.userData}),S.dragEndHandler&&Q.sentDragEvent&&S.dragEndHandler({eventSource:S,pointerType:ve.type,position:p(ve.currentPos,S.element),speed:ve.speed,direction:ve.direction,shift:T.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:T.originalEvent,userData:S.userData}),Q.sentDragEvent=!1,(S.clickHandler||S.dblClickHandler)&&ve.insideElement&&(Ce=we-ve.contactTime<=S.clickTimeThreshold&&ve.contactPos.distanceTo(pe)<=S.clickDistThreshold,S.clickHandler&&S.clickHandler({eventSource:S,pointerType:ve.type,position:p(ve.currentPos,S.element),quick:Ce,shift:T.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:T.originalEvent,originalTarget:ve.originalTarget,userData:S.userData}),S.dblClickHandler&&Ce&&(se.clicks++,se.clicks===1?(Q.lastClickPos=pe,Q.dblClickTimeOut=setTimeout(function(){se.clicks=0},S.dblClickTimeThreshold)):se.clicks===2&&(clearTimeout(Q.dblClickTimeOut),se.clicks=0,Q.lastClickPos.distanceTo(pe)<=S.dblClickDistThreshold&&S.dblClickHandler({eventSource:S,pointerType:ve.type,position:p(ve.currentPos,S.element),shift:T.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:T.originalEvent,userData:S.userData}),Q.lastClickPos=null)))):se.contacts===2&&S.pinchHandler&&ve.type==="touch"&&(Q.pinchGPoints=se.asArray(),Q.lastPinchDist=Q.currentPinchDist=Q.pinchGPoints[0].currentPos.distanceTo(Q.pinchGPoints[1].currentPos),Q.lastPinchCenter=Q.currentPinchCenter=v(Q.pinchGPoints[0].currentPos,Q.pinchGPoints[1].currentPos))):(T.shouldReleaseCapture=!1,S.releaseHandler&&pe&&(S.releaseHandler({eventSource:S,pointerType:ve.type,position:p(pe,S.element),buttons:se.buttons,insideElementPressed:ve.insideElementPressed,insideElementReleased:ve.insideElement,isTouchEvent:ve.type==="touch",originalEvent:T.originalEvent,userData:S.userData}),T.preventDefault=!0)))}function me(S,T,O){var M=c[S.hash],Q=S.getActivePointersListByType(O.type),se,pe,we;if(typeof T.originalEvent.buttons!="undefined"&&(Q.buttons=T.originalEvent.buttons),se=Q.getById(O.id),se)se.lastPos=se.currentPos,se.lastTime=se.currentTime,se.currentPos=O.currentPos,se.currentTime=O.currentTime;else return;T.shouldCapture=!1,T.shouldReleaseCapture=!1,S.stopHandler&&O.type==="mouse"&&(clearTimeout(S.stopTimeOut),S.stopTimeOut=setTimeout(function(){_e(S,T.originalEvent,O.type)},S.stopDelay)),Q.contacts===0?S.moveHandler&&S.moveHandler({eventSource:S,pointerType:O.type,position:p(O.currentPos,S.element),buttons:Q.buttons,isTouchEvent:O.type==="touch",originalEvent:T.originalEvent,userData:S.userData}):Q.contacts===1?(S.moveHandler&&(se=Q.asArray()[0],S.moveHandler({eventSource:S,pointerType:se.type,position:p(se.currentPos,S.element),buttons:Q.buttons,isTouchEvent:se.type==="touch",originalEvent:T.originalEvent,userData:S.userData})),S.dragHandler&&!T.preventGesture&&!T.defaultPrevented&&(se=Q.asArray()[0],we=se.currentPos.minus(se.lastPos),S.dragHandler({eventSource:S,pointerType:se.type,position:p(se.currentPos,S.element),buttons:Q.buttons,delta:we,speed:se.speed,direction:se.direction,shift:T.originalEvent.shiftKey,isTouchEvent:se.type==="touch",originalEvent:T.originalEvent,userData:S.userData}),T.preventDefault=!0,M.sentDragEvent=!0)):Q.contacts===2&&(S.moveHandler&&(pe=Q.asArray(),S.moveHandler({eventSource:S,pointerType:pe[0].type,position:p(v(pe[0].currentPos,pe[1].currentPos),S.element),buttons:Q.buttons,isTouchEvent:pe[0].type==="touch",originalEvent:T.originalEvent,userData:S.userData})),S.pinchHandler&&O.type==="touch"&&!T.preventGesture&&!T.defaultPrevented&&(we=M.pinchGPoints[0].currentPos.distanceTo(M.pinchGPoints[1].currentPos),we!==M.currentPinchDist&&(M.lastPinchDist=M.currentPinchDist,M.currentPinchDist=we,M.lastPinchCenter=M.currentPinchCenter,M.currentPinchCenter=v(M.pinchGPoints[0].currentPos,M.pinchGPoints[1].currentPos),S.pinchHandler({eventSource:S,pointerType:"touch",gesturePoints:M.pinchGPoints,lastCenter:p(M.lastPinchCenter,S.element),center:p(M.currentPinchCenter,S.element),lastDistance:M.lastPinchDist,distance:M.currentPinchDist,shift:T.originalEvent.shiftKey,originalEvent:T.originalEvent,userData:S.userData}),T.preventDefault=!0)))}function ye(S,T,O){var M=S.getActivePointersListByType(O.type),Q;Q=M.getById(O.id),Q&&I(S,M,Q)}function _e(S,T,O){S.stopHandler&&S.stopHandler({eventSource:S,pointerType:O,position:f(T,S.element),buttons:S.getActivePointersListByType(O).buttons,isTouchEvent:O==="touch",originalEvent:T,userData:S.userData})}}(h),function(t){t.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},t.Control=function(c,g,m){var y=c.parentNode;typeof g=="number"&&(t.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),g={anchor:g}),g.attachToViewer=typeof g.attachToViewer=="undefined"?!0:g.attachToViewer,this.autoFade=typeof g.autoFade=="undefined"?!0:g.autoFade,this.element=c,this.anchor=g.anchor,this.container=m,this.anchor===t.ControlAnchor.ABSOLUTE?(this.wrapper=t.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof g.top=="number"?g.top+"px":g.top,this.wrapper.style.left=typeof g.left=="number"?g.left+"px":g.left,this.wrapper.style.height=typeof g.height=="number"?g.height+"px":g.height,this.wrapper.style.width=typeof g.width=="number"?g.width+"px":g.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=t.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===t.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),g.attachToViewer?this.anchor===t.ControlAnchor.TOP_RIGHT||this.anchor===t.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):y.appendChild(this.wrapper)},t.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==t.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(c){this.wrapper.style.display=c?this.anchor===t.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(c){this.element[t.SIGNAL]&&t.Browser.vendor===t.BROWSERS.IE?t.setElementOpacity(this.element,c,!0):t.setElementOpacity(this.wrapper,c,!0)}}}(h),function(t){t.ControlDock=function(g){var m=["topleft","topright","bottomright","bottomleft"],y,a;for(t.extend(!0,this,{id:"controldock-"+t.now()+"-"+Math.floor(Math.random()*1e6),container:t.makeNeutralElement("div"),controls:[]},g),this.container.onsubmit=function(){return!1},this.element&&(this.element=t.getElement(this.element),this.element.appendChild(this.container),this.element.style.position="relative",this.container.style.width="100%",this.container.style.height="100%"),a=0;a<m.length;a++)y=m[a],this.controls[y]=t.makeNeutralElement("div"),this.controls[y].style.position="absolute",y.match("left")&&(this.controls[y].style.left="0px"),y.match("right")&&(this.controls[y].style.right="0px"),y.match("top")&&(this.controls[y].style.top="0px"),y.match("bottom")&&(this.controls[y].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},t.ControlDock.prototype={addControl:function(g,m){g=t.getElement(g);var y=null;if(!(c(this,g)>=0)){switch(m.anchor){case t.ControlAnchor.TOP_RIGHT:y=this.controls.topright,g.style.position="relative",g.style.paddingRight="0px",g.style.paddingTop="0px";break;case t.ControlAnchor.BOTTOM_RIGHT:y=this.controls.bottomright,g.style.position="relative",g.style.paddingRight="0px",g.style.paddingBottom="0px";break;case t.ControlAnchor.BOTTOM_LEFT:y=this.controls.bottomleft,g.style.position="relative",g.style.paddingLeft="0px",g.style.paddingBottom="0px";break;case t.ControlAnchor.TOP_LEFT:y=this.controls.topleft,g.style.position="relative",g.style.paddingLeft="0px",g.style.paddingTop="0px";break;case t.ControlAnchor.ABSOLUTE:y=this.container,g.style.margin="0px",g.style.padding="0px";break;default:case t.ControlAnchor.NONE:y=this.container,g.style.margin="0px",g.style.padding="0px";break}this.controls.push(new t.Control(g,m,y)),g.style.display="inline-block"}},removeControl:function(g){g=t.getElement(g);var m=c(this,g);return m>=0&&(this.controls[m].destroy(),this.controls.splice(m,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var g;for(g=this.controls.length-1;g>=0;g--)if(this.controls[g].isVisible())return!0;return!1},setControlsEnabled:function(g){var m;for(m=this.controls.length-1;m>=0;m--)this.controls[m].setVisible(g);return this}};function c(g,m){var y=g.controls,a;for(a=y.length-1;a>=0;a--)if(y[a].element===m)return a;return-1}}(h),function(t){t.Placement=t.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(h),function(t){var c={},g=1;t.Viewer=function(x){var E=arguments,I=this,z;if(t.isPlainObject(x)||(x={id:E[0],xmlPath:E.length>1?E[1]:void 0,prefixUrl:E.length>2?E[2]:void 0,controls:E.length>3?E[3]:void 0,overlays:E.length>4?E[4]:void 0}),x.config&&(t.extend(!0,x,x.config),delete x.config),t.extend(!0,this,{id:x.id,hash:x.hash||g++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttons:null,profiler:null},t.DEFAULT_SETTINGS,x),typeof this.hash=="undefined")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");for(typeof c[this.hash]!="undefined"&&t.console.warn("Hash "+this.hash+" has already been used."),c[this.hash]={fsBoundsDelta:new t.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=t.now(),t.EventSource.call(this),this.addHandler("open-failed",function(B){var q=t.getString("Errors.OpenFailed",B.eventSource,B.message);I._showMessage(q)}),t.ControlDock.call(this,x),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=t.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(B){B.width="100%",B.height="100%",B.overflow="hidden",B.position="absolute",B.top="0px",B.left="0px"}(this.canvas.style),t.setElementTouchActionNone(this.canvas),x.tabIndex!==""&&(this.canvas.tabIndex=x.tabIndex===void 0?0:x.tabIndex),this.container.className="openseadragon-container",function(B){B.width="100%",B.height="100%",B.position="relative",B.overflow="hidden",B.left="0px",B.top="0px",B.textAlign="left"}(this.container.style),t.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new t.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:t.delegate(this,f),keyDownHandler:t.delegate(this,p),keyHandler:t.delegate(this,v),clickHandler:t.delegate(this,w),dblClickHandler:t.delegate(this,C),dragHandler:t.delegate(this,b),dragEndHandler:t.delegate(this,P),enterHandler:t.delegate(this,R),leaveHandler:t.delegate(this,A),pressHandler:t.delegate(this,W),releaseHandler:t.delegate(this,$),nonPrimaryPressHandler:t.delegate(this,X),nonPrimaryReleaseHandler:t.delegate(this,re),scrollHandler:t.delegate(this,ne),pinchHandler:t.delegate(this,he)}),this.outerTracker=new t.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:t.delegate(this,ce),leaveHandler:t.delegate(this,ue)}),this.toolbar&&(this.toolbar=new t.ControlDock({element:this.toolbar})),this.bindStandardControls(),c[this.hash].prevContainerSize=m(this.container),this.world=new t.World({viewer:this}),this.world.addHandler("add-item",function(B){I.source=I.world.getItemAt(0).source,c[I.hash].forceRedraw=!0,I._updateRequestId||(I._updateRequestId=r(I,de))}),this.world.addHandler("remove-item",function(B){I.world.getItemCount()?I.source=I.world.getItemAt(0).source:I.source=null,c[I.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(B){I.viewport&&I.viewport._setContentBounds(I.world.getHomeBounds(),I.world.getContentFactor())}),this.world.addHandler("item-index-change",function(B){I.source=I.world.getItemAt(0).source}),this.viewport=new t.Viewport({containerSize:c[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new t.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:x.timeout}),this.tileCache=new t.TileCache({maxImageCacheCount:this.maxImageCacheCount}),this.drawer=new t.Drawer({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor}),this.overlaysContainer=t.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(z=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(z,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(z=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(z,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new t.Navigator({id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),z=0;z<this.customControls.length;z++)this.addControl(this.customControls[z].id,{anchor:this.customControls[z].anchor});t.requestAnimationFrame(function(){n(I)}),this.imageSmoothingEnabled!==void 0&&!this.imageSmoothingEnabled&&this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),t._viewers.set(this.element,this)},t.extend(t.Viewer.prototype,t.EventSource.prototype,t.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(x){return t.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(x)},openTileSource:function(x){return t.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(x)},get buttons(){return t.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(x,E){var I=this;if(this.close(),!x)return this;if(this.sequenceMode&&t.isArray(x))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof E!="undefined"&&!isNaN(E)&&(this.initialPage=E),this.tileSources=x,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(t.isArray(x)||(x=[x]),!x.length)return this;this._opening=!0;for(var z=x.length,B=0,q=0,ee,le=function(){if(B+q===z)if(B){(I._firstOpen||!I.preserveViewport)&&(I.viewport.goHome(!0),I.viewport.update()),I._firstOpen=!1;var ae=x[0];if(ae.tileSource&&(ae=ae.tileSource),I.overlays&&!I.preserveOverlays)for(var ge=0;ge<I.overlays.length;ge++)I.currentOverlays[ge]=a(I,I.overlays[ge]);I._drawOverlays(),I._opening=!1,I.raiseEvent("open",{source:ae})}else I._opening=!1,I.raiseEvent("open-failed",ee)},Z=function(ae){(!t.isPlainObject(ae)||!ae.tileSource)&&(ae={tileSource:ae}),ae.index!==void 0&&(t.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete ae.index),ae.collectionImmediately===void 0&&(ae.collectionImmediately=!0);var ge=ae.success;ae.success=function(ye){if(B++,ae.tileSource.overlays)for(var _e=0;_e<ae.tileSource.overlays.length;_e++)I.addOverlay(ae.tileSource.overlays[_e]);ge&&ge(ye),le()};var me=ae.error;ae.error=function(ye){q++,ee||(ee=ye),me&&me(ye),le()},I.addTiledImage(ae)},oe=0;oe<x.length;oe++)Z(x[oe]);return this},close:function(){return c[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),c[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(!!c[this.hash]){if(this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(t.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),c[this.navigator.hash]=null,delete c[this.navigator.hash],this.navigator=null),this.removeAllHandlers(),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),c[this.hash]=null,delete c[this.hash],this.canvas=null,this.container=null,t._viewers.delete(this.element),this.element=null}},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(x){return this.innerTracker.setTracking(x),this.outerTracker.setTracking(x),this.raiseEvent("mouse-enabled",{enabled:x}),this},areControlsEnabled:function(){var x=this.controls.length,E;for(E=0;E<this.controls.length;E++)x=x&&this.controls[E].isVisible();return x},setControlsEnabled:function(x){return x?l(this):n(this),this.raiseEvent("controls-enabled",{enabled:x}),this},setDebugMode:function(x){for(var E=0;E<this.world.getItemCount();E++)this.world.getItemAt(E).debugMode=x;this.debugMode=x,this.forceRedraw()},isFullPage:function(){return c[this.hash].fullPage},setFullPage:function(x){var E=document.body,I=E.style,z=document.documentElement.style,B=this,q,ee;if(x===this.isFullPage())return this;var le={fullPage:x,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",le),le.preventDefaultAction)return this;if(x){for(this.elementSize=t.getElementSize(this.element),this.pageScroll=t.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=I.margin,this.docMargin=z.margin,I.margin="0",z.margin="0",this.bodyPadding=I.padding,this.docPadding=z.padding,I.padding="0",z.padding="0",this.bodyWidth=I.width,this.docWidth=z.width,I.width="100%",z.width="100%",this.bodyHeight=I.height,this.docHeight=z.height,I.height="100%",z.height="100%",this.bodyDisplay=I.display,I.display="block",this.previousBody=[],c[this.hash].prevElementParent=this.element.parentNode,c[this.hash].prevNextSibling=this.element.nextSibling,c[this.hash].prevElementWidth=this.element.style.width,c[this.hash].prevElementHeight=this.element.style.height,q=E.childNodes.length,ee=0;ee<q;ee++)this.previousBody.push(E.childNodes[0]),E.removeChild(E.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,E.appendChild(this.toolbar.element),t.addClass(this.toolbar.element,"fullpage")),t.addClass(this.element,"fullpage"),E.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=t.getElementSize(this.element).y-t.getElementSize(this.toolbar.element).y+"px"),c[this.hash].fullPage=!0,t.delegate(this,ce)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,I.margin=this.bodyMargin,z.margin=this.docMargin,I.padding=this.bodyPadding,z.padding=this.docPadding,I.width=this.bodyWidth,z.width=this.docWidth,I.height=this.bodyHeight,z.height=this.docHeight,I.display=this.bodyDisplay,E.removeChild(this.element),q=this.previousBody.length,ee=0;ee<q;ee++)E.appendChild(this.previousBody.shift());t.removeClass(this.element,"fullpage"),c[this.hash].prevElementParent.insertBefore(this.element,c[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(E.removeChild(this.toolbar.element),t.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=c[this.hash].prevElementWidth,this.element.style.height=c[this.hash].prevElementHeight;var Z=0,oe=function(){t.setPageScroll(B.pageScroll);var ae=t.getPageScroll();Z++,Z<10&&(ae.x!==B.pageScroll.x||ae.y!==B.pageScroll.y)&&t.requestAnimationFrame(oe)};t.requestAnimationFrame(oe),c[this.hash].fullPage=!1,t.delegate(this,ue)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:x}),this},setFullScreen:function(x){var E=this;if(!t.supportsFullScreen)return this.setFullPage(x);if(t.isFullScreen()===x)return this;var I={fullScreen:x,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",I),I.preventDefaultAction)return this;if(x){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var z=function(){var B=t.isFullScreen();B||(t.removeEvent(document,t.fullScreenEventName,z),t.removeEvent(document,t.fullScreenErrorEventName,z),E.setFullPage(!1),E.isFullPage()&&(E.element.style.width=E.fullPageStyleWidth,E.element.style.height=E.fullPageStyleHeight)),E.navigator&&E.viewport&&setTimeout(function(){E.navigator.update(E.viewport)}),E.raiseEvent("full-screen",{fullScreen:B})};t.addEvent(document,t.fullScreenEventName,z),t.addEvent(document,t.fullScreenErrorEventName,z),t.requestFullScreen(document.body)}else t.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return t.isFullScreen()&&this.isFullPage()},setVisible:function(x){return this.container.style.visibility=x?"":"hidden",this.raiseEvent("visible",{visible:x}),this},addTiledImage:function(x){t.console.assert(x,"[Viewer.addTiledImage] options is required"),t.console.assert(x.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),t.console.assert(!x.replace||x.index>-1&&x.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var E=this;x.replace&&(x.replaceItem=E.world.getItemAt(x.index)),this._hideMessage(),x.placeholderFillStyle===void 0&&(x.placeholderFillStyle=this.placeholderFillStyle),x.opacity===void 0&&(x.opacity=this.opacity),x.preload===void 0&&(x.preload=this.preload),x.compositeOperation===void 0&&(x.compositeOperation=this.compositeOperation),x.crossOriginPolicy===void 0&&(x.crossOriginPolicy=x.tileSource.crossOriginPolicy!==void 0?x.tileSource.crossOriginPolicy:this.crossOriginPolicy),x.ajaxWithCredentials===void 0&&(x.ajaxWithCredentials=this.ajaxWithCredentials),x.loadTilesWithAjax===void 0&&(x.loadTilesWithAjax=this.loadTilesWithAjax),x.ajaxHeaders===void 0||x.ajaxHeaders===null?x.ajaxHeaders=this.ajaxHeaders:t.isPlainObject(x.ajaxHeaders)&&t.isPlainObject(this.ajaxHeaders)&&(x.ajaxHeaders=t.extend({},this.ajaxHeaders,x.ajaxHeaders));var I={options:x};function z(ee){for(var le=0;le<E._loadQueue.length;le++)if(E._loadQueue[le]===I){E._loadQueue.splice(le,1);break}E._loadQueue.length===0&&B(I),E.raiseEvent("add-item-failed",ee),x.error&&x.error(ee)}function B(ee){E.collectionMode&&(E.world.arrange({immediately:ee.options.collectionImmediately,rows:E.collectionRows,columns:E.collectionColumns,layout:E.collectionLayout,tileSize:E.collectionTileSize,tileMargin:E.collectionTileMargin}),E.world.setAutoRefigureSizes(!0))}if(t.isArray(x.tileSource)){setTimeout(function(){z({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:x.tileSource,options:x})});return}this._loadQueue.push(I);function q(){for(var ee,le,Z;E._loadQueue.length&&(ee=E._loadQueue[0],!!ee.tileSource);){if(E._loadQueue.splice(0,1),ee.options.replace){var oe=E.world.getIndexOfItem(ee.options.replaceItem);oe!==-1&&(ee.options.index=oe),E.world.removeItem(ee.options.replaceItem)}le=new t.TiledImage({viewer:E,source:ee.tileSource,viewport:E.viewport,drawer:E.drawer,tileCache:E.tileCache,imageLoader:E.imageLoader,x:ee.options.x,y:ee.options.y,width:ee.options.width,height:ee.options.height,fitBounds:ee.options.fitBounds,fitBoundsPlacement:ee.options.fitBoundsPlacement,clip:ee.options.clip,placeholderFillStyle:ee.options.placeholderFillStyle,opacity:ee.options.opacity,preload:ee.options.preload,degrees:ee.options.degrees,flipped:ee.options.flipped,compositeOperation:ee.options.compositeOperation,springStiffness:E.springStiffness,animationTime:E.animationTime,minZoomImageRatio:E.minZoomImageRatio,wrapHorizontal:E.wrapHorizontal,wrapVertical:E.wrapVertical,immediateRender:E.immediateRender,blendTime:E.blendTime,alwaysBlend:E.alwaysBlend,minPixelRatio:E.minPixelRatio,smoothTileEdgesMinZoom:E.smoothTileEdgesMinZoom,iOSDevice:E.iOSDevice,crossOriginPolicy:ee.options.crossOriginPolicy,ajaxWithCredentials:ee.options.ajaxWithCredentials,loadTilesWithAjax:ee.options.loadTilesWithAjax,ajaxHeaders:ee.options.ajaxHeaders,debugMode:E.debugMode,subPixelRoundingForTransparency:E.subPixelRoundingForTransparency}),E.collectionMode&&E.world.setAutoRefigureSizes(!1),E.navigator&&(Z=t.extend({},ee.options,{replace:!1,originalTiledImage:le,tileSource:ee.tileSource}),E.navigator.addTiledImage(Z)),E.world.addItem(le,{index:ee.options.index}),E._loadQueue.length===0&&B(ee),E.world.getItemCount()===1&&!E.preserveViewport&&E.viewport.goHome(!0),ee.options.success&&ee.options.success({item:le})}}y(this,x.tileSource,x,function(ee){I.tileSource=ee,q()},function(ee){ee.options=x,z(ee),q()})},addSimpleImage:function(x){t.console.assert(x,"[Viewer.addSimpleImage] options is required"),t.console.assert(x.url,"[Viewer.addSimpleImage] options.url is required");var E=t.extend({},x,{tileSource:{type:"image",url:x.url}});delete E.url,this.addTiledImage(E)},addLayer:function(x){var E=this;t.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var I=t.extend({},x,{success:function(z){E.raiseEvent("add-layer",{options:x,drawer:z.item})},error:function(z){E.raiseEvent("add-layer-failed",z)}});return this.addTiledImage(I),this},getLayerAtLevel:function(x){return t.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(x)},getLevelOfLayer:function(x){return t.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(x)},getLayersCount:function(){return t.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(x,E){return t.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(x,E)},removeLayer:function(x){return t.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(x)},forceRedraw:function(){return c[this.hash].forceRedraw=!0,this},bindSequenceControls:function(){var x=t.delegate(this,u),E=t.delegate(this,d),I=t.delegate(this,this.goToNextPage),z=t.delegate(this,this.goToPreviousPage),B=this.navImages,q=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(q=!1),this.previousButton=new t.Button({element:this.previousButton?t.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.PreviousPage"),srcRest:U(this.prefixUrl,B.previous.REST),srcGroup:U(this.prefixUrl,B.previous.GROUP),srcHover:U(this.prefixUrl,B.previous.HOVER),srcDown:U(this.prefixUrl,B.previous.DOWN),onRelease:z,onFocus:x,onBlur:E}),this.nextButton=new t.Button({element:this.nextButton?t.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.NextPage"),srcRest:U(this.prefixUrl,B.next.REST),srcGroup:U(this.prefixUrl,B.next.GROUP),srcHover:U(this.prefixUrl,B.next.HOVER),srcDown:U(this.prefixUrl,B.next.DOWN),onRelease:I,onFocus:x,onBlur:E}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),q&&(this.paging=new t.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:t.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||t.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var x=t.delegate(this,N),E=t.delegate(this,G),I=t.delegate(this,H),z=t.delegate(this,j),B=t.delegate(this,F),q=t.delegate(this,V),ee=t.delegate(this,te),le=t.delegate(this,J),Z=t.delegate(this,ie),oe=t.delegate(this,Y),ae=t.delegate(this,u),ge=t.delegate(this,d),me=this.navImages,ye=[],_e=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(_e=!1),this.showZoomControl&&(ye.push(this.zoomInButton=new t.Button({element:this.zoomInButton?t.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.ZoomIn"),srcRest:U(this.prefixUrl,me.zoomIn.REST),srcGroup:U(this.prefixUrl,me.zoomIn.GROUP),srcHover:U(this.prefixUrl,me.zoomIn.HOVER),srcDown:U(this.prefixUrl,me.zoomIn.DOWN),onPress:x,onRelease:E,onClick:I,onEnter:x,onExit:E,onFocus:ae,onBlur:ge})),ye.push(this.zoomOutButton=new t.Button({element:this.zoomOutButton?t.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.ZoomOut"),srcRest:U(this.prefixUrl,me.zoomOut.REST),srcGroup:U(this.prefixUrl,me.zoomOut.GROUP),srcHover:U(this.prefixUrl,me.zoomOut.HOVER),srcDown:U(this.prefixUrl,me.zoomOut.DOWN),onPress:z,onRelease:E,onClick:B,onEnter:z,onExit:E,onFocus:ae,onBlur:ge}))),this.showHomeControl&&ye.push(this.homeButton=new t.Button({element:this.homeButton?t.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.Home"),srcRest:U(this.prefixUrl,me.home.REST),srcGroup:U(this.prefixUrl,me.home.GROUP),srcHover:U(this.prefixUrl,me.home.HOVER),srcDown:U(this.prefixUrl,me.home.DOWN),onRelease:q,onFocus:ae,onBlur:ge})),this.showFullPageControl&&ye.push(this.fullPageButton=new t.Button({element:this.fullPageButton?t.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.FullPage"),srcRest:U(this.prefixUrl,me.fullpage.REST),srcGroup:U(this.prefixUrl,me.fullpage.GROUP),srcHover:U(this.prefixUrl,me.fullpage.HOVER),srcDown:U(this.prefixUrl,me.fullpage.DOWN),onRelease:ee,onFocus:ae,onBlur:ge})),this.showRotationControl&&(ye.push(this.rotateLeftButton=new t.Button({element:this.rotateLeftButton?t.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.RotateLeft"),srcRest:U(this.prefixUrl,me.rotateleft.REST),srcGroup:U(this.prefixUrl,me.rotateleft.GROUP),srcHover:U(this.prefixUrl,me.rotateleft.HOVER),srcDown:U(this.prefixUrl,me.rotateleft.DOWN),onRelease:le,onFocus:ae,onBlur:ge})),ye.push(this.rotateRightButton=new t.Button({element:this.rotateRightButton?t.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.RotateRight"),srcRest:U(this.prefixUrl,me.rotateright.REST),srcGroup:U(this.prefixUrl,me.rotateright.GROUP),srcHover:U(this.prefixUrl,me.rotateright.HOVER),srcDown:U(this.prefixUrl,me.rotateright.DOWN),onRelease:Z,onFocus:ae,onBlur:ge}))),this.showFlipControl&&ye.push(this.flipButton=new t.Button({element:this.flipButton?t.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:t.getString("Tooltips.Flip"),srcRest:U(this.prefixUrl,me.flip.REST),srcGroup:U(this.prefixUrl,me.flip.GROUP),srcHover:U(this.prefixUrl,me.flip.HOVER),srcDown:U(this.prefixUrl,me.flip.DOWN),onRelease:oe,onFocus:ae,onBlur:ge})),_e?(this.buttonGroup=new t.ButtonGroup({buttons:ye,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",t.delegate(this,K)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||t.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||t.ControlAnchor.TOP_LEFT})):this.customButtons=ye),this},currentPage:function(){return this._sequenceIndex},goToPage:function(x){return this.tileSources&&x>=0&&x<this.tileSources.length&&(this._sequenceIndex=x,this._updateSequenceButtons(x),this.open(this.tileSources[x]),this.referenceStrip&&this.referenceStrip.setFocus(x),this.raiseEvent("page",{page:x})),this},addOverlay:function(x,E,I,z){var B;if(t.isPlainObject(x)?B=x:B={element:x,location:E,placement:I,onDraw:z},x=t.getElement(B.element),i(this.currentOverlays,x)>=0)return this;var q=a(this,B);return this.currentOverlays.push(q),q.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:x,location:B.location,placement:B.placement}),this},updateOverlay:function(x,E,I){var z;return x=t.getElement(x),z=i(this.currentOverlays,x),z>=0&&(this.currentOverlays[z].update(E,I),c[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:x,location:E,placement:I})),this},removeOverlay:function(x){var E;return x=t.getElement(x),E=i(this.currentOverlays,x),E>=0&&(this.currentOverlays[E].destroy(),this.currentOverlays.splice(E,1),c[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:x})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return c[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(x){var E;return x=t.getElement(x),E=i(this.currentOverlays,x),E>=0?this.currentOverlays[E]:null},_updateSequenceButtons:function(x){this.nextButton&&(!this.tileSources||this.tileSources.length-1===x?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(x>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(x){this._hideMessage();var E=t.makeNeutralElement("div");E.appendChild(document.createTextNode(x)),this.messageDiv=t.makeCenteredNode(E),t.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var x=this.messageDiv;x&&(x.parentNode.removeChild(x),delete this.messageDiv)},gestureSettingsByDeviceType:function(x){switch(x){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var x,E=this.currentOverlays.length;for(x=0;x<E;x++)this.currentOverlays[x].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new t.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,useCanvas:this.useCanvas,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else t.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),t.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){t.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var x=t.pixelDensityRatio,E=t.getCurrentPixelDensityRatio();x!==E&&(t.pixelDensityRatio=E,this.world.resetItems(),this.forceRedraw())},goToPreviousPage:function(){var x=this._sequenceIndex-1;this.navPrevNextWrap&&x<0&&(x+=this.tileSources.length),this.goToPage(x)},goToNextPage:function(){var x=this._sequenceIndex+1;this.navPrevNextWrap&&x>=this.tileSources.length&&(x=0),this.goToPage(x)},isAnimating:function(){return c[this.hash].animating}});function m(x){return x=t.getElement(x),new t.Point(x.clientWidth===0?1:x.clientWidth,x.clientHeight===0?1:x.clientHeight)}function y(x,E,I,z,B){var q=x;if(t.type(E)==="string"){if(E.match(/^\s*<.*>\s*$/))E=t.parseXml(E);else if(E.match(/^\s*[{[].*[}\]]\s*$/))try{var ee=t.parseJSON(E);E=ee}catch{}}function le(Z,oe){Z.ready?z(Z):(Z.addHandler("ready",function(){z(Z)}),Z.addHandler("open-failed",function(ae){B({message:ae.message,source:oe})}))}setTimeout(function(){if(t.type(E)==="string")E=new t.TileSource({url:E,crossOriginPolicy:I.crossOriginPolicy!==void 0?I.crossOriginPolicy:x.crossOriginPolicy,ajaxWithCredentials:x.ajaxWithCredentials,ajaxHeaders:I.ajaxHeaders?I.ajaxHeaders:x.ajaxHeaders,splitHashDataForPost:x.splitHashDataForPost,useCanvas:x.useCanvas,success:function(ge){z(ge.tileSource)}}),E.addHandler("open-failed",function(ge){B(ge)});else if(t.isPlainObject(E)||E.nodeType)if(E.crossOriginPolicy===void 0&&(I.crossOriginPolicy!==void 0||x.crossOriginPolicy!==void 0)&&(E.crossOriginPolicy=I.crossOriginPolicy!==void 0?I.crossOriginPolicy:x.crossOriginPolicy),E.ajaxWithCredentials===void 0&&(E.ajaxWithCredentials=x.ajaxWithCredentials),E.useCanvas===void 0&&(E.useCanvas=x.useCanvas),t.isFunction(E.getTileUrl)){var Z=new t.TileSource(E);Z.getTileUrl=E.getTileUrl,z(Z)}else{var oe=t.TileSource.determineType(q,E);if(!oe){B({message:"Unable to load TileSource",source:E});return}var ae=oe.prototype.configure.apply(q,[E]);le(new oe(ae),E)}else le(E,E)})}function a(x,E){if(E instanceof t.Overlay)return E;var I=null;if(E.element)I=t.getElement(E.element);else{var z=E.id?E.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);I=t.getElement(E.id),I||(I=document.createElement("a"),I.href="#/overlay/"+z),I.id=z,t.addClass(I,E.className?E.className:"openseadragon-overlay")}var B=E.location,q=E.width,ee=E.height;if(!B){var le=E.x,Z=E.y;if(E.px!==void 0){var oe=x.viewport.imageToViewportRectangle(new t.Rect(E.px,E.py,q||0,ee||0));le=oe.x,Z=oe.y,q=q!==void 0?oe.width:void 0,ee=ee!==void 0?oe.height:void 0}B=new t.Point(le,Z)}var ae=E.placement;return ae&&t.type(ae)==="string"&&(ae=t.Placement[E.placement.toUpperCase()]),new t.Overlay({element:I,location:B,placement:ae,onDraw:E.onDraw,checkResize:E.checkResize,width:q,height:ee,rotationMode:E.rotationMode})}function i(x,E){var I;for(I=x.length-1;I>=0;I--)if(x[I].element===E)return I;return-1}function r(x,E){return t.requestAnimationFrame(function(){E(x)})}function o(x){t.requestAnimationFrame(function(){s(x)})}function n(x){!x.autoHideControls||(x.controlsShouldFade=!0,x.controlsFadeBeginTime=t.now()+x.controlsFadeDelay,window.setTimeout(function(){o(x)},x.controlsFadeDelay))}function s(x){var E,I,z,B;if(x.controlsShouldFade){for(E=t.now(),I=E-x.controlsFadeBeginTime,z=1-I/x.controlsFadeLength,z=Math.min(1,z),z=Math.max(0,z),B=x.controls.length-1;B>=0;B--)x.controls[B].autoFade&&x.controls[B].setOpacity(z);z>0&&o(x)}}function l(x){var E;for(x.controlsShouldFade=!1,E=x.controls.length-1;E>=0;E--)x.controls[E].setOpacity(1)}function u(){l(this)}function d(){n(this)}function f(x){var E={tracker:x.eventSource,position:x.position,originalEvent:x.originalEvent,preventDefault:x.preventDefault};this.raiseEvent("canvas-contextmenu",E),x.preventDefault=E.preventDefault}function p(x){var E={originalEvent:x.originalEvent,preventDefaultAction:!1,preventVerticalPan:x.preventVerticalPan||!this.panVertical,preventHorizontalPan:x.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",E),!E.preventDefaultAction&&!x.ctrl&&!x.alt&&!x.meta)switch(x.keyCode){case 38:E.preventVerticalPan||(x.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new t.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),x.preventDefault=!0;break;case 40:E.preventVerticalPan||(x.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new t.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),x.preventDefault=!0;break;case 37:E.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new t.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),x.preventDefault=!0;break;case 39:E.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new t.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),x.preventDefault=!0;break;default:x.preventDefault=!1;break}else x.preventDefault=!1}function v(x){var E={originalEvent:x.originalEvent,preventDefaultAction:!1,preventVerticalPan:x.preventVerticalPan||!this.panVertical,preventHorizontalPan:x.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",E),!E.preventDefaultAction&&!x.ctrl&&!x.alt&&!x.meta)switch(x.keyCode){case 43:case 61:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),x.preventDefault=!0;break;case 45:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),x.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),x.preventDefault=!0;break;case 119:case 87:E.preventVerticalPan||(x.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new t.Point(0,-40))),this.viewport.applyConstraints()),x.preventDefault=!0;break;case 115:case 83:E.preventVerticalPan||(x.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new t.Point(0,40))),this.viewport.applyConstraints()),x.preventDefault=!0;break;case 97:E.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new t.Point(-40,0))),this.viewport.applyConstraints()),x.preventDefault=!0;break;case 100:E.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new t.Point(40,0))),this.viewport.applyConstraints()),x.preventDefault=!0;break;case 114:this.viewport.flipped?this.viewport.setRotation(t.positiveModulo(this.viewport.degrees-this.rotationIncrement,360)):this.viewport.setRotation(t.positiveModulo(this.viewport.degrees+this.rotationIncrement,360)),this.viewport.applyConstraints(),x.preventDefault=!0;break;case 82:this.viewport.flipped?this.viewport.setRotation(t.positiveModulo(this.viewport.degrees+this.rotationIncrement,360)):this.viewport.setRotation(t.positiveModulo(this.viewport.degrees-this.rotationIncrement,360)),this.viewport.applyConstraints(),x.preventDefault=!0;break;case 102:this.viewport.toggleFlip(),x.preventDefault=!0;break;case 106:this.goToPreviousPage();break;case 107:this.goToNextPage();break;default:x.preventDefault=!1;break}else x.preventDefault=!1}function w(x){var E,I=document.activeElement===this.canvas;I||this.canvas.focus(),this.viewport.flipped&&(x.position.x=this.viewport.getContainerSize().x-x.position.x);var z={tracker:x.eventSource,position:x.position,quick:x.quick,shift:x.shift,originalEvent:x.originalEvent,originalTarget:x.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",z),!z.preventDefaultAction&&this.viewport&&x.quick&&(E=this.gestureSettingsByDeviceType(x.pointerType),E.clickToZoom&&(this.viewport.zoomBy(x.shift?1/this.zoomPerClick:this.zoomPerClick,E.zoomToRefPoint?this.viewport.pointFromPixel(x.position,!0):null),this.viewport.applyConstraints()))}function C(x){var E,I={tracker:x.eventSource,position:x.position,shift:x.shift,originalEvent:x.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",I),!I.preventDefaultAction&&this.viewport&&(E=this.gestureSettingsByDeviceType(x.pointerType),E.dblClickToZoom&&(this.viewport.zoomBy(x.shift?1/this.zoomPerClick:this.zoomPerClick,E.zoomToRefPoint?this.viewport.pointFromPixel(x.position,!0):null),this.viewport.applyConstraints()))}function b(x){var E,I={tracker:x.eventSource,pointerType:x.pointerType,position:x.position,delta:x.delta,speed:x.speed,direction:x.direction,shift:x.shift,originalEvent:x.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",I),E=this.gestureSettingsByDeviceType(x.pointerType),E.dragToPan&&!I.preventDefaultAction&&this.viewport){if(this.panHorizontal||(x.delta.x=0),this.panVertical||(x.delta.y=0),this.viewport.flipped&&(x.delta.x=-x.delta.x),this.constrainDuringPan){var z=this.viewport.deltaPointsFromPixels(x.delta.negate());this.viewport.centerSpringX.target.value+=z.x,this.viewport.centerSpringY.target.value+=z.y;var B=this.viewport.getBounds(),q=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=z.x,this.viewport.centerSpringY.target.value-=z.y,B.x!==q.x&&(x.delta.x=0),B.y!==q.y&&(x.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(x.delta.negate()),E.flickEnabled&&!this.constrainDuringPan)}}function P(x){var E={tracker:x.eventSource,pointerType:x.pointerType,position:x.position,speed:x.speed,direction:x.direction,shift:x.shift,originalEvent:x.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",E),!E.preventDefaultAction&&this.viewport){var I=this.gestureSettingsByDeviceType(x.pointerType);if(I.flickEnabled&&x.speed>=I.flickMinSpeed){var z=0;this.panHorizontal&&(z=I.flickMomentum*x.speed*Math.cos(x.direction));var B=0;this.panVertical&&(B=I.flickMomentum*x.speed*Math.sin(x.direction));var q=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),ee=this.viewport.pointFromPixel(new t.Point(q.x-z,q.y-B));this.viewport.panTo(ee,!1)}this.viewport.applyConstraints()}}function R(x){this.raiseEvent("canvas-enter",{tracker:x.eventSource,pointerType:x.pointerType,position:x.position,buttons:x.buttons,pointers:x.pointers,insideElementPressed:x.insideElementPressed,buttonDownAny:x.buttonDownAny,originalEvent:x.originalEvent})}function A(x){this.raiseEvent("canvas-exit",{tracker:x.eventSource,pointerType:x.pointerType,position:x.position,buttons:x.buttons,pointers:x.pointers,insideElementPressed:x.insideElementPressed,buttonDownAny:x.buttonDownAny,originalEvent:x.originalEvent})}function W(x){this.raiseEvent("canvas-press",{tracker:x.eventSource,pointerType:x.pointerType,position:x.position,insideElementPressed:x.insideElementPressed,insideElementReleased:x.insideElementReleased,originalEvent:x.originalEvent})}function $(x){this.raiseEvent("canvas-release",{tracker:x.eventSource,pointerType:x.pointerType,position:x.position,insideElementPressed:x.insideElementPressed,insideElementReleased:x.insideElementReleased,originalEvent:x.originalEvent})}function X(x){this.raiseEvent("canvas-nonprimary-press",{tracker:x.eventSource,position:x.position,pointerType:x.pointerType,button:x.button,buttons:x.buttons,originalEvent:x.originalEvent})}function re(x){this.raiseEvent("canvas-nonprimary-release",{tracker:x.eventSource,position:x.position,pointerType:x.pointerType,button:x.button,buttons:x.buttons,originalEvent:x.originalEvent})}function he(x){var E,I,z,B,q={tracker:x.eventSource,pointerType:x.pointerType,gesturePoints:x.gesturePoints,lastCenter:x.lastCenter,center:x.center,lastDistance:x.lastDistance,distance:x.distance,shift:x.shift,originalEvent:x.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",q),this.viewport&&(E=this.gestureSettingsByDeviceType(x.pointerType),E.pinchToZoom&&(!q.preventDefaultPanAction||!q.preventDefaultZoomAction)&&(I=this.viewport.pointFromPixel(x.center,!0),E.zoomToRefPoint&&!q.preventDefaultPanAction&&(z=this.viewport.pointFromPixel(x.lastCenter,!0),B=z.minus(I),this.panHorizontal||(B.x=0),this.panVertical||(B.y=0),this.viewport.panBy(B,!0)),q.preventDefaultZoomAction||this.viewport.zoomBy(x.distance/x.lastDistance,I,!0),this.viewport.applyConstraints()),E.pinchRotate&&!q.preventDefaultRotateAction)){var ee=Math.atan2(x.gesturePoints[0].currentPos.y-x.gesturePoints[1].currentPos.y,x.gesturePoints[0].currentPos.x-x.gesturePoints[1].currentPos.x),le=Math.atan2(x.gesturePoints[0].lastPos.y-x.gesturePoints[1].lastPos.y,x.gesturePoints[0].lastPos.x-x.gesturePoints[1].lastPos.x);this.viewport.setRotation(this.viewport.getRotation()+(ee-le)*(180/Math.PI))}}function ne(x){var E,I,z,B,q;B=t.now(),q=B-this._lastScrollTime,q>this.minScrollDeltaTime?(this._lastScrollTime=B,E={tracker:x.eventSource,position:x.position,scroll:x.scroll,shift:x.shift,originalEvent:x.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",E),!E.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(x.position.x=this.viewport.getContainerSize().x-x.position.x),I=this.gestureSettingsByDeviceType(x.pointerType),I.scrollToZoom&&(z=Math.pow(this.zoomPerScroll,x.scroll),this.viewport.zoomBy(z,I.zoomToRefPoint?this.viewport.pointFromPixel(x.position,!0):null),this.viewport.applyConstraints())),x.preventDefault=E.preventDefault):x.preventDefault=!0}function ce(x){c[this.hash].mouseInside=!0,l(this),this.raiseEvent("container-enter",{tracker:x.eventSource,pointerType:x.pointerType,position:x.position,buttons:x.buttons,pointers:x.pointers,insideElementPressed:x.insideElementPressed,buttonDownAny:x.buttonDownAny,originalEvent:x.originalEvent})}function ue(x){x.pointers<1&&(c[this.hash].mouseInside=!1,c[this.hash].animating||n(this)),this.raiseEvent("container-exit",{tracker:x.eventSource,pointerType:x.pointerType,position:x.position,buttons:x.buttons,pointers:x.pointers,insideElementPressed:x.insideElementPressed,buttonDownAny:x.buttonDownAny,originalEvent:x.originalEvent})}function de(x){fe(x),x.isOpen()?x._updateRequestId=r(x,de):x._updateRequestId=!1}function fe(x){if(!(x._opening||!c[x.hash])){if(x.autoResize){var E=m(x.container),I=c[x.hash].prevContainerSize;if(!E.equals(I)){var z=x.viewport;if(x.preserveImageSizeOnResize){var B=I.x/E.x,q=z.getZoom()*B,ee=z.getCenter();z.resize(E,!1),z.zoomTo(q,null,!0),z.panTo(ee,!0)}else{var le=z.getBounds();z.resize(E,!0),z.fitBoundsWithConstraints(le,!0)}c[x.hash].prevContainerSize=E,c[x.hash].forceRedraw=!0}}var Z=x.viewport.update(),oe=x.world.update()||Z;Z&&x.raiseEvent("viewport-change"),x.referenceStrip&&(oe=x.referenceStrip.update(x.viewport)||oe);var ae=c[x.hash].animating;!ae&&oe&&(x.raiseEvent("animation-start"),l(x));var ge=ae&&!oe;ge&&(c[x.hash].animating=!1),(oe||ge||c[x.hash].forceRedraw||x.world.needsDraw())&&(L(x),x._drawOverlays(),x.navigator&&x.navigator.update(x.viewport),c[x.hash].forceRedraw=!1,oe&&x.raiseEvent("animation")),ge&&(x.raiseEvent("animation-finish"),c[x.hash].mouseInside||n(x)),c[x.hash].animating=oe}}function L(x){x.imageLoader.clear(),x.drawer.clear(),x.world.draw(),x.raiseEvent("update-viewport",{})}function U(x,E){return x?x+E:E}function N(){c[this.hash].lastZoomTime=t.now(),c[this.hash].zoomFactor=this.zoomPerSecond,c[this.hash].zooming=!0,D(this)}function j(){c[this.hash].lastZoomTime=t.now(),c[this.hash].zoomFactor=1/this.zoomPerSecond,c[this.hash].zooming=!0,D(this)}function G(){c[this.hash].zooming=!1}function D(x){t.requestAnimationFrame(t.delegate(x,k))}function k(){var x,E,I;c[this.hash].zooming&&this.viewport&&(x=t.now(),E=x-c[this.hash].lastZoomTime,I=Math.pow(c[this.hash].zoomFactor,E/1e3),this.viewport.zoomBy(I),this.viewport.applyConstraints(),c[this.hash].lastZoomTime=x,D(this))}function H(){this.viewport&&(c[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function F(){this.viewport&&(c[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function K(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function V(){this.viewport&&this.viewport.goHome()}function te(){this.isFullPage()&&!t.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function J(){if(this.viewport){var x=this.viewport.getRotation();this.viewport.flipped?x=t.positiveModulo(x+this.rotationIncrement,360):x=t.positiveModulo(x-this.rotationIncrement,360),this.viewport.setRotation(x)}}function ie(){if(this.viewport){var x=this.viewport.getRotation();this.viewport.flipped?x=t.positiveModulo(x-this.rotationIncrement,360):x=t.positiveModulo(x+this.rotationIncrement,360),this.viewport.setRotation(x)}}function Y(){this.viewport.toggleFlip()}}(h),function(t){t.Navigator=function(r){var o=r.viewer,n=this,s,l;r.id?(this.element=document.getElementById(r.id),r.controlOptions={anchor:t.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(r.id="navigator-"+t.now(),this.element=t.makeNeutralElement("div"),r.controlOptions={anchor:t.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:r.autoFade},r.position&&(r.position==="BOTTOM_RIGHT"?r.controlOptions.anchor=t.ControlAnchor.BOTTOM_RIGHT:r.position==="BOTTOM_LEFT"?r.controlOptions.anchor=t.ControlAnchor.BOTTOM_LEFT:r.position==="TOP_RIGHT"?r.controlOptions.anchor=t.ControlAnchor.TOP_RIGHT:r.position==="TOP_LEFT"?r.controlOptions.anchor=t.ControlAnchor.TOP_LEFT:r.position==="ABSOLUTE"&&(r.controlOptions.anchor=t.ControlAnchor.ABSOLUTE,r.controlOptions.top=r.top,r.controlOptions.left=r.left,r.controlOptions.height=r.height,r.controlOptions.width=r.width))),this.element.id=r.id,this.element.className+=" navigator",r=t.extend(!0,{sizeRatio:t.DEFAULT_SETTINGS.navigatorSizeRatio},r,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,autoResize:r.autoResize,minZoomImageRatio:1,background:r.background,opacity:r.opacity,borderColor:r.borderColor,displayRegionColor:r.displayRegionColor}),r.minPixelRatio=this.minPixelRatio=o.minPixelRatio,t.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new t.Point(1,1),this.totalBorderWidths=new t.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),r.controlOptions.anchor!==t.ControlAnchor.NONE&&function(f,p){f.margin="0px",f.border=p+"px solid "+r.borderColor,f.padding="0px",f.background=r.background,f.opacity=r.opacity,f.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=t.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(f,p){f.position="relative",f.top="0px",f.left="0px",f.fontSize="0px",f.overflow="hidden",f.border=p+"px solid "+r.displayRegionColor,f.margin="0px",f.padding="0px",f.background="transparent",f.float="left",f.cssFloat="left",f.styleFloat="left",f.zIndex=999999999,f.cursor="default"}(this.displayRegion.style,this.borderWidth),t.setElementPointerEventsNone(this.displayRegion),t.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=t.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",t.setElementPointerEventsNone(this.displayRegionContainer),t.setElementTouchActionNone(this.displayRegionContainer),o.addControl(this.element,r.controlOptions),this._resizeWithViewer=r.controlOptions.anchor!==t.ControlAnchor.ABSOLUTE&&r.controlOptions.anchor!==t.ControlAnchor.NONE,r.width&&r.height?(this.setWidth(r.width),this.setHeight(r.height)):this._resizeWithViewer&&(s=t.getElementSize(o.element),this.element.style.height=Math.round(s.y*r.sizeRatio)+"px",this.element.style.width=Math.round(s.x*r.sizeRatio)+"px",this.oldViewerSize=s,l=t.getElementSize(this.element),this.elementArea=l.x*l.y),this.oldContainerSize=new t.Point(0,0),t.Viewer.apply(this,[r]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function u(f){a(n.displayRegionContainer,f),a(n.displayRegion,-f),n.viewport.setRotation(f)}if(r.navigatorRotate){var d=r.viewer.viewport?r.viewer.viewport.getRotation():r.viewer.degrees||0;u(d),r.viewer.addHandler("rotate",function(f){u(f.degrees)})}this.innerTracker.destroy(),this.innerTracker=new t.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:t.delegate(this,g),clickHandler:t.delegate(this,c),releaseHandler:t.delegate(this,m),scrollHandler:t.delegate(this,y),preProcessEventHandler:function(f){f.eventType==="wheel"&&(f.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",t.setElementPointerEventsNone(this.canvas),t.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){n.viewport&&n.viewport.goHome(!0)}),o.world.addHandler("item-index-change",function(f){window.setTimeout(function(){var p=n.world.getItemAt(f.previousIndex);n.world.setItemIndex(p,f.newIndex)},1)}),o.world.addHandler("remove-item",function(f){var p=f.item,v=n._getMatchingItem(p);v&&n.world.removeItem(v)}),this.update(o.viewport)},t.extend(t.Navigator.prototype,t.EventSource.prototype,t.Viewer.prototype,{updateSize:function(){if(this.viewport){var r=new t.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);r.equals(this.oldContainerSize)||(this.viewport.resize(r,!0),this.viewport.goHome(!0),this.oldContainerSize=r,this.drawer.clear(),this.world.draw())}},setWidth:function(r){this.width=r,this.element.style.width=typeof r=="number"?r+"px":r,this._resizeWithViewer=!1},setHeight:function(r){this.height=r,this.element.style.height=typeof r=="number"?r+"px":r,this._resizeWithViewer=!1},setFlip:function(r){return this.viewport.setFlip(r),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(r){i(this.displayRegion,r),i(this.canvas,r),i(this.element,r)},update:function(r){var o,n,s,l,u,d;if(o=t.getElementSize(this.viewer.element),this._resizeWithViewer&&o.x&&o.y&&!o.equals(this.oldViewerSize)&&(this.oldViewerSize=o,this.maintainSizeRatio||!this.elementArea?(n=o.x*this.sizeRatio,s=o.y*this.sizeRatio):(n=Math.sqrt(this.elementArea*(o.x/o.y)),s=this.elementArea/n),this.element.style.width=Math.round(n)+"px",this.element.style.height=Math.round(s)+"px",this.elementArea||(this.elementArea=n*s),this.updateSize()),r&&this.viewport){l=r.getBoundsNoRotate(!0),u=this.viewport.pixelFromPointNoRotate(l.getTopLeft(),!1),d=this.viewport.pixelFromPointNoRotate(l.getBottomRight(),!1).minus(this.totalBorderWidths);var f=this.displayRegion.style;f.display=this.world.getItemCount()?"block":"none",f.top=Math.round(u.y)+"px",f.left=Math.round(u.x)+"px";var p=Math.abs(u.x-d.x),v=Math.abs(u.y-d.y);f.width=Math.round(Math.max(p,0))+"px",f.height=Math.round(Math.max(v,0))+"px"}},addTiledImage:function(r){var o=this,n=r.originalTiledImage;delete r.original;var s=t.extend({},r,{success:function(l){var u=l.item;u._originalForNavigator=n,o._matchBounds(u,n,!0),o._matchOpacity(u,n),o._matchCompositeOperation(u,n);function d(){o._matchBounds(u,n)}function f(){o._matchOpacity(u,n)}function p(){o._matchCompositeOperation(u,n)}n.addHandler("bounds-change",d),n.addHandler("clip-change",d),n.addHandler("opacity-change",f),n.addHandler("composite-operation-change",p)}});return t.Viewer.prototype.addTiledImage.apply(this,[s])},destroy:function(){return t.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(r){for(var o=this.world.getItemCount(),n,s=0;s<o;s++)if(n=this.world.getItemAt(s),n._originalForNavigator===r)return n;return null},_matchBounds:function(r,o,n){var s=o.getBoundsNoRotate();r.setPosition(s.getTopLeft(),n),r.setWidth(s.width,n),r.setRotation(o.getRotation(),n),r.setClip(o.getClip()),r.setFlip(o.getFlip())},_matchOpacity:function(r,o){r.setOpacity(o.opacity)},_matchCompositeOperation:function(r,o){r.setCompositeOperation(o.compositeOperation)}});function c(r){var o={tracker:r.eventSource,position:r.position,quick:r.quick,shift:r.shift,originalEvent:r.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",o),!o.preventDefaultAction&&r.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(r.position.x=this.viewport.getContainerSize().x-r.position.x);var n=this.viewport.pointFromPixel(r.position);this.panVertical?this.panHorizontal||(n.x=this.viewer.viewport.getCenter(!0).x):n.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(n),this.viewer.viewport.applyConstraints()}}function g(r){var o={tracker:r.eventSource,position:r.position,delta:r.delta,speed:r.speed,direction:r.direction,shift:r.shift,originalEvent:r.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",o),!o.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(r.delta.x=0),this.panVertical||(r.delta.y=0),this.viewer.viewport.flipped&&(r.delta.x=-r.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(r.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function m(r){r.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function y(r){var o={tracker:r.eventSource,position:r.position,scroll:r.scroll,shift:r.shift,originalEvent:r.originalEvent,preventDefault:r.preventDefault};this.viewer.raiseEvent("navigator-scroll",o),r.preventDefault=o.preventDefault}function a(r,o){i(r,"rotate("+o+"deg)")}function i(r,o){r.style.webkitTransform=o,r.style.mozTransform=o,r.style.msTransform=o,r.style.oTransform=o,r.style.transform=o}}(h),function(t){var c={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};t.extend(t,{getString:function(g){var m=g.split("."),y=null,a=arguments,i=c,r;for(r=0;r<m.length-1;r++)i=i[m[r]]||{};return y=i[m[r]],typeof y!="string"&&(t.console.error("Untranslated source string:",g),y=""),y.replace(/\{\d+\}/g,function(o){var n=parseInt(o.match(/\d+/),10)+1;return n<a.length?a[n]:""})},setString:function(g,m){var y=g.split("."),a=c,i;for(i=0;i<y.length-1;i++)a[y[i]]||(a[y[i]]={}),a=a[y[i]];a[y[i]]=m}})}(h),function(t){t.Point=function(c,g){this.x=typeof c=="number"?c:0,this.y=typeof g=="number"?g:0},t.Point.prototype={clone:function(){return new t.Point(this.x,this.y)},plus:function(c){return new t.Point(this.x+c.x,this.y+c.y)},minus:function(c){return new t.Point(this.x-c.x,this.y-c.y)},times:function(c){return new t.Point(this.x*c,this.y*c)},divide:function(c){return new t.Point(this.x/c,this.y/c)},negate:function(){return new t.Point(-this.x,-this.y)},distanceTo:function(c){return Math.sqrt(Math.pow(this.x-c.x,2)+Math.pow(this.y-c.y,2))},squaredDistanceTo:function(c){return Math.pow(this.x-c.x,2)+Math.pow(this.y-c.y,2)},apply:function(c){return new t.Point(c(this.x),c(this.y))},equals:function(c){return c instanceof t.Point&&this.x===c.x&&this.y===c.y},rotate:function(c,g){g=g||new t.Point(0,0);var m,y;if(c%90===0){var a=t.positiveModulo(c,360);switch(a){case 0:m=1,y=0;break;case 90:m=0,y=1;break;case 180:m=-1,y=0;break;case 270:m=0,y=-1;break}}else{var i=c*Math.PI/180;m=Math.cos(i),y=Math.sin(i)}var r=m*(this.x-g.x)-y*(this.y-g.y)+g.x,o=y*(this.x-g.x)+m*(this.y-g.y)+g.y;return new t.Point(r,o)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(h),function(t){t.TileSource=function(g,m,y,a,i,r){var o=this,n=arguments,s,l;if(t.isPlainObject(g)?s=g:s={width:n[0],height:n[1],tileSize:n[2],tileOverlap:n[3],minLevel:n[4],maxLevel:n[5]},t.EventSource.call(this),t.extend(!0,this,s),!this.success){for(l=0;l<arguments.length;l++)if(t.isFunction(arguments[l])){this.success=arguments[l];break}}this.success&&this.addHandler("ready",function(u){o.success(u)}),t.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new t.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=s.width&&s.height?s.width/s.height:1,this.dimensions=new t.Point(s.width,s.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=s.tileOverlap?s.tileOverlap:0,this.minLevel=s.minLevel?s.minLevel:0,this.maxLevel=s.maxLevel!==void 0&&s.maxLevel!==null?s.maxLevel:s.width&&s.height?Math.ceil(Math.log(Math.max(s.width,s.height))/Math.log(2)):0,this.success&&t.isFunction(this.success)&&this.success(this))},t.TileSource.prototype={getTileSize:function(g){return t.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(g){return this._tileWidth?this._tileWidth:this.getTileSize(g)},getTileHeight:function(g){return this._tileHeight?this._tileHeight:this.getTileSize(g)},setMaxLevel:function(g){this.maxLevel=g,this._memoizeLevelScale()},getLevelScale:function(g){return this._memoizeLevelScale(),this.getLevelScale(g)},_memoizeLevelScale:function(){var g={},m;for(m=0;m<=this.maxLevel;m++)g[m]=1/Math.pow(2,this.maxLevel-m);this.getLevelScale=function(y){return g[y]}},getNumTiles:function(g){var m=this.getLevelScale(g),y=Math.ceil(m*this.dimensions.x/this.getTileWidth(g)),a=Math.ceil(m*this.dimensions.y/this.getTileHeight(g));return new t.Point(y,a)},getPixelRatio:function(g){var m=this.dimensions.times(this.getLevelScale(g)),y=1/m.x*t.pixelDensityRatio,a=1/m.y*t.pixelDensityRatio;return new t.Point(y,a)},getClosestLevel:function(){var g,m;for(g=this.minLevel+1;g<=this.maxLevel&&(m=this.getNumTiles(g),!(m.x>1||m.y>1));g++);return g-1},getTileAtPoint:function(g,m){var y=m.x>=0&&m.x<=1&&m.y>=0&&m.y<=1/this.aspectRatio;t.console.assert(y,"[TileSource.getTileAtPoint] must be called with a valid point.");var a=this.dimensions.x*this.getLevelScale(g),i=m.x*a,r=m.y*a,o=Math.floor(i/this.getTileWidth(g)),n=Math.floor(r/this.getTileHeight(g));m.x>=1&&(o=this.getNumTiles(g).x-1);var s=1e-15;return m.y>=1/this.aspectRatio-s&&(n=this.getNumTiles(g).y-1),new t.Point(o,n)},getTileBounds:function(g,m,y,a){var i=this.dimensions.times(this.getLevelScale(g)),r=this.getTileWidth(g),o=this.getTileHeight(g),n=m===0?0:r*m-this.tileOverlap,s=y===0?0:o*y-this.tileOverlap,l=r+(m===0?1:2)*this.tileOverlap,u=o+(y===0?1:2)*this.tileOverlap,d=1/i.x;return l=Math.min(l,i.x-n),u=Math.min(u,i.y-s),a?new t.Rect(0,0,l,u):new t.Rect(n*d,s*d,l*d,u*d)},getImageInfo:function(g){var m=this,y,a,i,r,o,n,s;g&&(o=g.split("/"),n=o[o.length-1],s=n.lastIndexOf("."),s>-1&&(o[o.length-1]=n.slice(0,s)));var l=null;if(this.splitHashDataForPost){var u=g.indexOf("#");u!==-1&&(l=g.substring(u+1),g=g.substr(0,u))}a=function(d){typeof d=="string"&&(d=t.parseXml(d));var f=t.TileSource.determineType(m,d,g);if(!f){m.raiseEvent("open-failed",{message:"Unable to load TileSource",source:g});return}r=f.prototype.configure.apply(m,[d,g,l]),r.ajaxWithCredentials===void 0&&(r.ajaxWithCredentials=m.ajaxWithCredentials),i=new f(r),m.ready=!0,m.raiseEvent("ready",{tileSource:i})},g.match(/\.js$/)?(y=g.split("/").pop().replace(".js",""),t.jsonp({url:g,async:!1,callbackName:y,callback:a})):t.makeAjaxRequest({url:g,postData:l,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(d){var f=c(d);a(f)},error:function(d,f){var p;try{p="HTTP "+d.status+" attempting to load TileSource: "+g}catch{var v;typeof f=="undefined"||!f.toString?v="Unknown error":v=f.toString(),p=v+" attempting to load TileSource: "+g}t.console.error(p),m.raiseEvent("open-failed",{message:p,source:g,postData:l})}})},supports:function(g,m){return!1},configure:function(g,m,y){throw new Error("Method not implemented.")},getTileUrl:function(g,m,y){throw new Error("Method not implemented.")},getTilePostData:function(g,m,y){return null},getTileAjaxHeaders:function(g,m,y){return{}},getTileHashKey:function(g,m,y,a,i,r){return i?a+"+"+JSON.stringify(i):a},tileExists:function(g,m,y){var a=this.getNumTiles(g);return g>=this.minLevel&&g<=this.maxLevel&&m>=0&&y>=0&&m<a.x&&y<a.y}},t.extend(!0,t.TileSource.prototype,t.EventSource.prototype);function c(g){var m=g.responseText,y=g.status,a,i;if(g){if(g.status!==200&&g.status!==0)throw y=g.status,a=y===404?"Not Found":g.statusText,new Error(t.getString("Errors.Status",y,a))}else throw new Error(t.getString("Errors.Security"));if(m.match(/\s*<.*/))try{i=g.responseXML&&g.responseXML.documentElement?g.responseXML:t.parseXml(m)}catch{i=g.responseText}else if(m.match(/\s*[{[].*/))try{i=t.parseJSON(m)}catch{i=m}else i=m;return i}t.TileSource.determineType=function(g,m,y){var a;for(a in h)if(a.match(/.+TileSource$/)&&t.isFunction(h[a])&&t.isFunction(h[a].prototype.supports)&&h[a].prototype.supports.call(g,m,y))return h[a];return t.console.error("No TileSource was able to open %s %s",y,m),null}}(h),function(t){t.DziTileSource=function(m,y,a,i,r,o,n,s,l){var u,d,f,p;if(t.isPlainObject(m)?p=m:p={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=p.tilesUrl,this.fileFormat=p.fileFormat,this.displayRects=p.displayRects,this.displayRects)for(u=this.displayRects.length-1;u>=0;u--)for(d=this.displayRects[u],f=d.minLevel;f<=d.maxLevel;f++)this._levelRects[f]||(this._levelRects[f]=[]),this._levelRects[f].push(d);t.TileSource.apply(this,[p])},t.extend(t.DziTileSource.prototype,t.TileSource.prototype,{supports:function(m,y){var a;return m.Image?a=m.Image.xmlns:m.documentElement&&(m.documentElement.localName==="Image"||m.documentElement.tagName==="Image")&&(a=m.documentElement.namespaceURI),a=(a||"").toLowerCase(),a.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||a.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(m,y,a){var i;return t.isPlainObject(m)?i=g(this,m):i=c(this,m),y&&!i.tilesUrl&&(i.tilesUrl=y.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),y.search(/\.(dzi|xml|js)\?/)!==-1?i.queryParams=y.match(/\?.*/):i.queryParams=""),i},getTileUrl:function(m,y,a){return[this.tilesUrl,m,"/",y,"_",a,".",this.fileFormat,this.queryParams].join("")},tileExists:function(m,y,a){var i=this._levelRects[m],r,o,n,s,l,u,d;if(this.minLevel&&m<this.minLevel||this.maxLevel&&m>this.maxLevel)return!1;if(!i||!i.length)return!0;for(d=i.length-1;d>=0;d--)if(r=i[d],!(m<r.minLevel||m>r.maxLevel)&&(o=this.getLevelScale(m),n=r.x*o,s=r.y*o,l=n+r.width*o,u=s+r.height*o,n=Math.floor(n/this._tileWidth),s=Math.floor(s/this._tileWidth),l=Math.ceil(l/this._tileWidth),u=Math.ceil(u/this._tileWidth),n<=y&&y<l&&s<=a&&a<u))return!0;return!1}});function c(m,y){if(!y||!y.documentElement)throw new Error(t.getString("Errors.Xml"));var a=y.documentElement,i=a.localName||a.tagName,r=y.documentElement.namespaceURI,o=null,n=[],s,l,u,d,f;if(i==="Image")try{if(d=a.getElementsByTagName("Size")[0],d===void 0&&(d=a.getElementsByTagNameNS(r,"Size")[0]),o={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(d.getAttribute("Height"),10),Width:parseInt(d.getAttribute("Width"),10)}}},!t.imageFormatSupported(o.Image.Format))throw new Error(t.getString("Errors.ImageFormat",o.Image.Format.toUpperCase()));for(s=a.getElementsByTagName("DisplayRect"),s===void 0&&(s=a.getElementsByTagNameNS(r,"DisplayRect")[0]),f=0;f<s.length;f++)l=s[f],u=l.getElementsByTagName("Rect")[0],u===void 0&&(u=l.getElementsByTagNameNS(r,"Rect")[0]),n.push({Rect:{X:parseInt(u.getAttribute("X"),10),Y:parseInt(u.getAttribute("Y"),10),Width:parseInt(u.getAttribute("Width"),10),Height:parseInt(u.getAttribute("Height"),10),MinLevel:parseInt(l.getAttribute("MinLevel"),10),MaxLevel:parseInt(l.getAttribute("MaxLevel"),10)}});return n.length&&(o.Image.DisplayRect=n),g(m,o)}catch(w){throw w instanceof Error?w:new Error(t.getString("Errors.Dzi"))}else{if(i==="Collection")throw new Error(t.getString("Errors.Dzc"));if(i==="Error"){var p=a.getElementsByTagName("Message")[0],v=p.firstChild.nodeValue;throw new Error(v)}}throw new Error(t.getString("Errors.Dzi"))}function g(m,y){var a=y.Image,i=a.Url,r=a.Format,o=a.Size,n=a.DisplayRect||[],s=parseInt(o.Width,10),l=parseInt(o.Height,10),u=parseInt(a.TileSize,10),d=parseInt(a.Overlap,10),f=[],p,v;for(v=0;v<n.length;v++)p=n[v].Rect,f.push(new t.DisplayRect(parseInt(p.X,10),parseInt(p.Y,10),parseInt(p.Width,10),parseInt(p.Height,10),parseInt(p.MinLevel,10),parseInt(p.MaxLevel,10)));return t.extend(!0,{width:s,height:l,tileSize:u,tileOverlap:d,minLevel:null,maxLevel:null,tilesUrl:i,fileFormat:r,displayRects:f},y)}}(h),function(t){t.IIIFTileSource=function(a){if(t.extend(!0,this,a),!(this.height&&this.width&&this["@id"]))throw new Error("IIIF required parameters not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var i=0;i<this.tiles.length;i++)for(var r=0;r<this.tiles[i].scaleFactors.length;r++){var o=this.tiles[i].scaleFactors[r];this.scale_factors.push(o),a.tileSizePerScaleFactor[o]={width:this.tiles[i].width,height:this.tiles[i].height||this.tiles[i].width}}}else if(c(a)){for(var n=Math.min(this.height,this.width),s=[256,512,1024],l=[],u=0;u<s.length;u++)s[u]<=n&&l.push(s[u]);l.length>0?a.tileSize=Math.max.apply(null,l):a.tileSize=n}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,a.levels=g(this),t.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):t.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)a.maxLevel=Number(Math.ceil(Math.log(Math.max(this.width,this.height),2)));else{var d=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(d)*Math.LOG2E)}t.TileSource.apply(this,[a])},t.extend(t.IIIFTileSource.prototype,t.TileSource.prototype,{supports:function(a,i){return a.protocol&&a.protocol==="http://iiif.io/api/image"||a["@context"]&&(a["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||a["@context"]==="http://iiif.io/api/image/1/context.json")||a.profile&&a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||a.identifier&&a.width&&a.height?!0:!!(a.documentElement&&a.documentElement.tagName==="info"&&a.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(a,i,r){if(t.isPlainObject(a)){if(!a["@context"])a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=i.replace("/info.json",""),a.version=1;else{var n=a["@context"];if(Array.isArray(n)){for(var s=0;s<n.length;s++)if(typeof n[s]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(n[s])||n[s]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){n=n[s];break}}switch(n){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:t.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(!a["@id"]&&a.id&&(a["@id"]=a.id),a.preferredFormats){for(var l=0;l<a.preferredFormats.length;l++)if(h.imageFormatSupported(a.preferredFormats[l])){a.tileFormat=a.preferredFormats[l];break}}return a}else{var o=m(a);return o["@context"]="http://iiif.io/api/image/1.0/context.json",o["@id"]=i.replace("/info.xml",""),o.version=1,o}},getTileWidth:function(a){if(this.emulateLegacyImagePyramid)return t.TileSource.prototype.getTileWidth.call(this,a);var i=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[i]?this.tileSizePerScaleFactor[i].width:this._tileWidth},getTileHeight:function(a){if(this.emulateLegacyImagePyramid)return t.TileSource.prototype.getTileHeight.call(this,a);var i=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[i]?this.tileSizePerScaleFactor[i].height:this._tileHeight},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){var i=NaN;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(i=this.levels[a].width/this.levels[this.maxLevel].width),i}return t.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){if(this.emulateLegacyImagePyramid){var i=this.getLevelScale(a);return i?new t.Point(1,1):new t.Point(0,0)}return t.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,i){return this.emulateLegacyImagePyramid?new t.Point(0,0):t.TileSource.prototype.getTileAtPoint.call(this,a,i)},getTileUrl:function(a,i,r){if(this.emulateLegacyImagePyramid){var o=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(o=this.levels[a].url),o}var n="0",s=Math.pow(.5,this.maxLevel-a),l=Math.ceil(this.width*s),u=Math.ceil(this.height*s),d,f,p,v,w,C,b,P,R,A,W,$,X,re;return d=this.getTileWidth(a),f=this.getTileHeight(a),p=Math.ceil(d/s),v=Math.ceil(f/s),this.version===1?X="native."+this.tileFormat:X="default."+this.tileFormat,l<d&&u<f?(this.version===2&&l===this.width?A="full":this.version===3&&l===this.width&&u===this.height?A="max":this.version===3?A=l+","+u:A=l+",",w="full"):(C=i*p,b=r*v,P=Math.min(p,this.width-C),R=Math.min(v,this.height-b),i===0&&r===0&&P===this.width&&R===this.height?w="full":w=[C,b,P,R].join(","),W=Math.ceil(P*s),$=Math.ceil(R*s),this.version===2&&W===this.width?A="full":this.version===3&&W===this.width&&$===this.height?A="max":this.version===3?A=W+","+$:A=W+","),re=[this["@id"],w,A,n,X].join("/"),re},__testonly__:{canBeTiled:c,constructLevels:g}});function c(a){var i=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],r=Array.isArray(a.profile)?a.profile[0]:a.profile,o=i.indexOf(r)!==-1,n=!1;return a.version===2&&a.profile.length>1&&a.profile[1].supports&&(n=a.profile[1].supports.indexOf("sizeByW")!==-1),a.version===3&&a.extraFeatures&&(n=a.extraFeatures.indexOf("sizeByWh")!==-1),!o||n}function g(a){for(var i=[],r=0;r<a.sizes.length;r++)i.push({url:a["@id"]+"/full/"+a.sizes[r].width+","+(a.version===3?a.sizes[r].height:"")+"/0/default."+a.tileFormat,width:a.sizes[r].width,height:a.sizes[r].height});return i.sort(function(o,n){return o.width-n.width})}function m(a){if(!a||!a.documentElement)throw new Error(t.getString("Errors.Xml"));var i=a.documentElement,r=i.tagName,o=null;if(r==="info")try{return o={},y(i,o),o}catch(n){throw n instanceof Error?n:new Error(t.getString("Errors.IIIF"))}throw new Error(t.getString("Errors.IIIF"))}function y(a,i,r){var o,n;if(a.nodeType===3&&r)n=a.nodeValue.trim(),n.match(/^\d*$/)&&(n=Number(n)),i[r]?(t.isArray(i[r])||(i[r]=[i[r]]),i[r].push(n)):i[r]=n;else if(a.nodeType===1)for(o=0;o<a.childNodes.length;o++)y(a.childNodes[o],i,a.nodeName)}}(h),function(t){t.OsmTileSource=function(c,g,m,y,a){var i;t.isPlainObject(c)?i=c:i={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!i.width||!i.height)&&(i.width=65572864,i.height=65572864),i.tileSize||(i.tileSize=256,i.tileOverlap=0),i.tilesUrl||(i.tilesUrl="http://tile.openstreetmap.org/"),i.minLevel=8,t.TileSource.apply(this,[i])},t.extend(t.OsmTileSource.prototype,t.TileSource.prototype,{supports:function(c,g){return c.type&&c.type==="openstreetmaps"},configure:function(c,g,m){return c},getTileUrl:function(c,g,m){return this.tilesUrl+(c-8)+"/"+g+"/"+m+".png"}})}(h),function(t){t.TmsTileSource=function(c,g,m,y,a){var i;t.isPlainObject(c)?i=c:i={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var r=Math.ceil(i.width/256)*256,o=Math.ceil(i.height/256)*256,n;r>o?n=r/256:n=o/256,i.maxLevel=Math.ceil(Math.log(n)/Math.log(2))-1,i.tileSize=256,i.width=r,i.height=o,t.TileSource.apply(this,[i])},t.extend(t.TmsTileSource.prototype,t.TileSource.prototype,{supports:function(c,g){return c.type&&c.type==="tiledmapservice"},configure:function(c,g,m){return c},getTileUrl:function(c,g,m){var y=this.getNumTiles(c).y-1;return this.tilesUrl+c+"/"+g+"/"+(y-m)+".png"}})}(h),function(t){t.ZoomifyTileSource=function(c){typeof c.tileSize=="undefined"&&(c.tileSize=256),typeof c.fileFormat=="undefined"&&(c.fileFormat="jpg",this.fileFormat=c.fileFormat);var g={x:c.width,y:c.height};for(c.imageSizes=[{x:c.width,y:c.height}],c.gridSize=[this._getGridSize(c.width,c.height,c.tileSize)];parseInt(g.x,10)>c.tileSize||parseInt(g.y,10)>c.tileSize;)g.x=Math.floor(g.x/2),g.y=Math.floor(g.y/2),c.imageSizes.push({x:g.x,y:g.y}),c.gridSize.push(this._getGridSize(g.x,g.y,c.tileSize));c.imageSizes.reverse(),c.gridSize.reverse(),c.minLevel=0,c.maxLevel=c.gridSize.length-1,h.TileSource.apply(this,[c])},t.extend(t.ZoomifyTileSource.prototype,t.TileSource.prototype,{_getGridSize:function(c,g,m){return{x:Math.ceil(c/m),y:Math.ceil(g/m)}},_calculateAbsoluteTileNumber:function(c,g,m){for(var y=0,a={},i=0;i<c;i++)a=this.gridSize[i],y+=a.x*a.y;return a=this.gridSize[c],y+=a.x*m+g,y},supports:function(c,g){return c.type&&c.type==="zoomifytileservice"},configure:function(c,g,m){return c},getTileUrl:function(c,g,m){var y=0,a=this._calculateAbsoluteTileNumber(c,g,m);return y=Math.floor(a/256),this.tilesUrl+"TileGroup"+y+"/"+c+"-"+g+"-"+m+"."+this.fileFormat}})}(h),function(t){t.LegacyTileSource=function(y){var a,i,r;t.isArray(y)&&(a={type:"legacy-image-pyramid",levels:y}),a.levels=c(a.levels),a.levels.length>0?(i=a.levels[a.levels.length-1].width,r=a.levels[a.levels.length-1].height):(i=0,r=0,t.console.error("No supported image formats found")),t.extend(!0,a,{width:i,height:r,tileSize:Math.max(r,i),tileOverlap:0,minLevel:0,maxLevel:a.levels.length>0?a.levels.length-1:0}),t.TileSource.apply(this,[a]),this.levels=a.levels},t.extend(t.LegacyTileSource.prototype,t.TileSource.prototype,{supports:function(y,a){return y.type&&y.type==="legacy-image-pyramid"||y.documentElement&&y.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(y,a,i){var r;return t.isPlainObject(y)?r=m(this,y):r=g(this,y),r},getLevelScale:function(y){var a=NaN;return this.levels.length>0&&y>=this.minLevel&&y<=this.maxLevel&&(a=this.levels[y].width/this.levels[this.maxLevel].width),a},getNumTiles:function(y){var a=this.getLevelScale(y);return a?new t.Point(1,1):new t.Point(0,0)},getTileUrl:function(y,a,i){var r=null;return this.levels.length>0&&y>=this.minLevel&&y<=this.maxLevel&&(r=this.levels[y].url),r}});function c(y){var a=[],i,r;for(r=0;r<y.length;r++)i=y[r],i.height&&i.width&&i.url?a.push({url:i.url,width:Number(i.width),height:Number(i.height)}):t.console.error("Unsupported image format: %s",i.url?i.url:"<no URL>");return a.sort(function(o,n){return o.height-n.height})}function g(y,a){if(!a||!a.documentElement)throw new Error(t.getString("Errors.Xml"));var i=a.documentElement,r=i.tagName,o=null,n=[],s,l;if(r==="image")try{for(o={type:i.getAttribute("type"),levels:[]},n=i.getElementsByTagName("level"),l=0;l<n.length;l++)s=n[l],o.levels.push({url:s.getAttribute("url"),width:parseInt(s.getAttribute("width"),10),height:parseInt(s.getAttribute("height"),10)});return m(y,o)}catch(u){throw u instanceof Error?u:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(r==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(r==="error")throw new Error("Error: "+a)}throw new Error("Unknown element "+r)}function m(y,a){return a.levels}}(h),function(t){t.ImageTileSource=function(c){c=t.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1,useCanvas:!0},c),t.TileSource.apply(this,[c])},t.extend(t.ImageTileSource.prototype,t.TileSource.prototype,{supports:function(c,g){return c.type&&c.type==="image"},configure:function(c,g,m){return c},getImageInfo:function(c){var g=this._image=new Image,m=this;this.crossOriginPolicy&&(g.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(g.useCredentials=this.ajaxWithCredentials),t.addEvent(g,"load",function(){m.width=g.naturalWidth,m.height=g.naturalHeight,m.aspectRatio=m.width/m.height,m.dimensions=new t.Point(m.width,m.height),m._tileWidth=m.width,m._tileHeight=m.height,m.tileOverlap=0,m.minLevel=0,m.levels=m._buildLevels(),m.maxLevel=m.levels.length-1,m.ready=!0,m.raiseEvent("ready",{tileSource:m})}),t.addEvent(g,"error",function(){m.raiseEvent("open-failed",{message:"Error loading image at "+c,source:c})}),g.src=c},getLevelScale:function(c){var g=NaN;return c>=this.minLevel&&c<=this.maxLevel&&(g=this.levels[c].width/this.levels[this.maxLevel].width),g},getNumTiles:function(c){var g=this.getLevelScale(c);return g?new t.Point(1,1):new t.Point(0,0)},getTileUrl:function(c,g,m){var y=null;return c>=this.minLevel&&c<=this.maxLevel&&(y=this.levels[c].url),y},getContext2D:function(c,g,m){var y=null;return c>=this.minLevel&&c<=this.maxLevel&&(y=this.levels[c].context2D),y},destroy:function(){this._freeupCanvasMemory()},_buildLevels:function(){var c=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!t.supportsCanvas||!this.useCanvas)return delete this._image,c;var g=this._image.naturalWidth,m=this._image.naturalHeight,y=document.createElement("canvas"),a=y.getContext("2d");if(y.width=g,y.height=m,a.drawImage(this._image,0,0,g,m),c[0].context2D=a,delete this._image,t.isCanvasTainted(y))return c;for(;g>=2&&m>=2;){g=Math.floor(g/2),m=Math.floor(m/2);var i=document.createElement("canvas"),r=i.getContext("2d");i.width=g,i.height=m,r.drawImage(y,0,0,g,m),c.splice(0,0,{context2D:r,width:g,height:m}),y=i,a=r}return c},_freeupCanvasMemory:function(){for(var c=0;c<this.levels.length;c++)this.levels[c].context2D&&(this.levels[c].context2D.canvas.height=0,this.levels[c].context2D.canvas.width=0)}})}(h),function(t){t.TileSourceCollection=function(c,g,m,y){t.console.error("TileSourceCollection is deprecated; use World instead")}}(h),function(t){t.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},t.Button=function(r){var o=this;t.EventSource.call(this),t.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:t.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:t.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},r),this.element=r.element||t.makeNeutralElement("div"),r.element||(this.imgRest=t.makeTransparentImage(this.srcRest),this.imgGroup=t.makeTransparentImage(this.srcGroup),this.imgHover=t.makeTransparentImage(this.srcHover),this.imgDown=t.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,t.setElementPointerEventsNone(this.imgRest),t.setElementPointerEventsNone(this.imgGroup),t.setElementPointerEventsNone(this.imgHover),t.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",t.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",t.Browser.vendor===t.BROWSERS.FIREFOX&&t.Browser.version<3&&(this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top=""),this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=t.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new t.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(n){n.insideElementPressed?(a(o,t.ButtonState.DOWN),o.raiseEvent("enter",{originalEvent:n.originalEvent})):n.buttonDownAny||a(o,t.ButtonState.HOVER)},focusHandler:function(n){o.tracker.enterHandler(n),o.raiseEvent("focus",{originalEvent:n.originalEvent})},leaveHandler:function(n){i(o,t.ButtonState.GROUP),n.insideElementPressed&&o.raiseEvent("exit",{originalEvent:n.originalEvent})},blurHandler:function(n){o.tracker.leaveHandler(n),o.raiseEvent("blur",{originalEvent:n.originalEvent})},pressHandler:function(n){a(o,t.ButtonState.DOWN),o.raiseEvent("press",{originalEvent:n.originalEvent})},releaseHandler:function(n){n.insideElementPressed&&n.insideElementReleased?(i(o,t.ButtonState.HOVER),o.raiseEvent("release",{originalEvent:n.originalEvent})):n.insideElementPressed?i(o,t.ButtonState.GROUP):a(o,t.ButtonState.HOVER)},clickHandler:function(n){n.quick&&o.raiseEvent("click",{originalEvent:n.originalEvent})},keyHandler:function(n){n.keyCode===13?(o.raiseEvent("click",{originalEvent:n.originalEvent}),o.raiseEvent("release",{originalEvent:n.originalEvent}),n.preventDefault=!0):n.preventDefault=!1}}),i(this,t.ButtonState.REST)},t.extend(t.Button.prototype,t.EventSource.prototype,{notifyGroupEnter:function(){a(this,t.ButtonState.GROUP)},notifyGroupExit:function(){i(this,t.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,t.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,t.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function c(r){t.requestAnimationFrame(function(){g(r)})}function g(r){var o,n,s;r.shouldFade&&(o=t.now(),n=o-r.fadeBeginTime,s=1-n/r.fadeLength,s=Math.min(1,s),s=Math.max(0,s),r.imgGroup&&t.setElementOpacity(r.imgGroup,s,!0),s>0&&c(r))}function m(r){r.shouldFade=!0,r.fadeBeginTime=t.now()+r.fadeDelay,window.setTimeout(function(){c(r)},r.fadeDelay)}function y(r){r.shouldFade=!1,r.imgGroup&&t.setElementOpacity(r.imgGroup,1,!0)}function a(r,o){r.element.disabled||(o>=t.ButtonState.GROUP&&r.currentState===t.ButtonState.REST&&(y(r),r.currentState=t.ButtonState.GROUP),o>=t.ButtonState.HOVER&&r.currentState===t.ButtonState.GROUP&&(r.imgHover&&(r.imgHover.style.visibility=""),r.currentState=t.ButtonState.HOVER),o>=t.ButtonState.DOWN&&r.currentState===t.ButtonState.HOVER&&(r.imgDown&&(r.imgDown.style.visibility=""),r.currentState=t.ButtonState.DOWN))}function i(r,o){r.element.disabled||(o<=t.ButtonState.HOVER&&r.currentState===t.ButtonState.DOWN&&(r.imgDown&&(r.imgDown.style.visibility="hidden"),r.currentState=t.ButtonState.HOVER),o<=t.ButtonState.GROUP&&r.currentState===t.ButtonState.HOVER&&(r.imgHover&&(r.imgHover.style.visibility="hidden"),r.currentState=t.ButtonState.GROUP),o<=t.ButtonState.REST&&r.currentState===t.ButtonState.GROUP&&(m(r),r.currentState=t.ButtonState.REST))}}(h),function(t){t.ButtonGroup=function(c){t.extend(!0,this,{buttons:[],clickTimeThreshold:t.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:t.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},c);var g=this.buttons.concat([]),m=this,y;if(this.element=c.element||t.makeNeutralElement("div"),!c.group)for(this.element.style.display="inline-block",y=0;y<g.length;y++)this.element.appendChild(g[y].element);t.setElementTouchActionNone(this.element),this.tracker=new t.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(a){var i;for(i=0;i<m.buttons.length;i++)m.buttons[i].notifyGroupEnter()},leaveHandler:function(a){var i;if(!a.insideElementPressed)for(i=0;i<m.buttons.length;i++)m.buttons[i].notifyGroupExit()}})},t.ButtonGroup.prototype={emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var c=this.buttons.pop();this.element.removeChild(c.element),c.destroy()}this.tracker.destroy(),this.element=null}}}(h),function(t){t.Rect=function(c,g,m,y,a){this.x=typeof c=="number"?c:0,this.y=typeof g=="number"?g:0,this.width=typeof m=="number"?m:0,this.height=typeof y=="number"?y:0,this.degrees=typeof a=="number"?a:0,this.degrees=t.positiveModulo(this.degrees,360);var i,r;this.degrees>=270?(i=this.getTopRight(),this.x=i.x,this.y=i.y,r=this.height,this.height=this.width,this.width=r,this.degrees-=270):this.degrees>=180?(i=this.getBottomRight(),this.x=i.x,this.y=i.y,this.degrees-=180):this.degrees>=90&&(i=this.getBottomLeft(),this.x=i.x,this.y=i.y,r=this.height,this.height=this.width,this.width=r,this.degrees-=90)},t.Rect.fromSummits=function(c,g,m){var y=c.distanceTo(g),a=c.distanceTo(m),i=g.minus(c),r=Math.atan(i.y/i.x);return i.x<0?r+=Math.PI:i.y<0&&(r+=2*Math.PI),new t.Rect(c.x,c.y,y,a,r/Math.PI*180)},t.Rect.prototype={clone:function(){return new t.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new t.Point(this.x,this.y)},getBottomRight:function(){return new t.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new t.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new t.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new t.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new t.Point(this.width,this.height)},equals:function(c){return c instanceof t.Rect&&this.x===c.x&&this.y===c.y&&this.width===c.width&&this.height===c.height&&this.degrees===c.degrees},times:function(c){return new t.Rect(this.x*c,this.y*c,this.width*c,this.height*c,this.degrees)},translate:function(c){return new t.Rect(this.x+c.x,this.y+c.y,this.width,this.height,this.degrees)},union:function(c){var g=this.getBoundingBox(),m=c.getBoundingBox(),y=Math.min(g.x,m.x),a=Math.min(g.y,m.y),i=Math.max(g.x+g.width,m.x+m.width),r=Math.max(g.y+g.height,m.y+m.height);return new t.Rect(y,a,i-y,r-a)},intersection:function(c){var g=1e-10,m=[],y=this.getTopLeft();c.containsPoint(y,g)&&m.push(y);var a=this.getTopRight();c.containsPoint(a,g)&&m.push(a);var i=this.getBottomLeft();c.containsPoint(i,g)&&m.push(i);var r=this.getBottomRight();c.containsPoint(r,g)&&m.push(r);var o=c.getTopLeft();this.containsPoint(o,g)&&m.push(o);var n=c.getTopRight();this.containsPoint(n,g)&&m.push(n);var s=c.getBottomLeft();this.containsPoint(s,g)&&m.push(s);var l=c.getBottomRight();this.containsPoint(l,g)&&m.push(l);for(var u=this._getSegments(),d=c._getSegments(),f=0;f<u.length;f++)for(var p=u[f],v=0;v<d.length;v++){var w=d[v],C=b(p[0],p[1],w[0],w[1]);C&&m.push(C)}function b(re,he,ne,ce){var ue=he.minus(re),de=ce.minus(ne),fe=-de.x*ue.y+ue.x*de.y;if(fe===0)return null;var L=(ue.x*(re.y-ne.y)-ue.y*(re.x-ne.x))/fe,U=(de.x*(re.y-ne.y)-de.y*(re.x-ne.x))/fe;return-g<=L&&L<=1-g&&-g<=U&&U<=1-g?new t.Point(re.x+U*ue.x,re.y+U*ue.y):null}if(m.length===0)return null;for(var P=m[0].x,R=m[0].x,A=m[0].y,W=m[0].y,$=1;$<m.length;$++){var X=m[$];X.x<P&&(P=X.x),X.x>R&&(R=X.x),X.y<A&&(A=X.y),X.y>W&&(W=X.y)}return new t.Rect(P,A,R-P,W-A)},_getSegments:function(){var c=this.getTopLeft(),g=this.getTopRight(),m=this.getBottomLeft(),y=this.getBottomRight();return[[c,g],[g,y],[y,m],[m,c]]},rotate:function(c,g){if(c=t.positiveModulo(c,360),c===0)return this.clone();g=g||this.getCenter();var m=this.getTopLeft().rotate(c,g),y=this.getTopRight().rotate(c,g),a=y.minus(m);a=a.apply(function(r){var o=1e-15;return Math.abs(r)<o?0:r});var i=Math.atan(a.y/a.x);return a.x<0?i+=Math.PI:a.y<0&&(i+=2*Math.PI),new t.Rect(m.x,m.y,this.width,this.height,i/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var c=this.getTopLeft(),g=this.getTopRight(),m=this.getBottomLeft(),y=this.getBottomRight(),a=Math.min(c.x,g.x,m.x,y.x),i=Math.max(c.x,g.x,m.x,y.x),r=Math.min(c.y,g.y,m.y,y.y),o=Math.max(c.y,g.y,m.y,y.y);return new t.Rect(a,r,i-a,o-r)},getIntegerBoundingBox:function(){var c=this.getBoundingBox(),g=Math.floor(c.x),m=Math.floor(c.y),y=Math.ceil(c.width+c.x-g),a=Math.ceil(c.height+c.y-m);return new t.Rect(g,m,y,a)},containsPoint:function(c,g){g=g||0;var m=this.getTopLeft(),y=this.getTopRight(),a=this.getBottomLeft(),i=y.minus(m),r=a.minus(m);return(c.x-m.x)*i.x+(c.y-m.y)*i.y>=-g&&(c.x-y.x)*i.x+(c.y-y.y)*i.y<=g&&(c.x-m.x)*r.x+(c.y-m.y)*r.y>=-g&&(c.x-a.x)*r.x+(c.y-a.y)*r.y<=g},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(h),function(t){var c={};t.ReferenceStrip=function(s){var l=this,u=s.viewer,d=t.getElementSize(u.element),f,p,v;for(s.id||(s.id="referencestrip-"+t.now(),this.element=t.makeNeutralElement("div"),this.element.id=s.id,this.element.className="referencestrip"),s=t.extend(!0,{sizeRatio:t.DEFAULT_SETTINGS.referenceStripSizeRatio,position:t.DEFAULT_SETTINGS.referenceStripPosition,scroll:t.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:t.DEFAULT_SETTINGS.clickTimeThreshold},s,{element:this.element}),t.extend(this,s),c[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,p=this.element.style,p.marginTop="0px",p.marginRight="0px",p.marginBottom="0px",p.marginLeft="0px",p.left="0px",p.bottom="0px",p.border="0px",p.background="#000",p.position="relative",t.setElementTouchActionNone(this.element),t.setElementOpacity(this.element,.8),this.viewer=u,this.tracker=new t.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:t.delegate(this,g),dragHandler:t.delegate(this,m),scrollHandler:t.delegate(this,y),enterHandler:t.delegate(this,i),leaveHandler:t.delegate(this,r),keyDownHandler:t.delegate(this,o),keyHandler:t.delegate(this,n),preProcessEventHandler:function(w){w.eventType==="wheel"&&(w.preventDefault=!0)}}),s.width&&s.height?(this.element.style.width=s.width+"px",this.element.style.height=s.height+"px",u.addControl(this.element,{anchor:t.ControlAnchor.BOTTOM_LEFT})):s.scroll==="horizontal"?(this.element.style.width=d.x*s.sizeRatio*u.tileSources.length+12*u.tileSources.length+"px",this.element.style.height=d.y*s.sizeRatio+"px",u.addControl(this.element,{anchor:t.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=d.y*s.sizeRatio*u.tileSources.length+12*u.tileSources.length+"px",this.element.style.width=d.x*s.sizeRatio+"px",u.addControl(this.element,{anchor:t.ControlAnchor.TOP_LEFT})),this.panelWidth=d.x*this.sizeRatio+8,this.panelHeight=d.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},v=0;v<u.tileSources.length;v++)f=t.makeNeutralElement("div"),f.id=this.element.id+"-"+v,f.style.width=l.panelWidth+"px",f.style.height=l.panelHeight+"px",f.style.display="inline",f.style.float="left",f.style.cssFloat="left",f.style.styleFloat="left",f.style.padding="2px",t.setElementTouchActionNone(f),t.setElementPointerEventsNone(f),this.element.appendChild(f),f.activePanel=!1,this.panels.push(f);a(this,this.scroll==="vertical"?d.y:d.x,0),this.setFocus(0)},t.ReferenceStrip.prototype={setFocus:function(s){var l=this.element.querySelector("#"+this.element.id+"-"+s),u=t.getElementSize(this.viewer.canvas),d=Number(this.element.style.width.replace("px","")),f=Number(this.element.style.height.replace("px","")),p=-Number(this.element.style.marginLeft.replace("px","")),v=-Number(this.element.style.marginTop.replace("px","")),w;this.currentSelected!==l&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=l,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(w=Number(s)*(this.panelWidth+3),w>p+u.x-this.panelWidth?(w=Math.min(w,d-u.x),this.element.style.marginLeft=-w+"px",a(this,u.x,-w)):w<p&&(w=Math.max(0,w-u.x/2),this.element.style.marginLeft=-w+"px",a(this,u.x,-w))):(w=Number(s)*(this.panelHeight+3),w>v+u.y-this.panelHeight?(w=Math.min(w,f-u.y),this.element.style.marginTop=-w+"px",a(this,u.y,-w)):w<v&&(w=Math.max(0,w-u.y/2),this.element.style.marginTop=-w+"px",a(this,u.y,-w))),this.currentPage=s,i.call(this,{eventSource:this.tracker}))},update:function(){return!!c[this.id].animating},destroy:function(){if(this.miniViewers)for(var s in this.miniViewers)this.miniViewers[s].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function g(s){if(s.quick){var l;this.scroll==="horizontal"?l=Math.floor(s.position.x/this.panelWidth):l=Math.floor(s.position.y/this.panelHeight),this.viewer.goToPage(l)}this.element.focus()}function m(s){if(this.dragging=!0,this.element){var l=Number(this.element.style.marginLeft.replace("px","")),u=Number(this.element.style.marginTop.replace("px","")),d=Number(this.element.style.width.replace("px","")),f=Number(this.element.style.height.replace("px","")),p=t.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-s.delta.x>0?l>-(d-p.x)&&(this.element.style.marginLeft=l+s.delta.x*2+"px",a(this,p.x,l+s.delta.x*2)):-s.delta.x<0&&l<0&&(this.element.style.marginLeft=l+s.delta.x*2+"px",a(this,p.x,l+s.delta.x*2)):-s.delta.y>0?u>-(f-p.y)&&(this.element.style.marginTop=u+s.delta.y*2+"px",a(this,p.y,u+s.delta.y*2)):-s.delta.y<0&&u<0&&(this.element.style.marginTop=u+s.delta.y*2+"px",a(this,p.y,u+s.delta.y*2))}}function y(s){if(this.element){var l=Number(this.element.style.marginLeft.replace("px","")),u=Number(this.element.style.marginTop.replace("px","")),d=Number(this.element.style.width.replace("px","")),f=Number(this.element.style.height.replace("px","")),p=t.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?s.scroll>0?l>-(d-p.x)&&(this.element.style.marginLeft=l-s.scroll*60+"px",a(this,p.x,l-s.scroll*60)):s.scroll<0&&l<0&&(this.element.style.marginLeft=l-s.scroll*60+"px",a(this,p.x,l-s.scroll*60)):s.scroll<0?u>p.y-f&&(this.element.style.marginTop=u+s.scroll*60+"px",a(this,p.y,u+s.scroll*60)):s.scroll>0&&u<0&&(this.element.style.marginTop=u+s.scroll*60+"px",a(this,p.y,u+s.scroll*60)),s.preventDefault=!0}}function a(s,l,u){var d,f,p,v,w,C;for(s.scroll==="horizontal"?d=s.panelWidth:d=s.panelHeight,f=Math.ceil(l/d)+5,p=Math.ceil((Math.abs(u)+l)/d)+1,f=p-f,f=f<0?0:f,w=f;w<p&&w<s.panels.length;w++)if(C=s.panels[w],!C.activePanel){var b,P=s.viewer.tileSources[w];P.referenceStripThumbnailUrl?b={type:"image",url:P.referenceStripThumbnailUrl}:b=P,v=new t.Viewer({id:C.id,tileSources:[b],element:C,navigatorSizeRatio:s.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:s.viewer.loadTilesWithAjax,ajaxHeaders:s.viewer.ajaxHeaders,useCanvas:s.useCanvas}),t.setElementPointerEventsNone(v.canvas),t.setElementPointerEventsNone(v.container),v.innerTracker.setTracking(!1),v.outerTracker.setTracking(!1),s.miniViewers[C.id]=v,C.activePanel=!0}}function i(s){var l=s.eventSource.element;this.scroll==="horizontal"?l.style.marginBottom="0px":l.style.marginLeft="0px"}function r(s){var l=s.eventSource.element;this.scroll==="horizontal"?l.style.marginBottom="-"+t.getElementSize(l).y/2+"px":l.style.marginLeft="-"+t.getElementSize(l).x/2+"px"}function o(s){if(!s.ctrl&&!s.alt&&!s.meta)switch(s.keyCode){case 38:y.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),s.preventDefault=!0;break;case 40:y.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),s.preventDefault=!0;break;case 37:y.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),s.preventDefault=!0;break;case 39:y.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),s.preventDefault=!0;break;default:s.preventDefault=!1;break}else s.preventDefault=!1}function n(s){if(!s.ctrl&&!s.alt&&!s.meta)switch(s.keyCode){case 61:y.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),s.preventDefault=!0;break;case 45:y.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),s.preventDefault=!0;break;case 48:case 119:case 87:y.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),s.preventDefault=!0;break;case 115:case 83:y.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),s.preventDefault=!0;break;case 97:y.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),s.preventDefault=!0;break;case 100:y.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),s.preventDefault=!0;break;default:s.preventDefault=!1;break}else s.preventDefault=!1}}(h),function(t){t.DisplayRect=function(c,g,m,y,a,i){t.Rect.apply(this,[c,g,m,y]),this.minLevel=a,this.maxLevel=i},t.extend(t.DisplayRect.prototype,t.Rect.prototype)}(h),function(t){t.Spring=function(g){var m=arguments;typeof g!="object"&&(g={initial:m.length&&typeof m[0]=="number"?m[0]:void 0,springStiffness:m.length>1?m[1].springStiffness:5,animationTime:m.length>1?m[1].animationTime:1.5}),t.console.assert(typeof g.springStiffness=="number"&&g.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),t.console.assert(typeof g.animationTime=="number"&&g.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),g.exponential&&(this._exponential=!0,delete g.exponential),t.extend(!0,this,g),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:t.now()},t.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},t.Spring.prototype={resetTo:function(g){t.console.assert(!this._exponential||g!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=g,this.start.time=this.target.time=this.current.time=t.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(g){t.console.assert(!this._exponential||g!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=g,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(g){this.start.value+=g,this.target.value+=g,this._exponential&&(t.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(g){this._exponential=g,this._exponential&&(t.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=t.now();var g,m;this._exponential?(g=this.start._logValue,m=this.target._logValue):(g=this.start.value,m=this.target.value);var y=this.current.time>=this.target.time?m:g+(m-g)*c(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time)),a=this.current.value;return this._exponential?this.current.value=Math.exp(y):this.current.value=y,a!==this.current.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function c(g,m){return(1-Math.exp(g*-m))/(1-Math.exp(-g))}}(h),function(t){function c(m){t.extend(!0,this,{timeout:t.DEFAULT_SETTINGS.timeout,jobId:null},m),this.image=null}c.prototype={errorMsg:null,start:function(){var m=this,y=this.abort;this.image=new Image,this.image.onload=function(){m.finish(!0)},this.image.onabort=this.image.onerror=function(){m.errorMsg="Image load aborted",m.finish(!1)},this.jobId=window.setTimeout(function(){m.errorMsg="Image load exceeded timeout ("+m.timeout+" ms)",m.finish(!1)},this.timeout),this.loadWithAjax?(this.request=t.makeAjaxRequest({url:this.src,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,responseType:"arraybuffer",postData:this.postData,success:function(a){var i;try{i=new window.Blob([a.response])}catch(s){var r=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(s.name==="TypeError"&&r){var o=new r;o.append(a.response),i=o.getBlob()}}i.size===0&&(m.errorMsg="Empty image response.",m.finish(!1));var n=(window.URL||window.webkitURL).createObjectURL(i);m.image.src=n},error:function(a){m.errorMsg="Image load aborted - XHR error: Ajax returned "+a.status,m.finish(!1)}}),this.abort=function(){m.request.abort(),typeof y=="function"&&y()}):(this.crossOriginPolicy!==!1&&(this.image.crossOrigin=this.crossOriginPolicy),this.image.src=this.src)},finish:function(m){this.image.onload=this.image.onerror=this.image.onabort=null,m||(this.image=null),this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},t.ImageLoader=function(m){t.extend(!0,this,{jobLimit:t.DEFAULT_SETTINGS.imageLoaderLimit,timeout:t.DEFAULT_SETTINGS.timeout,jobQueue:[],jobsInProgress:0},m)},t.ImageLoader.prototype={addJob:function(m){var y=this,a=function(o){g(y,o,m.callback)},i={src:m.src,loadWithAjax:m.loadWithAjax,ajaxHeaders:m.loadWithAjax?m.ajaxHeaders:null,crossOriginPolicy:m.crossOriginPolicy,ajaxWithCredentials:m.ajaxWithCredentials,postData:m.postData,callback:a,abort:m.abort,timeout:this.timeout},r=new c(i);!this.jobLimit||this.jobsInProgress<this.jobLimit?(r.start(),this.jobsInProgress++):this.jobQueue.push(r)},clear:function(){for(var m=0;m<this.jobQueue.length;m++){var y=this.jobQueue[m];typeof y.abort=="function"&&y.abort()}this.jobQueue=[]}};function g(m,y,a){var i;m.jobsInProgress--,(!m.jobLimit||m.jobsInProgress<m.jobLimit)&&m.jobQueue.length>0&&(i=m.jobQueue.shift(),i.start(),m.jobsInProgress++),a(y.image,y.errorMsg,y.request)}}(h),function(t){t.Tile=function(c,g,m,y,a,i,r,o,n,s,l,u){this.level=c,this.x=g,this.y=m,this.bounds=y,this.sourceBounds=s,this.exists=a,this.url=i,this.postData=l,this.context2D=r,this.loadWithAjax=o,this.ajaxHeaders=n,u===void 0&&(t.console.error("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),u=t.TileSource.prototype.getTileHashKey(c,g,m,i,n,l)),this.cacheKey=u,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.image=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},t.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return!!this.context2D||this.url.match(".png")},drawHTML:function(c){if(!this.cacheImageRecord){t.console.warn("[Tile.drawHTML] attempting to draw tile %s when it's not cached",this.toString());return}if(!this.loaded){t.console.warn("Attempting to draw tile %s when it's not yet loaded.",this.toString());return}this.element||(this.element=t.makeNeutralElement("div"),this.imgElement=this.cacheImageRecord.getImage().cloneNode(),this.imgElement.style.msInterpolationMode="nearest-neighbor",this.imgElement.style.width="100%",this.imgElement.style.height="100%",this.style=this.element.style,this.style.position="absolute"),this.element.parentNode!==c&&c.appendChild(this.element),this.imgElement.parentNode!==this.element&&this.element.appendChild(this.imgElement),this.style.top=this.position.y+"px",this.style.left=this.position.x+"px",this.style.height=this.size.y+"px",this.style.width=this.size.x+"px",this.flipped&&(this.style.transform="scaleX(-1)"),t.setElementOpacity(this.element,this.opacity)},drawCanvas:function(c,g,m,y,a){var i=this.position.times(t.pixelDensityRatio),r=this.size.times(t.pixelDensityRatio),o;if(!this.context2D&&!this.cacheImageRecord){t.console.warn("[Tile.drawCanvas] attempting to draw tile %s when it's not cached",this.toString());return}if(o=this.context2D||this.cacheImageRecord.getRenderedContext(),!this.loaded||!o){t.console.warn("Attempting to draw tile %s when it's not yet loaded.",this.toString());return}c.save(),c.globalAlpha=this.opacity,typeof m=="number"&&m!==1&&(i=i.times(m),r=r.times(m)),y instanceof t.Point&&(i=i.plus(y)),c.globalAlpha===1&&this._hasTransparencyChannel()&&(a&&(i.x=Math.round(i.x),i.y=Math.round(i.y),r.x=Math.round(r.x),r.y=Math.round(r.y)),c.clearRect(i.x,i.y,r.x,r.y)),g({context:c,tile:this,rendered:o});var n,s;this.sourceBounds?(n=Math.min(this.sourceBounds.width,o.canvas.width),s=Math.min(this.sourceBounds.height,o.canvas.height)):(n=o.canvas.width,s=o.canvas.height),c.translate(i.x+r.x/2,0),this.flipped&&c.scale(-1,1),c.drawImage(o.canvas,0,0,n,s,-r.x/2,i.y,r.x,r.y),c.restore()},getScaleForEdgeSmoothing:function(){var c;if(this.cacheImageRecord)c=this.cacheImageRecord.getRenderedContext();else if(this.context2D)c=this.context2D;else return t.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return c.canvas.width/(this.size.x*t.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(c,g,m){var y=Math.max(1,Math.ceil((m.x-g.x)/2)),a=Math.max(1,Math.ceil((m.y-g.y)/2));return new t.Point(y,a).minus(this.position.times(t.pixelDensityRatio).times(c||1).apply(function(i){return i%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(h),function(t){t.OverlayPlacement=t.Placement,t.OverlayRotationMode=t.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),t.Overlay=function(c,g,m){var y;t.isPlainObject(c)?y=c:y={element:c,location:g,placement:m},this.element=y.element,this.style=y.element.style,this._init(y)},t.Overlay.prototype={_init:function(c){this.location=c.location,this.placement=c.placement===void 0?t.Placement.TOP_LEFT:c.placement,this.onDraw=c.onDraw,this.checkResize=c.checkResize===void 0?!0:c.checkResize,this.width=c.width===void 0?null:c.width,this.height=c.height===void 0?null:c.height,this.rotationMode=c.rotationMode||t.OverlayRotationMode.EXACT,this.location instanceof t.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=t.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new t.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(c,g){var m=t.Placement.properties[this.placement];!m||(m.isHorizontallyCentered?c.x-=g.x/2:m.isRight&&(c.x-=g.x),m.isVerticallyCentered?c.y-=g.y/2:m.isBottom&&(c.y-=g.y))},destroy:function(){var c=this.element,g=this.style;c.parentNode&&(c.parentNode.removeChild(c),c.prevElementParent&&(g.display="none",document.body.appendChild(c))),this.onDraw=null,g.top="",g.left="",g.position="",this.width!==null&&(g.width=""),this.height!==null&&(g.height="");var m=t.getCssPropertyWithVendorPrefix("transformOrigin"),y=t.getCssPropertyWithVendorPrefix("transform");m&&y&&(g[m]="",g[y]="")},drawHTML:function(c,g){var m=this.element;m.parentNode!==c&&(m.prevElementParent=m.parentNode,m.prevNextSibling=m.nextSibling,c.appendChild(m),this.style.position="absolute",this.size=t.getElementSize(m));var y=this._getOverlayPositionAndSize(g),a=y.position,i=this.size=y.size,r=y.rotate;if(this.onDraw)this.onDraw(a,i,this.element);else{var o=this.style;o.left=a.x+"px",o.top=a.y+"px",this.width!==null&&(o.width=i.x+"px"),this.height!==null&&(o.height=i.y+"px");var n=t.getCssPropertyWithVendorPrefix("transformOrigin"),s=t.getCssPropertyWithVendorPrefix("transform");n&&s&&(r?(o[n]=this._getTransformOrigin(),o[s]="rotate("+r+"deg)"):(o[n]="",o[s]="")),o.display="block"}},_getOverlayPositionAndSize:function(c){var g=c.pixelFromPoint(this.location,!0),m=this._getSizeInPixels(c);this.adjust(g,m);var y=0;if(c.degrees&&this.rotationMode!==t.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===t.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var a=new t.Rect(g.x,g.y,m.x,m.y),i=this._getBoundingBox(a,c.degrees);g=i.getTopLeft(),m=i.getSize()}else y=c.degrees;return{position:g,size:m,rotate:y}},_getSizeInPixels:function(c){var g=this.size.x,m=this.size.y;if(this.width!==null||this.height!==null){var y=c.deltaPixelsFromPointsNoRotate(new t.Point(this.width||0,this.height||0),!0);this.width!==null&&(g=y.x),this.height!==null&&(m=y.y)}if(this.checkResize&&(this.width===null||this.height===null)){var a=this.size=t.getElementSize(this.element);this.width===null&&(g=a.x),this.height===null&&(m=a.y)}return new t.Point(g,m)},_getBoundingBox:function(c,g){var m=this._getPlacementPoint(c);return c.rotate(g,m).getBoundingBox()},_getPlacementPoint:function(c){var g=new t.Point(c.x,c.y),m=t.Placement.properties[this.placement];return m&&(m.isHorizontallyCentered?g.x+=c.width/2:m.isRight&&(g.x+=c.width),m.isVerticallyCentered?g.y+=c.height/2:m.isBottom&&(g.y+=c.height)),g},_getTransformOrigin:function(){var c="",g=t.Placement.properties[this.placement];return g&&(g.isLeft?c="left":g.isRight&&(c="right"),g.isTop?c+=" top":g.isBottom&&(c+=" bottom")),c},update:function(c,g){var m=t.isPlainObject(c)?c:{location:c,placement:g};this._init({location:m.location||this.location,placement:m.placement!==void 0?m.placement:this.placement,onDraw:m.onDraw||this.onDraw,checkResize:m.checkResize||this.checkResize,width:m.width!==void 0?m.width:this.width,height:m.height!==void 0?m.height:this.height,rotationMode:m.rotationMode||this.rotationMode})},getBounds:function(c){t.console.assert(c,"A viewport must now be passed to Overlay.getBounds.");var g=this.width,m=this.height;if(g===null||m===null){var y=c.deltaPointsFromPixelsNoRotate(this.size,!0);g===null&&(g=y.x),m===null&&(m=y.y)}var a=this.location.clone();return this.adjust(a,new t.Point(g,m)),this._adjustBoundsForRotation(c,new t.Rect(a.x,a.y,g,m))},_adjustBoundsForRotation:function(c,g){if(!c||c.degrees===0||this.rotationMode===t.OverlayRotationMode.EXACT)return g;if(this.rotationMode===t.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return g;var m=this._getOverlayPositionAndSize(c);return c.viewerElementToViewportRectangle(new t.Rect(m.position.x,m.position.y,m.size.x,m.size.y))}return g.rotate(-c.degrees,this._getPlacementPoint(g))}}}(h),function(t){t.Drawer=function(c){t.console.assert(c.viewer,"[Drawer] options.viewer is required");var g=arguments;if(t.isPlainObject(c)||(c={source:g[0],viewport:g[1],element:g[2]}),t.console.assert(c.viewport,"[Drawer] options.viewport is required"),t.console.assert(c.element,"[Drawer] options.element is required"),c.source&&t.console.error("[Drawer] options.source is no longer accepted; use TiledImage instead"),this.viewer=c.viewer,this.viewport=c.viewport,this.debugGridColor=typeof c.debugGridColor=="string"?[c.debugGridColor]:c.debugGridColor||t.DEFAULT_SETTINGS.debugGridColor,c.opacity&&t.console.error("[Drawer] options.opacity is no longer accepted; set the opacity on the TiledImage instead"),this.useCanvas=t.supportsCanvas&&(this.viewer?this.viewer.useCanvas:!0),this.container=t.getElement(c.element),this.canvas=t.makeNeutralElement(this.useCanvas?"canvas":"div"),this.context=this.useCanvas?this.canvas.getContext("2d"):null,this.sketchCanvas=null,this.sketchContext=null,this.element=this.container,this.container.dir="ltr",this.useCanvas){var m=this._calculateCanvasSize();this.canvas.width=m.x,this.canvas.height=m.y}this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",t.setElementOpacity(this.canvas,this.opacity,!0),t.setElementPointerEventsNone(this.canvas),t.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._imageSmoothingEnabled=!0},t.Drawer.prototype={addOverlay:function(c,g,m,y){return t.console.error("drawer.addOverlay is deprecated. Use viewer.addOverlay instead."),this.viewer.addOverlay(c,g,m,y),this},updateOverlay:function(c,g,m){return t.console.error("drawer.updateOverlay is deprecated. Use viewer.updateOverlay instead."),this.viewer.updateOverlay(c,g,m),this},removeOverlay:function(c){return t.console.error("drawer.removeOverlay is deprecated. Use viewer.removeOverlay instead."),this.viewer.removeOverlay(c),this},clearOverlays:function(){return t.console.error("drawer.clearOverlays is deprecated. Use viewer.clearOverlays instead."),this.viewer.clearOverlays(),this},viewportCoordToDrawerCoord:function(c){var g=this.viewport.pixelFromPointNoRotate(c,!0);return new t.Point(g.x*t.pixelDensityRatio,g.y*t.pixelDensityRatio)},clipWithPolygons:function(c,g){if(!!this.useCanvas){var m=this._getContext(g);m.beginPath(),c.forEach(function(y){y.forEach(function(a,i){m[i===0?"moveTo":"lineTo"](a.x,a.y)})}),m.clip()}},setOpacity:function(c){t.console.error("drawer.setOpacity is deprecated. Use tiledImage.setOpacity instead.");for(var g=this.viewer.world,m=0;m<g.getItemCount();m++)g.getItemAt(m).setOpacity(c);return this},getOpacity:function(){t.console.error("drawer.getOpacity is deprecated. Use tiledImage.getOpacity instead.");for(var c=this.viewer.world,g=0,m=0;m<c.getItemCount();m++){var y=c.getItemAt(m).getOpacity();y>g&&(g=y)}return g},needsUpdate:function(){return t.console.error("[Drawer.needsUpdate] this function is deprecated. Use World.needsDraw instead."),this.viewer.world.needsDraw()},numTilesLoaded:function(){return t.console.error("[Drawer.numTilesLoaded] this function is deprecated. Use TileCache.numTilesLoaded instead."),this.viewer.tileCache.numTilesLoaded()},reset:function(){return t.console.error("[Drawer.reset] this function is deprecated. Use World.resetItems instead."),this.viewer.world.resetItems(),this},update:function(){return t.console.error("[Drawer.update] this function is deprecated. Use Drawer.clear and World.draw instead."),this.clear(),this.viewer.world.draw(),this},canRotate:function(){return this.useCanvas},destroy:function(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null},clear:function(){if(this.canvas.innerHTML="",this.useCanvas){var c=this._calculateCanvasSize();if((this.canvas.width!==c.x||this.canvas.height!==c.y)&&(this.canvas.width=c.x,this.canvas.height=c.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var g=this._calculateSketchCanvasSize();this.sketchCanvas.width=g.x,this.sketchCanvas.height=g.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}},_clear:function(c,g){if(!!this.useCanvas){var m=this._getContext(c);if(g)m.clearRect(g.x,g.y,g.width,g.height);else{var y=m.canvas;m.clearRect(0,0,y.width,y.height)}}},viewportToDrawerRectangle:function(c){var g=this.viewport.pixelFromPointNoRotate(c.getTopLeft(),!0),m=this.viewport.deltaPixelsFromPointsNoRotate(c.getSize(),!0);return new t.Rect(g.x*t.pixelDensityRatio,g.y*t.pixelDensityRatio,m.x*t.pixelDensityRatio,m.y*t.pixelDensityRatio)},drawTile:function(c,g,m,y,a,i){if(t.console.assert(c,"[Drawer.drawTile] tile is required"),t.console.assert(g,"[Drawer.drawTile] drawingHandler is required"),this.useCanvas){var r=this._getContext(m);y=y||1,c.drawCanvas(r,g,y,a,i)}else c.drawHTML(this.canvas)},_getContext:function(c){var g=this.context;if(c){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var m=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=m.x,this.sketchCanvas.height=m.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var y=this;this.viewer.addHandler("rotate",function a(){if(y.viewport.getRotation()!==0){y.viewer.removeHandler("rotate",a);var i=y._calculateSketchCanvasSize();y.sketchCanvas.width=i.x,y.sketchCanvas.height=i.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}g=this.sketchContext}return g},saveContext:function(c){!this.useCanvas||this._getContext(c).save()},restoreContext:function(c){!this.useCanvas||this._getContext(c).restore()},setClip:function(c,g){if(!!this.useCanvas){var m=this._getContext(g);m.beginPath(),m.rect(c.x,c.y,c.width,c.height),m.clip()}},drawRectangle:function(c,g,m){if(!!this.useCanvas){var y=this._getContext(m);y.save(),y.fillStyle=g,y.fillRect(c.x,c.y,c.width,c.height),y.restore()}},blendSketch:function(c,g,m,y){var a=c;if(t.isPlainObject(a)||(a={opacity:c,scale:g,translate:m,compositeOperation:y}),!(!this.useCanvas||!this.sketchCanvas)){c=a.opacity,y=a.compositeOperation;var i=a.bounds;if(this.context.save(),this.context.globalAlpha=c,y&&(this.context.globalCompositeOperation=y),i)i.x<0&&(i.width+=i.x,i.x=0),i.x+i.width>this.canvas.width&&(i.width=this.canvas.width-i.x),i.y<0&&(i.height+=i.y,i.y=0),i.y+i.height>this.canvas.height&&(i.height=this.canvas.height-i.y),this.context.drawImage(this.sketchCanvas,i.x,i.y,i.width,i.height,i.x,i.y,i.width,i.height);else{g=a.scale||1,m=a.translate;var r=m instanceof t.Point?m:new t.Point(0,0),o=0,n=0;if(m){var s=this.sketchCanvas.width-this.canvas.width,l=this.sketchCanvas.height-this.canvas.height;o=Math.round(s/2),n=Math.round(l/2)}this.context.drawImage(this.sketchCanvas,r.x-o*g,r.y-n*g,(this.canvas.width+2*o)*g,(this.canvas.height+2*n)*g,-o,-n,this.canvas.width+2*o,this.canvas.height+2*n)}this.context.restore()}},drawDebugInfo:function(c,g,m,y){if(!!this.useCanvas){var a=this.viewer.world.getIndexOfItem(y)%this.debugGridColor.length,i=this.context;i.save(),i.lineWidth=2*t.pixelDensityRatio,i.font="small-caps bold "+13*t.pixelDensityRatio+"px arial",i.strokeStyle=this.debugGridColor[a],i.fillStyle=this.debugGridColor[a],this.viewport.degrees!==0&&this._offsetForRotation({degrees:this.viewport.degrees}),y.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:y.getRotation(!0),point:y.viewport.pixelFromPointNoRotate(y._getRotationPoint(!0),!0)}),y.viewport.degrees===0&&y.getRotation(!0)%360===0&&y._drawer.viewer.viewport.getFlip()&&y._drawer._flip(),i.strokeRect(c.position.x*t.pixelDensityRatio,c.position.y*t.pixelDensityRatio,c.size.x*t.pixelDensityRatio,c.size.y*t.pixelDensityRatio);var r=(c.position.x+c.size.x/2)*t.pixelDensityRatio,o=(c.position.y+c.size.y/2)*t.pixelDensityRatio;i.translate(r,o),i.rotate(Math.PI/180*-this.viewport.degrees),i.translate(-r,-o),c.x===0&&c.y===0&&(i.fillText("Zoom: "+this.viewport.getZoom(),c.position.x*t.pixelDensityRatio,(c.position.y-30)*t.pixelDensityRatio),i.fillText("Pan: "+this.viewport.getBounds().toString(),c.position.x*t.pixelDensityRatio,(c.position.y-20)*t.pixelDensityRatio)),i.fillText("Level: "+c.level,(c.position.x+10)*t.pixelDensityRatio,(c.position.y+20)*t.pixelDensityRatio),i.fillText("Column: "+c.x,(c.position.x+10)*t.pixelDensityRatio,(c.position.y+30)*t.pixelDensityRatio),i.fillText("Row: "+c.y,(c.position.x+10)*t.pixelDensityRatio,(c.position.y+40)*t.pixelDensityRatio),i.fillText("Order: "+m+" of "+g,(c.position.x+10)*t.pixelDensityRatio,(c.position.y+50)*t.pixelDensityRatio),i.fillText("Size: "+c.size.toString(),(c.position.x+10)*t.pixelDensityRatio,(c.position.y+60)*t.pixelDensityRatio),i.fillText("Position: "+c.position.toString(),(c.position.x+10)*t.pixelDensityRatio,(c.position.y+70)*t.pixelDensityRatio),this.viewport.degrees!==0&&this._restoreRotationChanges(),y.getRotation(!0)%360!==0&&this._restoreRotationChanges(),y.viewport.degrees===0&&y.getRotation(!0)%360===0&&y._drawer.viewer.viewport.getFlip()&&y._drawer._flip(),i.restore()}},debugRect:function(c){if(this.useCanvas){var g=this.context;g.save(),g.lineWidth=2*t.pixelDensityRatio,g.strokeStyle=this.debugGridColor[0],g.fillStyle=this.debugGridColor[0],g.strokeRect(c.x*t.pixelDensityRatio,c.y*t.pixelDensityRatio,c.width*t.pixelDensityRatio,c.height*t.pixelDensityRatio),g.restore()}},setImageSmoothingEnabled:function(c){this.useCanvas&&(this._imageSmoothingEnabled=c,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw())},_updateImageSmoothingEnabled:function(c){c.msImageSmoothingEnabled=this._imageSmoothingEnabled,c.imageSmoothingEnabled=this._imageSmoothingEnabled},getCanvasSize:function(c){var g=this._getContext(c).canvas;return new t.Point(g.width,g.height)},getCanvasCenter:function(){return new t.Point(this.canvas.width/2,this.canvas.height/2)},_offsetForRotation:function(c){var g=c.point?c.point.times(t.pixelDensityRatio):this.getCanvasCenter(),m=this._getContext(c.useSketch);m.save(),m.translate(g.x,g.y),this.viewer.viewport.flipped?(m.rotate(Math.PI/180*-c.degrees),m.scale(-1,1)):m.rotate(Math.PI/180*c.degrees),m.translate(-g.x,-g.y)},_flip:function(c){c=c||{};var g=c.point?c.point.times(t.pixelDensityRatio):this.getCanvasCenter(),m=this._getContext(c.useSketch);m.translate(g.x,0),m.scale(-1,1),m.translate(-g.x,0)},_restoreRotationChanges:function(c){var g=this._getContext(c);g.restore()},_calculateCanvasSize:function(){var c=t.pixelDensityRatio,g=this.viewport.getContainerSize();return{x:Math.round(g.x*c),y:Math.round(g.y*c)}},_calculateSketchCanvasSize:function(){var c=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return c;var g=Math.ceil(Math.sqrt(c.x*c.x+c.y*c.y));return{x:g,y:g}}}}(h),function(t){t.Viewport=function(c){var g=arguments;g.length&&g[0]instanceof t.Point&&(c={containerSize:g[0],contentSize:g[1],config:g[2]}),c.config&&(t.extend(!0,c,c.config),delete c.config),this._margins=t.extend({left:0,top:0,right:0,bottom:0},c.margins||{}),delete c.margins,t.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,viewer:null,springStiffness:t.DEFAULT_SETTINGS.springStiffness,animationTime:t.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:t.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:t.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:t.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:t.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:t.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:t.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:t.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:t.DEFAULT_SETTINGS.maxZoomLevel,degrees:t.DEFAULT_SETTINGS.degrees,flipped:t.DEFAULT_SETTINGS.flipped,homeFillsViewer:t.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:t.DEFAULT_SETTINGS.silenceMultiImageWarnings},c),this._updateContainerInnerSize(),this.centerSpringX=new t.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new t.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new t.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._setContentBounds(new t.Rect(0,0,1,1),1),this.goHome(!0),this.update()},t.Viewport.prototype={resetContentSize:function(c){return t.console.assert(c,"[Viewport.resetContentSize] contentSize is required"),t.console.assert(c instanceof t.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),t.console.assert(c.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),t.console.assert(c.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new t.Rect(0,0,1,c.y/c.x),c.x),this},setHomeBounds:function(c,g){t.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(c,g)},_setContentBounds:function(c,g){t.console.assert(c,"[Viewport._setContentBounds] bounds is required"),t.console.assert(c instanceof t.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),t.console.assert(c.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),t.console.assert(c.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=c.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(g),this._contentBounds=c.rotate(this.degrees).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(g),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:g,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var c=this._contentAspectRatio/this.getAspectRatio(),g;return this.homeFillsViewer?g=c>=1?c:1:g=c>=1?1:c,g/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var c=this._contentBounds.getCenter(),g=1/this.getHomeZoom(),m=g/this.getAspectRatio();return new t.Rect(c.x-g/2,c.y-m/2,g,m)},goHome:function(c){return this.viewer&&this.viewer.raiseEvent("home",{immediately:c}),this.fitBounds(this.getHomeBounds(),c)},getMinZoom:function(){var c=this.getHomeZoom(),g=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*c;return g},getMaxZoom:function(){var c=this.maxZoomLevel;return c||(c=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,c/=this._contentBounds.width),Math.max(c,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new t.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return t.extend({},this._margins)},setMargins:function(c){t.console.assert(t.type(c)==="object","[Viewport.setMargins] margins must be an object"),this._margins=t.extend({left:0,top:0,right:0,bottom:0},c),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(c){return this.getBoundsNoRotate(c).rotate(-this.getRotation())},getBoundsNoRotate:function(c){var g=this.getCenter(c),m=1/this.getZoom(c),y=m/this.getAspectRatio();return new t.Rect(g.x-m/2,g.y-y/2,m,y)},getBoundsWithMargins:function(c){return this.getBoundsNoRotateWithMargins(c).rotate(-this.getRotation(),this.getCenter(c))},getBoundsNoRotateWithMargins:function(c){var g=this.getBoundsNoRotate(c),m=this._containerInnerSize.x*this.getZoom(c);return g.x-=this._margins.left/m,g.y-=this._margins.top/m,g.width+=(this._margins.left+this._margins.right)/m,g.height+=(this._margins.top+this._margins.bottom)/m,g},getCenter:function(c){var g=new t.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),m=new t.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),y,a,i,r,o,n,s,l;return c?g:this.zoomPoint?(y=this.pixelFromPoint(this.zoomPoint,!0),a=this.getZoom(),i=1/a,r=i/this.getAspectRatio(),o=new t.Rect(g.x-i/2,g.y-r/2,i,r),n=this._pixelFromPoint(this.zoomPoint,o),s=n.minus(y),l=s.divide(this._containerInnerSize.x*a),m.plus(l)):m},getZoom:function(c){return c?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(c){return Math.max(Math.min(c,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(c){var g=new t.Rect(c.x,c.y,c.width,c.height);if(!this.wrapHorizontal){var m=this.visibilityRatio*g.width,y=g.x+g.width,a=this._contentBoundsNoRotate.x+this._contentBoundsNoRotate.width,i=this._contentBoundsNoRotate.x-y+m,r=a-g.x-m;m>this._contentBoundsNoRotate.width?g.x+=(i+r)/2:r<0?g.x+=r:i>0&&(g.x+=i)}if(!this.wrapVertical){var o=this.visibilityRatio*g.height,n=g.y+g.height,s=this._contentBoundsNoRotate.y+this._contentBoundsNoRotate.height,l=this._contentBoundsNoRotate.y-n+o,u=s-g.y-o;o>this._contentBoundsNoRotate.height?g.y+=(l+u)/2:u<0?g.y+=u:l>0&&(g.y+=l)}return g},_raiseConstraintsEvent:function(c){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:c})},applyConstraints:function(c){var g=this.getZoom(),m=this._applyZoomConstraints(g);g!==m&&this.zoomTo(m,this.zoomPoint,c);var y=this.getBoundsNoRotate(),a=this._applyBoundaryConstraints(y);return this._raiseConstraintsEvent(c),(y.x!==a.x||y.y!==a.y||c)&&this.fitBounds(a.rotate(-this.getRotation()),c),this},ensureVisible:function(c){return this.applyConstraints(c)},_fitBounds:function(c,g){g=g||{};var m=g.immediately||!1,y=g.constraints||!1,a=this.getAspectRatio(),i=c.getCenter(),r=new t.Rect(c.x,c.y,c.width,c.height,c.degrees+this.getRotation()).getBoundingBox();r.getAspectRatio()>=a?r.height=r.width/a:r.width=r.height*a,r.x=i.x-r.width/2,r.y=i.y-r.height/2;var o=1/r.width;if(y){var n=r.getAspectRatio(),s=this._applyZoomConstraints(o);o!==s&&(o=s,r.width=1/o,r.x=i.x-r.width/2,r.height=r.width/n,r.y=i.y-r.height/2),r=this._applyBoundaryConstraints(r),i=r.getCenter(),this._raiseConstraintsEvent(m)}if(m)return this.panTo(i,!0),this.zoomTo(o,null,!0);this.panTo(this.getCenter(!0),!0),this.zoomTo(this.getZoom(!0),null,!0);var l=this.getBounds(),u=this.getZoom();if(u===0||Math.abs(o/u-1)<1e-8)return this.zoomTo(o,!0),this.panTo(i,m);r=r.rotate(-this.getRotation());var d=r.getTopLeft().times(o).minus(l.getTopLeft().times(u)).divide(o-u);return this.zoomTo(o,d,m)},fitBounds:function(c,g){return this._fitBounds(c,{immediately:g,constraints:!1})},fitBoundsWithConstraints:function(c,g){return this._fitBounds(c,{immediately:g,constraints:!0})},fitVertically:function(c){var g=new t.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(g,c)},fitHorizontally:function(c){var g=new t.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(g,c)},getConstrainedBounds:function(c){var g,m;return g=this.getBounds(c),m=this._applyBoundaryConstraints(g),m},panBy:function(c,g){var m=new t.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(m.plus(c),g)},panTo:function(c,g){return g?(this.centerSpringX.resetTo(c.x),this.centerSpringY.resetTo(c.y)):(this.centerSpringX.springTo(c.x),this.centerSpringY.springTo(c.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:c,immediately:g}),this},zoomBy:function(c,g,m){return this.zoomTo(this.zoomSpring.target.value*c,g,m)},zoomTo:function(c,g,m){var y=this;return this.zoomPoint=g instanceof t.Point&&!isNaN(g.x)&&!isNaN(g.y)?g:null,m?this._adjustCenterSpringsForZoomPoint(function(){y.zoomSpring.resetTo(c)}):this.zoomSpring.springTo(c),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:c,refPoint:g,immediately:m}),this},setRotation:function(c){return!this.viewer||!this.viewer.drawer.canRotate()?this:(this.degrees=t.positiveModulo(c,360),this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:c}),this)},getRotation:function(){return this.degrees},resize:function(c,g){var m=this.getBoundsNoRotate(),y=m,a;return this.containerSize.x=c.x,this.containerSize.y=c.y,this._updateContainerInnerSize(),g&&(a=c.x/this.containerSize.x,y.width=m.width*a,y.height=y.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:c,maintain:g}),this.fitBounds(y,!0)},_updateContainerInnerSize:function(){this._containerInnerSize=new t.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var c=this;this._adjustCenterSpringsForZoomPoint(function(){c.zoomSpring.update()}),this.centerSpringX.update(),this.centerSpringY.update();var g=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom;return this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,g},_adjustCenterSpringsForZoomPoint:function(c){if(this.zoomPoint){var g=this.pixelFromPoint(this.zoomPoint,!0);c();var m=this.pixelFromPoint(this.zoomPoint,!0),y=m.minus(g),a=this.deltaPointsFromPixels(y,!0);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else c()},deltaPixelsFromPointsNoRotate:function(c,g){return c.times(this._containerInnerSize.x*this.getZoom(g))},deltaPixelsFromPoints:function(c,g){return this.deltaPixelsFromPointsNoRotate(c.rotate(this.getRotation()),g)},deltaPointsFromPixelsNoRotate:function(c,g){return c.divide(this._containerInnerSize.x*this.getZoom(g))},deltaPointsFromPixels:function(c,g){return this.deltaPointsFromPixelsNoRotate(c,g).rotate(-this.getRotation())},pixelFromPointNoRotate:function(c,g){return this._pixelFromPointNoRotate(c,this.getBoundsNoRotate(g))},pixelFromPoint:function(c,g){return this._pixelFromPoint(c,this.getBoundsNoRotate(g))},_pixelFromPointNoRotate:function(c,g){return c.minus(g.getTopLeft()).times(this._containerInnerSize.x/g.width).plus(new t.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(c,g){return this._pixelFromPointNoRotate(c.rotate(this.getRotation(),this.getCenter(!0)),g)},pointFromPixelNoRotate:function(c,g){var m=this.getBoundsNoRotate(g);return c.minus(new t.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/m.width).plus(m.getTopLeft())},pointFromPixel:function(c,g){return this.pointFromPixelNoRotate(c,g).rotate(-this.getRotation(),this.getCenter(!0))},_viewportToImageDelta:function(c,g){var m=this._contentBoundsNoRotate.width;return new t.Point(c*this._contentSizeNoRotate.x/m,g*this._contentSizeNoRotate.x/m)},viewportToImageCoordinates:function(c,g){if(c instanceof t.Point)return this.viewportToImageCoordinates(c.x,c.y);if(this.viewer){var m=this.viewer.world.getItemCount();if(m>1)this.silenceMultiImageWarnings||t.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(m===1){var y=this.viewer.world.getItemAt(0);return y.viewportToImageCoordinates(c,g,!0)}}return this._viewportToImageDelta(c-this._contentBoundsNoRotate.x,g-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(c,g){var m=this._contentBoundsNoRotate.width;return new t.Point(c/this._contentSizeNoRotate.x*m,g/this._contentSizeNoRotate.x*m)},imageToViewportCoordinates:function(c,g){if(c instanceof t.Point)return this.imageToViewportCoordinates(c.x,c.y);if(this.viewer){var m=this.viewer.world.getItemCount();if(m>1)this.silenceMultiImageWarnings||t.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(m===1){var y=this.viewer.world.getItemAt(0);return y.imageToViewportCoordinates(c,g,!0)}}var a=this._imageToViewportDelta(c,g);return a.x+=this._contentBoundsNoRotate.x,a.y+=this._contentBoundsNoRotate.y,a},imageToViewportRectangle:function(c,g,m,y){var a=c;if(a instanceof t.Rect||(a=new t.Rect(c,g,m,y)),this.viewer){var i=this.viewer.world.getItemCount();if(i>1)this.silenceMultiImageWarnings||t.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(i===1){var r=this.viewer.world.getItemAt(0);return r.imageToViewportRectangle(c,g,m,y,!0)}}var o=this.imageToViewportCoordinates(a.x,a.y),n=this._imageToViewportDelta(a.width,a.height);return new t.Rect(o.x,o.y,n.x,n.y,a.degrees)},viewportToImageRectangle:function(c,g,m,y){var a=c;if(a instanceof t.Rect||(a=new t.Rect(c,g,m,y)),this.viewer){var i=this.viewer.world.getItemCount();if(i>1)this.silenceMultiImageWarnings||t.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(i===1){var r=this.viewer.world.getItemAt(0);return r.viewportToImageRectangle(c,g,m,y,!0)}}var o=this.viewportToImageCoordinates(a.x,a.y),n=this._viewportToImageDelta(a.width,a.height);return new t.Rect(o.x,o.y,n.x,n.y,a.degrees)},viewerElementToImageCoordinates:function(c){var g=this.pointFromPixel(c,!0);return this.viewportToImageCoordinates(g)},imageToViewerElementCoordinates:function(c){var g=this.imageToViewportCoordinates(c);return this.pixelFromPoint(g,!0)},windowToImageCoordinates:function(c){t.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var g=c.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(g)},imageToWindowCoordinates:function(c){t.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var g=this.imageToViewerElementCoordinates(c);return g.plus(t.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(c){return this.pointFromPixel(c,!0)},viewportToViewerElementCoordinates:function(c){return this.pixelFromPoint(c,!0)},viewerElementToViewportRectangle:function(c){return t.Rect.fromSummits(this.pointFromPixel(c.getTopLeft(),!0),this.pointFromPixel(c.getTopRight(),!0),this.pointFromPixel(c.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(c){return t.Rect.fromSummits(this.pixelFromPoint(c.getTopLeft(),!0),this.pixelFromPoint(c.getTopRight(),!0),this.pixelFromPoint(c.getBottomLeft(),!0))},windowToViewportCoordinates:function(c){t.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var g=c.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(g)},viewportToWindowCoordinates:function(c){t.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var g=this.viewportToViewerElementCoordinates(c);return g.plus(t.getElementPosition(this.viewer.element))},viewportToImageZoom:function(c){if(this.viewer){var g=this.viewer.world.getItemCount();if(g>1)this.silenceMultiImageWarnings||t.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(g===1){var m=this.viewer.world.getItemAt(0);return m.viewportToImageZoom(c)}}var y=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,i=this._contentBoundsNoRotate.width,r=a/y*i;return c*r},imageToViewportZoom:function(c){if(this.viewer){var g=this.viewer.world.getItemCount();if(g>1)this.silenceMultiImageWarnings||t.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image.");else if(g===1){var m=this.viewer.world.getItemAt(0);return m.imageToViewportZoom(c)}}var y=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,i=this._contentBoundsNoRotate.width,r=y/a/i;return c*r},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(c){return this.flipped===c?this:(this.flipped=c,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:c}),this)}}}(h),function(t){t.TiledImage=function(a){var i=this;t.console.assert(a.tileCache,"[TiledImage] options.tileCache is required"),t.console.assert(a.drawer,"[TiledImage] options.drawer is required"),t.console.assert(a.viewer,"[TiledImage] options.viewer is required"),t.console.assert(a.imageLoader,"[TiledImage] options.imageLoader is required"),t.console.assert(a.source,"[TiledImage] options.source is required"),t.console.assert(!a.clip||a.clip instanceof t.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),t.EventSource.call(this),this._tileCache=a.tileCache,delete a.tileCache,this._drawer=a.drawer,delete a.drawer,this._imageLoader=a.imageLoader,delete a.imageLoader,a.clip instanceof t.Rect&&(this._clip=a.clip.clone()),delete a.clip;var r=a.x||0;delete a.x;var o=a.y||0;delete a.y,this.normHeight=a.source.dimensions.y/a.source.dimensions.x,this.contentAspectX=a.source.dimensions.x/a.source.dimensions.y;var n=1;a.width?(n=a.width,delete a.width,a.height&&(t.console.error("specifying both width and height to a tiledImage is not supported"),delete a.height)):a.height&&(n=a.height/this.normHeight,delete a.height);var s=a.fitBounds;delete a.fitBounds;var l=a.fitBoundsPlacement||h.Placement.CENTER;delete a.fitBoundsPlacement;var u=a.degrees||0;delete a.degrees,t.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_midDraw:!1,_needsDraw:!0,_hasOpaqueTile:!1,_tilesLoading:0,springStiffness:t.DEFAULT_SETTINGS.springStiffness,animationTime:t.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:t.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:t.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:t.DEFAULT_SETTINGS.wrapVertical,immediateRender:t.DEFAULT_SETTINGS.immediateRender,blendTime:t.DEFAULT_SETTINGS.blendTime,alwaysBlend:t.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:t.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:t.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:t.DEFAULT_SETTINGS.iOSDevice,debugMode:t.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:t.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:t.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:t.DEFAULT_SETTINGS.placeholderFillStyle,opacity:t.DEFAULT_SETTINGS.opacity,preload:t.DEFAULT_SETTINGS.preload,compositeOperation:t.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:t.DEFAULT_SETTINGS.subPixelRoundingForTransparency},a),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new t.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new t.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new t.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new t.Spring({initial:u,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),s&&this.fitBounds(s,l,!0),this._drawingHandler=function(d){i.viewer.raiseEvent("tile-drawing",t.extend({tiledImage:i},d))}},t.extend(t.TiledImage.prototype,t.EventSource.prototype,{needsDraw:function(){return this._needsDraw},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(a){a!==this._fullyLoaded&&(this._fullyLoaded=a,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=t.now(),this._needsDraw=!0},update:function(){var a=this._xSpring.update(),i=this._ySpring.update(),r=this._scaleSpring.update(),o=this._degreesSpring.update();return a||i||r||o?(this._updateForScale(),this._needsDraw=!0,!0):!1},draw:function(){this.opacity!==0||this._preload?(this._midDraw=!0,this._updateViewport(),this._midDraw=!1):this._needsDraw=!1},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy()},getBounds:function(a){return this.getBoundsNoRotate(a).rotate(this.getRotation(a),this._getRotationPoint(a))},getBoundsNoRotate:function(a){return a?new t.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new t.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return t.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(a){var i=this.getBoundsNoRotate(a);if(this._clip){var r=a?this._worldWidthCurrent:this._worldWidthTarget,o=r/this.source.dimensions.x,n=this._clip.times(o);i=new t.Rect(i.x+n.x,i.y+n.y,n.width,n.height)}return i.rotate(this.getRotation(a),this._getRotationPoint(a))},getTileBounds:function(a,i,r){var o=this.source.getNumTiles(a),n=(o.x+i%o.x)%o.x,s=(o.y+r%o.y)%o.y,l=this.source.getTileBounds(a,n,s);return this.getFlip()&&(l.x=1-l.x-l.width),l.x+=(i-n)/o.x,l.y+=this._worldHeightCurrent/this._worldWidthCurrent*((r-s)/o.y),l},getContentSize:function(){return new t.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var a=this.imageToWindowCoordinates(new t.Point(0,0)),i=this.imageToWindowCoordinates(this.getContentSize());return new t.Point(i.x-a.x,i.y-a.y)},_viewportToImageDelta:function(a,i,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new t.Point(a*(this.source.dimensions.x/o),i*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(a,i,r){var o;return a instanceof t.Point?(r=i,o=a):o=new t.Point(a,i),o=o.rotate(-this.getRotation(r),this._getRotationPoint(r)),r?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(a,i,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new t.Point(a/this.source.dimensions.x*o,i/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(a,i,r){a instanceof t.Point&&(r=i,i=a.y,a=a.x);var o=this._imageToViewportDelta(a,i);return r?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(r),this._getRotationPoint(r))},imageToViewportRectangle:function(a,i,r,o,n){var s=a;s instanceof t.Rect?n=i:s=new t.Rect(a,i,r,o);var l=this.imageToViewportCoordinates(s.getTopLeft(),n),u=this._imageToViewportDelta(s.width,s.height,n);return new t.Rect(l.x,l.y,u.x,u.y,s.degrees+this.getRotation(n))},viewportToImageRectangle:function(a,i,r,o,n){var s=a;a instanceof t.Rect?n=i:s=new t.Rect(a,i,r,o);var l=this.viewportToImageCoordinates(s.getTopLeft(),n),u=this._viewportToImageDelta(s.width,s.height,n);return new t.Rect(l.x,l.y,u.x,u.y,s.degrees-this.getRotation(n))},viewerElementToImageCoordinates:function(a){var i=this.viewport.pointFromPixel(a,!0);return this.viewportToImageCoordinates(i)},imageToViewerElementCoordinates:function(a){var i=this.imageToViewportCoordinates(a);return this.viewport.pixelFromPoint(i,!0)},windowToImageCoordinates:function(a){var i=a.minus(h.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(i)},imageToWindowCoordinates:function(a){var i=this.imageToViewerElementCoordinates(a);return i.plus(h.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(a){var i=this._scaleSpring.current.value;return a=a.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new t.Rect((a.x-this._xSpring.current.value)/i,(a.y-this._ySpring.current.value)/i,a.width/i,a.height/i,a.degrees)},viewportToImageZoom:function(a){var i=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i*a},imageToViewportZoom:function(a){var i=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return a/i},setPosition:function(a,i){var r=this._xSpring.target.value===a.x&&this._ySpring.target.value===a.y;if(i){if(r&&this._xSpring.current.value===a.x&&this._ySpring.current.value===a.y)return;this._xSpring.resetTo(a.x),this._ySpring.resetTo(a.y),this._needsDraw=!0}else{if(r)return;this._xSpring.springTo(a.x),this._ySpring.springTo(a.y),this._needsDraw=!0}r||this._raiseBoundsChange()},setWidth:function(a,i){this._setScale(a,i)},setHeight:function(a,i){this._setScale(a/this.normHeight,i)},setCroppingPolygons:function(a){var i=function(o){return o instanceof t.Point||typeof o.x=="number"&&typeof o.y=="number"},r=function(o){return o.map(function(n){try{if(i(n))return{x:n.x,y:n.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!t.isArray(a))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=a.map(function(o){return r(o)})}catch(o){t.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),t.console.error(o),this._croppingPolygons=null}},resetCroppingPolygons:function(){this._croppingPolygons=null},fitBounds:function(a,i,r){i=i||t.Placement.CENTER;var o=t.Placement.properties[i],n=this.contentAspectX,s=0,l=0,u=1,d=1;if(this._clip&&(n=this._clip.getAspectRatio(),u=this._clip.width/this.source.dimensions.x,d=this._clip.height/this.source.dimensions.y,a.getAspectRatio()>n?(s=this._clip.x/this._clip.height*a.height,l=this._clip.y/this._clip.height*a.height):(s=this._clip.x/this._clip.width*a.width,l=this._clip.y/this._clip.width*a.width)),a.getAspectRatio()>n){var f=a.height/d,p=0;o.isHorizontallyCentered?p=(a.width-a.height*n)/2:o.isRight&&(p=a.width-a.height*n),this.setPosition(new t.Point(a.x-s+p,a.y-l),r),this.setHeight(f,r)}else{var v=a.width/u,w=0;o.isVerticallyCentered?w=(a.height-a.width/n)/2:o.isBottom&&(w=a.height-a.width/n),this.setPosition(new t.Point(a.x-s,a.y-l+w),r),this.setWidth(v,r)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(a){t.console.assert(!a||a instanceof t.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),a instanceof t.Rect?this._clip=a.clone():this._clip=null,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return!!this.flipped},setFlip:function(a){this.flipped=!!a,this._needsDraw=!0,this._raiseBoundsChange()},getOpacity:function(){return this.opacity},setOpacity:function(a){a!==this.opacity&&(this.opacity=a,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(a){this._preload=!!a,this._needsDraw=!0},getRotation:function(a){return a?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(a,i){this._degreesSpring.target.value===a&&this._degreesSpring.isAtTargetValue()||(i?this._degreesSpring.resetTo(a):this._degreesSpring.springTo(a),this._needsDraw=!0,this._raiseBoundsChange())},_getRotationPoint:function(a){return this.getBoundsNoRotate(a).getCenter()},getCompositeOperation:function(){return this.compositeOperation},setCompositeOperation:function(a){a!==this.compositeOperation&&(this.compositeOperation=a,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this.compositeOperation}))},_setScale:function(a,i){var r=this._scaleSpring.target.value===a;if(i){if(r&&this._scaleSpring.current.value===a)return;this._scaleSpring.resetTo(a),this._updateForScale(),this._needsDraw=!0}else{if(r)return;this._scaleSpring.springTo(a),this._updateForScale(),this._needsDraw=!0}r||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var a=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),i=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(i/this.minPixelRatio)/Math.log(2))));return r=Math.max(r,this.source.minLevel||0),a=Math.min(a,r),{lowestLevel:a,highestLevel:r}},_updateViewport:function(){for(this._needsDraw=!1,this._tilesLoading=0,this.loadingCoverage={};this.lastDrawn.length>0;){var a=this.lastDrawn.pop();a.beingDrawn=!1}var i=this.viewport,r=this._viewportToTiledImageRectangle(i.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var o=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));if(r=r.intersection(o),r===null)return}for(var n=this._getLevelsInterval(),s=n.lowestLevel,l=n.highestLevel,u=null,d=!1,f=t.now(),p=l;p>=s;p--){var v=!1,w=i.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(p),!0).x*this._scaleSpring.current.value;if(p===s||!d&&w>=this.minPixelRatio)v=!0,d=!0;else if(!d)continue;var C=i.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(p),!1).x*this._scaleSpring.current.value,b=i.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,P=this.immediateRender?1:b,R=Math.min(1,(w-.5)/.5),A=P/Math.abs(P-C);if(u=this._updateLevel(d,v,p,R,A,r,f,u),this._providesCoverage(this.coverage,p))break}this._drawTiles(this.lastDrawn),u&&!u.context2D?(this._loadTile(u,f),this._needsDraw=!0,this._setFullyLoaded(!1)):this._setFullyLoaded(this._tilesLoading===0)},_getCornerTiles:function(a,i,r){var o,n;this.wrapHorizontal?(o=t.positiveModulo(i.x,1),n=t.positiveModulo(r.x,1)):(o=Math.max(0,i.x),n=Math.min(1,r.x));var s,l,u=1/this.source.aspectRatio;this.wrapVertical?(s=t.positiveModulo(i.y,u),l=t.positiveModulo(r.y,u)):(s=Math.max(0,i.y),l=Math.min(u,r.y));var d=this.source.getTileAtPoint(a,new t.Point(o,s)),f=this.source.getTileAtPoint(a,new t.Point(n,l)),p=this.source.getNumTiles(a);return this.wrapHorizontal&&(d.x+=p.x*Math.floor(i.x),f.x+=p.x*Math.floor(r.x)),this.wrapVertical&&(d.y+=p.y*Math.floor(i.y/u),f.y+=p.y*Math.floor(r.y/u)),{topLeft:d,bottomRight:f}},_updateLevel:function(a,i,r,o,n,s,l,u){var d=s.getBoundingBox().getTopLeft(),f=s.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:a,level:r,opacity:o,visibility:n,drawArea:s,topleft:d,bottomright:f,currenttime:l,best:u}),this._resetCoverage(this.coverage,r),this._resetCoverage(this.loadingCoverage,r);var p=this._getCornerTiles(r,d,f),v=p.topLeft,w=p.bottomRight,C=this.source.getNumTiles(r),b=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(w.x+=1,this.wrapHorizontal||(w.x=Math.min(w.x,C.x-1)));for(var P=v.x;P<=w.x;P++)for(var R=v.y;R<=w.y;R++){var A;if(this.getFlip()){var W=(C.x+P%C.x)%C.x;A=P+C.x-W-W-1}else A=P;s.intersection(this.getTileBounds(r,A,R))!==null&&(u=this._updateTile(i,a,A,R,r,o,n,b,C,l,u))}return u},_updateTile:function(a,i,r,o,n,s,l,u,d,f,p){var v=this._getTile(r,o,n,f,d,this._worldWidthCurrent,this._worldHeightCurrent),w=i;this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:v}),this._setCoverage(this.coverage,n,r,o,!1);var C=v.loaded||v.loading||this._isCovered(this.loadingCoverage,n,r,o);if(this._setCoverage(this.loadingCoverage,n,r,o,C),!v.exists||(a&&!w&&(this._isCovered(this.coverage,n,r,o)?this._setCoverage(this.coverage,n,r,o,!0):w=!0),!w))return p;if(this._positionTile(v,this.source.tileOverlap,this.viewport,u,l),!v.loaded)if(v.context2D)this._setTileLoaded(v);else{var b=this._tileCache.getImageRecord(v.cacheKey);if(b){var P=b.getImage();this._setTileLoaded(v,P)}}if(v.loaded){var R=this._blendTile(v,r,o,n,s,f);R&&(this._needsDraw=!0)}else v.loading?this._tilesLoading++:C||(p=this._compareTiles(p,v));return p},_getTile:function(a,i,r,o,n,s,l){var u,d,f,p,v,w,C,b,P,R,A=this.tilesMatrix,W=this.source;return A[r]||(A[r]={}),A[r][a]||(A[r][a]={}),(!A[r][a][i]||!A[r][a][i].flipped!=!this.flipped)&&(u=(n.x+a%n.x)%n.x,d=(n.y+i%n.y)%n.y,f=this.getTileBounds(r,a,i),p=W.getTileBounds(r,u,d,!0),v=W.tileExists(r,u,d),w=W.getTileUrl(r,u,d),C=W.getTilePostData(r,u,d),this.loadTilesWithAjax?(b=W.getTileAjaxHeaders(r,u,d),t.isPlainObject(this.ajaxHeaders)&&(b=t.extend({},this.ajaxHeaders,b))):b=null,P=W.getContext2D?W.getContext2D(r,u,d):void 0,R=new t.Tile(r,a,i,f,v,w,P,this.loadTilesWithAjax,b,p,C,W.getTileHashKey(r,u,d,w,b,C)),this.getFlip()?u===0&&(R.isRightMost=!0):u===n.x-1&&(R.isRightMost=!0),d===n.y-1&&(R.isBottomMost=!0),R.flipped=this.flipped,A[r][a][i]=R),R=A[r][a][i],R.lastTouchTime=o,R},_loadTile:function(a,i){var r=this;a.loading=!0,this._imageLoader.addJob({src:a.url,postData:a.postData,loadWithAjax:a.loadWithAjax,ajaxHeaders:a.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,n,s){r._onTileLoad(a,i,o,n,s)},abort:function(){a.loading=!1}})},_onTileLoad:function(a,i,r,o,n){if(!r){t.console.error("Tile %s failed to load: %s - error: %s",a,a.url,o),this.viewer.raiseEvent("tile-load-failed",{tile:a,tiledImage:this,time:i,message:o,tileRequest:n}),a.loading=!1,a.exists=!1;return}if(i<this.lastResetTime){t.console.warn("Ignoring tile %s loaded before reset: %s",a,a.url),a.loading=!1;return}var s=this,l=function(){var u=s.source,d=u.getClosestLevel();s._setTileLoaded(a,r,d,n)};this._midDraw?window.setTimeout(l,1):l()},_setTileLoaded:function(a,i,r,o){var n=0,s=this;function l(){return n++,u}function u(){n--,n===0&&(a.loading=!1,a.loaded=!0,a.context2D||s._tileCache.cacheTile({image:i,tile:a,cutoff:r,tiledImage:s}),s._needsDraw=!0)}this.viewer.raiseEvent("tile-loaded",{tile:a,tiledImage:this,tileRequest:o,image:i,getCompletionCallback:l}),l()()},_positionTile:function(a,i,r,o,n){var s=a.bounds.getTopLeft();s.x*=this._scaleSpring.current.value,s.y*=this._scaleSpring.current.value,s.x+=this._xSpring.current.value,s.y+=this._ySpring.current.value;var l=a.bounds.getSize();l.x*=this._scaleSpring.current.value,l.y*=this._scaleSpring.current.value;var u=r.pixelFromPointNoRotate(s,!0),d=r.pixelFromPointNoRotate(s,!1),f=r.deltaPixelsFromPointsNoRotate(l,!0),p=r.deltaPixelsFromPointsNoRotate(l,!1),v=d.plus(p.divide(2)),w=o.squaredDistanceTo(v);i||(f=f.plus(new t.Point(1,1))),a.isRightMost&&this.wrapHorizontal&&(f.x+=.75),a.isBottomMost&&this.wrapVertical&&(f.y+=.75),a.position=u,a.size=f,a.squaredDistance=w,a.visibility=n},_blendTile:function(a,i,r,o,n,s){var l=1e3*this.blendTime,u,d;if(a.blendStart||(a.blendStart=s),u=s-a.blendStart,d=l?Math.min(1,u/l):1,this.alwaysBlend&&(d*=n),a.opacity=d,this.lastDrawn.push(a),d===1)this._setCoverage(this.coverage,o,i,r,!0),this._hasOpaqueTile=!0;else if(u<l)return!0;return!1},_compareTiles:function(a,i){return!a||i.visibility>a.visibility||i.visibility===a.visibility&&i.squaredDistance<a.squaredDistance?i:a},_drawTiles:function(a){if(!(this.opacity===0||a.length===0&&!this.placeholderFillStyle)){var i=a[0],r;i&&(r=this.opacity<1||this.compositeOperation&&this.compositeOperation!=="source-over"||!this._isBottomItem()&&i._hasTransparencyChannel());var o,n,s=this.viewport.getZoom(!0),l=this.viewportToImageZoom(s);a.length>1&&l>this.smoothTileEdgesMinZoom&&!this.iOSDevice&&this.getRotation(!0)%360===0&&t.supportsCanvas&&this.viewer.useCanvas&&(r=!0,o=i.getScaleForEdgeSmoothing(),n=i.getTranslationForEdgeSmoothing(o,this._drawer.getCanvasSize(!1),this._drawer.getCanvasSize(!0)));var u;r&&(o||(u=this.viewport.viewportToViewerElementRectangle(this.getClippedBounds(!0)).getIntegerBoundingBox(),this._drawer.viewer.viewport.getFlip()&&(this.viewport.degrees!==0||this.getRotation(!0)%360!==0)&&(u.x=this._drawer.viewer.container.clientWidth-(u.x+u.width)),u=u.times(t.pixelDensityRatio)),this._drawer._clear(!0,u)),o||(this.viewport.degrees!==0&&this._drawer._offsetForRotation({degrees:this.viewport.degrees,useSketch:r}),this.getRotation(!0)%360!==0&&this._drawer._offsetForRotation({degrees:this.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(this._getRotationPoint(!0),!0),useSketch:r}),this.viewport.degrees===0&&this.getRotation(!0)%360===0&&this._drawer.viewer.viewport.getFlip()&&this._drawer._flip());var d=!1;if(this._clip){this._drawer.saveContext(r);var f=this.imageToViewportRectangle(this._clip,!0);f=f.rotate(-this.getRotation(!0),this._getRotationPoint(!0));var p=this._drawer.viewportToDrawerRectangle(f);o&&(p=p.times(o)),n&&(p=p.translate(n)),this._drawer.setClip(p,r),d=!0}if(this._croppingPolygons){this._drawer.saveContext(r);try{var v=this._croppingPolygons.map(function(W){return W.map(function($){var X=this.imageToViewportCoordinates($.x,$.y,!0).rotate(-this.getRotation(!0),this._getRotationPoint(!0)),re=this._drawer.viewportCoordToDrawerCoord(X);return o&&(re=re.times(o)),re})});this._drawer.clipWithPolygons(v,r)}catch(W){t.console.error(W)}d=!0}if(this.placeholderFillStyle&&this._hasOpaqueTile===!1){var w=this._drawer.viewportToDrawerRectangle(this.getBounds(!0));o&&(w=w.times(o)),n&&(w=w.translate(n));var C=null;typeof this.placeholderFillStyle=="function"?C=this.placeholderFillStyle(this,this._drawer.context):C=this.placeholderFillStyle,this._drawer.drawRectangle(w,C,r)}var b=y(this.subPixelRoundingForTransparency),P=!1;if(b===t.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)P=!0;else if(b===t.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var R=this.viewer&&this.viewer.isAnimating();P=!R}for(var A=a.length-1;A>=0;A--)i=a[A],this._drawer.drawTile(i,this._drawingHandler,r,o,n,P),i.beingDrawn=!0,this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:this,tile:i});d&&this._drawer.restoreContext(r),o||(this.getRotation(!0)%360!==0&&this._drawer._restoreRotationChanges(r),this.viewport.degrees!==0&&this._drawer._restoreRotationChanges(r)),r&&(o&&(this.viewport.degrees!==0&&this._drawer._offsetForRotation({degrees:this.viewport.degrees,useSketch:!1}),this.getRotation(!0)%360!==0&&this._drawer._offsetForRotation({degrees:this.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(this._getRotationPoint(!0),!0),useSketch:!1})),this._drawer.blendSketch({opacity:this.opacity,scale:o,translate:n,compositeOperation:this.compositeOperation,bounds:u}),o&&(this.getRotation(!0)%360!==0&&this._drawer._restoreRotationChanges(!1),this.viewport.degrees!==0&&this._drawer._restoreRotationChanges(!1))),o||this.viewport.degrees===0&&this.getRotation(!0)%360===0&&this._drawer.viewer.viewport.getFlip()&&this._drawer._flip(),this._drawDebugInfo(a)}},_drawDebugInfo:function(a){if(this.debugMode)for(var i=a.length-1;i>=0;i--){var r=a[i];try{this._drawer.drawDebugInfo(r,a.length,i,this)}catch(o){t.console.error(o)}}},_providesCoverage:function(a,i,r,o){var n,s,l,u;if(!a[i])return!1;if(r===void 0||o===void 0){n=a[i];for(l in n)if(Object.prototype.hasOwnProperty.call(n,l)){s=n[l];for(u in s)if(Object.prototype.hasOwnProperty.call(s,u)&&!s[u])return!1}return!0}return a[i][r]===void 0||a[i][r][o]===void 0||a[i][r][o]===!0},_isCovered:function(a,i,r,o){return r===void 0||o===void 0?this._providesCoverage(a,i+1):this._providesCoverage(a,i+1,2*r,2*o)&&this._providesCoverage(a,i+1,2*r,2*o+1)&&this._providesCoverage(a,i+1,2*r+1,2*o)&&this._providesCoverage(a,i+1,2*r+1,2*o+1)},_setCoverage:function(a,i,r,o,n){if(!a[i]){t.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",i);return}a[i][r]||(a[i][r]={}),a[i][r][o]=n},_resetCoverage:function(a,i){a[i]={}}});var c=t.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function g(a){return a!==t.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&a!==t.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&a!==t.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function m(a){return g(a)?c:a}function y(a){if(typeof a=="number")return m(a);if(!a||!t.Browser)return c;var i=a[t.Browser.vendor];return g(i)&&(i=a["*"]),m(i)}}(h),function(t){var c=function(m){t.console.assert(m,"[TileCache.cacheTile] options is required"),t.console.assert(m.tile,"[TileCache.cacheTile] options.tile is required"),t.console.assert(m.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=m.tile,this.tiledImage=m.tiledImage},g=function(m){t.console.assert(m,"[ImageRecord] options is required"),t.console.assert(m.image,"[ImageRecord] options.image is required"),this._image=m.image,this._tiles=[]};g.prototype={destroy:function(){this._image=null,this._renderedContext=null,this._tiles=null},getImage:function(){return this._image},getRenderedContext:function(){if(!this._renderedContext){var m=document.createElement("canvas");m.width=this._image.width,m.height=this._image.height,this._renderedContext=m.getContext("2d"),this._renderedContext.drawImage(this._image,0,0),this._image=null}return this._renderedContext},setRenderedContext:function(m){t.console.error("ImageRecord.setRenderedContext is deprecated. The rendered context should be created by the ImageRecord itself when calling ImageRecord.getRenderedContext."),this._renderedContext=m},addTile:function(m){t.console.assert(m,"[ImageRecord.addTile] tile is required"),this._tiles.push(m)},removeTile:function(m){for(var y=0;y<this._tiles.length;y++)if(this._tiles[y]===m){this._tiles.splice(y,1);return}t.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",m)},getTileCount:function(){return this._tiles.length}},t.TileCache=function(m){m=m||{},this._maxImageCacheCount=m.maxImageCacheCount||t.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},t.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(m){t.console.assert(m,"[TileCache.cacheTile] options is required"),t.console.assert(m.tile,"[TileCache.cacheTile] options.tile is required"),t.console.assert(m.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),t.console.assert(m.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var y=m.cutoff||0,a=this._tilesLoaded.length,i=this._imagesLoaded[m.tile.cacheKey];if(i||(t.console.assert(m.image,"[TileCache.cacheTile] options.image is required to create an ImageRecord"),i=this._imagesLoaded[m.tile.cacheKey]=new g({image:m.image}),this._imagesLoadedCount++),i.addTile(m.tile),m.tile.cacheImageRecord=i,this._imagesLoadedCount>this._maxImageCacheCount){for(var r=null,o=-1,n=null,s,l,u,d,f,p,v=this._tilesLoaded.length-1;v>=0;v--)if(p=this._tilesLoaded[v],s=p.tile,!(s.level<=y||s.beingDrawn)){if(!r){r=s,o=v,n=p;continue}d=s.lastTouchTime,l=r.lastTouchTime,f=s.level,u=r.level,(d<l||d===l&&f>u)&&(r=s,o=v,n=p)}r&&o>=0&&(this._unloadTile(n),a=o)}this._tilesLoaded[a]=new c({tile:m.tile,tiledImage:m.tiledImage})},clearTilesFor:function(m){t.console.assert(m,"[TileCache.clearTilesFor] tiledImage is required");for(var y,a=0;a<this._tilesLoaded.length;++a)y=this._tilesLoaded[a],y.tiledImage===m&&(this._unloadTile(y),this._tilesLoaded.splice(a,1),a--)},getImageRecord:function(m){return t.console.assert(m,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[m]},_unloadTile:function(m){t.console.assert(m,"[TileCache._unloadTile] tileRecord is required");var y=m.tile,a=m.tiledImage;y.unload(),y.cacheImageRecord=null;var i=this._imagesLoaded[y.cacheKey];i.removeTile(y),i.getTileCount()||(i.destroy(),delete this._imagesLoaded[y.cacheKey],this._imagesLoadedCount--),a.viewer.raiseEvent("tile-unloaded",{tile:y,tiledImage:a})}}}(h),function(t){t.World=function(c){var g=this;t.console.assert(c.viewer,"[World] options.viewer is required"),t.EventSource.call(this),this.viewer=c.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(m){g._autoRefigureSizes?g._figureSizes():g._needsSizesFigured=!0},this._figureSizes()},t.extend(t.World.prototype,t.EventSource.prototype,{addItem:function(c,g){if(t.console.assert(c,"[World.addItem] item is required"),t.console.assert(c instanceof t.TiledImage,"[World.addItem] only TiledImages supported at this time"),g=g||{},g.index!==void 0){var m=Math.max(0,Math.min(this._items.length,g.index));this._items.splice(m,0,c)}else this._items.push(c);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,c.addHandler("bounds-change",this._delegatedFigureSizes),c.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:c})},getItemAt:function(c){return t.console.assert(c!==void 0,"[World.getItemAt] index is required"),this._items[c]},getIndexOfItem:function(c){return t.console.assert(c,"[World.getIndexOfItem] item is required"),t.indexOf(this._items,c)},getItemCount:function(){return this._items.length},setItemIndex:function(c,g){t.console.assert(c,"[World.setItemIndex] item is required"),t.console.assert(g!==void 0,"[World.setItemIndex] index is required");var m=this.getIndexOfItem(c);if(g>=this._items.length)throw new Error("Index bigger than number of layers.");g===m||m===-1||(this._items.splice(m,1),this._items.splice(g,0,c),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:c,previousIndex:m,newIndex:g}))},removeItem:function(c){t.console.assert(c,"[World.removeItem] item is required");var g=t.indexOf(this._items,c);g!==-1&&(c.removeHandler("bounds-change",this._delegatedFigureSizes),c.removeHandler("clip-change",this._delegatedFigureSizes),c.destroy(),this._items.splice(g,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(c))},removeAll:function(){this.viewer._cancelPendingImages();var c,g;for(g=0;g<this._items.length;g++)c=this._items[g],c.removeHandler("bounds-change",this._delegatedFigureSizes),c.removeHandler("clip-change",this._delegatedFigureSizes),c.destroy();var m=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,g=0;g<m.length;g++)c=m[g],this._raiseRemoveItem(c)},resetItems:function(){for(var c=0;c<this._items.length;c++)this._items[c].reset()},update:function(){for(var c=!1,g=0;g<this._items.length;g++)c=this._items[g].update()||c;return c},draw:function(){for(var c=0;c<this._items.length;c++)this._items[c].draw();this._needsDraw=!1},needsDraw:function(){for(var c=0;c<this._items.length;c++)if(this._items[c].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(c){this._autoRefigureSizes=c,c&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(c){c=c||{};var g=c.immediately||!1,m=c.layout||t.DEFAULT_SETTINGS.collectionLayout,y=c.rows||t.DEFAULT_SETTINGS.collectionRows,a=c.columns||t.DEFAULT_SETTINGS.collectionColumns,i=c.tileSize||t.DEFAULT_SETTINGS.collectionTileSize,r=c.tileMargin||t.DEFAULT_SETTINGS.collectionTileMargin,o=i+r,n;!c.rows&&a?n=a:n=Math.ceil(this._items.length/y);var s=0,l=0,u,d,f,p,v;this.setAutoRefigureSizes(!1);for(var w=0;w<this._items.length;w++)w&&w%n===0&&(m==="horizontal"?(l+=o,s=0):(s+=o,l=0)),u=this._items[w],d=u.getBounds(),d.width>d.height?f=i:f=i*(d.width/d.height),p=f*(d.height/d.width),v=new t.Point(s+(i-f)/2,l+(i-p)/2),u.setPosition(v,g),u.setWidth(f,g),m==="horizontal"?s+=o:l+=o;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var c=this._homeBounds?this._homeBounds.clone():null,g=this._contentSize?this._contentSize.clone():null,m=this._contentFactor||0;if(!this._items.length)this._homeBounds=new t.Rect(0,0,1,1),this._contentSize=new t.Point(1,1),this._contentFactor=1;else{var y=this._items[0],a=y.getBounds();this._contentFactor=y.getContentSize().x/a.width;for(var i=y.getClippedBounds().getBoundingBox(),r=i.x,o=i.y,n=i.x+i.width,s=i.y+i.height,l=1;l<this._items.length;l++)y=this._items[l],a=y.getBounds(),this._contentFactor=Math.max(this._contentFactor,y.getContentSize().x/a.width),i=y.getClippedBounds().getBoundingBox(),r=Math.min(r,i.x),o=Math.min(o,i.y),n=Math.max(n,i.x+i.width),s=Math.max(s,i.y+i.height);this._homeBounds=new t.Rect(r,o,n-r,s-o),this._contentSize=new t.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==m||!this._homeBounds.equals(c)||!this._contentSize.equals(g))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(c){this.raiseEvent("remove-item",{item:c})}})}(h)})(dn);var Ie=dn.exports;(function(e){window.OpenSeadragon=e;var h=window.OpenSeadragon;if(!h&&(h=require("openseadragon"),!h))throw new Error("OpenSeadragon is missing.");if(!h.version||h.version.major<2||h.version.major===2&&h.version.minor<1)throw new Error("Filtering plugin requires OpenSeadragon version >= 2.1");h.Viewer.prototype.setFilterOptions=function(y){this.filterPluginInstance?t(this.filterPluginInstance,y):(y=y||{},y.viewer=this,this.filterPluginInstance=new h.FilterPlugin(y))},h.FilterPlugin=function(y){if(y=y||{},!y.viewer)throw new Error("A viewer must be specified.");var a=this;this.viewer=y.viewer,this.viewer.addHandler("tile-loaded",i),this.viewer.addHandler("tile-drawing",o),this.filterIncrement=0,t(this,y);function i(n){var s=m(a,n.tiledImage);if(s.length!==0){var l=n.tile,u=n.image;if(u!=null){var d=window.document.createElement("canvas");d.width=u.width,d.height=u.height;var f=d.getContext("2d");f.drawImage(u,0,0),l._renderedContext=f;var p=n.getCompletionCallback();r(f,s,p),l._filterIncrement=a.filterIncrement}}}function r(n,s,l){if(l){for(var u=a.filterIncrement,d=[],f=0;f<s.length-1;f++)(function(p){d[p]=function(){a.filterIncrement===u&&s[p+1](n,d[p+1])}})(f);d[s.length-1]=function(){a.filterIncrement===u&&l()},s[0](n,d[0])}else for(var f=0;f<s.length;f++)s[f](n,function(){})}function o(n){var s=n.tile,l=n.rendered;if(l._filterIncrement!==a.filterIncrement){var u=m(a,n.tiledImage);if(u.length===0){l._originalImageData&&(l.putImageData(l._originalImageData,0,0),delete l._originalImageData),l._filterIncrement=a.filterIncrement;return}if(l._originalImageData?l.putImageData(l._originalImageData,0,0):l._originalImageData=l.getImageData(0,0,l.canvas.width,l.canvas.height),s._renderedContext){if(s._filterIncrement===a.filterIncrement){var d=s._renderedContext.getImageData(0,0,s._renderedContext.canvas.width,s._renderedContext.canvas.height);l.putImageData(d,0,0),delete s._renderedContext,delete s._filterIncrement,l._filterIncrement=a.filterIncrement;return}delete s._renderedContext,delete s._filterIncrement}r(l,u),l._filterIncrement=a.filterIncrement}}};function t(y,a){a=a||{};var i=a.filters;y.filters=i?h.isArray(i)?i:[i]:[];for(var r=0;r<y.filters.length;r++){var o=y.filters[r];if(!o.processors)throw new Error("Filter processors must be specified.");o.processors=h.isArray(o.processors)?o.processors:[o.processors]}if(y.filterIncrement++,a.loadMode==="sync")y.viewer.forceRedraw();else{for(var n=[],r=0;r<y.filters.length;r++){var o=y.filters[r];if(!o.items){n=g(y.viewer.world);break}if(h.isArray(o.items))for(var s=0;s<o.items.length;s++)c(o.items[s],n);else c(o.items,n)}for(var r=0;r<n.length;r++)n[r].reset()}}function c(y,a){if(a.indexOf(y)>=0)throw new Error("An item can not have filters assigned multiple times.");a.push(y)}function g(y){for(var a=[],i=0;i<y.getItemCount();i++)a.push(y.getItemAt(i));return a}function m(y,a){if(y.filters.length===0)return[];for(var i=null,r=0;r<y.filters.length;r++){var o=y.filters[r];if(!o.items)i=o.processors;else if(o.items===a||h.isArray(o.items)&&o.items.indexOf(a)>=0)return o.processors}return i||[]}h.Filters={THRESHOLDING:function(y){if(y<0||y>255)throw new Error("Threshold must be between 0 and 255.");return function(a,i){for(var r=a.getImageData(0,0,a.canvas.width,a.canvas.height),o=r.data,n=0;n<o.length;n+=4){var s=o[n],l=o[n+1],u=o[n+2],d=(s+l+u)/3;o[n]=o[n+1]=o[n+2]=d<y?0:255}a.putImageData(r,0,0),i()}},BRIGHTNESS:function(y){if(y<-255||y>255)throw new Error("Brightness adjustment must be between -255 and 255.");for(var a=[],i=0;i<256;i++)a[i]=i+y;return function(r,o){for(var n=r.getImageData(0,0,r.canvas.width,r.canvas.height),s=n.data,l=0;l<s.length;l+=4)s[l]=a[s[l]],s[l+1]=a[s[l+1]],s[l+2]=a[s[l+2]];r.putImageData(n,0,0),o()}},CONTRAST:function(y){if(y<0)throw new Error("Contrast adjustment must be positive.");for(var a=[],i=0;i<256;i++)a[i]=i*y;return function(r,o){for(var n=r.getImageData(0,0,r.canvas.width,r.canvas.height),s=n.data,l=0;l<s.length;l+=4)s[l]=a[s[l]],s[l+1]=a[s[l+1]],s[l+2]=a[s[l+2]];r.putImageData(n,0,0),o()}},GAMMA:function(y){if(y<0)throw new Error("Gamma adjustment must be positive.");for(var a=[],i=0;i<256;i++)a[i]=Math.pow(i/255,y)*255;return function(r,o){for(var n=r.getImageData(0,0,r.canvas.width,r.canvas.height),s=n.data,l=0;l<s.length;l+=4)s[l]=a[s[l]],s[l+1]=a[s[l+1]],s[l+2]=a[s[l+2]];r.putImageData(n,0,0),o()}},GREYSCALE:function(){return function(y,a){for(var i=y.getImageData(0,0,y.canvas.width,y.canvas.height),r=i.data,o=0;o<r.length;o+=4){var n=(r[o]+r[o+1]+r[o+2])/3;r[o]=n,r[o+1]=n,r[o+2]=n}y.putImageData(i,0,0),a()}},INVERT:function(){for(var y=[],a=0;a<256;a++)y[a]=255-a;return function(i,r){for(var o=i.getImageData(0,0,i.canvas.width,i.canvas.height),n=o.data,s=0;s<n.length;s+=4)n[s]=y[n[s]],n[s+1]=y[n[s+1]],n[s+2]=y[n[s+2]];i.putImageData(o,0,0),r()}},MORPHOLOGICAL_OPERATION:function(y,a){if(y%2===0)throw new Error("The kernel size must be an odd number.");var i=Math.floor(y/2);if(!a)throw new Error("A comparator must be defined.");return function(r,o){for(var n=r.canvas.width,s=r.canvas.height,l=r.getImageData(0,0,n,s),u=r.getImageData(0,0,n,s).data,d,f=0;f<s;f++)for(var p=0;p<n;p++){d=(f*n+p)*4;for(var v=u[d],w=u[d+1],C=u[d+2],b=0;b<y;b++)for(var P=0;P<y;P++){var R=p+P-i,A=f+b-i;R>=0&&R<n&&A>=0&&A<s&&(d=(A*n+R)*4,v=a(u[d],v),w=a(u[d+1],w),C=a(u[d+2],C))}l.data[d]=v,l.data[d+1]=w,l.data[d+2]=C}r.putImageData(l,0,0),o()}},CONVOLUTION:function(y){if(!h.isArray(y))throw new Error("The kernel must be an array.");var a=Math.sqrt(y.length);if((a+1)%2!==0)throw new Error("The kernel must be a square matrix with oddwidth and height.");var i=(a-1)/2;return function(r,o){for(var n=r.canvas.width,s=r.canvas.height,l=r.getImageData(0,0,n,s),u=r.getImageData(0,0,n,s).data,d,f=0;f<s;f++)for(var p=0;p<n;p++){for(var v=0,w=0,C=0,b=0;b<a;b++)for(var P=0;P<a;P++){var R=p+P-i,A=f+b-i;if(R>=0&&R<n&&A>=0&&A<s){d=(A*n+R)*4;var W=y[b*a+P];v+=u[d]*W,w+=u[d+1]*W,C+=u[d+2]*W}}d=(f*n+p)*4,l.data[d]=v,l.data[d+1]=w,l.data[d+2]=C}r.putImageData(l,0,0),o()}},COLORMAP:function(y,a){for(var i=y.slice(0),r=255-a,o=0;o<256;o++){var n=0;o>a?n=Math.min((o-a)/r*128+128,255)|0:n=Math.max(0,o/(a/128))|0,i[o]=y[n]}return function(s,l){for(var u=s.getImageData(0,0,s.canvas.width,s.canvas.height),d=u.data,f=0;f<d.length;f+=4){var p=(d[f]+d[f+1]+d[f+2])/3|0,v=i[p];d[f]=v[0],d[f+1]=v[1],d[f+2]=v[2]}s.putImageData(u,0,0),l()}}}})(Ie);(function(e){if(window.OpenSeadragon=e,!window.OpenSeadragon&&(e=require("openseadragon"),!e)){console.error("[openseadragon-canvas-overlay] requires OpenSeadragon");return}e.Viewer.prototype.fabricjsOverlay=function(c){return this._fabricjsOverlayInfo=new t(this,c.static),c&&c.scale?this._fabricjsOverlayInfo._scale=c.scale:this._fabricjsOverlayInfo._scale=1e3,this._fabricjsOverlayInfo};let h=function(){let c=1;return function(){return c++}}(),t=function(c,g){let m=this;this._viewer=c,this._containerWidth=0,this._containerHeight=0,this._canvasdiv=document.createElement("div"),this._canvasdiv.style.position="absolute",this._canvasdiv.style.left="0px",this._canvasdiv.style.top="0px",this._canvasdiv.style.width="100%",this._canvasdiv.style.height="100%",this._viewer.canvas.appendChild(this._canvasdiv),this._canvas=document.createElement("canvas"),this._id="osd-overlaycanvas-"+h(),this._canvas.setAttribute("id",this._id),this._canvasdiv.appendChild(this._canvas),this.resize(),g?this._fabricCanvas=new fabric.StaticCanvas(this._canvas):this._fabricCanvas=new fabric.Canvas(this._canvas),this._fabricCanvas.selection=!1,this._fabricCanvas.on("mouse:down",function(y){y.target&&(y.e.preventDefaultAction=!0,y.e.preventDefault(),y.e.stopPropagation())}),this._fabricCanvas.on("mouse:up",function(y){y.target&&(y.e.preventDefaultAction=!0,y.e.preventDefault(),y.e.stopPropagation())}),this._viewer.addHandler("update-viewport",function(){m.resize(),m.resizeCanvas(),m.render()}),window.addEventListener("resize",function(){m.resize(),m.resizeCanvas()})};t.prototype={canvas:function(){return this._canvas},fabricCanvas:function(){return this._fabricCanvas},clear:function(){this._fabricCanvas.clear()},render:function(){this._fabricCanvas.renderAll()},resize:function(){this._containerWidth!==this._viewer.container.clientWidth&&(this._containerWidth=this._viewer.container.clientWidth,this._canvasdiv.setAttribute("width",this._containerWidth),this._canvas.setAttribute("width",this._containerWidth)),this._containerHeight!==this._viewer.container.clientHeight&&(this._containerHeight=this._viewer.container.clientHeight,this._canvasdiv.setAttribute("height",this._containerHeight),this._canvas.setAttribute("height",this._containerHeight))},resizeCanvas:function(){let c=new e.Point(0,0),g=this._viewer.viewport.getZoom(!0);this._fabricCanvas.setWidth(this._containerWidth),this._fabricCanvas.setHeight(this._containerHeight);let m=this._viewer.viewport._containerInnerSize.x*g;this._fabricCanvas.setZoom(m);let y=this._viewer.viewport.viewportToWindowCoordinates(c),a=Math.round(y.x),i=Math.round(y.y),r=this._canvasdiv.getBoundingClientRect(),o=e.getPageScroll();this._fabricCanvas.absolutePan(new fabric.Point(r.left-a+o.x,r.top-i+o.y))}}})(Ie);(function(e){if(!e.version||e.version.major<2)throw new Error("This version of OpenSeadragonScalebar requires OpenSeadragon version 2.0.0+");e.Viewer.prototype.scalebar=function(o){this.scalebarInstance?this.scalebarInstance.refresh(o):(o=o||{},o.viewer=this,this.scalebarInstance=new e.Scalebar(o))},e.ScalebarType={NONE:0,MICROSCOPY:1,MAP:2},e.ScalebarLocation={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4},e.Scalebar=function(o){if(o=o||{},!o.viewer)throw new Error("A viewer must be specified.");this.viewer=o.viewer,this.divElt=document.createElement("div"),this.divElt.id="openSeadragonScaleBar",this.viewer.container.appendChild(this.divElt),this.divElt.style.position="relative",this.divElt.style.margin="0",this.divElt.style.pointerEvents="none",this.setMinWidth(o.minWidth||"150px"),this.setDrawScalebarFunction(o.type||e.ScalebarType.MICROSCOPY),this.color=o.color||"black",this.fontColor=o.fontColor||"black",this.backgroundColor=o.backgroundColor||"none",this.fontSize=o.fontSize||"",this.fontFamily=o.fontFamily||"",this.barThickness=o.barThickness||2,this.pixelsPerMeter=o.pixelsPerMeter||null,this.referenceItemIdx=o.referenceItemIdx||0,this.location=o.location||e.ScalebarLocation.BOTTOM_LEFT,this.xOffset=o.xOffset||5,this.yOffset=o.yOffset||5,this.stayInsideImage=r(o.stayInsideImage)?o.stayInsideImage:!0,this.sizeAndTextRenderer=o.sizeAndTextRenderer||e.ScalebarSizeAndTextRenderer.METRIC_LENGTH;var n=this;this.viewer.addHandler("open",function(){n.refresh()}),this.viewer.addHandler("animation",function(){n.refresh()}),this.viewer.addHandler("resize",function(){n.refresh()})},e.Scalebar.prototype={updateOptions:function(o){!o||(r(o.type)&&this.setDrawScalebarFunction(o.type),r(o.minWidth)&&this.setMinWidth(o.minWidth),r(o.color)&&(this.color=o.color),r(o.fontColor)&&(this.fontColor=o.fontColor),r(o.backgroundColor)&&(this.backgroundColor=o.backgroundColor),r(o.fontSize)&&(this.fontSize=o.fontSize),r(o.fontFamily)&&(this.fontFamily=o.fontFamily),r(o.barThickness)&&(this.barThickness=o.barThickness),r(o.pixelsPerMeter)&&(this.pixelsPerMeter=o.pixelsPerMeter),r(o.referenceItemIdx)&&(this.referenceItemIdx=o.referenceItemIdx),r(o.location)&&(this.location=o.location),r(o.xOffset)&&(this.xOffset=o.xOffset),r(o.yOffset)&&(this.yOffset=o.yOffset),r(o.stayInsideImage)&&(this.stayInsideImage=o.stayInsideImage),r(o.sizeAndTextRenderer)&&(this.sizeAndTextRenderer=o.sizeAndTextRenderer))},setDrawScalebarFunction:function(o){o?o===e.ScalebarType.MAP?this.drawScalebar=this.drawMapScalebar:this.drawScalebar=this.drawMicroscopyScalebar:this.drawScalebar=null},setMinWidth:function(o){this.divElt.style.width=o,this.divElt.style.display="",this.minWidth=this.divElt.offsetWidth},refresh:function(o){if(this.updateOptions(o),!this.viewer.isOpen()||!this.drawScalebar||!this.pixelsPerMeter||!this.location){this.divElt.style.display="none";return}this.divElt.style.display="";var n=this.viewer.viewport,s=this.viewer.world.getItemAt(this.referenceItemIdx),l=h(s,n.getZoom(!0)),u=l*this.pixelsPerMeter,d=this.sizeAndTextRenderer(u,this.minWidth);this.drawScalebar(d.size,d.text);var f=this.getScalebarLocation();this.divElt.style.left=f.x+"px",this.divElt.style.top=f.y+"px"},drawMicroscopyScalebar:function(o,n){this.divElt.style.fontSize=this.fontSize,this.divElt.style.fontFamily=this.fontFamily,this.divElt.style.textAlign="center",this.divElt.style.color=this.fontColor,this.divElt.style.border="none",this.divElt.style.borderBottom=this.barThickness+"px solid "+this.color,this.divElt.style.backgroundColor=this.backgroundColor,this.divElt.innerHTML=n,this.divElt.style.width=o+"px"},drawMapScalebar:function(o,n){this.divElt.style.fontSize=this.fontSize,this.divElt.style.fontFamily=this.fontFamily,this.divElt.style.textAlign="center",this.divElt.style.color=this.fontColor,this.divElt.style.border=this.barThickness+"px solid "+this.color,this.divElt.style.borderTop="none",this.divElt.style.backgroundColor=this.backgroundColor,this.divElt.innerHTML=n,this.divElt.style.width=o+"px"},getScalebarLocation:function(){if(this.location===e.ScalebarLocation.TOP_LEFT){var o=0,n=0;if(this.stayInsideImage){var s=this.viewer.viewport.pixelFromPoint(new e.Point(0,0),!0);this.viewer.wrapHorizontal||(o=Math.max(s.x,0)),this.viewer.wrapVertical||(n=Math.max(s.y,0))}return new e.Point(o+this.xOffset,n+this.yOffset)}if(this.location===e.ScalebarLocation.TOP_RIGHT){var l=this.divElt.offsetWidth,u=this.viewer.container,o=u.offsetWidth-l,n=0;if(this.stayInsideImage){var s=this.viewer.viewport.pixelFromPoint(new e.Point(1,0),!0);this.viewer.wrapHorizontal||(o=Math.min(o,s.x-l)),this.viewer.wrapVertical||(n=Math.max(n,s.y))}return new e.Point(o-this.xOffset,n+this.yOffset)}if(this.location===e.ScalebarLocation.BOTTOM_RIGHT){var l=this.divElt.offsetWidth,d=this.divElt.offsetHeight,u=this.viewer.container,o=u.offsetWidth-l,n=u.offsetHeight-d;if(this.stayInsideImage){var s=this.viewer.viewport.pixelFromPoint(new e.Point(1,1/this.viewer.source.aspectRatio),!0);this.viewer.wrapHorizontal||(o=Math.min(o,s.x-l)),this.viewer.wrapVertical||(n=Math.min(n,s.y-d))}return new e.Point(o-this.xOffset,n-this.yOffset)}if(this.location===e.ScalebarLocation.BOTTOM_LEFT){var d=this.divElt.offsetHeight,u=this.viewer.container,o=0,n=u.offsetHeight-d;if(this.stayInsideImage){var s=this.viewer.viewport.pixelFromPoint(new e.Point(0,1/this.viewer.source.aspectRatio),!0);this.viewer.wrapHorizontal||(o=Math.max(o,s.x)),this.viewer.wrapVertical||(n=Math.min(n,s.y-d))}return new e.Point(o+this.xOffset,n-this.yOffset)}},getAsCanvas:function(){var o=document.createElement("canvas");o.width=this.divElt.offsetWidth,o.height=this.divElt.offsetHeight;var n=o.getContext("2d");n.fillStyle=this.backgroundColor,n.fillRect(0,0,o.width,o.height),n.fillStyle=this.color,n.fillRect(0,o.height-this.barThickness,o.width,o.height),this.drawScalebar===this.drawMapScalebar&&(n.fillRect(0,0,this.barThickness,o.height),n.fillRect(o.width-this.barThickness,0,this.barThickness,o.height)),n.font=window.getComputedStyle(this.divElt).font,n.textAlign="center",n.textBaseline="middle",n.fillStyle=this.fontColor;var s=o.width/2,l=o.height/2;return n.fillText(this.divElt.textContent,s,l),o},getImageWithScalebarAsCanvas:function(){var o=this.viewer.drawer.canvas,n=document.createElement("canvas");n.width=o.width,n.height=o.height;var s=n.getContext("2d");s.drawImage(o,0,0);var l=this.getAsCanvas(),u=this.getScalebarLocation();return s.drawImage(l,u.x,u.y),n}},e.ScalebarSizeAndTextRenderer={METRIC_LENGTH:function(o,n){return c(o,n,"m")},IMPERIAL_LENGTH:function(o,n){var s=n*2,l=o*.0254;if(s<l*12){if(s<l){var u=l/1e3;return t(u,n,"th")}return t(l,n,"in")}var d=l*12;if(s<d*2e3)return t(d,n,"ft");var f=d*5280;return t(f,n,"mi")},ASTRONOMY:function(o,n){var s=n*2;if(s<o*60)return t(o,n,'"',!1,"");var l=o*60;if(s<l*60)return t(l,n,"'",!1,"");var u=l*60;return t(u,n,"&#176",!1,"")},STANDARD_TIME:function(o,n){var s=n*2;if(s<o*60)return c(o,n,"s");var l=o*60;if(s<l*60)return t(l,n,"minute",!0);var u=l*60;if(s<u*24)return t(u,n,"hour",!0);var d=u*24;if(s<d*365.25)return t(d,n,"day",!0);var f=d*365.25;return t(f,n,"year",!0)},METRIC_GENERIC:c};function h(o,n){var s=o._scaleSpring.current.value*o.viewport._containerInnerSize.x/o.source.dimensions.x;return s*n}function t(o,n,s,l,u){u=u===void 0?" ":u;var d=g(o,n),f=y(d/o*n,3),p=d*n,v=l&&f>1?"s":"";return{size:p,text:f+u+s+v}}function c(o,n,s){var l=g(o,n),u=y(l/o*n,3),d=l*n,f=i(u,s);return{size:d,text:f}}function g(o,n){var s=m(o),l=m(n),u=m(s/l);return u>=5&&(u/=5),u>=4&&(u/=4),u>=2&&(u/=2),u}function m(o){return o*Math.pow(10,Math.ceil(-a(o)))}function y(o,n){var s=-Math.ceil(-a(o)),l=n-s,u=o*Math.pow(10,l);return l<0?Math.round(u)*Math.pow(10,-l):Math.round(u)/Math.pow(10,l)}function a(o){return Math.log(o)/Math.log(10)}function i(o,n){return o<1e-6?o*1e9+" n"+n:o<.001?o*1e6+" \u03BC"+n:o<1?o*1e3+" m"+n:o>=1e3?o/1e3+" k"+n:o+" "+n}function r(o){return typeof o!="undefined"}})(OpenSeadragon);var gn={},nr={},rr=Object.freeze(Object.defineProperty({__proto__:null,default:nr},Symbol.toStringTag,{value:"Module"})),zt=tr(rr);(function(e){/*! Fabric.js Copyright 2008-2015, Printio (Juriy Zaytsev, Maxim Chernyak) */var h=h||{version:"4.6.0"};if(e.fabric=h,typeof document!="undefined"&&typeof window!="undefined")document instanceof(typeof HTMLDocument!="undefined"?HTMLDocument:Document)?h.document=document:h.document=document.implementation.createHTMLDocument(""),h.window=window;else{var t=zt,c=new t.JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;h.document=c.document,h.jsdomImplForWrapper=zt.implForWrapper,h.nodeCanvas=zt.Canvas,h.window=c,DOMParser=h.window.DOMParser}h.isTouchSupported="ontouchstart"in h.window||"ontouchstart"in h.document||h.window&&h.window.navigator&&h.window.navigator.maxTouchPoints>0,h.isLikelyNode=typeof Buffer!="undefined"&&typeof window=="undefined",h.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],h.DPI=96,h.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",h.commaWsp="(?:\\s+,?\\s*|,\\s*)",h.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/ig,h.reNonWord=/[ \n\.,;!\?\-]/,h.fontPaths={},h.iMatrix=[1,0,0,1,0,0],h.svgNS="http://www.w3.org/2000/svg",h.perfLimitSizeTotal=2097152,h.maxCacheSideLimit=4096,h.minCacheSideLimit=256,h.charWidthsCache={},h.textureSize=2048,h.disableStyleCopyPaste=!1,h.enableGLFiltering=!0,h.devicePixelRatio=h.window.devicePixelRatio||h.window.webkitDevicePixelRatio||h.window.mozDevicePixelRatio||1,h.browserShadowBlurConstant=1,h.arcToSegmentsCache={},h.boundsOfCurveCache={},h.cachesBoundsOfCurve=!0,h.forceGLPutImageData=!1,h.initFilterBackend=function(){if(h.enableGLFiltering&&h.isWebglSupported&&h.isWebglSupported(h.textureSize))return console.log("max texture size: "+h.maxTextureSize),new h.WebglFilterBackend({tileSize:h.textureSize});if(h.Canvas2dFilterBackend)return new h.Canvas2dFilterBackend},typeof document!="undefined"&&typeof window!="undefined"&&(window.fabric=h),function(){function a(l,u){if(!!this.__eventListeners[l]){var d=this.__eventListeners[l];u?d[d.indexOf(u)]=!1:h.util.array.fill(d,!1)}}function i(l,u){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var d in l)this.on(d,l[d]);else this.__eventListeners[l]||(this.__eventListeners[l]=[]),this.__eventListeners[l].push(u);return this}function r(l,u){var d=function(){u.apply(this,arguments),this.off(l,d)}.bind(this);this.on(l,d)}function o(l,u){if(arguments.length===1)for(var d in l)r.call(this,d,l[d]);else r.call(this,l,u);return this}function n(l,u){if(!this.__eventListeners)return this;if(arguments.length===0)for(l in this.__eventListeners)a.call(this,l);else if(arguments.length===1&&typeof arguments[0]=="object")for(var d in l)a.call(this,d,l[d]);else a.call(this,l,u);return this}function s(l,u){if(!this.__eventListeners)return this;var d=this.__eventListeners[l];if(!d)return this;for(var f=0,p=d.length;f<p;f++)d[f]&&d[f].call(this,u||{});return this.__eventListeners[l]=d.filter(function(v){return v!==!1}),this}h.Observable={fire:s,on:i,once:o,off:n}}(),h.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var a=0,i=arguments.length;a<i;a++)this._onObjectAdded(arguments[a]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(a,i,r){var o=this._objects;return r?o[i]=a:o.splice(i,0,a),this._onObjectAdded&&this._onObjectAdded(a),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var a=this._objects,i,r=!1,o=0,n=arguments.length;o<n;o++)i=a.indexOf(arguments[o]),i!==-1&&(r=!0,a.splice(i,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[o]));return this.renderOnAddRemove&&r&&this.requestRenderAll(),this},forEachObject:function(a,i){for(var r=this.getObjects(),o=0,n=r.length;o<n;o++)a.call(i,r[o],o,r);return this},getObjects:function(a){return typeof a=="undefined"?this._objects.concat():this._objects.filter(function(i){return i.type===a})},item:function(a){return this._objects[a]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(a,i){return this._objects.indexOf(a)>-1?!0:i?this._objects.some(function(r){return typeof r.contains=="function"&&r.contains(a,!0)}):!1},complexity:function(){return this._objects.reduce(function(a,i){return a+=i.complexity?i.complexity():0,a},0)}},h.CommonMethods={_setOptions:function(a){for(var i in a)this.set(i,a[i])},_initGradient:function(a,i){a&&a.colorStops&&!(a instanceof h.Gradient)&&this.set(i,new h.Gradient(a))},_initPattern:function(a,i,r){a&&a.source&&!(a instanceof h.Pattern)?this.set(i,new h.Pattern(a,r)):r&&r()},_setObject:function(a){for(var i in a)this._set(i,a[i])},set:function(a,i){return typeof a=="object"?this._setObject(a):this._set(a,i),this},_set:function(a,i){this[a]=i},toggle:function(a){var i=this.get(a);return typeof i=="boolean"&&this.set(a,!i),this},get:function(a){return this[a]}},function(a){var i=Math.sqrt,r=Math.atan2,o=Math.pow,n=Math.PI/180,s=Math.PI/2;h.util={cos:function(l){if(l===0)return 1;l<0&&(l=-l);var u=l/s;switch(u){case 1:case 3:return 0;case 2:return-1}return Math.cos(l)},sin:function(l){if(l===0)return 0;var u=l/s,d=1;switch(l<0&&(d=-1),u){case 1:return d;case 2:return 0;case 3:return-d}return Math.sin(l)},removeFromArray:function(l,u){var d=l.indexOf(u);return d!==-1&&l.splice(d,1),l},getRandomInt:function(l,u){return Math.floor(Math.random()*(u-l+1))+l},degreesToRadians:function(l){return l*n},radiansToDegrees:function(l){return l/n},rotatePoint:function(l,u,d){var f=new h.Point(l.x-u.x,l.y-u.y),p=h.util.rotateVector(f,d);return new h.Point(p.x,p.y).addEquals(u)},rotateVector:function(l,u){var d=h.util.sin(u),f=h.util.cos(u),p=l.x*f-l.y*d,v=l.x*d+l.y*f;return{x:p,y:v}},transformPoint:function(l,u,d){return d?new h.Point(u[0]*l.x+u[2]*l.y,u[1]*l.x+u[3]*l.y):new h.Point(u[0]*l.x+u[2]*l.y+u[4],u[1]*l.x+u[3]*l.y+u[5])},makeBoundingBoxFromPoints:function(l,u){if(u)for(var d=0;d<l.length;d++)l[d]=h.util.transformPoint(l[d],u);var f=[l[0].x,l[1].x,l[2].x,l[3].x],p=h.util.array.min(f),v=h.util.array.max(f),w=v-p,C=[l[0].y,l[1].y,l[2].y,l[3].y],b=h.util.array.min(C),P=h.util.array.max(C),R=P-b;return{left:p,top:b,width:w,height:R}},invertTransform:function(l){var u=1/(l[0]*l[3]-l[1]*l[2]),d=[u*l[3],-u*l[1],-u*l[2],u*l[0]],f=h.util.transformPoint({x:l[4],y:l[5]},d,!0);return d[4]=-f.x,d[5]=-f.y,d},toFixed:function(l,u){return parseFloat(Number(l).toFixed(u))},parseUnit:function(l,u){var d=/\D{0,2}$/.exec(l),f=parseFloat(l);switch(u||(u=h.Text.DEFAULT_SVG_FONT_SIZE),d[0]){case"mm":return f*h.DPI/25.4;case"cm":return f*h.DPI/2.54;case"in":return f*h.DPI;case"pt":return f*h.DPI/72;case"pc":return f*h.DPI/72*12;case"em":return f*u;default:return f}},falseFunction:function(){return!1},getKlass:function(l,u){return l=h.util.string.camelize(l.charAt(0).toUpperCase()+l.slice(1)),h.util.resolveNamespace(u)[l]},getSvgAttributes:function(l){var u=["instantiated_by_use","style","id","class"];switch(l){case"linearGradient":u=u.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":u=u.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":u=u.concat(["offset","stop-color","stop-opacity"]);break}return u},resolveNamespace:function(l){if(!l)return h;var u=l.split("."),d=u.length,f,p=a||h.window;for(f=0;f<d;++f)p=p[u[f]];return p},loadImage:function(l,u,d,f){if(!l){u&&u.call(d,l);return}var p=h.util.createImage(),v=function(){u&&u.call(d,p,!1),p=p.onload=p.onerror=null};p.onload=v,p.onerror=function(){h.log("Error loading "+p.src),u&&u.call(d,null,!0),p=p.onload=p.onerror=null},l.indexOf("data")!==0&&f!==void 0&&f!==null&&(p.crossOrigin=f),l.substring(0,14)==="data:image/svg"&&(p.onload=null,h.util.loadImageInDom(p,v)),p.src=l},loadImageInDom:function(l,u){var d=h.document.createElement("div");d.style.width=d.style.height="1px",d.style.left=d.style.top="-100%",d.style.position="absolute",d.appendChild(l),h.document.querySelector("body").appendChild(d),l.onload=function(){u(),d.parentNode.removeChild(d),d=null}},enlivenObjects:function(l,u,d,f){l=l||[];var p=[],v=0,w=l.length;function C(){++v===w&&u&&u(p.filter(function(b){return b}))}if(!w){u&&u(p);return}l.forEach(function(b,P){if(!b||!b.type){C();return}var R=h.util.getKlass(b.type,d);R.fromObject(b,function(A,W){W||(p[P]=A),f&&f(b,A,W),C()})})},enlivenPatterns:function(l,u){l=l||[];function d(){++p===v&&u&&u(f)}var f=[],p=0,v=l.length;if(!v){u&&u(f);return}l.forEach(function(w,C){w&&w.source?new h.Pattern(w,function(b){f[C]=b,d()}):(f[C]=w,d())})},groupSVGElements:function(l,u,d){var f;return l&&l.length===1?l[0]:(u&&(u.width&&u.height?u.centerPoint={x:u.width/2,y:u.height/2}:(delete u.width,delete u.height)),f=new h.Group(l,u),typeof d!="undefined"&&(f.sourcePath=d),f)},populateWithProperties:function(l,u,d){if(d&&Object.prototype.toString.call(d)==="[object Array]")for(var f=0,p=d.length;f<p;f++)d[f]in l&&(u[d[f]]=l[d[f]])},drawDashedLine:function(l,u,d,f,p,v){var w=f-u,C=p-d,b=i(w*w+C*C),P=r(C,w),R=v.length,A=0,W=!0;for(l.save(),l.translate(u,d),l.moveTo(0,0),l.rotate(P),u=0;b>u;)u+=v[A++%R],u>b&&(u=b),l[W?"lineTo":"moveTo"](u,0),W=!W;l.restore()},createCanvasElement:function(){return h.document.createElement("canvas")},copyCanvasElement:function(l){var u=h.util.createCanvasElement();return u.width=l.width,u.height=l.height,u.getContext("2d").drawImage(l,0,0),u},toDataURL:function(l,u,d){return l.toDataURL("image/"+u,d)},createImage:function(){return h.document.createElement("img")},multiplyTransformMatrices:function(l,u,d){return[l[0]*u[0]+l[2]*u[1],l[1]*u[0]+l[3]*u[1],l[0]*u[2]+l[2]*u[3],l[1]*u[2]+l[3]*u[3],d?0:l[0]*u[4]+l[2]*u[5]+l[4],d?0:l[1]*u[4]+l[3]*u[5]+l[5]]},qrDecompose:function(l){var u=r(l[1],l[0]),d=o(l[0],2)+o(l[1],2),f=i(d),p=(l[0]*l[3]-l[2]*l[1])/f,v=r(l[0]*l[2]+l[1]*l[3],d);return{angle:u/n,scaleX:f,scaleY:p,skewX:v/n,skewY:0,translateX:l[4],translateY:l[5]}},calcRotateMatrix:function(l){if(!l.angle)return h.iMatrix.concat();var u=h.util.degreesToRadians(l.angle),d=h.util.cos(u),f=h.util.sin(u);return[d,f,-f,d,0,0]},calcDimensionsMatrix:function(l){var u=typeof l.scaleX=="undefined"?1:l.scaleX,d=typeof l.scaleY=="undefined"?1:l.scaleY,f=[l.flipX?-u:u,0,0,l.flipY?-d:d,0,0],p=h.util.multiplyTransformMatrices,v=h.util.degreesToRadians;return l.skewX&&(f=p(f,[1,0,Math.tan(v(l.skewX)),1],!0)),l.skewY&&(f=p(f,[1,Math.tan(v(l.skewY)),0,1],!0)),f},composeMatrix:function(l){var u=[1,0,0,1,l.translateX||0,l.translateY||0],d=h.util.multiplyTransformMatrices;return l.angle&&(u=d(u,h.util.calcRotateMatrix(l))),(l.scaleX!==1||l.scaleY!==1||l.skewX||l.skewY||l.flipX||l.flipY)&&(u=d(u,h.util.calcDimensionsMatrix(l))),u},resetObjectTransform:function(l){l.scaleX=1,l.scaleY=1,l.skewX=0,l.skewY=0,l.flipX=!1,l.flipY=!1,l.rotate(0)},saveObjectTransform:function(l){return{scaleX:l.scaleX,scaleY:l.scaleY,skewX:l.skewX,skewY:l.skewY,angle:l.angle,left:l.left,flipX:l.flipX,flipY:l.flipY,top:l.top}},isTransparent:function(l,u,d,f){f>0&&(u>f?u-=f:u=0,d>f?d-=f:d=0);var p=!0,v,w,C=l.getImageData(u,d,f*2||1,f*2||1),b=C.data.length;for(v=3;v<b&&(w=C.data[v],p=w<=0,p!==!1);v+=4);return C=null,p},parsePreserveAspectRatioAttribute:function(l){var u="meet",d="Mid",f="Mid",p=l.split(" "),v;return p&&p.length&&(u=p.pop(),u!=="meet"&&u!=="slice"?(v=u,u="meet"):p.length&&(v=p.pop())),d=v!=="none"?v.slice(1,4):"none",f=v!=="none"?v.slice(5,8):"none",{meetOrSlice:u,alignX:d,alignY:f}},clearFabricFontCache:function(l){l=(l||"").toLowerCase(),l?h.charWidthsCache[l]&&delete h.charWidthsCache[l]:h.charWidthsCache={}},limitDimsByArea:function(l,u){var d=Math.sqrt(u*l),f=Math.floor(u/d);return{x:Math.floor(d),y:f}},capValue:function(l,u,d){return Math.max(l,Math.min(u,d))},findScaleToFit:function(l,u){return Math.min(u.width/l.width,u.height/l.height)},findScaleToCover:function(l,u){return Math.max(u.width/l.width,u.height/l.height)},matrixToSVG:function(l){return"matrix("+l.map(function(u){return h.util.toFixed(u,h.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(l,u){var d=h.util.invertTransform(u),f=h.util.multiplyTransformMatrices(d,l.calcOwnMatrix());h.util.applyTransformToObject(l,f)},addTransformToObject:function(l,u){h.util.applyTransformToObject(l,h.util.multiplyTransformMatrices(u,l.calcOwnMatrix()))},applyTransformToObject:function(l,u){var d=h.util.qrDecompose(u),f=new h.Point(d.translateX,d.translateY);l.flipX=!1,l.flipY=!1,l.set("scaleX",d.scaleX),l.set("scaleY",d.scaleY),l.skewX=d.skewX,l.skewY=d.skewY,l.angle=d.angle,l.setPositionByOrigin(f,"center","center")},sizeAfterTransform:function(l,u,d){var f=l/2,p=u/2,v=[{x:-f,y:-p},{x:f,y:-p},{x:-f,y:p},{x:f,y:p}],w=h.util.calcDimensionsMatrix(d),C=h.util.makeBoundingBoxFromPoints(v,w);return{x:C.width,y:C.height}}}}(e),function(){var a=Array.prototype.join,i={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},r={m:"l",M:"L"};function o(N,j,G,D,k,H,F,K,V,te,J){var ie=h.util.cos(N),Y=h.util.sin(N),x=h.util.cos(j),E=h.util.sin(j),I=G*k*x-D*H*E+F,z=D*k*x+G*H*E+K,B=te+V*(-G*k*Y-D*H*ie),q=J+V*(-D*k*Y+G*H*ie),ee=I+V*(G*k*E+D*H*x),le=z+V*(D*k*E-G*H*x);return["C",B,q,ee,le,I,z]}function n(N,j,G,D,k,H,F){var K=Math.PI,V=F*K/180,te=h.util.sin(V),J=h.util.cos(V),ie=0,Y=0;G=Math.abs(G),D=Math.abs(D);var x=-J*N*.5-te*j*.5,E=-J*j*.5+te*N*.5,I=G*G,z=D*D,B=E*E,q=x*x,ee=I*z-I*B-z*q,le=0;if(ee<0){var Z=Math.sqrt(1-ee/(I*z));G*=Z,D*=Z}else le=(k===H?-1:1)*Math.sqrt(ee/(I*B+z*q));var oe=le*G*E/D,ae=-le*D*x/G,ge=J*oe-te*ae+N*.5,me=te*oe+J*ae+j*.5,ye=s(1,0,(x-oe)/G,(E-ae)/D),_e=s((x-oe)/G,(E-ae)/D,(-x-oe)/G,(-E-ae)/D);H===0&&_e>0?_e-=2*K:H===1&&_e<0&&(_e+=2*K);for(var S=Math.ceil(Math.abs(_e/K*2)),T=[],O=_e/S,M=8/3*Math.sin(O/4)*Math.sin(O/4)/Math.sin(O/2),Q=ye+O,se=0;se<S;se++)T[se]=o(ye,Q,J,te,G,D,ge,me,M,ie,Y),ie=T[se][5],Y=T[se][6],ye=Q,Q+=O;return T}function s(N,j,G,D){var k=Math.atan2(j,N),H=Math.atan2(D,G);return H>=k?H-k:2*Math.PI-(k-H)}function l(N,j,G,D,k,H,F,K){var V;if(h.cachesBoundsOfCurve&&(V=a.call(arguments),h.boundsOfCurveCache[V]))return h.boundsOfCurveCache[V];var te=Math.sqrt,J=Math.min,ie=Math.max,Y=Math.abs,x=[],E=[[],[]],I,z,B,q,ee,le,Z,oe;z=6*N-12*G+6*k,I=-3*N+9*G-9*k+3*F,B=3*G-3*N;for(var ae=0;ae<2;++ae){if(ae>0&&(z=6*j-12*D+6*H,I=-3*j+9*D-9*H+3*K,B=3*D-3*j),Y(I)<1e-12){if(Y(z)<1e-12)continue;q=-B/z,0<q&&q<1&&x.push(q);continue}Z=z*z-4*B*I,!(Z<0)&&(oe=te(Z),ee=(-z+oe)/(2*I),0<ee&&ee<1&&x.push(ee),le=(-z-oe)/(2*I),0<le&&le<1&&x.push(le))}for(var ge,me,ye=x.length,_e=ye,S;ye--;)q=x[ye],S=1-q,ge=S*S*S*N+3*S*S*q*G+3*S*q*q*k+q*q*q*F,E[0][ye]=ge,me=S*S*S*j+3*S*S*q*D+3*S*q*q*H+q*q*q*K,E[1][ye]=me;E[0][_e]=N,E[1][_e]=j,E[0][_e+1]=F,E[1][_e+1]=K;var T=[{x:J.apply(null,E[0]),y:J.apply(null,E[1])},{x:ie.apply(null,E[0]),y:ie.apply(null,E[1])}];return h.cachesBoundsOfCurve&&(h.boundsOfCurveCache[V]=T),T}function u(N,j,G){for(var D=G[1],k=G[2],H=G[3],F=G[4],K=G[5],V=G[6],te=G[7],J=n(V-N,te-j,D,k,F,K,H),ie=0,Y=J.length;ie<Y;ie++)J[ie][1]+=N,J[ie][2]+=j,J[ie][3]+=N,J[ie][4]+=j,J[ie][5]+=N,J[ie][6]+=j;return J}function d(N){var j=0,G=0,D=N.length,k=0,H=0,F,K,V,te=[],J,ie,Y;for(K=0;K<D;++K){switch(V=!1,F=N[K].slice(0),F[0]){case"l":F[0]="L",F[1]+=j,F[2]+=G;case"L":j=F[1],G=F[2];break;case"h":F[1]+=j;case"H":F[0]="L",F[2]=G,j=F[1];break;case"v":F[1]+=G;case"V":F[0]="L",G=F[1],F[1]=j,F[2]=G;break;case"m":F[0]="M",F[1]+=j,F[2]+=G;case"M":j=F[1],G=F[2],k=F[1],H=F[2];break;case"c":F[0]="C",F[1]+=j,F[2]+=G,F[3]+=j,F[4]+=G,F[5]+=j,F[6]+=G;case"C":ie=F[3],Y=F[4],j=F[5],G=F[6];break;case"s":F[0]="S",F[1]+=j,F[2]+=G,F[3]+=j,F[4]+=G;case"S":J==="C"?(ie=2*j-ie,Y=2*G-Y):(ie=j,Y=G),j=F[3],G=F[4],F[0]="C",F[5]=F[3],F[6]=F[4],F[3]=F[1],F[4]=F[2],F[1]=ie,F[2]=Y,ie=F[3],Y=F[4];break;case"q":F[0]="Q",F[1]+=j,F[2]+=G,F[3]+=j,F[4]+=G;case"Q":ie=F[1],Y=F[2],j=F[3],G=F[4];break;case"t":F[0]="T",F[1]+=j,F[2]+=G;case"T":J==="Q"?(ie=2*j-ie,Y=2*G-Y):(ie=j,Y=G),F[0]="Q",j=F[1],G=F[2],F[1]=ie,F[2]=Y,F[3]=j,F[4]=G;break;case"a":F[0]="A",F[6]+=j,F[7]+=G;case"A":V=!0,te=te.concat(u(j,G,F)),j=F[6],G=F[7];break;case"z":case"Z":j=k,G=H;break}V||te.push(F),J=F[0]}return te}function f(N,j,G,D){return Math.sqrt((G-N)*(G-N)+(D-j)*(D-j))}function p(N){return N*N*N}function v(N){return 3*N*N*(1-N)}function w(N){return 3*N*(1-N)*(1-N)}function C(N){return(1-N)*(1-N)*(1-N)}function b(N,j,G,D,k,H,F,K){return function(V){var te=p(V),J=v(V),ie=w(V),Y=C(V);return{x:F*te+k*J+G*ie+N*Y,y:K*te+H*J+D*ie+j*Y}}}function P(N,j,G,D,k,H,F,K){return function(V){var te=1-V,J=3*te*te*(G-N)+6*te*V*(k-G)+3*V*V*(F-k),ie=3*te*te*(D-j)+6*te*V*(H-D)+3*V*V*(K-H);return Math.atan2(ie,J)}}function R(N){return N*N}function A(N){return 2*N*(1-N)}function W(N){return(1-N)*(1-N)}function $(N,j,G,D,k,H){return function(F){var K=R(F),V=A(F),te=W(F);return{x:k*K+G*V+N*te,y:H*K+D*V+j*te}}}function X(N,j,G,D,k,H){return function(F){var K=1-F,V=2*K*(G-N)+2*F*(k-G),te=2*K*(D-j)+2*F*(H-D);return Math.atan2(te,V)}}function re(N,j,G){var D={x:j,y:G},k,H=0,F;for(F=1;F<=100;F+=1)k=N(F/100),H+=f(D.x,D.y,k.x,k.y),D=k;return H}function he(N,j){for(var G=0,D=0,k=N.iterator,H={x:N.x,y:N.y},F,K,V=.01,te=N.angleFinder,J;D<j&&G<=1&&V>1e-4;)F=k(G),J=G,K=f(H.x,H.y,F.x,F.y),K+D>j?(V/=2,G-=V):(H=F,G+=V,D+=K);return F.angle=te(J),F}function ne(N){for(var j=0,G=N.length,D,k=0,H=0,F=0,K=0,V=[],te,J,ie,Y=0;Y<G;Y++){switch(D=N[Y],J={x:k,y:H,command:D[0]},D[0]){case"M":J.length=0,F=k=D[1],K=H=D[2];break;case"L":J.length=f(k,H,D[1],D[2]),k=D[1],H=D[2];break;case"C":te=b(k,H,D[1],D[2],D[3],D[4],D[5],D[6]),ie=P(k,H,D[1],D[2],D[3],D[4],D[5],D[6]),J.iterator=te,J.angleFinder=ie,J.length=re(te,k,H),k=D[5],H=D[6];break;case"Q":te=$(k,H,D[1],D[2],D[3],D[4]),ie=X(k,H,D[1],D[2],D[3],D[4]),J.iterator=te,J.angleFinder=ie,J.length=re(te,k,H),k=D[3],H=D[4];break;case"Z":case"z":J.destX=F,J.destY=K,J.length=f(k,H,F,K),k=F,H=K;break}j+=J.length,V.push(J)}return V.push({length:j,x:k,y:H}),V}function ce(N,j,G){G||(G=ne(N));for(var D=0;j-G[D].length>0&&D<G.length-2;)j-=G[D].length,D++;var k=G[D],H=j/k.length,F=k.command,K=N[D],V;switch(F){case"M":return{x:k.x,y:k.y,angle:0};case"Z":case"z":return V=new h.Point(k.x,k.y).lerp(new h.Point(k.destX,k.destY),H),V.angle=Math.atan2(k.destY-k.y,k.destX-k.x),V;case"L":return V=new h.Point(k.x,k.y).lerp(new h.Point(K[1],K[2]),H),V.angle=Math.atan2(K[2]-k.y,K[1]-k.x),V;case"C":return he(k,j);case"Q":return he(k,j)}}function ue(N){var j=[],G=[],D,k,H=h.rePathCommand,F="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",K="("+F+")"+h.commaWsp,V="([01])"+h.commaWsp+"?",te=K+"?"+K+"?"+K+V+V+K+"?("+F+")",J=new RegExp(te,"g"),ie,Y,x;if(!N||!N.match)return j;x=N.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(var E=0,I,z=x.length;E<z;E++){D=x[E],Y=D.slice(1).trim(),G.length=0;var B=D.charAt(0);if(I=[B],B.toLowerCase()==="a")for(var q;q=J.exec(Y);)for(var ee=1;ee<q.length;ee++)G.push(q[ee]);else for(;ie=H.exec(Y);)G.push(ie[0]);for(var ee=0,le=G.length;ee<le;ee++)k=parseFloat(G[ee]),isNaN(k)||I.push(k);var Z=i[B.toLowerCase()],oe=r[B]||B;if(I.length-1>Z)for(var ae=1,ge=I.length;ae<ge;ae+=Z)j.push([B].concat(I.slice(ae,ae+Z))),B=oe;else j.push(I)}return j}function de(N,j){var G=[],D,k=new h.Point(N[0].x,N[0].y),H=new h.Point(N[1].x,N[1].y),F=N.length,K=1,V=0,te=F>2;for(j=j||0,te&&(K=N[2].x<H.x?-1:N[2].x===H.x?0:1,V=N[2].y<H.y?-1:N[2].y===H.y?0:1),G.push(["M",k.x-K*j,k.y-V*j]),D=1;D<F;D++){if(!k.eq(H)){var J=k.midPointFrom(H);G.push(["Q",k.x,k.y,J.x,J.y])}k=N[D],D+1<N.length&&(H=N[D+1])}return te&&(K=k.x>N[D-2].x?1:k.x===N[D-2].x?0:-1,V=k.y>N[D-2].y?1:k.y===N[D-2].y?0:-1),G.push(["L",k.x+K*j,k.y+V*j]),G}function fe(N,j,G){return G&&(j=h.util.multiplyTransformMatrices(j,[1,0,0,1,-G.x,-G.y])),N.map(function(D){for(var k=D.slice(0),H={},F=1;F<D.length-1;F+=2)H.x=D[F],H.y=D[F+1],H=h.util.transformPoint(H,j),k[F]=H.x,k[F+1]=H.y;return k})}function L(N,j,G,D,k,H,F,K,V){for(var te=0,J=0,ie,Y=[],x=n(K-N,V-j,G,D,H,F,k),E=0,I=x.length;E<I;E++)ie=l(te,J,x[E][1],x[E][2],x[E][3],x[E][4],x[E][5],x[E][6]),Y.push({x:ie[0].x+N,y:ie[0].y+j}),Y.push({x:ie[1].x+N,y:ie[1].y+j}),te=x[E][5],J=x[E][6];return Y}function U(N,j,G,D){D=D.slice(0).unshift("X");var k=u(j,G,D);k.forEach(function(H){N.bezierCurveTo.apply(N,H.slice(1))})}h.util.joinPath=function(N){return N.map(function(j){return j.join(" ")}).join(" ")},h.util.parsePath=ue,h.util.makePathSimpler=d,h.util.getSmoothPathFromPoints=de,h.util.getPathSegmentsInfo=ne,h.util.getBoundsOfCurve=l,h.util.getPointOnPath=ce,h.util.transformPath=fe,h.util.fromArcToBeizers=u,h.util.getBoundsOfArc=L,h.util.drawArc=U}(),function(){var a=Array.prototype.slice;function i(l,u){for(var d=a.call(arguments,2),f=[],p=0,v=l.length;p<v;p++)f[p]=d.length?l[p][u].apply(l[p],d):l[p][u].call(l[p]);return f}function r(l,u){return s(l,u,function(d,f){return d>=f})}function o(l,u){return s(l,u,function(d,f){return d<f})}function n(l,u){for(var d=l.length;d--;)l[d]=u;return l}function s(l,u,d){if(!(!l||l.length===0)){var f=l.length-1,p=u?l[f][u]:l[f];if(u)for(;f--;)d(l[f][u],p)&&(p=l[f][u]);else for(;f--;)d(l[f],p)&&(p=l[f]);return p}}h.util.array={fill:n,invoke:i,min:o,max:r}}(),function(){function a(r,o,n){if(n)if(!h.isLikelyNode&&o instanceof Element)r=o;else if(o instanceof Array){r=[];for(var s=0,l=o.length;s<l;s++)r[s]=a({},o[s],n)}else if(o&&typeof o=="object")for(var u in o)u==="canvas"||u==="group"?r[u]=null:o.hasOwnProperty(u)&&(r[u]=a({},o[u],n));else r=o;else for(var u in o)r[u]=o[u];return r}function i(r,o){return a({},r,o)}h.util.object={extend:a,clone:i},h.util.object.extend(h.util,h.Observable)}(),function(){function a(s){return s.replace(/-+(.)?/g,function(l,u){return u?u.toUpperCase():""})}function i(s,l){return s.charAt(0).toUpperCase()+(l?s.slice(1):s.slice(1).toLowerCase())}function r(s){return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function o(s){var l=0,u,d=[];for(l=0,u;l<s.length;l++)(u=n(s,l))!==!1&&d.push(u);return d}function n(s,l){var u=s.charCodeAt(l);if(isNaN(u))return"";if(u<55296||u>57343)return s.charAt(l);if(55296<=u&&u<=56319){if(s.length<=l+1)throw"High surrogate without following low surrogate";var d=s.charCodeAt(l+1);if(56320>d||d>57343)throw"High surrogate without following low surrogate";return s.charAt(l)+s.charAt(l+1)}if(l===0)throw"Low surrogate without preceding high surrogate";var f=s.charCodeAt(l-1);if(55296>f||f>56319)throw"Low surrogate without preceding high surrogate";return!1}h.util.string={camelize:a,capitalize:i,escapeXml:r,graphemeSplit:o}}(),function(){var a=Array.prototype.slice,i=function(){},r=function(){for(var u in{toString:1})if(u==="toString")return!1;return!0}(),o=function(u,d,f){for(var p in d)p in u.prototype&&typeof u.prototype[p]=="function"&&(d[p]+"").indexOf("callSuper")>-1?u.prototype[p]=function(v){return function(){var w=this.constructor.superclass;this.constructor.superclass=f;var C=d[v].apply(this,arguments);if(this.constructor.superclass=w,v!=="initialize")return C}}(p):u.prototype[p]=d[p],r&&(d.toString!==Object.prototype.toString&&(u.prototype.toString=d.toString),d.valueOf!==Object.prototype.valueOf&&(u.prototype.valueOf=d.valueOf))};function n(){}function s(u){for(var d=null,f=this;f.constructor.superclass;){var p=f.constructor.superclass.prototype[u];if(f[u]!==p){d=p;break}f=f.constructor.superclass.prototype}return d?arguments.length>1?d.apply(this,a.call(arguments,1)):d.call(this):console.log("tried to callSuper "+u+", method not found in prototype chain",this)}function l(){var u=null,d=a.call(arguments,0);typeof d[0]=="function"&&(u=d.shift());function f(){this.initialize.apply(this,arguments)}f.superclass=u,f.subclasses=[],u&&(n.prototype=u.prototype,f.prototype=new n,u.subclasses.push(f));for(var p=0,v=d.length;p<v;p++)o(f,d[p],u);return f.prototype.initialize||(f.prototype.initialize=i),f.prototype.constructor=f,f.prototype.callSuper=s,f}h.util.createClass=l}(),function(){var a=!!h.document.createElement("div").attachEvent,i=["touchstart","touchmove","touchend"];h.util.addListener=function(o,n,s,l){o&&o.addEventListener(n,s,a?!1:l)},h.util.removeListener=function(o,n,s,l){o&&o.removeEventListener(n,s,a?!1:l)};function r(o){var n=o.changedTouches;return n&&n[0]?n[0]:o}h.util.getPointer=function(o){var n=o.target,s=h.util.getScrollLeftTop(n),l=r(o);return{x:l.clientX+s.left,y:l.clientY+s.top}},h.util.isTouchEvent=function(o){return i.indexOf(o.type)>-1||o.pointerType==="touch"}}(),function(){function a(l,u){var d=l.style;if(!d)return l;if(typeof u=="string")return l.style.cssText+=";"+u,u.indexOf("opacity")>-1?s(l,u.match(/opacity:\s*(\d?\.?\d*)/)[1]):l;for(var f in u)if(f==="opacity")s(l,u[f]);else{var p=f==="float"||f==="cssFloat"?typeof d.styleFloat=="undefined"?"cssFloat":"styleFloat":f;d[p]=u[f]}return l}var i=h.document.createElement("div"),r=typeof i.style.opacity=="string",o=typeof i.style.filter=="string",n=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,s=function(l){return l};r?s=function(l,u){return l.style.opacity=u,l}:o&&(s=function(l,u){var d=l.style;return l.currentStyle&&!l.currentStyle.hasLayout&&(d.zoom=1),n.test(d.filter)?(u=u>=.9999?"":"alpha(opacity="+u*100+")",d.filter=d.filter.replace(n,u)):d.filter+=" alpha(opacity="+u*100+")",l}),h.util.setStyle=a}(),function(){var a=Array.prototype.slice;function i(C){return typeof C=="string"?h.document.getElementById(C):C}var r,o=function(C){return a.call(C,0)};try{r=o(h.document.childNodes)instanceof Array}catch{}r||(o=function(C){for(var b=new Array(C.length),P=C.length;P--;)b[P]=C[P];return b});function n(C,b){var P=h.document.createElement(C);for(var R in b)R==="class"?P.className=b[R]:R==="for"?P.htmlFor=b[R]:P.setAttribute(R,b[R]);return P}function s(C,b){C&&(" "+C.className+" ").indexOf(" "+b+" ")===-1&&(C.className+=(C.className?" ":"")+b)}function l(C,b,P){return typeof b=="string"&&(b=n(b,P)),C.parentNode&&C.parentNode.replaceChild(b,C),b.appendChild(C),b}function u(C){for(var b=0,P=0,R=h.document.documentElement,A=h.document.body||{scrollLeft:0,scrollTop:0};C&&(C.parentNode||C.host)&&(C=C.parentNode||C.host,C===h.document?(b=A.scrollLeft||R.scrollLeft||0,P=A.scrollTop||R.scrollTop||0):(b+=C.scrollLeft||0,P+=C.scrollTop||0),!(C.nodeType===1&&C.style.position==="fixed")););return{left:b,top:P}}function d(C){var b,P=C&&C.ownerDocument,R={left:0,top:0},A={left:0,top:0},W,$={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!P)return A;for(var X in $)A[$[X]]+=parseInt(f(C,X),10)||0;return b=P.documentElement,typeof C.getBoundingClientRect!="undefined"&&(R=C.getBoundingClientRect()),W=u(C),{left:R.left+W.left-(b.clientLeft||0)+A.left,top:R.top+W.top-(b.clientTop||0)+A.top}}var f;h.document.defaultView&&h.document.defaultView.getComputedStyle?f=function(C,b){var P=h.document.defaultView.getComputedStyle(C,null);return P?P[b]:void 0}:f=function(C,b){var P=C.style[b];return!P&&C.currentStyle&&(P=C.currentStyle[b]),P},function(){var C=h.document.documentElement.style,b="userSelect"in C?"userSelect":"MozUserSelect"in C?"MozUserSelect":"WebkitUserSelect"in C?"WebkitUserSelect":"KhtmlUserSelect"in C?"KhtmlUserSelect":"";function P(A){return typeof A.onselectstart!="undefined"&&(A.onselectstart=h.util.falseFunction),b?A.style[b]="none":typeof A.unselectable=="string"&&(A.unselectable="on"),A}function R(A){return typeof A.onselectstart!="undefined"&&(A.onselectstart=null),b?A.style[b]="":typeof A.unselectable=="string"&&(A.unselectable=""),A}h.util.makeElementUnselectable=P,h.util.makeElementSelectable=R}();function p(C){var b=h.jsdomImplForWrapper(C);return b._canvas||b._image}function v(C){if(!!h.isLikelyNode){var b=h.jsdomImplForWrapper(C);b&&(b._image=null,b._canvas=null,b._currentSrc=null,b._attributes=null,b._classList=null)}}function w(C,b){C.imageSmoothingEnabled=C.imageSmoothingEnabled||C.webkitImageSmoothingEnabled||C.mozImageSmoothingEnabled||C.msImageSmoothingEnabled||C.oImageSmoothingEnabled,C.imageSmoothingEnabled=b}h.util.setImageSmoothing=w,h.util.getById=i,h.util.toArray=o,h.util.addClass=s,h.util.makeElement=n,h.util.wrapElement=l,h.util.getScrollLeftTop=u,h.util.getElementOffset=d,h.util.getNodeCanvas=p,h.util.cleanUpJsdomNode=v}(),function(){function a(o,n){return o+(/\?/.test(o)?"&":"?")+n}function i(){}function r(o,n){n||(n={});var s=n.method?n.method.toUpperCase():"GET",l=n.onComplete||function(){},u=new h.window.XMLHttpRequest,d=n.body||n.parameters;return u.onreadystatechange=function(){u.readyState===4&&(l(u),u.onreadystatechange=i)},s==="GET"&&(d=null,typeof n.parameters=="string"&&(o=a(o,n.parameters))),u.open(s,o,!0),(s==="POST"||s==="PUT")&&u.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),u.send(d),u}h.util.request=r}(),h.log=console.log,h.warn=console.warn,function(){function a(){return!1}function i(u,d,f,p){return-f*Math.cos(u/p*(Math.PI/2))+f+d}function r(u){var d=!1;return s(function(f){u||(u={});var p=f||+new Date,v=u.duration||500,w=p+v,C,b=u.onChange||a,P=u.abort||a,R=u.onComplete||a,A=u.easing||i,W="startValue"in u?u.startValue:0,$="endValue"in u?u.endValue:100,X=u.byValue||$-W;u.onStart&&u.onStart(),function re(he){C=he||+new Date;var ne=C>w?v:C-p,ce=ne/v,ue=A(ne,W,X,v),de=Math.abs((ue-W)/X);if(!d){if(P(ue,de,ce)){R($,1,1);return}if(C>w){b($,1,1),R($,1,1);return}else b(ue,de,ce),s(re)}}(p)}),function(){d=!0}}var o=h.window.requestAnimationFrame||h.window.webkitRequestAnimationFrame||h.window.mozRequestAnimationFrame||h.window.oRequestAnimationFrame||h.window.msRequestAnimationFrame||function(u){return h.window.setTimeout(u,1e3/60)},n=h.window.cancelAnimationFrame||h.window.clearTimeout;function s(){return o.apply(h.window,arguments)}function l(){return n.apply(h.window,arguments)}h.util.animate=r,h.util.requestAnimFrame=s,h.util.cancelAnimFrame=l}(),function(){function a(r,o,n){var s="rgba("+parseInt(r[0]+n*(o[0]-r[0]),10)+","+parseInt(r[1]+n*(o[1]-r[1]),10)+","+parseInt(r[2]+n*(o[2]-r[2]),10);return s+=","+(r&&o?parseFloat(r[3]+n*(o[3]-r[3])):1),s+=")",s}function i(r,o,n,s){var l=new h.Color(r).getSource(),u=new h.Color(o).getSource(),d=s.onComplete,f=s.onChange;return s=s||{},h.util.animate(h.util.object.extend(s,{duration:n||500,startValue:l,endValue:u,byValue:u,easing:function(p,v,w,C){var b=s.colorEasing?s.colorEasing(p,C):1-Math.cos(p/C*(Math.PI/2));return a(v,w,b)},onComplete:function(p,v,w){if(d)return d(a(u,u,0),v,w)},onChange:function(p,v,w){if(f){if(Array.isArray(p))return f(a(p,p,0),v,w);f(p,v,w)}}}))}h.util.animateColor=i}(),function(){function a(L,U,N,j){return L<Math.abs(U)?(L=U,j=N/4):U===0&&L===0?j=N/(2*Math.PI)*Math.asin(1):j=N/(2*Math.PI)*Math.asin(U/L),{a:L,c:U,p:N,s:j}}function i(L,U,N){return L.a*Math.pow(2,10*(U-=1))*Math.sin((U*N-L.s)*(2*Math.PI)/L.p)}function r(L,U,N,j){return N*((L=L/j-1)*L*L+1)+U}function o(L,U,N,j){return L/=j/2,L<1?N/2*L*L*L+U:N/2*((L-=2)*L*L+2)+U}function n(L,U,N,j){return N*(L/=j)*L*L*L+U}function s(L,U,N,j){return-N*((L=L/j-1)*L*L*L-1)+U}function l(L,U,N,j){return L/=j/2,L<1?N/2*L*L*L*L+U:-N/2*((L-=2)*L*L*L-2)+U}function u(L,U,N,j){return N*(L/=j)*L*L*L*L+U}function d(L,U,N,j){return N*((L=L/j-1)*L*L*L*L+1)+U}function f(L,U,N,j){return L/=j/2,L<1?N/2*L*L*L*L*L+U:N/2*((L-=2)*L*L*L*L+2)+U}function p(L,U,N,j){return-N*Math.cos(L/j*(Math.PI/2))+N+U}function v(L,U,N,j){return N*Math.sin(L/j*(Math.PI/2))+U}function w(L,U,N,j){return-N/2*(Math.cos(Math.PI*L/j)-1)+U}function C(L,U,N,j){return L===0?U:N*Math.pow(2,10*(L/j-1))+U}function b(L,U,N,j){return L===j?U+N:N*(-Math.pow(2,-10*L/j)+1)+U}function P(L,U,N,j){return L===0?U:L===j?U+N:(L/=j/2,L<1?N/2*Math.pow(2,10*(L-1))+U:N/2*(-Math.pow(2,-10*--L)+2)+U)}function R(L,U,N,j){return-N*(Math.sqrt(1-(L/=j)*L)-1)+U}function A(L,U,N,j){return N*Math.sqrt(1-(L=L/j-1)*L)+U}function W(L,U,N,j){return L/=j/2,L<1?-N/2*(Math.sqrt(1-L*L)-1)+U:N/2*(Math.sqrt(1-(L-=2)*L)+1)+U}function $(L,U,N,j){var G=1.70158,D=0,k=N;if(L===0)return U;if(L/=j,L===1)return U+N;D||(D=j*.3);var H=a(k,N,D,G);return-i(H,L,j)+U}function X(L,U,N,j){var G=1.70158,D=0,k=N;if(L===0)return U;if(L/=j,L===1)return U+N;D||(D=j*.3);var H=a(k,N,D,G);return H.a*Math.pow(2,-10*L)*Math.sin((L*j-H.s)*(2*Math.PI)/H.p)+H.c+U}function re(L,U,N,j){var G=1.70158,D=0,k=N;if(L===0)return U;if(L/=j/2,L===2)return U+N;D||(D=j*(.3*1.5));var H=a(k,N,D,G);return L<1?-.5*i(H,L,j)+U:H.a*Math.pow(2,-10*(L-=1))*Math.sin((L*j-H.s)*(2*Math.PI)/H.p)*.5+H.c+U}function he(L,U,N,j,G){return G===void 0&&(G=1.70158),N*(L/=j)*L*((G+1)*L-G)+U}function ne(L,U,N,j,G){return G===void 0&&(G=1.70158),N*((L=L/j-1)*L*((G+1)*L+G)+1)+U}function ce(L,U,N,j,G){return G===void 0&&(G=1.70158),L/=j/2,L<1?N/2*(L*L*(((G*=1.525)+1)*L-G))+U:N/2*((L-=2)*L*(((G*=1.525)+1)*L+G)+2)+U}function ue(L,U,N,j){return N-de(j-L,0,N,j)+U}function de(L,U,N,j){return(L/=j)<1/2.75?N*(7.5625*L*L)+U:L<2/2.75?N*(7.5625*(L-=1.5/2.75)*L+.75)+U:L<2.5/2.75?N*(7.5625*(L-=2.25/2.75)*L+.9375)+U:N*(7.5625*(L-=2.625/2.75)*L+.984375)+U}function fe(L,U,N,j){return L<j/2?ue(L*2,0,N,j)*.5+U:de(L*2-j,0,N,j)*.5+N*.5+U}h.util.ease={easeInQuad:function(L,U,N,j){return N*(L/=j)*L+U},easeOutQuad:function(L,U,N,j){return-N*(L/=j)*(L-2)+U},easeInOutQuad:function(L,U,N,j){return L/=j/2,L<1?N/2*L*L+U:-N/2*(--L*(L-2)-1)+U},easeInCubic:function(L,U,N,j){return N*(L/=j)*L*L+U},easeOutCubic:r,easeInOutCubic:o,easeInQuart:n,easeOutQuart:s,easeInOutQuart:l,easeInQuint:u,easeOutQuint:d,easeInOutQuint:f,easeInSine:p,easeOutSine:v,easeInOutSine:w,easeInExpo:C,easeOutExpo:b,easeInOutExpo:P,easeInCirc:R,easeOutCirc:A,easeInOutCirc:W,easeInElastic:$,easeOutElastic:X,easeInOutElastic:re,easeInBack:he,easeOutBack:ne,easeInOutBack:ce,easeInBounce:ue,easeOutBounce:de,easeInOutBounce:fe}}(),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.extend,o=i.util.object.clone,n=i.util.toFixed,s=i.util.parseUnit,l=i.util.multiplyTransformMatrices,u=["path","circle","polygon","polyline","ellipse","rect","line","image","text"],d=["symbol","image","marker","pattern","view","svg"],f=["pattern","defs","symbol","metadata","clipPath","mask","desc"],p=["symbol","g","a","svg","clipPath","defs"],v={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},w={stroke:"strokeOpacity",fill:"fillOpacity"},C="font-size",b="clip-path";i.svgValidTagNamesRegEx=A(u),i.svgViewBoxElementsRegEx=A(d),i.svgInvalidAncestorsRegEx=A(f),i.svgValidParentsRegEx=A(p),i.cssRules={},i.gradientDefs={},i.clipPaths={};function P(D){return D in v?v[D]:D}function R(D,k,H,F){var K=Object.prototype.toString.call(k)==="[object Array]",V;if((D==="fill"||D==="stroke")&&k==="none")k="";else{if(D==="strokeUniform")return k==="non-scaling-stroke";if(D==="strokeDashArray")k==="none"?k=null:k=k.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(D==="transformMatrix")H&&H.transformMatrix?k=l(H.transformMatrix,i.parseTransformAttribute(k)):k=i.parseTransformAttribute(k);else if(D==="visible")k=k!=="none"&&k!=="hidden",H&&H.visible===!1&&(k=!1);else if(D==="opacity")k=parseFloat(k),H&&typeof H.opacity!="undefined"&&(k*=H.opacity);else if(D==="textAnchor")k=k==="start"?"left":k==="end"?"right":"center";else if(D==="charSpacing")V=s(k,F)/F*1e3;else if(D==="paintFirst"){var te=k.indexOf("fill"),J=k.indexOf("stroke"),k="fill";(te>-1&&J>-1&&J<te||te===-1&&J>-1)&&(k="stroke")}else{if(D==="href"||D==="xlink:href"||D==="font")return k;if(D==="imageSmoothing")return k==="optimizeQuality";V=K?k.map(s):s(k,F)}}return!K&&isNaN(V)?k:V}function A(D){return new RegExp("^("+D.join("|")+")\\b","i")}function W(D){for(var k in w)if(!(typeof D[w[k]]=="undefined"||D[k]==="")){if(typeof D[k]=="undefined"){if(!i.Object.prototype[k])continue;D[k]=i.Object.prototype[k]}if(D[k].indexOf("url(")!==0){var H=new i.Color(D[k]);D[k]=H.setAlpha(n(H.getAlpha()*D[w[k]],2)).toRgba()}}return D}function $(D,k){var H,F=[],K,V,te;for(V=0,te=k.length;V<te;V++)H=k[V],K=D.getElementsByTagName(H),F=F.concat(Array.prototype.slice.call(K));return F}i.parseTransformAttribute=function(){function D(Z,oe){var ae=i.util.cos(oe[0]),ge=i.util.sin(oe[0]),me=0,ye=0;oe.length===3&&(me=oe[1],ye=oe[2]),Z[0]=ae,Z[1]=ge,Z[2]=-ge,Z[3]=ae,Z[4]=me-(ae*me-ge*ye),Z[5]=ye-(ge*me+ae*ye)}function k(Z,oe){var ae=oe[0],ge=oe.length===2?oe[1]:oe[0];Z[0]=ae,Z[3]=ge}function H(Z,oe,ae){Z[ae]=Math.tan(i.util.degreesToRadians(oe[0]))}function F(Z,oe){Z[4]=oe[0],oe.length===2&&(Z[5]=oe[1])}var K=i.iMatrix,V=i.reNum,te=i.commaWsp,J="(?:(skewX)\\s*\\(\\s*("+V+")\\s*\\))",ie="(?:(skewY)\\s*\\(\\s*("+V+")\\s*\\))",Y="(?:(rotate)\\s*\\(\\s*("+V+")(?:"+te+"("+V+")"+te+"("+V+"))?\\s*\\))",x="(?:(scale)\\s*\\(\\s*("+V+")(?:"+te+"("+V+"))?\\s*\\))",E="(?:(translate)\\s*\\(\\s*("+V+")(?:"+te+"("+V+"))?\\s*\\))",I="(?:(matrix)\\s*\\(\\s*("+V+")"+te+"("+V+")"+te+"("+V+")"+te+"("+V+")"+te+"("+V+")"+te+"("+V+")\\s*\\))",z="(?:"+I+"|"+E+"|"+x+"|"+Y+"|"+J+"|"+ie+")",B="(?:"+z+"(?:"+te+"*"+z+")*)",q="^\\s*(?:"+B+"?)\\s*$",ee=new RegExp(q),le=new RegExp(z,"g");return function(Z){var oe=K.concat(),ae=[];if(!Z||Z&&!ee.test(Z))return oe;Z.replace(le,function(me){var ye=new RegExp(z).exec(me).filter(function(T){return!!T}),_e=ye[1],S=ye.slice(2).map(parseFloat);switch(_e){case"translate":F(oe,S);break;case"rotate":S[0]=i.util.degreesToRadians(S[0]),D(oe,S);break;case"scale":k(oe,S);break;case"skewX":H(oe,S,2);break;case"skewY":H(oe,S,1);break;case"matrix":oe=S;break}ae.push(oe.concat()),oe=K.concat()});for(var ge=ae[0];ae.length>1;)ae.shift(),ge=i.util.multiplyTransformMatrices(ge,ae[0]);return ge}}();function X(D,k){var H,F;D.replace(/;\s*$/,"").split(";").forEach(function(K){var V=K.split(":");H=V[0].trim().toLowerCase(),F=V[1].trim(),k[H]=F})}function re(D,k){var H,F;for(var K in D)typeof D[K]!="undefined"&&(H=K.toLowerCase(),F=D[K],k[H]=F)}function he(D,k){var H={};for(var F in i.cssRules[k])if(ne(D,F.split(" ")))for(var K in i.cssRules[k][F])H[K]=i.cssRules[k][F][K];return H}function ne(D,k){var H,F=!0;return H=ue(D,k.pop()),H&&k.length&&(F=ce(D,k)),H&&F&&k.length===0}function ce(D,k){for(var H,F=!0;D.parentNode&&D.parentNode.nodeType===1&&k.length;)F&&(H=k.pop()),D=D.parentNode,F=ue(D,H);return k.length===0}function ue(D,k){var H=D.nodeName,F=D.getAttribute("class"),K=D.getAttribute("id"),V,te;if(V=new RegExp("^"+H,"i"),k=k.replace(V,""),K&&k.length&&(V=new RegExp("#"+K+"(?![a-zA-Z\\-]+)","i"),k=k.replace(V,"")),F&&k.length)for(F=F.split(" "),te=F.length;te--;)V=new RegExp("\\."+F[te]+"(?![a-zA-Z\\-]+)","i"),k=k.replace(V,"");return k.length===0}function de(D,k){var H;if(D.getElementById&&(H=D.getElementById(k)),H)return H;var F,K,V,te=D.getElementsByTagName("*");for(K=0,V=te.length;K<V;K++)if(F=te[K],k===F.getAttribute("id"))return F}function fe(D){for(var k=$(D,["use","svg:use"]),H=0;k.length&&H<k.length;){var F=k[H],K=F.getAttribute("xlink:href")||F.getAttribute("href");if(K===null)return;var V=K.substr(1),te=F.getAttribute("x")||0,J=F.getAttribute("y")||0,ie=de(D,V).cloneNode(!0),Y=(ie.getAttribute("transform")||"")+" translate("+te+", "+J+")",x,E=k.length,I,z,B,q,ee=i.svgNS;if(U(ie),/^svg$/i.test(ie.nodeName)){var le=ie.ownerDocument.createElementNS(ee,"g");for(z=0,B=ie.attributes,q=B.length;z<q;z++)I=B.item(z),le.setAttributeNS(ee,I.nodeName,I.nodeValue);for(;ie.firstChild;)le.appendChild(ie.firstChild);ie=le}for(z=0,B=F.attributes,q=B.length;z<q;z++)I=B.item(z),!(I.nodeName==="x"||I.nodeName==="y"||I.nodeName==="xlink:href"||I.nodeName==="href")&&(I.nodeName==="transform"?Y=I.nodeValue+" "+Y:ie.setAttribute(I.nodeName,I.nodeValue));ie.setAttribute("transform",Y),ie.setAttribute("instantiated_by_use","1"),ie.removeAttribute("id"),x=F.parentNode,x.replaceChild(ie,F),k.length===E&&H++}}var L=new RegExp("^\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*$");function U(D){if(!i.svgViewBoxElementsRegEx.test(D.nodeName))return{};var k=D.getAttribute("viewBox"),H=1,F=1,K=0,V=0,te,J,ie,Y,x=D.getAttribute("width"),E=D.getAttribute("height"),I=D.getAttribute("x")||0,z=D.getAttribute("y")||0,B=D.getAttribute("preserveAspectRatio")||"",q=!k||!(k=k.match(L)),ee=!x||!E||x==="100%"||E==="100%",le=q&&ee,Z={},oe="",ae=0,ge=0;if(Z.width=0,Z.height=0,Z.toBeParsed=le,q&&(I||z)&&D.parentNode&&D.parentNode.nodeName!=="#document"&&(oe=" translate("+s(I)+" "+s(z)+") ",ie=(D.getAttribute("transform")||"")+oe,D.setAttribute("transform",ie),D.removeAttribute("x"),D.removeAttribute("y")),le)return Z;if(q)return Z.width=s(x),Z.height=s(E),Z;if(K=-parseFloat(k[1]),V=-parseFloat(k[2]),te=parseFloat(k[3]),J=parseFloat(k[4]),Z.minX=K,Z.minY=V,Z.viewBoxWidth=te,Z.viewBoxHeight=J,ee?(Z.width=te,Z.height=J):(Z.width=s(x),Z.height=s(E),H=Z.width/te,F=Z.height/J),B=i.util.parsePreserveAspectRatioAttribute(B),B.alignX!=="none"&&(B.meetOrSlice==="meet"&&(F=H=H>F?F:H),B.meetOrSlice==="slice"&&(F=H=H>F?H:F),ae=Z.width-te*H,ge=Z.height-J*H,B.alignX==="Mid"&&(ae/=2),B.alignY==="Mid"&&(ge/=2),B.alignX==="Min"&&(ae=0),B.alignY==="Min"&&(ge=0)),H===1&&F===1&&K===0&&V===0&&I===0&&z===0)return Z;if((I||z)&&D.parentNode.nodeName!=="#document"&&(oe=" translate("+s(I)+" "+s(z)+") "),ie=oe+" matrix("+H+" 0 0 "+F+" "+(K*H+ae)+" "+(V*F+ge)+") ",D.nodeName==="svg"){for(Y=D.ownerDocument.createElementNS(i.svgNS,"g");D.firstChild;)Y.appendChild(D.firstChild);D.appendChild(Y)}else Y=D,Y.removeAttribute("x"),Y.removeAttribute("y"),ie=Y.getAttribute("transform")+ie;return Y.setAttribute("transform",ie),Z}function N(D,k){for(;D&&(D=D.parentNode);)if(D.nodeName&&k.test(D.nodeName.replace("svg:",""))&&!D.getAttribute("instantiated_by_use"))return!0;return!1}i.parseSVGDocument=function(D,k,H,F){if(!!D){fe(D);var K=i.Object.__uid++,V,te,J=U(D),ie=i.util.toArray(D.getElementsByTagName("*"));if(J.crossOrigin=F&&F.crossOrigin,J.svgUid=K,ie.length===0&&i.isLikelyNode){ie=D.selectNodes('//*[name(.)!="svg"]');var Y=[];for(V=0,te=ie.length;V<te;V++)Y[V]=ie[V];ie=Y}var x=ie.filter(function(I){return U(I),i.svgValidTagNamesRegEx.test(I.nodeName.replace("svg:",""))&&!N(I,i.svgInvalidAncestorsRegEx)});if(!x||x&&!x.length){k&&k([],{});return}var E={};ie.filter(function(I){return I.nodeName.replace("svg:","")==="clipPath"}).forEach(function(I){var z=I.getAttribute("id");E[z]=i.util.toArray(I.getElementsByTagName("*")).filter(function(B){return i.svgValidTagNamesRegEx.test(B.nodeName.replace("svg:",""))})}),i.gradientDefs[K]=i.getGradientDefs(D),i.cssRules[K]=i.getCSSRules(D),i.clipPaths[K]=E,i.parseElements(x,function(I,z){k&&(k(I,J,z,ie),delete i.gradientDefs[K],delete i.cssRules[K],delete i.clipPaths[K])},o(J),H,F)}};function j(D,k){var H=["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"],F="xlink:href",K=k.getAttribute(F).substr(1),V=de(D,K);if(V&&V.getAttribute(F)&&j(D,V),H.forEach(function(J){V&&!k.hasAttribute(J)&&V.hasAttribute(J)&&k.setAttribute(J,V.getAttribute(J))}),!k.children.length)for(var te=V.cloneNode(!0);te.firstChild;)k.appendChild(te.firstChild);k.removeAttribute(F)}var G=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+i.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+i.reNum+"))?\\s+(.*)");r(i,{parseFontDeclaration:function(D,k){var H=D.match(G);if(!!H){var F=H[1],K=H[3],V=H[4],te=H[5],J=H[6];F&&(k.fontStyle=F),K&&(k.fontWeight=isNaN(parseFloat(K))?K:parseFloat(K)),V&&(k.fontSize=s(V)),J&&(k.fontFamily=J),te&&(k.lineHeight=te==="normal"?1:te)}},getGradientDefs:function(D){var k=["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"],H=$(D,k),F,K=0,V={};for(K=H.length;K--;)F=H[K],F.getAttribute("xlink:href")&&j(D,F),V[F.getAttribute("id")]=F;return V},parseAttributes:function(D,k,H){if(!!D){var F,K={},V,te;typeof H=="undefined"&&(H=D.getAttribute("svgUid")),D.parentNode&&i.svgValidParentsRegEx.test(D.parentNode.nodeName)&&(K=i.parseAttributes(D.parentNode,k,H));var J=k.reduce(function(B,q){return F=D.getAttribute(q),F&&(B[q]=F),B},{}),ie=r(he(D,H),i.parseStyleAttribute(D));J=r(J,ie),ie[b]&&D.setAttribute(b,ie[b]),V=te=K.fontSize||i.Text.DEFAULT_SVG_FONT_SIZE,J[C]&&(J[C]=V=s(J[C],te));var Y,x,E={};for(var I in J)Y=P(I),x=R(Y,J[I],K,V),E[Y]=x;E&&E.font&&i.parseFontDeclaration(E.font,E);var z=r(K,E);return i.svgValidParentsRegEx.test(D.nodeName)?z:W(z)}},parseElements:function(D,k,H,F,K){new i.ElementsParser(D,k,H,F,K).parse()},parseStyleAttribute:function(D){var k={},H=D.getAttribute("style");return H&&(typeof H=="string"?X(H,k):re(H,k)),k},parsePointsAttribute:function(D){if(!D)return null;D=D.replace(/,/g," ").trim(),D=D.split(/\s+/);var k=[],H,F;for(H=0,F=D.length;H<F;H+=2)k.push({x:parseFloat(D[H]),y:parseFloat(D[H+1])});return k},getCSSRules:function(D){var k=D.getElementsByTagName("style"),H,F,K={},V;for(H=0,F=k.length;H<F;H++){var te=k[H].textContent;te=te.replace(/\/\*[\s\S]*?\*\//g,""),te.trim()!==""&&(V=te.match(/[^{]*\{[\s\S]*?\}/g),V=V.map(function(J){return J.trim()}),V.forEach(function(J){var ie=J.match(/([\s\S]*?)\s*\{([^}]*)\}/),Y={},x=ie[2].trim(),E=x.replace(/;$/,"").split(/\s*;\s*/);for(H=0,F=E.length;H<F;H++){var I=E[H].split(/\s*:\s*/),z=I[0],B=I[1];Y[z]=B}J=ie[1],J.split(",").forEach(function(q){q=q.replace(/^svg/i,"").trim(),q!==""&&(K[q]?i.util.object.extend(K[q],Y):K[q]=i.util.object.clone(Y))})}))}return K},loadSVGFromURL:function(D,k,H,F){D=D.replace(/^\n\s*/,"").trim(),new i.util.request(D,{method:"get",onComplete:K});function K(V){var te=V.responseXML;if(!te||!te.documentElement)return k&&k(null),!1;i.parseSVGDocument(te.documentElement,function(J,ie,Y,x){k&&k(J,ie,Y,x)},H,F)}},loadSVGFromString:function(D,k,H,F){var K=new i.window.DOMParser,V=K.parseFromString(D.trim(),"text/xml");i.parseSVGDocument(V.documentElement,function(te,J,ie,Y){k(te,J,ie,Y)},H,F)}})}(e),h.ElementsParser=function(a,i,r,o,n,s){this.elements=a,this.callback=i,this.options=r,this.reviver=o,this.svgUid=r&&r.svgUid||0,this.parsingOptions=n,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=s},function(a){a.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},a.createObjects=function(){var i=this;this.elements.forEach(function(r,o){r.setAttribute("svgUid",i.svgUid),i.createObject(r,o)})},a.findTag=function(i){return h[h.util.string.capitalize(i.tagName.replace("svg:",""))]},a.createObject=function(i,r){var o=this.findTag(i);if(o&&o.fromElement)try{o.fromElement(i,this.createCallback(r,i),this.options)}catch(n){h.log(n)}else this.checkIfDone()},a.createCallback=function(i,r){var o=this;return function(n){var s;o.resolveGradient(n,r,"fill"),o.resolveGradient(n,r,"stroke"),n instanceof h.Image&&n._originalElement&&(s=n.parsePreserveAspectRatioAttribute(r)),n._removeTransformMatrix(s),o.resolveClipPath(n,r),o.reviver&&o.reviver(r,n),o.instances[i]=n,o.checkIfDone()}},a.extractPropertyDefinition=function(i,r,o){var n=i[r],s=this.regexUrl;if(!!s.test(n)){s.lastIndex=0;var l=s.exec(n)[1];return s.lastIndex=0,h[o][this.svgUid][l]}},a.resolveGradient=function(i,r,o){var n=this.extractPropertyDefinition(i,o,"gradientDefs");if(n){var s=r.getAttribute(o+"-opacity"),l=h.Gradient.fromElement(n,i,s,this.options);i.set(o,l)}},a.createClipPathCallback=function(i,r){return function(o){o._removeTransformMatrix(),o.fillRule=o.clipRule,r.push(o)}},a.resolveClipPath=function(i,r){var o=this.extractPropertyDefinition(i,"clipPath","clipPaths"),n,s,l,u,d,f;if(o){u=[],l=h.util.invertTransform(i.calcTransformMatrix());for(var p=o[0].parentNode,v=r;v.parentNode&&v.getAttribute("clip-path")!==i.clipPath;)v=v.parentNode;v.parentNode.appendChild(p);for(var w=0;w<o.length;w++)n=o[w],s=this.findTag(n),s.fromElement(n,this.createClipPathCallback(i,u),this.options);u.length===1?o=u[0]:o=new h.Group(u),d=h.util.multiplyTransformMatrices(l,o.calcTransformMatrix()),o.clipPath&&this.resolveClipPath(o,v);var f=h.util.qrDecompose(d);o.flipX=!1,o.flipY=!1,o.set("scaleX",f.scaleX),o.set("scaleY",f.scaleY),o.angle=f.angle,o.skewX=f.skewX,o.skewY=0,o.setPositionByOrigin({x:f.translateX,y:f.translateY},"center","center"),i.clipPath=o}else delete i.clipPath},a.checkIfDone=function(){--this.numElements===0&&(this.instances=this.instances.filter(function(i){return i!=null}),this.callback(this.instances,this.elements))}}(h.ElementsParser.prototype),function(a){var i=a.fabric||(a.fabric={});if(i.Point){i.warn("fabric.Point is already defined");return}i.Point=r;function r(o,n){this.x=o,this.y=n}r.prototype={type:"point",constructor:r,add:function(o){return new r(this.x+o.x,this.y+o.y)},addEquals:function(o){return this.x+=o.x,this.y+=o.y,this},scalarAdd:function(o){return new r(this.x+o,this.y+o)},scalarAddEquals:function(o){return this.x+=o,this.y+=o,this},subtract:function(o){return new r(this.x-o.x,this.y-o.y)},subtractEquals:function(o){return this.x-=o.x,this.y-=o.y,this},scalarSubtract:function(o){return new r(this.x-o,this.y-o)},scalarSubtractEquals:function(o){return this.x-=o,this.y-=o,this},multiply:function(o){return new r(this.x*o,this.y*o)},multiplyEquals:function(o){return this.x*=o,this.y*=o,this},divide:function(o){return new r(this.x/o,this.y/o)},divideEquals:function(o){return this.x/=o,this.y/=o,this},eq:function(o){return this.x===o.x&&this.y===o.y},lt:function(o){return this.x<o.x&&this.y<o.y},lte:function(o){return this.x<=o.x&&this.y<=o.y},gt:function(o){return this.x>o.x&&this.y>o.y},gte:function(o){return this.x>=o.x&&this.y>=o.y},lerp:function(o,n){return typeof n=="undefined"&&(n=.5),n=Math.max(Math.min(1,n),0),new r(this.x+(o.x-this.x)*n,this.y+(o.y-this.y)*n)},distanceFrom:function(o){var n=this.x-o.x,s=this.y-o.y;return Math.sqrt(n*n+s*s)},midPointFrom:function(o){return this.lerp(o)},min:function(o){return new r(Math.min(this.x,o.x),Math.min(this.y,o.y))},max:function(o){return new r(Math.max(this.x,o.x),Math.max(this.y,o.y))},toString:function(){return this.x+","+this.y},setXY:function(o,n){return this.x=o,this.y=n,this},setX:function(o){return this.x=o,this},setY:function(o){return this.y=o,this},setFromPoint:function(o){return this.x=o.x,this.y=o.y,this},swap:function(o){var n=this.x,s=this.y;this.x=o.x,this.y=o.y,o.x=n,o.y=s},clone:function(){return new r(this.x,this.y)}}}(e),function(a){var i=a.fabric||(a.fabric={});if(i.Intersection){i.warn("fabric.Intersection is already defined");return}function r(o){this.status=o,this.points=[]}i.Intersection=r,i.Intersection.prototype={constructor:r,appendPoint:function(o){return this.points.push(o),this},appendPoints:function(o){return this.points=this.points.concat(o),this}},i.Intersection.intersectLineLine=function(o,n,s,l){var u,d=(l.x-s.x)*(o.y-s.y)-(l.y-s.y)*(o.x-s.x),f=(n.x-o.x)*(o.y-s.y)-(n.y-o.y)*(o.x-s.x),p=(l.y-s.y)*(n.x-o.x)-(l.x-s.x)*(n.y-o.y);if(p!==0){var v=d/p,w=f/p;0<=v&&v<=1&&0<=w&&w<=1?(u=new r("Intersection"),u.appendPoint(new i.Point(o.x+v*(n.x-o.x),o.y+v*(n.y-o.y)))):u=new r}else d===0||f===0?u=new r("Coincident"):u=new r("Parallel");return u},i.Intersection.intersectLinePolygon=function(o,n,s){var l=new r,u=s.length,d,f,p,v;for(v=0;v<u;v++)d=s[v],f=s[(v+1)%u],p=r.intersectLineLine(o,n,d,f),l.appendPoints(p.points);return l.points.length>0&&(l.status="Intersection"),l},i.Intersection.intersectPolygonPolygon=function(o,n){var s=new r,l=o.length,u;for(u=0;u<l;u++){var d=o[u],f=o[(u+1)%l],p=r.intersectLinePolygon(d,f,n);s.appendPoints(p.points)}return s.points.length>0&&(s.status="Intersection"),s},i.Intersection.intersectPolygonRectangle=function(o,n,s){var l=n.min(s),u=n.max(s),d=new i.Point(u.x,l.y),f=new i.Point(l.x,u.y),p=r.intersectLinePolygon(l,d,o),v=r.intersectLinePolygon(d,u,o),w=r.intersectLinePolygon(u,f,o),C=r.intersectLinePolygon(f,l,o),b=new r;return b.appendPoints(p.points),b.appendPoints(v.points),b.appendPoints(w.points),b.appendPoints(C.points),b.points.length>0&&(b.status="Intersection"),b}}(e),function(a){var i=a.fabric||(a.fabric={});if(i.Color){i.warn("fabric.Color is already defined.");return}function r(n){n?this._tryParsingColor(n):this.setSource([0,0,0,1])}i.Color=r,i.Color.prototype={_tryParsingColor:function(n){var s;n in r.colorNameMap&&(n=r.colorNameMap[n]),n==="transparent"&&(s=[255,255,255,0]),s||(s=r.sourceFromHex(n)),s||(s=r.sourceFromRgb(n)),s||(s=r.sourceFromHsl(n)),s||(s=[0,0,0,1]),s&&this.setSource(s)},_rgbToHsl:function(n,s,l){n/=255,s/=255,l/=255;var u,d,f,p=i.util.array.max([n,s,l]),v=i.util.array.min([n,s,l]);if(f=(p+v)/2,p===v)u=d=0;else{var w=p-v;switch(d=f>.5?w/(2-p-v):w/(p+v),p){case n:u=(s-l)/w+(s<l?6:0);break;case s:u=(l-n)/w+2;break;case l:u=(n-s)/w+4;break}u/=6}return[Math.round(u*360),Math.round(d*100),Math.round(f*100)]},getSource:function(){return this._source},setSource:function(n){this._source=n},toRgb:function(){var n=this.getSource();return"rgb("+n[0]+","+n[1]+","+n[2]+")"},toRgba:function(){var n=this.getSource();return"rgba("+n[0]+","+n[1]+","+n[2]+","+n[3]+")"},toHsl:function(){var n=this.getSource(),s=this._rgbToHsl(n[0],n[1],n[2]);return"hsl("+s[0]+","+s[1]+"%,"+s[2]+"%)"},toHsla:function(){var n=this.getSource(),s=this._rgbToHsl(n[0],n[1],n[2]);return"hsla("+s[0]+","+s[1]+"%,"+s[2]+"%,"+n[3]+")"},toHex:function(){var n=this.getSource(),s,l,u;return s=n[0].toString(16),s=s.length===1?"0"+s:s,l=n[1].toString(16),l=l.length===1?"0"+l:l,u=n[2].toString(16),u=u.length===1?"0"+u:u,s.toUpperCase()+l.toUpperCase()+u.toUpperCase()},toHexa:function(){var n=this.getSource(),s;return s=Math.round(n[3]*255),s=s.toString(16),s=s.length===1?"0"+s:s,this.toHex()+s.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(n){var s=this.getSource();return s[3]=n,this.setSource(s),this},toGrayscale:function(){var n=this.getSource(),s=parseInt((n[0]*.3+n[1]*.59+n[2]*.11).toFixed(0),10),l=n[3];return this.setSource([s,s,s,l]),this},toBlackWhite:function(n){var s=this.getSource(),l=(s[0]*.3+s[1]*.59+s[2]*.11).toFixed(0),u=s[3];return n=n||127,l=Number(l)<Number(n)?0:255,this.setSource([l,l,l,u]),this},overlayWith:function(n){n instanceof r||(n=new r(n));var s=[],l=this.getAlpha(),u=.5,d=this.getSource(),f=n.getSource(),p;for(p=0;p<3;p++)s.push(Math.round(d[p]*(1-u)+f[p]*u));return s[3]=l,this.setSource(s),this}},i.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,i.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,i.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,i.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"};function o(n,s,l){return l<0&&(l+=1),l>1&&(l-=1),l<1/6?n+(s-n)*6*l:l<1/2?s:l<2/3?n+(s-n)*(2/3-l)*6:n}i.Color.fromRgb=function(n){return r.fromSource(r.sourceFromRgb(n))},i.Color.sourceFromRgb=function(n){var s=n.match(r.reRGBa);if(s){var l=parseInt(s[1],10)/(/%$/.test(s[1])?100:1)*(/%$/.test(s[1])?255:1),u=parseInt(s[2],10)/(/%$/.test(s[2])?100:1)*(/%$/.test(s[2])?255:1),d=parseInt(s[3],10)/(/%$/.test(s[3])?100:1)*(/%$/.test(s[3])?255:1);return[parseInt(l,10),parseInt(u,10),parseInt(d,10),s[4]?parseFloat(s[4]):1]}},i.Color.fromRgba=r.fromRgb,i.Color.fromHsl=function(n){return r.fromSource(r.sourceFromHsl(n))},i.Color.sourceFromHsl=function(n){var s=n.match(r.reHSLa);if(!!s){var l=(parseFloat(s[1])%360+360)%360/360,u=parseFloat(s[2])/(/%$/.test(s[2])?100:1),d=parseFloat(s[3])/(/%$/.test(s[3])?100:1),f,p,v;if(u===0)f=p=v=d;else{var w=d<=.5?d*(u+1):d+u-d*u,C=d*2-w;f=o(C,w,l+1/3),p=o(C,w,l),v=o(C,w,l-1/3)}return[Math.round(f*255),Math.round(p*255),Math.round(v*255),s[4]?parseFloat(s[4]):1]}},i.Color.fromHsla=r.fromHsl,i.Color.fromHex=function(n){return r.fromSource(r.sourceFromHex(n))},i.Color.sourceFromHex=function(n){if(n.match(r.reHex)){var s=n.slice(n.indexOf("#")+1),l=s.length===3||s.length===4,u=s.length===8||s.length===4,d=l?s.charAt(0)+s.charAt(0):s.substring(0,2),f=l?s.charAt(1)+s.charAt(1):s.substring(2,4),p=l?s.charAt(2)+s.charAt(2):s.substring(4,6),v=u?l?s.charAt(3)+s.charAt(3):s.substring(6,8):"FF";return[parseInt(d,16),parseInt(f,16),parseInt(p,16),parseFloat((parseInt(v,16)/255).toFixed(2))]}},i.Color.fromSource=function(n){var s=new r;return s.setSource(n),s}}(e),function(a){var i=a.fabric||(a.fabric={}),r=["e","se","s","sw","w","nw","n","ne","e"],o=["ns","nesw","ew","nwse"],n={},s="left",l="top",u="right",d="bottom",f="center",p={top:d,bottom:l,left:u,right:s,center:f},v=i.util.radiansToDegrees,w=Math.sign||function(Y){return(Y>0)-(Y<0)||+Y};function C(Y,x){var E=Y.angle+v(Math.atan2(x.y,x.x))+360;return Math.round(E%360/45)}function b(Y,x){var E=x.transform.target,I=E.canvas,z=i.util.object.clone(x);z.target=E,I&&I.fire("object:"+Y,z),E.fire(Y,x)}function P(Y,x){var E=x.canvas,I=E.uniScaleKey,z=Y[I];return E.uniformScaling&&!z||!E.uniformScaling&&z}function R(Y){return Y.originX===f&&Y.originY===f}function A(Y,x,E){var I=Y.lockScalingX,z=Y.lockScalingY;return!!(I&&z||!x&&(I||z)&&E||I&&x==="x"||z&&x==="y")}function W(Y,x,E){var I="not-allowed",z=P(Y,E),B="";if(x.x!==0&&x.y===0?B="x":x.x===0&&x.y!==0&&(B="y"),A(E,B,z))return I;var q=C(E,x);return r[q]+"-resize"}function $(Y,x,E){var I="not-allowed";if(x.x!==0&&E.lockSkewingY||x.y!==0&&E.lockSkewingX)return I;var z=C(E,x)%4;return o[z]+"-resize"}function X(Y,x,E){return Y[E.canvas.altActionKey]?n.skewCursorStyleHandler(Y,x,E):n.scaleCursorStyleHandler(Y,x,E)}function re(Y,x,E){var I=Y[E.canvas.altActionKey];if(x.x===0)return I?"skewX":"scaleY";if(x.y===0)return I?"skewY":"scaleX"}function he(Y,x,E){return E.lockRotation?"not-allowed":x.cursorStyle}function ne(Y,x,E,I){return{e:Y,transform:x,pointer:{x:E,y:I}}}function ce(Y){return function(x,E,I,z){var B=E.target,q=B.getCenterPoint(),ee=B.translateToOriginPoint(q,E.originX,E.originY),le=Y(x,E,I,z);return B.setPositionByOrigin(ee,E.originX,E.originY),le}}function ue(Y,x){return function(E,I,z,B){var q=x(E,I,z,B);return q&&b(Y,ne(E,I,z,B)),q}}function de(Y,x,E,I,z){var B=Y.target,q=B.controls[Y.corner],ee=B.canvas.getZoom(),le=B.padding/ee,Z=B.toLocalPoint(new i.Point(I,z),x,E);return Z.x>=le&&(Z.x-=le),Z.x<=-le&&(Z.x+=le),Z.y>=le&&(Z.y-=le),Z.y<=le&&(Z.y+=le),Z.x-=q.offsetX,Z.y-=q.offsetY,Z}function fe(Y){return Y.flipX!==Y.flipY}function L(Y,x,E,I,z){if(Y[x]!==0){var B=Y._getTransformedDimensions()[I],q=z/B*Y[E];Y.set(E,q)}}function U(Y,x,E,I){var z=x.target,B=z._getTransformedDimensions(0,z.skewY),q=de(x,x.originX,x.originY,E,I),ee=Math.abs(q.x*2)-B.x,le=z.skewX,Z;ee<2?Z=0:(Z=v(Math.atan2(ee/z.scaleX,B.y/z.scaleY)),x.originX===s&&x.originY===d&&(Z=-Z),x.originX===u&&x.originY===l&&(Z=-Z),fe(z)&&(Z=-Z));var oe=le!==Z;if(oe){var ae=z._getTransformedDimensions().y;z.set("skewX",Z),L(z,"skewY","scaleY","y",ae)}return oe}function N(Y,x,E,I){var z=x.target,B=z._getTransformedDimensions(z.skewX,0),q=de(x,x.originX,x.originY,E,I),ee=Math.abs(q.y*2)-B.y,le=z.skewY,Z;ee<2?Z=0:(Z=v(Math.atan2(ee/z.scaleY,B.x/z.scaleX)),x.originX===s&&x.originY===d&&(Z=-Z),x.originX===u&&x.originY===l&&(Z=-Z),fe(z)&&(Z=-Z));var oe=le!==Z;if(oe){var ae=z._getTransformedDimensions().x;z.set("skewY",Z),L(z,"skewX","scaleX","x",ae)}return oe}function j(Y,x,E,I){var z=x.target,B=z.skewX,q,ee=x.originY;if(z.lockSkewingX)return!1;if(B===0){var le=de(x,f,f,E,I);le.x>0?q=s:q=u}else B>0&&(q=ee===l?s:u),B<0&&(q=ee===l?u:s),fe(z)&&(q=q===s?u:s);x.originX=q;var Z=ue("skewing",ce(U));return Z(Y,x,E,I)}function G(Y,x,E,I){var z=x.target,B=z.skewY,q,ee=x.originX;if(z.lockSkewingY)return!1;if(B===0){var le=de(x,f,f,E,I);le.y>0?q=l:q=d}else B>0&&(q=ee===s?l:d),B<0&&(q=ee===s?d:l),fe(z)&&(q=q===l?d:l);x.originY=q;var Z=ue("skewing",ce(N));return Z(Y,x,E,I)}function D(Y,x,E,I){var z=x,B=z.target,q=B.translateToOriginPoint(B.getCenterPoint(),z.originX,z.originY);if(B.lockRotation)return!1;var ee=Math.atan2(z.ey-q.y,z.ex-q.x),le=Math.atan2(I-q.y,E-q.x),Z=v(le-ee+z.theta),oe=!0;if(B.snapAngle>0){var ae=B.snapAngle,ge=B.snapThreshold||ae,me=Math.ceil(Z/ae)*ae,ye=Math.floor(Z/ae)*ae;Math.abs(Z-ye)<ge?Z=ye:Math.abs(Z-me)<ge&&(Z=me)}return Z<0&&(Z=360+Z),Z%=360,oe=B.angle!==Z,B.angle=Z,oe}function k(Y,x,E,I,z){z=z||{};var B=x.target,q=B.lockScalingX,ee=B.lockScalingY,le=z.by,Z,oe,ae,ge,me=P(Y,B),ye=A(B,le,me),_e,S,T=x.gestureScale;if(ye)return!1;if(T)oe=x.scaleX*T,ae=x.scaleY*T;else{if(Z=de(x,x.originX,x.originY,E,I),_e=le!=="y"?w(Z.x):1,S=le!=="x"?w(Z.y):1,x.signX||(x.signX=_e),x.signY||(x.signY=S),B.lockScalingFlip&&(x.signX!==_e||x.signY!==S))return!1;if(ge=B._getTransformedDimensions(),me&&!le){var O=Math.abs(Z.x)+Math.abs(Z.y),M=x.original,Q=Math.abs(ge.x*M.scaleX/B.scaleX)+Math.abs(ge.y*M.scaleY/B.scaleY),se=O/Q;oe=M.scaleX*se,ae=M.scaleY*se}else oe=Math.abs(Z.x*B.scaleX/ge.x),ae=Math.abs(Z.y*B.scaleY/ge.y);R(x)&&(oe*=2,ae*=2),x.signX!==_e&&le!=="y"&&(x.originX=p[x.originX],oe*=-1,x.signX=_e),x.signY!==S&&le!=="x"&&(x.originY=p[x.originY],ae*=-1,x.signY=S)}var pe=B.scaleX,we=B.scaleY;return le?(le==="x"&&B.set("scaleX",oe),le==="y"&&B.set("scaleY",ae)):(!q&&B.set("scaleX",oe),!ee&&B.set("scaleY",ae)),pe!==B.scaleX||we!==B.scaleY}function H(Y,x,E,I){return k(Y,x,E,I)}function F(Y,x,E,I){return k(Y,x,E,I,{by:"x"})}function K(Y,x,E,I){return k(Y,x,E,I,{by:"y"})}function V(Y,x,E,I){return Y[x.target.canvas.altActionKey]?n.skewHandlerX(Y,x,E,I):n.scalingY(Y,x,E,I)}function te(Y,x,E,I){return Y[x.target.canvas.altActionKey]?n.skewHandlerY(Y,x,E,I):n.scalingX(Y,x,E,I)}function J(Y,x,E,I){var z=x.target,B=de(x,x.originX,x.originY,E,I),q=z.strokeWidth/(z.strokeUniform?z.scaleX:1),ee=R(x)?2:1,le=z.width,Z=Math.abs(B.x*ee/z.scaleX)-q;return z.set("width",Math.max(Z,0)),le!==Z}function ie(Y,x,E,I){var z=x.target,B=E-x.offsetX,q=I-x.offsetY,ee=!z.get("lockMovementX")&&z.left!==B,le=!z.get("lockMovementY")&&z.top!==q;return ee&&z.set("left",B),le&&z.set("top",q),(ee||le)&&b("moving",ne(Y,x,E,I)),ee||le}n.scaleCursorStyleHandler=W,n.skewCursorStyleHandler=$,n.scaleSkewCursorStyleHandler=X,n.rotationWithSnapping=ue("rotating",ce(D)),n.scalingEqually=ue("scaling",ce(H)),n.scalingX=ue("scaling",ce(F)),n.scalingY=ue("scaling",ce(K)),n.scalingYOrSkewingX=V,n.scalingXOrSkewingY=te,n.changeWidth=ue("resizing",ce(J)),n.skewHandlerX=j,n.skewHandlerY=G,n.dragHandler=ie,n.scaleOrSkewActionName=re,n.rotationStyleHandler=he,n.fireEvent=b,n.wrapWithFixedAnchor=ce,n.wrapWithFireEvent=ue,n.getLocalPoint=de,i.controlsUtils=n}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.degreesToRadians,o=i.controlsUtils;function n(l,u,d,f,p){f=f||{};var v=this.sizeX||f.cornerSize||p.cornerSize,w=this.sizeY||f.cornerSize||p.cornerSize,C=typeof f.transparentCorners!="undefined"?f.transparentCorners:p.transparentCorners,b=C?"stroke":"fill",P=!C&&(f.cornerStrokeColor||p.cornerStrokeColor),R=u,A=d,W;l.save(),l.fillStyle=f.cornerColor||p.cornerColor,l.strokeStyle=f.cornerStrokeColor||p.cornerStrokeColor,v>w?(W=v,l.scale(1,w/v),A=d*v/w):w>v?(W=w,l.scale(v/w,1),R=u*w/v):W=v,l.lineWidth=1,l.beginPath(),l.arc(R,A,W/2,0,2*Math.PI,!1),l[b](),P&&l.stroke(),l.restore()}function s(l,u,d,f,p){f=f||{};var v=this.sizeX||f.cornerSize||p.cornerSize,w=this.sizeY||f.cornerSize||p.cornerSize,C=typeof f.transparentCorners!="undefined"?f.transparentCorners:p.transparentCorners,b=C?"stroke":"fill",P=!C&&(f.cornerStrokeColor||p.cornerStrokeColor),R=v/2,A=w/2;l.save(),l.fillStyle=f.cornerColor||p.cornerColor,l.strokeStyle=f.cornerStrokeColor||p.cornerStrokeColor,l.lineWidth=1,l.translate(u,d),l.rotate(r(p.angle)),l[b+"Rect"](-R,-A,v,w),P&&l.strokeRect(-R,-A,v,w),l.restore()}o.renderCircleControl=n,o.renderSquareControl=s}(e),function(a){var i=a.fabric||(a.fabric={});function r(o){for(var n in o)this[n]=o[n]}i.Control=r,i.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(o,n){return n.cursorStyle},getActionName:function(o,n){return n.actionName},getVisibility:function(o,n){var s=o._controlsVisibility;return s&&typeof s[n]!="undefined"?s[n]:this.visible},setVisibility:function(o){this.visible=o},positionHandler:function(o,n){var s=i.util.transformPoint({x:this.x*o.x+this.offsetX,y:this.y*o.y+this.offsetY},n);return s},calcCornerCoords:function(o,n,s,l,u){var d,f,p,v,w=u?this.touchSizeX:this.sizeX,C=u?this.touchSizeY:this.sizeY;if(w&&C&&w!==C){var b=Math.atan2(C,w),P=Math.sqrt(w*w+C*C)/2,R=b-i.util.degreesToRadians(o),A=Math.PI/2-b-i.util.degreesToRadians(o);d=P*i.util.cos(R),f=P*i.util.sin(R),p=P*i.util.cos(A),v=P*i.util.sin(A)}else{var W=w&&C?w:n;P=W*.7071067812;var R=i.util.degreesToRadians(45-o);d=p=P*i.util.cos(R),f=v=P*i.util.sin(R)}return{tl:{x:s-v,y:l-p},tr:{x:s+d,y:l-f},bl:{x:s-d,y:l+f},br:{x:s+v,y:l+p}}},render:function(o,n,s,l,u){switch(l=l||{},l.cornerStyle||u.cornerStyle){case"circle":i.controlsUtils.renderCircleControl.call(this,o,n,s,l,u);break;default:i.controlsUtils.renderSquareControl.call(this,o,n,s,l,u)}}}}(e),function(){function a(s,l){var u=s.getAttribute("style"),d=s.getAttribute("offset")||0,f,p,v,w;if(d=parseFloat(d)/(/%$/.test(d)?100:1),d=d<0?0:d>1?1:d,u){var C=u.split(/\s*;\s*/);for(C[C.length-1]===""&&C.pop(),w=C.length;w--;){var b=C[w].split(/\s*:\s*/),P=b[0].trim(),R=b[1].trim();P==="stop-color"?f=R:P==="stop-opacity"&&(v=R)}}return f||(f=s.getAttribute("stop-color")||"rgb(0,0,0)"),v||(v=s.getAttribute("stop-opacity")),f=new h.Color(f),p=f.getAlpha(),v=isNaN(parseFloat(v))?1:parseFloat(v),v*=p*l,{offset:d,color:f.toRgb(),opacity:v}}function i(s){return{x1:s.getAttribute("x1")||0,y1:s.getAttribute("y1")||0,x2:s.getAttribute("x2")||"100%",y2:s.getAttribute("y2")||0}}function r(s){return{x1:s.getAttribute("fx")||s.getAttribute("cx")||"50%",y1:s.getAttribute("fy")||s.getAttribute("cy")||"50%",r1:0,x2:s.getAttribute("cx")||"50%",y2:s.getAttribute("cy")||"50%",r2:s.getAttribute("r")||"50%"}}var o=h.util.object.clone;h.Gradient=h.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(s){s||(s={}),s.coords||(s.coords={});var l,u=this;Object.keys(s).forEach(function(d){u[d]=s[d]}),this.id?this.id+="_"+h.Object.__uid++:this.id=h.Object.__uid++,l={x1:s.coords.x1||0,y1:s.coords.y1||0,x2:s.coords.x2||0,y2:s.coords.y2||0},this.type==="radial"&&(l.r1=s.coords.r1||0,l.r2=s.coords.r2||0),this.coords=l,this.colorStops=s.colorStops.slice()},addColorStop:function(s){for(var l in s){var u=new h.Color(s[l]);this.colorStops.push({offset:parseFloat(l),color:u.toRgb(),opacity:u.getAlpha()})}return this},toObject:function(s){var l={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return h.util.populateWithProperties(this,l,s),l},toSVG:function(s,p){var u=o(this.coords,!0),d,f,p=p||{},v,w,C=o(this.colorStops,!0),b=u.r1>u.r2,P=this.gradientTransform?this.gradientTransform.concat():h.iMatrix.concat(),R=-this.offsetX,A=-this.offsetY,W=!!p.additionalTransform,$=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(C.sort(function(ce,ue){return ce.offset-ue.offset}),$==="objectBoundingBox"?(R/=s.width,A/=s.height):(R+=s.width/2,A+=s.height/2),s.type==="path"&&this.gradientUnits!=="percentage"&&(R-=s.pathOffset.x,A-=s.pathOffset.y),P[4]-=R,P[5]-=A,w='id="SVGID_'+this.id+'" gradientUnits="'+$+'"',w+=' gradientTransform="'+(W?p.additionalTransform+" ":"")+h.util.matrixToSVG(P)+'" ',this.type==="linear"?v=["<linearGradient ",w,' x1="',u.x1,'" y1="',u.y1,'" x2="',u.x2,'" y2="',u.y2,`">
`]:this.type==="radial"&&(v=["<radialGradient ",w,' cx="',b?u.x1:u.x2,'" cy="',b?u.y1:u.y2,'" r="',b?u.r1:u.r2,'" fx="',b?u.x2:u.x1,'" fy="',b?u.y2:u.y1,`">
`]),this.type==="radial"){if(b)for(C=C.concat(),C.reverse(),d=0,f=C.length;d<f;d++)C[d].offset=1-C[d].offset;var X=Math.min(u.r1,u.r2);if(X>0){var re=Math.max(u.r1,u.r2),he=X/re;for(d=0,f=C.length;d<f;d++)C[d].offset+=he*(1-C[d].offset)}}for(d=0,f=C.length;d<f;d++){var ne=C[d];v.push("<stop ",'offset="',ne.offset*100+"%",'" style="stop-color:',ne.color,typeof ne.opacity!="undefined"?";stop-opacity: "+ne.opacity:";",`"/>
`)}return v.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),v.join("")},toLive:function(s){var l,u=h.util.object.clone(this.coords),d,f;if(!!this.type){for(this.type==="linear"?l=s.createLinearGradient(u.x1,u.y1,u.x2,u.y2):this.type==="radial"&&(l=s.createRadialGradient(u.x1,u.y1,u.r1,u.x2,u.y2,u.r2)),d=0,f=this.colorStops.length;d<f;d++){var p=this.colorStops[d].color,v=this.colorStops[d].opacity,w=this.colorStops[d].offset;typeof v!="undefined"&&(p=new h.Color(p).setAlpha(v).toRgba()),l.addColorStop(w,p)}return l}}}),h.util.object.extend(h.Gradient,{fromElement:function(s,l,u,d){var f=parseFloat(u)/(/%$/.test(u)?100:1);f=f<0?0:f>1?1:f,isNaN(f)&&(f=1);var p=s.getElementsByTagName("stop"),v,w=s.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",C=s.getAttribute("gradientTransform")||"",b=[],P,R,A=0,W=0,$;for(s.nodeName==="linearGradient"||s.nodeName==="LINEARGRADIENT"?(v="linear",P=i(s)):(v="radial",P=r(s)),R=p.length;R--;)b.push(a(p[R],f));$=h.parseTransformAttribute(C),n(l,P,d,w),w==="pixels"&&(A=-l.left,W=-l.top);var X=new h.Gradient({id:s.getAttribute("id"),type:v,coords:P,colorStops:b,gradientUnits:w,gradientTransform:$,offsetX:A,offsetY:W});return X}});function n(s,l,u,d){var f,p;Object.keys(l).forEach(function(v){f=l[v],f==="Infinity"?p=1:f==="-Infinity"?p=0:(p=parseFloat(l[v],10),typeof f=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(f)&&(p*=.01,d==="pixels"&&((v==="x1"||v==="x2"||v==="r2")&&(p*=u.viewBoxWidth||u.width),(v==="y1"||v==="y2")&&(p*=u.viewBoxHeight||u.height)))),l[v]=p})}}(),function(){var a=h.util.toFixed;h.Pattern=h.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(i,r){if(i||(i={}),this.id=h.Object.__uid++,this.setOptions(i),!i.source||i.source&&typeof i.source!="string"){r&&r(this);return}else{var o=this;this.source=h.util.createImage(),h.util.loadImage(i.source,function(n,s){o.source=n,r&&r(o,s)},null,this.crossOrigin)}},toObject:function(i){var r=h.Object.NUM_FRACTION_DIGITS,o,n;return typeof this.source.src=="string"?o=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(o=this.source.toDataURL()),n={type:"pattern",source:o,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:a(this.offsetX,r),offsetY:a(this.offsetY,r),patternTransform:this.patternTransform?this.patternTransform.concat():null},h.util.populateWithProperties(this,n,i),n},toSVG:function(i){var r=typeof this.source=="function"?this.source():this.source,o=r.width/i.width,n=r.height/i.height,s=this.offsetX/i.width,l=this.offsetY/i.height,u="";return(this.repeat==="repeat-x"||this.repeat==="no-repeat")&&(n=1,l&&(n+=Math.abs(l))),(this.repeat==="repeat-y"||this.repeat==="no-repeat")&&(o=1,s&&(o+=Math.abs(s))),r.src?u=r.src:r.toDataURL&&(u=r.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+s+'" y="'+l+'" width="'+o+'" height="'+n+`">
<image x="0" y="0" width="`+r.width+'" height="'+r.height+'" xlink:href="'+u+`"></image>
</pattern>
`},setOptions:function(i){for(var r in i)this[r]=i[r]},toLive:function(i){var r=this.source;return!r||typeof r.src!="undefined"&&(!r.complete||r.naturalWidth===0||r.naturalHeight===0)?"":i.createPattern(r,this.repeat)}})}(),function(a){var i=a.fabric||(a.fabric={}),r=i.util.toFixed;if(i.Shadow){i.warn("fabric.Shadow is already defined.");return}i.Shadow=i.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(o){typeof o=="string"&&(o=this._parseShadow(o));for(var n in o)this[n]=o[n];this.id=i.Object.__uid++},_parseShadow:function(o){var n=o.trim(),s=i.Shadow.reOffsetsAndBlur.exec(n)||[],l=n.replace(i.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)";return{color:l.trim(),offsetX:parseFloat(s[1],10)||0,offsetY:parseFloat(s[2],10)||0,blur:parseFloat(s[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(o){var n=40,s=40,l=i.Object.NUM_FRACTION_DIGITS,u=i.util.rotateVector({x:this.offsetX,y:this.offsetY},i.util.degreesToRadians(-o.angle)),d=20,f=new i.Color(this.color);return o.width&&o.height&&(n=r((Math.abs(u.x)+this.blur)/o.width,l)*100+d,s=r((Math.abs(u.y)+this.blur)/o.height,l)*100+d),o.flipX&&(u.x*=-1),o.flipY&&(u.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+s+'%" height="'+(100+2*s)+'%" x="-'+n+'%" width="'+(100+2*n)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+r(this.blur?this.blur/2:0,l)+`"></feGaussianBlur>
	<feOffset dx="`+r(u.x,l)+'" dy="'+r(u.y,l)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+f.toRgb()+'" flood-opacity="'+f.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var o={},n=i.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(s){this[s]!==n[s]&&(o[s]=this[s])},this),o}}),i.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/}(e),function(){if(h.StaticCanvas){h.warn("fabric.StaticCanvas is already defined.");return}var a=h.util.object.extend,i=h.util.getElementOffset,r=h.util.removeFromArray,o=h.util.toFixed,n=h.util.transformPoint,s=h.util.invertTransform,l=h.util.getNodeCanvas,u=h.util.createCanvasElement,d=new Error("Could not initialize `canvas` element");h.StaticCanvas=h.util.createClass(h.CommonMethods,{initialize:function(f,p){p||(p={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(f,p)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:h.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(f,p){var v=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(f),this._initOptions(p),this.interactive||this._initRetinaScaling(),p.overlayImage&&this.setOverlayImage(p.overlayImage,v),p.backgroundImage&&this.setBackgroundImage(p.backgroundImage,v),p.backgroundColor&&this.setBackgroundColor(p.backgroundColor,v),p.overlayColor&&this.setOverlayColor(p.overlayColor,v),this.calcOffset()},_isRetinaScaling:function(){return h.devicePixelRatio!==1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?h.devicePixelRatio:1},_initRetinaScaling:function(){if(!!this._isRetinaScaling()){var f=h.devicePixelRatio;this.__initRetinaScaling(f,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(f,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(f,p,v){p.setAttribute("width",this.width*f),p.setAttribute("height",this.height*f),v.scale(f,f)},calcOffset:function(){return this._offset=i(this.lowerCanvasEl),this},setOverlayImage:function(f,p,v){return this.__setBgOverlayImage("overlayImage",f,p,v)},setBackgroundImage:function(f,p,v){return this.__setBgOverlayImage("backgroundImage",f,p,v)},setOverlayColor:function(f,p){return this.__setBgOverlayColor("overlayColor",f,p)},setBackgroundColor:function(f,p){return this.__setBgOverlayColor("backgroundColor",f,p)},__setBgOverlayImage:function(f,p,v,w){return typeof p=="string"?h.util.loadImage(p,function(C,b){if(C){var P=new h.Image(C,w);this[f]=P,P.canvas=this}v&&v(C,b)},this,w&&w.crossOrigin):(w&&p.setOptions(w),this[f]=p,p&&(p.canvas=this),v&&v(p,!1)),this},__setBgOverlayColor:function(f,p,v){return this[f]=p,this._initGradient(p,f),this._initPattern(p,f,v),this},_createCanvasElement:function(){var f=u();if(!f||(f.style||(f.style={}),typeof f.getContext=="undefined"))throw d;return f},_initOptions:function(f){var p=this.lowerCanvasEl;this._setOptions(f),this.width=this.width||parseInt(p.width,10)||0,this.height=this.height||parseInt(p.height,10)||0,this.lowerCanvasEl.style&&(p.width=this.width,p.height=this.height,p.style.width=this.width+"px",p.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(f){f&&f.getContext?this.lowerCanvasEl=f:this.lowerCanvasEl=h.util.getById(f)||this._createCanvasElement(),h.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(f,p){return this.setDimensions({width:f},p)},setHeight:function(f,p){return this.setDimensions({height:f},p)},setDimensions:function(f,p){var v;p=p||{};for(var w in f)v=f[w],p.cssOnly||(this._setBackstoreDimension(w,f[w]),v+="px",this.hasLostContext=!0),p.backstoreOnly||this._setCssDimension(w,v);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(),this._initRetinaScaling(),this.calcOffset(),p.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(f,p){return this.lowerCanvasEl[f]=p,this.upperCanvasEl&&(this.upperCanvasEl[f]=p),this.cacheCanvasEl&&(this.cacheCanvasEl[f]=p),this[f]=p,this},_setCssDimension:function(f,p){return this.lowerCanvasEl.style[f]=p,this.upperCanvasEl&&(this.upperCanvasEl.style[f]=p),this.wrapperEl&&(this.wrapperEl.style[f]=p),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(f){var p=this._activeObject,v=this.backgroundImage,w=this.overlayImage,C,b,P;for(this.viewportTransform=f,b=0,P=this._objects.length;b<P;b++)C=this._objects[b],C.group||C.setCoords(!0);return p&&p.setCoords(),v&&v.setCoords(!0),w&&w.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(f,p){var v=f,w=this.viewportTransform.slice(0);f=n(f,s(this.viewportTransform)),w[0]=p,w[3]=p;var C=n(f,w);return w[4]+=v.x-C.x,w[5]+=v.y-C.y,this.setViewportTransform(w)},setZoom:function(f){return this.zoomToPoint(new h.Point(0,0),f),this},absolutePan:function(f){var p=this.viewportTransform.slice(0);return p[4]=-f.x,p[5]=-f.y,this.setViewportTransform(p)},relativePan:function(f){return this.absolutePan(new h.Point(-f.x-this.viewportTransform[4],-f.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(f){this.stateful&&f.setupState(),f._set("canvas",this),f.setCoords(),this.fire("object:added",{target:f}),f.fire("added")},_onObjectRemoved:function(f){this.fire("object:removed",{target:f}),f.fire("removed"),delete f.canvas},clearContext:function(f){return f.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var f=this.contextContainer;return this.renderCanvas(f,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=h.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var f={},p=this.width,v=this.height,w=s(this.viewportTransform);return f.tl=n({x:0,y:0},w),f.br=n({x:p,y:v},w),f.tr=new h.Point(f.br.x,f.tl.y),f.bl=new h.Point(f.tl.x,f.br.y),this.vptCoords=f,f},cancelRequestedRender:function(){this.isRendering&&(h.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(f,p){var v=this.viewportTransform,w=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(f),h.util.setImageSmoothing(f,this.imageSmoothingEnabled),this.fire("before:render",{ctx:f}),this._renderBackground(f),f.save(),f.transform(v[0],v[1],v[2],v[3],v[4],v[5]),this._renderObjects(f,p),f.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(f),w&&(w.canvas=this,w.shouldCache(),w._transformDone=!0,w.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(f)),this._renderOverlay(f),this.controlsAboveOverlay&&this.interactive&&this.drawControls(f),this.fire("after:render",{ctx:f})},drawClipPathOnCanvas:function(f){var p=this.viewportTransform,v=this.clipPath;f.save(),f.transform(p[0],p[1],p[2],p[3],p[4],p[5]),f.globalCompositeOperation="destination-in",v.transform(f),f.scale(1/v.zoomX,1/v.zoomY),f.drawImage(v._cacheCanvas,-v.cacheTranslationX,-v.cacheTranslationY),f.restore()},_renderObjects:function(f,p){var v,w;for(v=0,w=p.length;v<w;++v)p[v]&&p[v].render(f)},_renderBackgroundOrOverlay:function(f,p){var v=this[p+"Color"],w=this[p+"Image"],C=this.viewportTransform,b=this[p+"Vpt"];if(!(!v&&!w)){if(v){f.save(),f.beginPath(),f.moveTo(0,0),f.lineTo(this.width,0),f.lineTo(this.width,this.height),f.lineTo(0,this.height),f.closePath(),f.fillStyle=v.toLive?v.toLive(f,this):v,b&&f.transform(C[0],C[1],C[2],C[3],C[4],C[5]),f.transform(1,0,0,1,v.offsetX||0,v.offsetY||0);var P=v.gradientTransform||v.patternTransform;P&&f.transform(P[0],P[1],P[2],P[3],P[4],P[5]),f.fill(),f.restore()}w&&(f.save(),b&&f.transform(C[0],C[1],C[2],C[3],C[4],C[5]),w.render(f),f.restore())}},_renderBackground:function(f){this._renderBackgroundOrOverlay(f,"background")},_renderOverlay:function(f){this._renderBackgroundOrOverlay(f,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},centerObjectH:function(f){return this._centerObject(f,new h.Point(this.getCenter().left,f.getCenterPoint().y))},centerObjectV:function(f){return this._centerObject(f,new h.Point(f.getCenterPoint().x,this.getCenter().top))},centerObject:function(f){var p=this.getCenter();return this._centerObject(f,new h.Point(p.left,p.top))},viewportCenterObject:function(f){var p=this.getVpCenter();return this._centerObject(f,p)},viewportCenterObjectH:function(f){var p=this.getVpCenter();return this._centerObject(f,new h.Point(p.x,f.getCenterPoint().y)),this},viewportCenterObjectV:function(f){var p=this.getVpCenter();return this._centerObject(f,new h.Point(f.getCenterPoint().x,p.y))},getVpCenter:function(){var f=this.getCenter(),p=s(this.viewportTransform);return n({x:f.left,y:f.top},p)},_centerObject:function(f,p){return f.setPositionByOrigin(p,"center","center"),f.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(f){return this.toDatalessObject(f)},toObject:function(f){return this._toObjectMethod("toObject",f)},toDatalessObject:function(f){return this._toObjectMethod("toDatalessObject",f)},_toObjectMethod:function(f,p){var v=this.clipPath,w={version:h.version,objects:this._toObjects(f,p)};return v&&!v.excludeFromExport&&(w.clipPath=this._toObject(this.clipPath,f,p)),a(w,this.__serializeBgOverlay(f,p)),h.util.populateWithProperties(this,w,p),w},_toObjects:function(f,p){return this._objects.filter(function(v){return!v.excludeFromExport}).map(function(v){return this._toObject(v,f,p)},this)},_toObject:function(f,p,v){var w;this.includeDefaultValues||(w=f.includeDefaultValues,f.includeDefaultValues=!1);var C=f[p](v);return this.includeDefaultValues||(f.includeDefaultValues=w),C},__serializeBgOverlay:function(f,p){var v={},w=this.backgroundImage,C=this.overlayImage,b=this.backgroundColor,P=this.overlayColor;return b&&b.toObject?b.excludeFromExport||(v.background=b.toObject(p)):b&&(v.background=b),P&&P.toObject?P.excludeFromExport||(v.overlay=P.toObject(p)):P&&(v.overlay=P),w&&!w.excludeFromExport&&(v.backgroundImage=this._toObject(w,f,p)),C&&!C.excludeFromExport&&(v.overlayImage=this._toObject(C,f,p)),v},svgViewportTransformation:!0,toSVG:function(f,p){f||(f={}),f.reviver=p;var v=[];return this._setSVGPreamble(v,f),this._setSVGHeader(v,f),this.clipPath&&v.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(v,"background"),this._setSVGBgOverlayImage(v,"backgroundImage",p),this._setSVGObjects(v,p),this.clipPath&&v.push(`</g>
`),this._setSVGBgOverlayColor(v,"overlay"),this._setSVGBgOverlayImage(v,"overlayImage",p),v.push("</svg>"),v.join("")},_setSVGPreamble:function(f,p){p.suppressPreamble||f.push('<?xml version="1.0" encoding="',p.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(f,p){var v=p.width||this.width,w=p.height||this.height,C,b='viewBox="0 0 '+this.width+" "+this.height+'" ',P=h.Object.NUM_FRACTION_DIGITS;p.viewBox?b='viewBox="'+p.viewBox.x+" "+p.viewBox.y+" "+p.viewBox.width+" "+p.viewBox.height+'" ':this.svgViewportTransformation&&(C=this.viewportTransform,b='viewBox="'+o(-C[4]/C[0],P)+" "+o(-C[5]/C[3],P)+" "+o(this.width/C[0],P)+" "+o(this.height/C[3],P)+'" '),f.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',v,'" ','height="',w,'" ',b,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",h.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(p),`</defs>
`)},createSVGClipPathMarkup:function(f){var p=this.clipPath;return p?(p.clipPathId="CLIPPATH_"+h.Object.__uid++,'<clipPath id="'+p.clipPathId+`" >
`+this.clipPath.toClipPathSVG(f.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var f=this,p=["background","overlay"].map(function(v){var w=f[v+"Color"];if(w&&w.toLive){var C=f[v+"Vpt"],b=f.viewportTransform,P={width:f.width/(C?b[0]:1),height:f.height/(C?b[3]:1)};return w.toSVG(P,{additionalTransform:C?h.util.matrixToSVG(b):""})}});return p.join("")},createSVGFontFacesMarkup:function(){var f="",p={},v,w,C,b,P,R,A,W,$,X=h.fontPaths,re=[];for(this._objects.forEach(function ne(ce){re.push(ce),ce._objects&&ce._objects.forEach(ne)}),W=0,$=re.length;W<$;W++)if(v=re[W],w=v.fontFamily,!(v.type.indexOf("text")===-1||p[w]||!X[w])&&(p[w]=!0,!!v.styles)){C=v.styles;for(P in C){b=C[P];for(A in b)R=b[A],w=R.fontFamily,!p[w]&&X[w]&&(p[w]=!0)}}for(var he in p)f+=[`		@font-face {
`,"			font-family: '",he,`';
`,"			src: url('",X[he],`');
`,`		}
`].join("");return f&&(f=['	<style type="text/css">',`<![CDATA[
`,f,"]]>",`</style>
`].join("")),f},_setSVGObjects:function(f,p){var v,w,C,b=this._objects;for(w=0,C=b.length;w<C;w++)v=b[w],!v.excludeFromExport&&this._setSVGObject(f,v,p)},_setSVGObject:function(f,p,v){f.push(p.toSVG(v))},_setSVGBgOverlayImage:function(f,p,v){this[p]&&!this[p].excludeFromExport&&this[p].toSVG&&f.push(this[p].toSVG(v))},_setSVGBgOverlayColor:function(f,p){var v=this[p+"Color"],w=this.viewportTransform,C=this.width,b=this.height;if(!!v)if(v.toLive){var P=v.repeat,R=h.util.invertTransform(w),A=this[p+"Vpt"],W=A?h.util.matrixToSVG(R):"";f.push('<rect transform="'+W+" translate(",C/2,",",b/2,')"',' x="',v.offsetX-C/2,'" y="',v.offsetY-b/2,'" ','width="',P==="repeat-y"||P==="no-repeat"?v.source.width:C,'" height="',P==="repeat-x"||P==="no-repeat"?v.source.height:b,'" fill="url(#SVGID_'+v.id+')"',`></rect>
`)}else f.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',v,'"',`></rect>
`)},sendToBack:function(f){if(!f)return this;var p=this._activeObject,v,w,C;if(f===p&&f.type==="activeSelection")for(C=p._objects,v=C.length;v--;)w=C[v],r(this._objects,w),this._objects.unshift(w);else r(this._objects,f),this._objects.unshift(f);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(f){if(!f)return this;var p=this._activeObject,v,w,C;if(f===p&&f.type==="activeSelection")for(C=p._objects,v=0;v<C.length;v++)w=C[v],r(this._objects,w),this._objects.push(w);else r(this._objects,f),this._objects.push(f);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(f,p){if(!f)return this;var v=this._activeObject,w,C,b,P,R,A=0;if(f===v&&f.type==="activeSelection")for(R=v._objects,w=0;w<R.length;w++)C=R[w],b=this._objects.indexOf(C),b>0+A&&(P=b-1,r(this._objects,C),this._objects.splice(P,0,C)),A++;else b=this._objects.indexOf(f),b!==0&&(P=this._findNewLowerIndex(f,b,p),r(this._objects,f),this._objects.splice(P,0,f));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(f,p,v){var w,C;if(v)for(w=p,C=p-1;C>=0;--C){var b=f.intersectsWithObject(this._objects[C])||f.isContainedWithinObject(this._objects[C])||this._objects[C].isContainedWithinObject(f);if(b){w=C;break}}else w=p-1;return w},bringForward:function(f,p){if(!f)return this;var v=this._activeObject,w,C,b,P,R,A=0;if(f===v&&f.type==="activeSelection")for(R=v._objects,w=R.length;w--;)C=R[w],b=this._objects.indexOf(C),b<this._objects.length-1-A&&(P=b+1,r(this._objects,C),this._objects.splice(P,0,C)),A++;else b=this._objects.indexOf(f),b!==this._objects.length-1&&(P=this._findNewUpperIndex(f,b,p),r(this._objects,f),this._objects.splice(P,0,f));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(f,p,v){var w,C,b;if(v)for(w=p,C=p+1,b=this._objects.length;C<b;++C){var P=f.intersectsWithObject(this._objects[C])||f.isContainedWithinObject(this._objects[C])||this._objects[C].isContainedWithinObject(f);if(P){w=C;break}}else w=p+1;return w},moveTo:function(f,p){return r(this._objects,f),this._objects.splice(p,0,f),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(h.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(f){f.dispose&&f.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),this.lowerCanvasEl.style=this._originalCanvasStyle,delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),h.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),a(h.StaticCanvas.prototype,h.Observable),a(h.StaticCanvas.prototype,h.Collection),a(h.StaticCanvas.prototype,h.DataURLExporter),a(h.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(f){var p=u();if(!p||!p.getContext)return null;var v=p.getContext("2d");if(!v)return null;switch(f){case"setLineDash":return typeof v.setLineDash!="undefined";default:return null}}}),h.StaticCanvas.prototype.toJSON=h.StaticCanvas.prototype.toObject,h.isLikelyNode&&(h.StaticCanvas.prototype.createPNGStream=function(){var f=l(this.lowerCanvasEl);return f&&f.createPNGStream()},h.StaticCanvas.prototype.createJPEGStream=function(f){var p=l(this.lowerCanvasEl);return p&&p.createJPEGStream(f)})}(),h.BaseBrush=h.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(){var a=this.canvas.contextTop;a.strokeStyle=this.color,a.lineWidth=this.width,a.lineCap=this.strokeLineCap,a.miterLimit=this.strokeMiterLimit,a.lineJoin=this.strokeLineJoin,a.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(a){var i=this.canvas.viewportTransform;a.save(),a.transform(i[0],i[1],i[2],i[3],i[4],i[5])},_setShadow:function(){if(!!this.shadow){var a=this.canvas,i=this.shadow,r=a.contextTop,o=a.getZoom();a&&a._isRetinaScaling()&&(o*=h.devicePixelRatio),r.shadowColor=i.color,r.shadowBlur=i.blur*o,r.shadowOffsetX=i.offsetX*o,r.shadowOffsetY=i.offsetY*o}},needsFullRender:function(){var a=new h.Color(this.color);return a.getAlpha()<1||!!this.shadow},_resetShadow:function(){var a=this.canvas.contextTop;a.shadowColor="",a.shadowBlur=a.shadowOffsetX=a.shadowOffsetY=0},_isOutSideCanvas:function(a){return a.x<0||a.x>this.canvas.getWidth()||a.y<0||a.y>this.canvas.getHeight()}}),function(){h.PencilBrush=h.util.createClass(h.BaseBrush,{decimate:.4,initialize:function(a){this.canvas=a,this._points=[]},_drawSegment:function(a,i,r){var o=i.midPointFrom(r);return a.quadraticCurveTo(i.x,i.y,o.x,o.y),o},onMouseDown:function(a,i){!this.canvas._isMainEvent(i.e)||(this._prepareForDrawing(a),this._captureDrawingPath(a),this._render())},onMouseMove:function(a,i){if(!!this.canvas._isMainEvent(i.e)&&!(this.limitedToCanvasSize===!0&&this._isOutSideCanvas(a))&&this._captureDrawingPath(a)&&this._points.length>1)if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var r=this._points,o=r.length,n=this.canvas.contextTop;this._saveAndTransform(n),this.oldEnd&&(n.beginPath(),n.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(n,r[o-2],r[o-1],!0),n.stroke(),n.restore()}},onMouseUp:function(a){return this.canvas._isMainEvent(a.e)?(this.oldEnd=void 0,this._finalizeAndAddPath(),!1):!0},_prepareForDrawing:function(a){var i=new h.Point(a.x,a.y);this._reset(),this._addPoint(i),this.canvas.contextTop.moveTo(i.x,i.y)},_addPoint:function(a){return this._points.length>1&&a.eq(this._points[this._points.length-1])?!1:(this._points.push(a),!0)},_reset:function(){this._points=[],this._setBrushStyles(),this._setShadow()},_captureDrawingPath:function(a){var i=new h.Point(a.x,a.y);return this._addPoint(i)},_render:function(){var a=this.canvas.contextTop,i,r,o=this._points[0],n=this._points[1];if(this._saveAndTransform(a),a.beginPath(),this._points.length===2&&o.x===n.x&&o.y===n.y){var s=this.width/1e3;o=new h.Point(o.x,o.y),n=new h.Point(n.x,n.y),o.x-=s,n.x+=s}for(a.moveTo(o.x,o.y),i=1,r=this._points.length;i<r;i++)this._drawSegment(a,o,n),o=this._points[i],n=this._points[i+1];a.lineTo(o.x,o.y),a.stroke(),a.restore()},convertPointsToSVGPath:function(a){var i=this.width/1e3;return h.util.getSmoothPathFromPoints(a,i)},_isEmptySVGPath:function(a){var i=h.util.joinPath(a);return i==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(a){var i=new h.Path(a,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,i.shadow=new h.Shadow(this.shadow)),i},decimatePoints:function(a,i){if(a.length<=2)return a;var r=this.canvas.getZoom(),o=Math.pow(i/r,2),n,s=a.length-1,l=a[0],u=[l],d;for(n=1;n<s-1;n++)d=Math.pow(l.x-a[n].x,2)+Math.pow(l.y-a[n].y,2),d>=o&&(l=a[n],u.push(l));return u.push(a[s]),u},_finalizeAndAddPath:function(){var a=this.canvas.contextTop;a.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var i=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(i)){this.canvas.requestRenderAll();return}var r=this.createPath(i);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:r}),this.canvas.add(r),this.canvas.requestRenderAll(),r.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:r})}})}(),h.CircleBrush=h.util.createClass(h.BaseBrush,{width:10,initialize:function(a){this.canvas=a,this.points=[]},drawDot:function(a){var i=this.addPoint(a),r=this.canvas.contextTop;this._saveAndTransform(r),this.dot(r,i),r.restore()},dot:function(a,i){a.fillStyle=i.fill,a.beginPath(),a.arc(i.x,i.y,i.radius,0,Math.PI*2,!1),a.closePath(),a.fill()},onMouseDown:function(a){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(a)},_render:function(){var a=this.canvas.contextTop,i,r,o=this.points;for(this._saveAndTransform(a),i=0,r=o.length;i<r;i++)this.dot(a,o[i]);a.restore()},onMouseMove:function(a){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(a)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(a),this._render()):this.drawDot(a))},onMouseUp:function(){var a=this.canvas.renderOnAddRemove,i,r;this.canvas.renderOnAddRemove=!1;var o=[];for(i=0,r=this.points.length;i<r;i++){var n=this.points[i],s=new h.Circle({radius:n.radius,left:n.x,top:n.y,originX:"center",originY:"center",fill:n.fill});this.shadow&&(s.shadow=new h.Shadow(this.shadow)),o.push(s)}var l=new h.Group(o);l.canvas=this.canvas,this.canvas.fire("before:path:created",{path:l}),this.canvas.add(l),this.canvas.fire("path:created",{path:l}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=a,this.canvas.requestRenderAll()},addPoint:function(a){var i=new h.Point(a.x,a.y),r=h.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,o=new h.Color(this.color).setAlpha(h.util.getRandomInt(0,100)/100).toRgba();return i.radius=r,i.fill=o,this.points.push(i),i}}),h.SprayBrush=h.util.createClass(h.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(a){this.canvas=a,this.sprayChunks=[]},onMouseDown:function(a){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(a),this.render(this.sprayChunkPoints)},onMouseMove:function(a){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(a)||(this.addSprayChunk(a),this.render(this.sprayChunkPoints))},onMouseUp:function(){var a=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var i=[],r=0,o=this.sprayChunks.length;r<o;r++)for(var n=this.sprayChunks[r],s=0,l=n.length;s<l;s++){var u=new h.Rect({width:n[s].width,height:n[s].width,left:n[s].x+1,top:n[s].y+1,originX:"center",originY:"center",fill:this.color});i.push(u)}this.optimizeOverlapping&&(i=this._getOptimizedRects(i));var d=new h.Group(i);this.shadow&&d.set("shadow",new h.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:d}),this.canvas.add(d),this.canvas.fire("path:created",{path:d}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=a,this.canvas.requestRenderAll()},_getOptimizedRects:function(a){var i={},r,o,n;for(o=0,n=a.length;o<n;o++)r=a[o].left+""+a[o].top,i[r]||(i[r]=a[o]);var s=[];for(r in i)s.push(i[r]);return s},render:function(a){var i=this.canvas.contextTop,r,o;for(i.fillStyle=this.color,this._saveAndTransform(i),r=0,o=a.length;r<o;r++){var n=a[r];typeof n.opacity!="undefined"&&(i.globalAlpha=n.opacity),i.fillRect(n.x,n.y,n.width,n.width)}i.restore()},_render:function(){var a=this.canvas.contextTop,i,r;for(a.fillStyle=this.color,this._saveAndTransform(a),i=0,r=this.sprayChunks.length;i<r;i++)this.render(this.sprayChunks[i]);a.restore()},addSprayChunk:function(a){this.sprayChunkPoints=[];var i,r,o,n=this.width/2,s;for(s=0;s<this.density;s++){i=h.util.getRandomInt(a.x-n,a.x+n),r=h.util.getRandomInt(a.y-n,a.y+n),this.dotWidthVariance?o=h.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):o=this.dotWidth;var l=new h.Point(i,r);l.width=o,this.randomOpacity&&(l.opacity=h.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(l)}this.sprayChunks.push(this.sprayChunkPoints)}}),h.PatternBrush=h.util.createClass(h.PencilBrush,{getPatternSrc:function(){var a=20,i=5,r=h.util.createCanvasElement(),o=r.getContext("2d");return r.width=r.height=a+i,o.fillStyle=this.color,o.beginPath(),o.arc(a/2,a/2,a/2,0,Math.PI*2,!1),o.closePath(),o.fill(),r},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(){return this.canvas.contextTop.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(){this.callSuper("_setBrushStyles"),this.canvas.contextTop.strokeStyle=this.getPattern()},createPath:function(a){var i=this.callSuper("createPath",a),r=i._getLeftTopCoords().scalarAdd(i.strokeWidth/2);return i.stroke=new h.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-r.x,offsetY:-r.y}),i}}),function(){var a=h.util.getPointer,i=h.util.degreesToRadians,r=h.util.isTouchEvent;h.Canvas=h.util.createClass(h.StaticCanvas,{initialize:function(n,s){s||(s={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(n,s),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",rotationCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=h.PencilBrush&&new h.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var n=this.getActiveObjects(),s,l,u;if(n.length>0&&!this.preserveObjectStacking){l=[],u=[];for(var d=0,f=this._objects.length;d<f;d++)s=this._objects[d],n.indexOf(s)===-1?l.push(s):u.push(s);n.length>1&&(this._activeObject._objects=u),l.push.apply(l,u)}else l=this._objects;return l},renderAll:function(){this.contextTopDirty&&!this._groupSelector&&!this.isDrawingMode&&(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&this.renderTopLayer(this.contextTop);var n=this.contextContainer;return this.renderCanvas(n,this._chooseObjectsToRender()),this},renderTopLayer:function(n){n.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(n),this.contextTopDirty=!0),n.restore()},renderTop:function(){var n=this.contextTop;return this.clearContext(n),this.renderTopLayer(n),this.fire("after:render"),this},_normalizePointer:function(n,s){var l=n.calcTransformMatrix(),u=h.util.invertTransform(l),d=this.restorePointerVpt(s);return h.util.transformPoint(d,u)},isTargetTransparent:function(n,s,l){if(n.shouldCache()&&n._cacheCanvas&&n!==this._activeObject){var u=this._normalizePointer(n,{x:s,y:l}),d=Math.max(n.cacheTranslationX+u.x*n.zoomX,0),f=Math.max(n.cacheTranslationY+u.y*n.zoomY,0),C=h.util.isTransparent(n._cacheContext,Math.round(d),Math.round(f),this.targetFindTolerance);return C}var p=this.contextCache,v=n.selectionBackgroundColor,w=this.viewportTransform;n.selectionBackgroundColor="",this.clearContext(p),p.save(),p.transform(w[0],w[1],w[2],w[3],w[4],w[5]),n.render(p),p.restore(),n.selectionBackgroundColor=v;var C=h.util.isTransparent(p,s,l,this.targetFindTolerance);return C},_isSelectionKeyPressed:function(n){var s=!1;return Object.prototype.toString.call(this.selectionKey)==="[object Array]"?s=!!this.selectionKey.find(function(l){return n[l]===!0}):s=n[this.selectionKey],s},_shouldClearSelection:function(n,s){var l=this.getActiveObjects(),u=this._activeObject;return!s||s&&u&&l.length>1&&l.indexOf(s)===-1&&u!==s&&!this._isSelectionKeyPressed(n)||s&&!s.evented||s&&!s.selectable&&u&&u!==s},_shouldCenterTransform:function(n,s,l){if(!!n){var u;return s==="scale"||s==="scaleX"||s==="scaleY"||s==="resizing"?u=this.centeredScaling||n.centeredScaling:s==="rotate"&&(u=this.centeredRotation||n.centeredRotation),u?!l:l}},_getOriginFromCorner:function(n,s){var l={x:n.originX,y:n.originY};return s==="ml"||s==="tl"||s==="bl"?l.x="right":(s==="mr"||s==="tr"||s==="br")&&(l.x="left"),s==="tl"||s==="mt"||s==="tr"?l.y="bottom":(s==="bl"||s==="mb"||s==="br")&&(l.y="top"),l},_getActionFromCorner:function(n,s,l,u){if(!s||!n)return"drag";var d=u.controls[s];return d.getActionName(l,d,u)},_setupCurrentTransform:function(n,s,l){if(!!s){var u=this.getPointer(n),d=s.__corner,f=s.controls[d],p=l&&d?f.getActionHandler(n,s,f):h.controlsUtils.dragHandler,v=this._getActionFromCorner(l,d,n,s),w=this._getOriginFromCorner(s,d),C=n[this.centeredKey],b={target:s,action:v,actionHandler:p,corner:d,scaleX:s.scaleX,scaleY:s.scaleY,skewX:s.skewX,skewY:s.skewY,offsetX:u.x-s.left,offsetY:u.y-s.top,originX:w.x,originY:w.y,ex:u.x,ey:u.y,lastX:u.x,lastY:u.y,theta:i(s.angle),width:s.width*s.scaleX,shiftKey:n.shiftKey,altKey:C,original:h.util.saveObjectTransform(s)};this._shouldCenterTransform(s,v,C)&&(b.originX="center",b.originY="center"),b.original.originX=w.x,b.original.originY=w.y,this._currentTransform=b,this._beforeTransform(n)}},setCursor:function(n){this.upperCanvasEl.style.cursor=n},_drawSelection:function(n){var s=this._groupSelector,l=new h.Point(s.ex,s.ey),u=h.util.transformPoint(l,this.viewportTransform),d=new h.Point(s.ex+s.left,s.ey+s.top),f=h.util.transformPoint(d,this.viewportTransform),p=Math.min(u.x,f.x),v=Math.min(u.y,f.y),w=Math.max(u.x,f.x),C=Math.max(u.y,f.y),b=this.selectionLineWidth/2;this.selectionColor&&(n.fillStyle=this.selectionColor,n.fillRect(p,v,w-p,C-v)),!(!this.selectionLineWidth||!this.selectionBorderColor)&&(n.lineWidth=this.selectionLineWidth,n.strokeStyle=this.selectionBorderColor,p+=b,v+=b,w-=b,C-=b,h.Object.prototype._setLineDash.call(this,n,this.selectionDashArray),n.strokeRect(p,v,w-p,C-v))},findTarget:function(n,s){if(!this.skipTargetFind){var l=!0,u=this.getPointer(n,l),d=this._activeObject,f=this.getActiveObjects(),p,v,w=r(n),C=f.length>1&&!s||f.length===1;if(this.targets=[],C&&d._findTargetCorner(u,w)||f.length>1&&!s&&d===this._searchPossibleTargets([d],u))return d;if(f.length===1&&d===this._searchPossibleTargets([d],u))if(this.preserveObjectStacking)p=d,v=this.targets,this.targets=[];else return d;var b=this._searchPossibleTargets(this._objects,u);return n[this.altSelectionKey]&&b&&p&&b!==p&&(b=p,this.targets=v),b}},_checkTarget:function(n,s,l){if(s&&s.visible&&s.evented&&s.containsPoint(n))if((this.perPixelTargetFind||s.perPixelTargetFind)&&!s.isEditing){var u=this.isTargetTransparent(s,l.x,l.y);if(!u)return!0}else return!0},_searchPossibleTargets:function(n,s){for(var l,u=n.length,d;u--;){var f=n[u],p=f.group?this._normalizePointer(f.group,s):s;if(this._checkTarget(p,f,s)){l=n[u],l.subTargetCheck&&l instanceof h.Group&&(d=this._searchPossibleTargets(l._objects,s),d&&this.targets.push(d));break}}return l},restorePointerVpt:function(n){return h.util.transformPoint(n,h.util.invertTransform(this.viewportTransform))},getPointer:function(n,s){if(this._absolutePointer&&!s)return this._absolutePointer;if(this._pointer&&s)return this._pointer;var l=a(n),u=this.upperCanvasEl,d=u.getBoundingClientRect(),f=d.width||0,p=d.height||0,v;(!f||!p)&&("top"in d&&"bottom"in d&&(p=Math.abs(d.top-d.bottom)),"right"in d&&"left"in d&&(f=Math.abs(d.right-d.left))),this.calcOffset(),l.x=l.x-this._offset.left,l.y=l.y-this._offset.top,s||(l=this.restorePointerVpt(l));var w=this.getRetinaScaling();return w!==1&&(l.x/=w,l.y/=w),f===0||p===0?v={width:1,height:1}:v={width:u.width/f,height:u.height/p},{x:l.x*v.width,y:l.y*v.height}},_createUpperCanvas:function(){var n=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),s=this.lowerCanvasEl,l=this.upperCanvasEl;l?l.className="":(l=this._createCanvasElement(),this.upperCanvasEl=l),h.util.addClass(l,"upper-canvas "+n),this.wrapperEl.appendChild(l),this._copyCanvasStyle(s,l),this._applyCanvasStyle(l),this.contextTop=l.getContext("2d")},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=h.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),h.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),h.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(n){var s=this.width||n.width,l=this.height||n.height;h.util.setStyle(n,{position:"absolute",width:s+"px",height:l+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),n.width=s,n.height=l,h.util.makeElementUnselectable(n)},_copyCanvasStyle:function(n,s){s.style.cssText=n.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var n=this._activeObject;return n?n.type==="activeSelection"&&n._objects?n._objects.slice(0):[n]:[]},_onObjectRemoved:function(n){n===this._activeObject&&(this.fire("before:selection:cleared",{target:n}),this._discardActiveObject(),this.fire("selection:cleared",{target:n}),n.fire("deselected")),n===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",n)},_fireSelectionEvents:function(n,s){var l=!1,u=this.getActiveObjects(),d=[],f=[];n.forEach(function(p){u.indexOf(p)===-1&&(l=!0,p.fire("deselected",{e:s,target:p}),f.push(p))}),u.forEach(function(p){n.indexOf(p)===-1&&(l=!0,p.fire("selected",{e:s,target:p}),d.push(p))}),n.length>0&&u.length>0?l&&this.fire("selection:updated",{e:s,selected:d,deselected:f,updated:d[0]||f[0],target:this._activeObject}):u.length>0?this.fire("selection:created",{e:s,selected:d,target:this._activeObject}):n.length>0&&this.fire("selection:cleared",{e:s,deselected:f})},setActiveObject:function(n,s){var l=this.getActiveObjects();return this._setActiveObject(n,s),this._fireSelectionEvents(l,s),this},_setActiveObject:function(n,s){return this._activeObject===n||!this._discardActiveObject(s,n)||n.onSelect({e:s})?!1:(this._activeObject=n,!0)},_discardActiveObject:function(n,s){var l=this._activeObject;if(l){if(l.onDeselect({e:n,object:s}))return!1;this._activeObject=null}return!0},discardActiveObject:function(n){var s=this.getActiveObjects(),l=this.getActiveObject();return s.length&&this.fire("before:selection:cleared",{target:l,e:n}),this._discardActiveObject(n),this._fireSelectionEvents(s,n),this},dispose:function(){var n=this.wrapperEl;return this.removeListeners(),n.removeChild(this.upperCanvasEl),n.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach(function(s){h.util.cleanUpJsdomNode(this[s]),this[s]=void 0}.bind(this)),n.parentNode&&n.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,h.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(n){var s=this._activeObject;s&&s._renderControls(n)},_toObject:function(n,s,l){var u=this._realizeGroupTransformOnObject(n),d=this.callSuper("_toObject",n,s,l);return this._unwindGroupTransformOnObject(n,u),d},_realizeGroupTransformOnObject:function(n){if(n.group&&n.group.type==="activeSelection"&&this._activeObject===n.group){var s=["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"],l={};return s.forEach(function(u){l[u]=n[u]}),h.util.addTransformToObject(n,this._activeObject.calcOwnMatrix()),l}else return null},_unwindGroupTransformOnObject:function(n,s){s&&n.set(s)},_setSVGObject:function(n,s,l){var u=this._realizeGroupTransformOnObject(s);this.callSuper("_setSVGObject",n,s,l),this._unwindGroupTransformOnObject(s,u)},setViewportTransform:function(n){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),h.StaticCanvas.prototype.setViewportTransform.call(this,n)}});for(var o in h.StaticCanvas)o!=="prototype"&&(h.Canvas[o]=h.StaticCanvas[o])}(),function(){var a=h.util.addListener,i=h.util.removeListener,r=3,o=2,n=1,s={passive:!1};function l(u,d){return u.button&&u.button===d-1}h.util.object.extend(h.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(a,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(u,d){var f=this.upperCanvasEl,p=this._getEventPrefix();u(h.window,"resize",this._onResize),u(f,p+"down",this._onMouseDown),u(f,p+"move",this._onMouseMove,s),u(f,p+"out",this._onMouseOut),u(f,p+"enter",this._onMouseEnter),u(f,"wheel",this._onMouseWheel),u(f,"contextmenu",this._onContextMenu),u(f,"dblclick",this._onDoubleClick),u(f,"dragover",this._onDragOver),u(f,"dragenter",this._onDragEnter),u(f,"dragleave",this._onDragLeave),u(f,"drop",this._onDrop),this.enablePointerEvents||u(f,"touchstart",this._onTouchStart,s),typeof eventjs!="undefined"&&d in eventjs&&(eventjs[d](f,"gesture",this._onGesture),eventjs[d](f,"drag",this._onDrag),eventjs[d](f,"orientation",this._onOrientationChange),eventjs[d](f,"shake",this._onShake),eventjs[d](f,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(i,"remove");var u=this._getEventPrefix();i(h.document,u+"up",this._onMouseUp),i(h.document,"touchend",this._onTouchEnd,s),i(h.document,u+"move",this._onMouseMove,s),i(h.document,"touchmove",this._onMouseMove,s)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._simpleEventHandler.bind(this,"drop"),this.eventsBound=!0)},_onGesture:function(u,d){this.__onTransformGesture&&this.__onTransformGesture(u,d)},_onDrag:function(u,d){this.__onDrag&&this.__onDrag(u,d)},_onMouseWheel:function(u){this.__onMouseWheel(u)},_onMouseOut:function(u){var d=this._hoveredTarget;this.fire("mouse:out",{target:d,e:u}),this._hoveredTarget=null,d&&d.fire("mouseout",{e:u});var f=this;this._hoveredTargets.forEach(function(p){f.fire("mouse:out",{target:d,e:u}),p&&d.fire("mouseout",{e:u})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(p){p.isEditing&&p.hiddenTextarea.focus()})},_onMouseEnter:function(u){!this._currentTransform&&!this.findTarget(u)&&(this.fire("mouse:over",{target:null,e:u}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(u,d){this.__onOrientationChange&&this.__onOrientationChange(u,d)},_onShake:function(u,d){this.__onShake&&this.__onShake(u,d)},_onLongPress:function(u,d){this.__onLongPress&&this.__onLongPress(u,d)},_onDragOver:function(u){u.preventDefault();var d=this._simpleEventHandler("dragover",u);this._fireEnterLeaveEvents(d,u)},_onContextMenu:function(u){return this.stopContextMenu&&(u.stopPropagation(),u.preventDefault()),!1},_onDoubleClick:function(u){this._cacheTransformEventData(u),this._handleEvent(u,"dblclick"),this._resetTransformEventData(u)},getPointerId:function(u){var d=u.changedTouches;return d?d[0]&&d[0].identifier:this.enablePointerEvents?u.pointerId:-1},_isMainEvent:function(u){return u.isPrimary===!0?!0:u.isPrimary===!1?!1:u.type==="touchend"&&u.touches.length===0?!0:u.changedTouches?u.changedTouches[0].identifier===this.mainTouchId:!0},_onTouchStart:function(u){u.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(u)),this.__onMouseDown(u),this._resetTransformEventData();var d=this.upperCanvasEl,f=this._getEventPrefix();a(h.document,"touchend",this._onTouchEnd,s),a(h.document,"touchmove",this._onMouseMove,s),i(d,f+"down",this._onMouseDown)},_onMouseDown:function(u){this.__onMouseDown(u),this._resetTransformEventData();var d=this.upperCanvasEl,f=this._getEventPrefix();i(d,f+"move",this._onMouseMove,s),a(h.document,f+"up",this._onMouseUp),a(h.document,f+"move",this._onMouseMove,s)},_onTouchEnd:function(u){if(!(u.touches.length>0)){this.__onMouseUp(u),this._resetTransformEventData(),this.mainTouchId=null;var d=this._getEventPrefix();i(h.document,"touchend",this._onTouchEnd,s),i(h.document,"touchmove",this._onMouseMove,s);var f=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){a(f.upperCanvasEl,d+"down",f._onMouseDown),f._willAddMouseDown=0},400)}},_onMouseUp:function(u){this.__onMouseUp(u),this._resetTransformEventData();var d=this.upperCanvasEl,f=this._getEventPrefix();this._isMainEvent(u)&&(i(h.document,f+"up",this._onMouseUp),i(h.document,f+"move",this._onMouseMove,s),a(d,f+"move",this._onMouseMove,s))},_onMouseMove:function(u){!this.allowTouchScrolling&&u.preventDefault&&u.preventDefault(),this.__onMouseMove(u)},_onResize:function(){this.calcOffset()},_shouldRender:function(u){var d=this._activeObject;return!!d!=!!u||d&&u&&d!==u?!0:(d&&d.isEditing,!1)},__onMouseUp:function(u){var d,f=this._currentTransform,p=this._groupSelector,v=!1,w=!p||p.left===0&&p.top===0;if(this._cacheTransformEventData(u),d=this._target,this._handleEvent(u,"up:before"),l(u,r)){this.fireRightClick&&this._handleEvent(u,"up",r,w);return}if(l(u,o)){this.fireMiddleClick&&this._handleEvent(u,"up",o,w),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing){this._onMouseUpInDrawingMode(u);return}if(!!this._isMainEvent(u)){if(f&&(this._finalizeCurrentTransform(u),v=f.actionPerformed),!w){var C=d===this._activeObject;this._maybeGroupObjects(u),v||(v=this._shouldRender(d)||!C&&d===this._activeObject)}if(d){if(d.selectable&&d!==this._activeObject&&d.activeOn==="up")this.setActiveObject(d,u),v=!0;else{var b=d._findTargetCorner(this.getPointer(u,!0),h.util.isTouchEvent(u)),P=d.controls[b],R=P&&P.getMouseUpHandler(u,d,P);if(R){var A=this.getPointer(u);R(u,f,A.x,A.y)}}d.isMoving=!1}this._setCursorFromEvent(u,d),this._handleEvent(u,"up",n,w),this._groupSelector=null,this._currentTransform=null,d&&(d.__corner=0),v?this.requestRenderAll():w||this.renderTop()}},_simpleEventHandler:function(u,d){var f=this.findTarget(d),p=this.targets,v={e:d,target:f,subTargets:p};if(this.fire(u,v),f&&f.fire(u,v),!p)return f;for(var w=0;w<p.length;w++)p[w].fire(u,v);return f},_handleEvent:function(u,d,f,p){var v=this._target,w=this.targets||[],C={e:u,target:v,subTargets:w,button:f||n,isClick:p||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};d==="up"&&(C.currentTarget=this.findTarget(u),C.currentSubTargets=this.targets),this.fire("mouse:"+d,C),v&&v.fire("mouse"+d,C);for(var b=0;b<w.length;b++)w[b].fire("mouse"+d,C)},_finalizeCurrentTransform:function(u){var d=this._currentTransform,f=d.target,p,v={e:u,target:f,transform:d,action:d.action};f._scaling&&(f._scaling=!1),f.setCoords(),(d.actionPerformed||this.stateful&&f.hasStateChanged())&&(d.actionPerformed&&(p=this._addEventOptions(v,d),this._fire(p,v)),this._fire("modified",v))},_addEventOptions:function(u,d){var f,p;switch(d.action){case"scaleX":f="scaled",p="x";break;case"scaleY":f="scaled",p="y";break;case"skewX":f="skewed",p="x";break;case"skewY":f="skewed",p="y";break;case"scale":f="scaled",p="equally";break;case"rotate":f="rotated";break;case"drag":f="moved";break}return u.by=p,f},_onMouseDownInDrawingMode:function(u){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(u).requestRenderAll();var d=this.getPointer(u);this.freeDrawingBrush.onMouseDown(d,{e:u,pointer:d}),this._handleEvent(u,"down")},_onMouseMoveInDrawingMode:function(u){if(this._isCurrentlyDrawing){var d=this.getPointer(u);this.freeDrawingBrush.onMouseMove(d,{e:u,pointer:d})}this.setCursor(this.freeDrawingCursor),this._handleEvent(u,"move")},_onMouseUpInDrawingMode:function(u){var d=this.getPointer(u);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:u,pointer:d}),this._handleEvent(u,"up")},__onMouseDown:function(u){this._cacheTransformEventData(u),this._handleEvent(u,"down:before");var d=this._target;if(l(u,r)){this.fireRightClick&&this._handleEvent(u,"down",r);return}if(l(u,o)){this.fireMiddleClick&&this._handleEvent(u,"down",o);return}if(this.isDrawingMode){this._onMouseDownInDrawingMode(u);return}if(!!this._isMainEvent(u)&&!this._currentTransform){var f=this._pointer;this._previousPointer=f;var p=this._shouldRender(d),v=this._shouldGroup(u,d);if(this._shouldClearSelection(u,d)?this.discardActiveObject(u):v&&(this._handleGrouping(u,d),d=this._activeObject),this.selection&&(!d||!d.selectable&&!d.isEditing&&d!==this._activeObject)&&(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),d){var w=d===this._activeObject;d.selectable&&d.activeOn==="down"&&this.setActiveObject(d,u);var C=d._findTargetCorner(this.getPointer(u,!0),h.util.isTouchEvent(u));if(d.__corner=C,d===this._activeObject&&(C||!v)){this._setupCurrentTransform(u,d,w);var b=d.controls[C],f=this.getPointer(u),P=b&&b.getMouseDownHandler(u,d,b);P&&P(u,this._currentTransform,f.x,f.y)}}this._handleEvent(u,"down"),(p||v)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(u){this._resetTransformEventData(),this._pointer=this.getPointer(u,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(u)||null},_beforeTransform:function(u){var d=this._currentTransform;this.stateful&&d.target.saveState(),this.fire("before:transform",{e:u,transform:d})},__onMouseMove:function(u){this._handleEvent(u,"move:before"),this._cacheTransformEventData(u);var d,f;if(this.isDrawingMode){this._onMouseMoveInDrawingMode(u);return}if(!!this._isMainEvent(u)){var p=this._groupSelector;p?(f=this._absolutePointer,p.left=f.x-p.ex,p.top=f.y-p.ey,this.renderTop()):this._currentTransform?this._transformObject(u):(d=this.findTarget(u)||null,this._setCursorFromEvent(u,d),this._fireOverOutEvents(d,u)),this._handleEvent(u,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(u,d){var f=this._hoveredTarget,p=this._hoveredTargets,v=this.targets,w=Math.max(p.length,v.length);this.fireSyntheticInOutEvents(u,d,{oldTarget:f,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var C=0;C<w;C++)this.fireSyntheticInOutEvents(v[C],d,{oldTarget:p[C],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=u,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(u,d){var f=this._draggedoverTarget,p=this._hoveredTargets,v=this.targets,w=Math.max(p.length,v.length);this.fireSyntheticInOutEvents(u,d,{oldTarget:f,evtOut:"dragleave",evtIn:"dragenter"});for(var C=0;C<w;C++)this.fireSyntheticInOutEvents(v[C],d,{oldTarget:p[C],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=u},fireSyntheticInOutEvents:function(u,d,f){var p,v,w=f.oldTarget,C,b,P=w!==u,R=f.canvasEvtIn,A=f.canvasEvtOut;P&&(p={e:d,target:u,previousTarget:w},v={e:d,target:w,nextTarget:u}),b=u&&P,C=w&&P,C&&(A&&this.fire(A,v),w.fire(f.evtOut,v)),b&&(R&&this.fire(R,p),u.fire(f.evtIn,p))},__onMouseWheel:function(u){this._cacheTransformEventData(u),this._handleEvent(u,"wheel"),this._resetTransformEventData()},_transformObject:function(u){var d=this.getPointer(u),f=this._currentTransform;f.reset=!1,f.shiftKey=u.shiftKey,f.altKey=u[this.centeredKey],this._performTransformAction(u,f,d),f.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(u,d,f){var p=f.x,v=f.y,w=d.action,C=!1,b=d.actionHandler;b&&(C=b(u,d,p,v)),w==="drag"&&C&&(d.target.isMoving=!0,this.setCursor(d.target.moveCursor||this.moveCursor)),d.actionPerformed=d.actionPerformed||C},_fire:h.controlsUtils.fireEvent,_setCursorFromEvent:function(u,d){if(!d)return this.setCursor(this.defaultCursor),!1;var f=d.hoverCursor||this.hoverCursor,p=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,v=(!p||!p.contains(d))&&d._findTargetCorner(this.getPointer(u,!0));v?this.setCursor(this.getCornerCursor(v,d,u)):(d.subTargetCheck&&this.targets.concat().reverse().map(function(w){f=w.hoverCursor||f}),this.setCursor(f))},getCornerCursor:function(u,d,f){var p=d.controls[u];return p.cursorStyleHandler(f,p,d)}})}(),function(){var a=Math.min,i=Math.max;h.util.object.extend(h.Canvas.prototype,{_shouldGroup:function(r,o){var n=this._activeObject;return n&&this._isSelectionKeyPressed(r)&&o&&o.selectable&&this.selection&&(n!==o||n.type==="activeSelection")&&!o.onSelect({e:r})},_handleGrouping:function(r,o){var n=this._activeObject;n.__corner||o===n&&(o=this.findTarget(r,!0),!o||!o.selectable)||(n&&n.type==="activeSelection"?this._updateActiveSelection(o,r):this._createActiveSelection(o,r))},_updateActiveSelection:function(r,o){var n=this._activeObject,s=n._objects.slice(0);n.contains(r)?(n.removeWithUpdate(r),this._hoveredTarget=r,this._hoveredTargets=this.targets.concat(),n.size()===1&&this._setActiveObject(n.item(0),o)):(n.addWithUpdate(r),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(s,o)},_createActiveSelection:function(r,o){var n=this.getActiveObjects(),s=this._createGroup(r);this._hoveredTarget=s,this._setActiveObject(s,o),this._fireSelectionEvents(n,o)},_createGroup:function(r){var o=this._objects,n=o.indexOf(this._activeObject)<o.indexOf(r),s=n?[this._activeObject,r]:[r,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new h.ActiveSelection(s,{canvas:this})},_groupSelectedObjects:function(r){var o=this._collectObjects(r),n;o.length===1?this.setActiveObject(o[0],r):o.length>1&&(n=new h.ActiveSelection(o.reverse(),{canvas:this}),this.setActiveObject(n,r))},_collectObjects:function(r){for(var o=[],n,s=this._groupSelector.ex,l=this._groupSelector.ey,u=s+this._groupSelector.left,d=l+this._groupSelector.top,f=new h.Point(a(s,u),a(l,d)),p=new h.Point(i(s,u),i(l,d)),v=!this.selectionFullyContained,w=s===u&&l===d,C=this._objects.length;C--&&(n=this._objects[C],!(!(!n||!n.selectable||!n.visible)&&(v&&n.intersectsWithRect(f,p,!0)||n.isContainedWithinRect(f,p,!0)||v&&n.containsPoint(f,null,!0)||v&&n.containsPoint(p,null,!0))&&(o.push(n),w))););return o.length>1&&(o=o.filter(function(b){return!b.onSelect({e:r})})),o},_maybeGroupObjects:function(r){this.selection&&this._groupSelector&&this._groupSelectedObjects(r),this.setCursor(this.defaultCursor),this._groupSelector=null}})}(),function(){h.util.object.extend(h.StaticCanvas.prototype,{toDataURL:function(a){a||(a={});var i=a.format||"png",r=a.quality||1,o=(a.multiplier||1)*(a.enableRetinaScaling?this.getRetinaScaling():1),n=this.toCanvasElement(o,a);return h.util.toDataURL(n,i,r)},toCanvasElement:function(a,i){a=a||1,i=i||{};var r=(i.width||this.width)*a,o=(i.height||this.height)*a,n=this.getZoom(),s=this.width,l=this.height,u=n*a,d=this.viewportTransform,f=(d[4]-(i.left||0))*a,p=(d[5]-(i.top||0))*a,v=this.interactive,w=[u,0,0,u,f,p],C=this.enableRetinaScaling,b=h.util.createCanvasElement(),P=this.contextTop;return b.width=r,b.height=o,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=w,this.width=r,this.height=o,this.calcViewportBoundaries(),this.renderCanvas(b.getContext("2d"),this._objects),this.viewportTransform=d,this.width=s,this.height=l,this.calcViewportBoundaries(),this.interactive=v,this.enableRetinaScaling=C,this.contextTop=P,b}})}(),h.util.object.extend(h.StaticCanvas.prototype,{loadFromJSON:function(a,i,r){if(!!a){var o=typeof a=="string"?JSON.parse(a):h.util.object.clone(a),n=this,s=o.clipPath,l=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete o.clipPath,this._enlivenObjects(o.objects,function(u){n.clear(),n._setBgOverlay(o,function(){s?n._enlivenObjects([s],function(d){n.clipPath=d[0],n.__setupCanvas.call(n,o,u,l,i)}):n.__setupCanvas.call(n,o,u,l,i)})},r),this}},__setupCanvas:function(a,i,r,o){var n=this;i.forEach(function(s,l){n.insertAt(s,l)}),this.renderOnAddRemove=r,delete a.objects,delete a.backgroundImage,delete a.overlayImage,delete a.background,delete a.overlay,this._setOptions(a),this.renderAll(),o&&o()},_setBgOverlay:function(a,i){var r={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(!a.backgroundImage&&!a.overlayImage&&!a.background&&!a.overlay){i&&i();return}var o=function(){r.backgroundImage&&r.overlayImage&&r.backgroundColor&&r.overlayColor&&i&&i()};this.__setBgOverlay("backgroundImage",a.backgroundImage,r,o),this.__setBgOverlay("overlayImage",a.overlayImage,r,o),this.__setBgOverlay("backgroundColor",a.background,r,o),this.__setBgOverlay("overlayColor",a.overlay,r,o)},__setBgOverlay:function(a,i,r,o){var n=this;if(!i){r[a]=!0,o&&o();return}a==="backgroundImage"||a==="overlayImage"?h.util.enlivenObjects([i],function(s){n[a]=s[0],r[a]=!0,o&&o()}):this["set"+h.util.string.capitalize(a,!0)](i,function(){r[a]=!0,o&&o()})},_enlivenObjects:function(a,i,r){if(!a||a.length===0){i&&i([]);return}h.util.enlivenObjects(a,function(o){i&&i(o)},null,r)},_toDataURL:function(a,i){this.clone(function(r){i(r.toDataURL(a))})},_toDataURLWithMultiplier:function(a,i,r){this.clone(function(o){r(o.toDataURLWithMultiplier(a,i))})},clone:function(a,i){var r=JSON.stringify(this.toJSON(i));this.cloneWithoutData(function(o){o.loadFromJSON(r,function(){a&&a(o)})})},cloneWithoutData:function(a){var i=h.util.createCanvasElement();i.width=this.width,i.height=this.height;var r=new h.Canvas(i);this.backgroundImage?(r.setBackgroundImage(this.backgroundImage.src,function(){r.renderAll(),a&&a(r)}),r.backgroundImageOpacity=this.backgroundImageOpacity,r.backgroundImageStretch=this.backgroundImageStretch):a&&a(r)}}),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.extend,o=i.util.object.clone,n=i.util.toFixed,s=i.util.string.capitalize,l=i.util.degreesToRadians,u=!i.isLikelyNode,d=2;i.Object||(i.Object=i.util.createClass(i.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:u,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(f){f&&this.setOptions(f)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=i.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(f){var p=i.perfLimitSizeTotal,v=f.width,w=f.height,C=i.maxCacheSideLimit,b=i.minCacheSideLimit;if(v<=C&&w<=C&&v*w<=p)return v<b&&(f.width=b),w<b&&(f.height=b),f;var P=v/w,R=i.util.limitDimsByArea(P,p),A=i.util.capValue,W=A(b,R.x,C),$=A(b,R.y,C);return v>W&&(f.zoomX/=v/W,f.width=W,f.capped=!0),w>$&&(f.zoomY/=w/$,f.height=$,f.capped=!0),f},_getCacheCanvasDimensions:function(){var f=this.getTotalObjectScaling(),p=this._getTransformedDimensions(0,0),v=p.x*f.scaleX/this.scaleX,w=p.y*f.scaleY/this.scaleY;return{width:v+d,height:w+d,zoomX:f.scaleX,zoomY:f.scaleY,x:v,y:w}},_updateCacheCanvas:function(){var f=this.canvas;if(this.noScaleCache&&f&&f._currentTransform){var p=f._currentTransform.target,v=f._currentTransform.action;if(this===p&&v.slice&&v.slice(0,5)==="scale")return!1}var w=this._cacheCanvas,C=this._limitCacheSize(this._getCacheCanvasDimensions()),b=i.minCacheSideLimit,P=C.width,R=C.height,A,W,$=C.zoomX,X=C.zoomY,re=P!==this.cacheWidth||R!==this.cacheHeight,he=this.zoomX!==$||this.zoomY!==X,ne=re||he,ce=0,ue=0,de=!1;if(re){var fe=this._cacheCanvas.width,L=this._cacheCanvas.height,U=P>fe||R>L,N=(P<fe*.9||R<L*.9)&&fe>b&&L>b;de=U||N,U&&!C.capped&&(P>b||R>b)&&(ce=P*.1,ue=R*.1)}return this instanceof i.Text&&this.path&&(ne=!0,de=!0,ce+=this.getHeightOfLine(0)*this.zoomX,ue+=this.getHeightOfLine(0)*this.zoomY),ne?(de?(w.width=Math.ceil(P+ce),w.height=Math.ceil(R+ue)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,w.width,w.height)),A=C.x/2,W=C.y/2,this.cacheTranslationX=Math.round(w.width/2-A)+A,this.cacheTranslationY=Math.round(w.height/2-W)+W,this.cacheWidth=P,this.cacheHeight=R,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale($,X),this.zoomX=$,this.zoomY=X,!0):!1},setOptions:function(f){this._setOptions(f),this._initGradient(f.fill,"fill"),this._initGradient(f.stroke,"stroke"),this._initPattern(f.fill,"fill"),this._initPattern(f.stroke,"stroke")},transform:function(f){var p=this.group&&!this.group._transformDone||this.group&&this.canvas&&f===this.canvas.contextTop,v=this.calcTransformMatrix(!p);f.transform(v[0],v[1],v[2],v[3],v[4],v[5])},toObject:function(f){var p=i.Object.NUM_FRACTION_DIGITS,v={type:this.type,version:i.version,originX:this.originX,originY:this.originY,left:n(this.left,p),top:n(this.top,p),width:n(this.width,p),height:n(this.height,p),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:n(this.strokeWidth,p),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:n(this.strokeMiterLimit,p),scaleX:n(this.scaleX,p),scaleY:n(this.scaleY,p),angle:n(this.angle,p),flipX:this.flipX,flipY:this.flipY,opacity:n(this.opacity,p),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:n(this.skewX,p),skewY:n(this.skewY,p)};return this.clipPath&&!this.clipPath.excludeFromExport&&(v.clipPath=this.clipPath.toObject(f),v.clipPath.inverted=this.clipPath.inverted,v.clipPath.absolutePositioned=this.clipPath.absolutePositioned),i.util.populateWithProperties(this,v,f),this.includeDefaultValues||(v=this._removeDefaultValues(v)),v},toDatalessObject:function(f){return this.toObject(f)},_removeDefaultValues:function(f){var p=i.util.getKlass(f.type).prototype,v=p.stateProperties;return v.forEach(function(w){if(!(w==="left"||w==="top")){f[w]===p[w]&&delete f[w];var C=Object.prototype.toString.call(f[w])==="[object Array]"&&Object.prototype.toString.call(p[w])==="[object Array]";C&&f[w].length===0&&p[w].length===0&&delete f[w]}}),f},toString:function(){return"#<fabric."+s(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var f=i.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(f.scaleX),scaleY:Math.abs(f.scaleY)}},getTotalObjectScaling:function(){var f=this.getObjectScaling(),p=f.scaleX,v=f.scaleY;if(this.canvas){var w=this.canvas.getZoom(),C=this.canvas.getRetinaScaling();p*=w*C,v*=w*C}return{scaleX:p,scaleY:v}},getObjectOpacity:function(){var f=this.opacity;return this.group&&(f*=this.group.getObjectOpacity()),f},_set:function(f,p){var v=f==="scaleX"||f==="scaleY",w=this[f]!==p,C=!1;return v&&(p=this._constrainScale(p)),f==="scaleX"&&p<0?(this.flipX=!this.flipX,p*=-1):f==="scaleY"&&p<0?(this.flipY=!this.flipY,p*=-1):f==="shadow"&&p&&!(p instanceof i.Shadow)?p=new i.Shadow(p):f==="dirty"&&this.group&&this.group.set("dirty",p),this[f]=p,w&&(C=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(f)>-1?(this.dirty=!0,C&&this.group.set("dirty",!0)):C&&this.stateProperties.indexOf(f)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:i.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(f){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(f.save(),this._setupCompositeOperation(f),this.drawSelectionBackground(f),this.transform(f),this._setOpacity(f),this._setShadow(f,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(f)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(f),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),f.restore())},renderCache:function(f){f=f||{},this._cacheCanvas||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,f.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!!(this.paintFirst==="stroke"&&this.hasFill()&&this.hasStroke()&&typeof this.shadow=="object"||this.clipPath)},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(f){var p=this.clipPath;if(f.save(),p.inverted?f.globalCompositeOperation="destination-out":f.globalCompositeOperation="destination-in",p.absolutePositioned){var v=i.util.invertTransform(this.calcTransformMatrix());f.transform(v[0],v[1],v[2],v[3],v[4],v[5])}p.transform(f),f.scale(1/p.zoomX,1/p.zoomY),f.drawImage(p._cacheCanvas,-p.cacheTranslationX,-p.cacheTranslationY),f.restore()},drawObject:function(f,p){var v=this.fill,w=this.stroke;p?(this.fill="black",this.stroke="",this._setClippingProperties(f)):this._renderBackground(f),this._render(f),this._drawClipPath(f),this.fill=v,this.stroke=w},_drawClipPath:function(f){var p=this.clipPath;!p||(p.canvas=this.canvas,p.shouldCache(),p._transformDone=!0,p.renderCache({forClipping:!0}),this.drawClipPathOnCache(f))},drawCacheOnCanvas:function(f){f.scale(1/this.zoomX,1/this.zoomY),f.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(f){if(this.isNotVisible())return!1;if(this._cacheCanvas&&!f&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&!f){var p=this.cacheWidth/this.zoomX,v=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-p/2,-v/2,p,v)}return!0}return!1},_renderBackground:function(f){if(!!this.backgroundColor){var p=this._getNonTransformedDimensions();f.fillStyle=this.backgroundColor,f.fillRect(-p.x/2,-p.y/2,p.x,p.y),this._removeShadow(f)}},_setOpacity:function(f){this.group&&!this.group._transformDone?f.globalAlpha=this.getObjectOpacity():f.globalAlpha*=this.opacity},_setStrokeStyles:function(f,p){var v=p.stroke;v&&(f.lineWidth=p.strokeWidth,f.lineCap=p.strokeLineCap,f.lineDashOffset=p.strokeDashOffset,f.lineJoin=p.strokeLineJoin,f.miterLimit=p.strokeMiterLimit,v.toLive?v.gradientUnits==="percentage"||v.gradientTransform||v.patternTransform?this._applyPatternForTransformedGradient(f,v):(f.strokeStyle=v.toLive(f,this),this._applyPatternGradientTransform(f,v)):f.strokeStyle=p.stroke)},_setFillStyles:function(f,p){var v=p.fill;v&&(v.toLive?(f.fillStyle=v.toLive(f,this),this._applyPatternGradientTransform(f,p.fill)):f.fillStyle=v)},_setClippingProperties:function(f){f.globalAlpha=1,f.strokeStyle="transparent",f.fillStyle="#000000"},_setLineDash:function(f,p){!p||p.length===0||(1&p.length&&p.push.apply(p,p),f.setLineDash(p))},_renderControls:function(f,p){var v=this.getViewportTransform(),w=this.calcTransformMatrix(),C,b,P;p=p||{},b=typeof p.hasBorders!="undefined"?p.hasBorders:this.hasBorders,P=typeof p.hasControls!="undefined"?p.hasControls:this.hasControls,w=i.util.multiplyTransformMatrices(v,w),C=i.util.qrDecompose(w),f.save(),f.translate(C.translateX,C.translateY),f.lineWidth=1*this.borderScaleFactor,this.group||(f.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),f.rotate(l(C.angle)),p.forActiveSelection||this.group?b&&this.drawBordersInGroup(f,C,p):b&&this.drawBorders(f,p),P&&this.drawControls(f,p),f.restore()},_setShadow:function(f){if(!!this.shadow){var p=this.shadow,v=this.canvas,w,C=v&&v.viewportTransform[0]||1,b=v&&v.viewportTransform[3]||1;p.nonScaling?w={scaleX:1,scaleY:1}:w=this.getObjectScaling(),v&&v._isRetinaScaling()&&(C*=i.devicePixelRatio,b*=i.devicePixelRatio),f.shadowColor=p.color,f.shadowBlur=p.blur*i.browserShadowBlurConstant*(C+b)*(w.scaleX+w.scaleY)/4,f.shadowOffsetX=p.offsetX*C*w.scaleX,f.shadowOffsetY=p.offsetY*b*w.scaleY}},_removeShadow:function(f){!this.shadow||(f.shadowColor="",f.shadowBlur=f.shadowOffsetX=f.shadowOffsetY=0)},_applyPatternGradientTransform:function(f,p){if(!p||!p.toLive)return{offsetX:0,offsetY:0};var v=p.gradientTransform||p.patternTransform,w=-this.width/2+p.offsetX||0,C=-this.height/2+p.offsetY||0;return p.gradientUnits==="percentage"?f.transform(this.width,0,0,this.height,w,C):f.transform(1,0,0,1,w,C),v&&f.transform(v[0],v[1],v[2],v[3],v[4],v[5]),{offsetX:w,offsetY:C}},_renderPaintInOrder:function(f){this.paintFirst==="stroke"?(this._renderStroke(f),this._renderFill(f)):(this._renderFill(f),this._renderStroke(f))},_render:function(){},_renderFill:function(f){!this.fill||(f.save(),this._setFillStyles(f,this),this.fillRule==="evenodd"?f.fill("evenodd"):f.fill(),f.restore())},_renderStroke:function(f){if(!(!this.stroke||this.strokeWidth===0)){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(f),f.save(),this.strokeUniform&&this.group){var p=this.getObjectScaling();f.scale(1/p.scaleX,1/p.scaleY)}else this.strokeUniform&&f.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(f,this.strokeDashArray),this._setStrokeStyles(f,this),f.stroke(),f.restore()}},_applyPatternForTransformedGradient:function(f,p){var v=this._limitCacheSize(this._getCacheCanvasDimensions()),w=i.util.createCanvasElement(),C,b=this.canvas.getRetinaScaling(),P=v.x/this.scaleX/b,R=v.y/this.scaleY/b;w.width=P,w.height=R,C=w.getContext("2d"),C.beginPath(),C.moveTo(0,0),C.lineTo(P,0),C.lineTo(P,R),C.lineTo(0,R),C.closePath(),C.translate(P/2,R/2),C.scale(v.zoomX/this.scaleX/b,v.zoomY/this.scaleY/b),this._applyPatternGradientTransform(C,p),C.fillStyle=p.toLive(f),C.fill(),f.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),f.scale(b*this.scaleX/v.zoomX,b*this.scaleY/v.zoomY),f.strokeStyle=C.createPattern(w,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var f=i.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",f.scaleX),this.set("scaleY",f.scaleY),this.angle=f.angle,this.skewX=f.skewX,this.skewY=0}},_removeTransformMatrix:function(f){var p=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),p=i.util.transformPoint(p,this.transformMatrix)),this.transformMatrix=null,f&&(this.scaleX*=f.scaleX,this.scaleY*=f.scaleY,this.cropX=f.cropX,this.cropY=f.cropY,p.x+=f.offsetLeft,p.y+=f.offsetTop,this.width=f.width,this.height=f.height),this.setPositionByOrigin(p,"center","center")},clone:function(f,p){var v=this.toObject(p);this.constructor.fromObject?this.constructor.fromObject(v,f):i.Object._fromObject("Object",v,f)},cloneAsImage:function(f,p){var v=this.toCanvasElement(p);return f&&f(new i.Image(v)),this},toCanvasElement:function(f){f||(f={});var p=i.util,v=p.saveObjectTransform(this),w=this.group,C=this.shadow,b=Math.abs,P=(f.multiplier||1)*(f.enableRetinaScaling?i.devicePixelRatio:1);delete this.group,f.withoutTransform&&p.resetObjectTransform(this),f.withoutShadow&&(this.shadow=null);var R=i.util.createCanvasElement(),A=this.getBoundingRect(!0,!0),W=this.shadow,$,X={x:0,y:0},re,he,ne;W&&(re=W.blur,W.nonScaling?$={scaleX:1,scaleY:1}:$=this.getObjectScaling(),X.x=2*Math.round(b(W.offsetX)+re)*b($.scaleX),X.y=2*Math.round(b(W.offsetY)+re)*b($.scaleY)),he=A.width+X.x,ne=A.height+X.y,R.width=Math.ceil(he),R.height=Math.ceil(ne);var ce=new i.StaticCanvas(R,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});f.format==="jpeg"&&(ce.backgroundColor="#fff"),this.setPositionByOrigin(new i.Point(ce.width/2,ce.height/2),"center","center");var ue=this.canvas;ce.add(this);var de=ce.toCanvasElement(P||1,f);return this.shadow=C,this.set("canvas",ue),w&&(this.group=w),this.set(v).setCoords(),ce._objects=[],ce.dispose(),ce=null,de},toDataURL:function(f){return f||(f={}),i.util.toDataURL(this.toCanvasElement(f),f.format||"png",f.quality||1)},isType:function(f){return this.type===f},complexity:function(){return 1},toJSON:function(f){return this.toObject(f)},rotate:function(f){var p=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return p&&this._setOriginToCenter(),this.set("angle",f),p&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(f,p){p=p||this.canvas.getPointer(f);var v=new i.Point(p.x,p.y),w=this._getLeftTopCoords();return this.angle&&(v=i.util.rotatePoint(v,w,l(-this.angle))),{x:v.x-w.x,y:v.y-w.y}},_setupCompositeOperation:function(f){this.globalCompositeOperation&&(f.globalCompositeOperation=this.globalCompositeOperation)}}),i.util.createAccessors&&i.util.createAccessors(i.Object),r(i.Object.prototype,i.Observable),i.Object.NUM_FRACTION_DIGITS=2,i.Object._fromObject=function(f,p,v,w){var C=i[f];p=o(p,!0),i.util.enlivenPatterns([p.fill,p.stroke],function(b){typeof b[0]!="undefined"&&(p.fill=b[0]),typeof b[1]!="undefined"&&(p.stroke=b[1]),i.util.enlivenObjects([p.clipPath],function(P){p.clipPath=P[0];var R=w?new C(p[w],p):new C(p);v&&v(R)})})},i.Object.__uid=0)}(e),function(){var a=h.util.degreesToRadians,i={left:-.5,center:0,right:.5},r={top:-.5,center:0,bottom:.5};h.util.object.extend(h.Object.prototype,{translateToGivenOrigin:function(o,n,s,l,u){var d=o.x,f=o.y,p,v,w;return typeof n=="string"?n=i[n]:n-=.5,typeof l=="string"?l=i[l]:l-=.5,p=l-n,typeof s=="string"?s=r[s]:s-=.5,typeof u=="string"?u=r[u]:u-=.5,v=u-s,(p||v)&&(w=this._getTransformedDimensions(),d=o.x+p*w.x,f=o.y+v*w.y),new h.Point(d,f)},translateToCenterPoint:function(o,n,s){var l=this.translateToGivenOrigin(o,n,s,"center","center");return this.angle?h.util.rotatePoint(l,o,a(this.angle)):l},translateToOriginPoint:function(o,n,s){var l=this.translateToGivenOrigin(o,"center","center",n,s);return this.angle?h.util.rotatePoint(l,o,a(this.angle)):l},getCenterPoint:function(){var o=new h.Point(this.left,this.top);return this.translateToCenterPoint(o,this.originX,this.originY)},getPointByOrigin:function(o,n){var s=this.getCenterPoint();return this.translateToOriginPoint(s,o,n)},toLocalPoint:function(o,n,s){var l=this.getCenterPoint(),u,d;return typeof n!="undefined"&&typeof s!="undefined"?u=this.translateToGivenOrigin(l,"center","center",n,s):u=new h.Point(this.left,this.top),d=new h.Point(o.x,o.y),this.angle&&(d=h.util.rotatePoint(d,l,-a(this.angle))),d.subtractEquals(u)},setPositionByOrigin:function(o,n,s){var l=this.translateToCenterPoint(o,n,s),u=this.translateToOriginPoint(l,this.originX,this.originY);this.set("left",u.x),this.set("top",u.y)},adjustPosition:function(o){var n=a(this.angle),s=this.getScaledWidth(),l=h.util.cos(n)*s,u=h.util.sin(n)*s,d,f;typeof this.originX=="string"?d=i[this.originX]:d=this.originX-.5,typeof o=="string"?f=i[o]:f=o-.5,this.left+=l*(f-d),this.top+=u*(f-d),this.setCoords(),this.originX=o},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var o=this.getCenterPoint();this.originX="center",this.originY="center",this.left=o.x,this.top=o.y},_resetOrigin:function(){var o=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=o.x,this.top=o.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}})}(),function(){function a(s){return[new h.Point(s.tl.x,s.tl.y),new h.Point(s.tr.x,s.tr.y),new h.Point(s.br.x,s.br.y),new h.Point(s.bl.x,s.bl.y)]}var i=h.util,r=i.degreesToRadians,o=i.multiplyTransformMatrices,n=i.transformPoint;i.object.extend(h.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(s,l){return l?s?this.calcACoords():this.calcLineCoords():((!this.aCoords||!this.lineCoords)&&this.setCoords(!0),s?this.aCoords:this.lineCoords)},getCoords:function(s,l){return a(this._getCoords(s,l))},intersectsWithRect:function(s,l,u,d){var f=this.getCoords(u,d),p=h.Intersection.intersectPolygonRectangle(f,s,l);return p.status==="Intersection"},intersectsWithObject:function(s,l,u){var d=h.Intersection.intersectPolygonPolygon(this.getCoords(l,u),s.getCoords(l,u));return d.status==="Intersection"||s.isContainedWithinObject(this,l,u)||this.isContainedWithinObject(s,l,u)},isContainedWithinObject:function(s,l,u){for(var d=this.getCoords(l,u),f=l?s.aCoords:s.lineCoords,p=0,v=s._getImageLines(f);p<4;p++)if(!s.containsPoint(d[p],v))return!1;return!0},isContainedWithinRect:function(s,l,u,d){var f=this.getBoundingRect(u,d);return f.left>=s.x&&f.left+f.width<=l.x&&f.top>=s.y&&f.top+f.height<=l.y},containsPoint:function(s,p,u,d){var f=this._getCoords(u,d),p=p||this._getImageLines(f),v=this._findCrossPoints(s,p);return v!==0&&v%2===1},isOnScreen:function(s){if(!this.canvas)return!1;var l=this.canvas.vptCoords.tl,u=this.canvas.vptCoords.br,d=this.getCoords(!0,s);return d.some(function(f){return f.x<=u.x&&f.x>=l.x&&f.y<=u.y&&f.y>=l.y})||this.intersectsWithRect(l,u,!0,s)?!0:this._containsCenterOfCanvas(l,u,s)},_containsCenterOfCanvas:function(s,l,u){var d={x:(s.x+l.x)/2,y:(s.y+l.y)/2};return!!this.containsPoint(d,null,!0,u)},isPartiallyOnScreen:function(s){if(!this.canvas)return!1;var l=this.canvas.vptCoords.tl,u=this.canvas.vptCoords.br;if(this.intersectsWithRect(l,u,!0,s))return!0;var d=this.getCoords(!0,s).every(function(f){return(f.x>=u.x||f.x<=l.x)&&(f.y>=u.y||f.y<=l.y)});return d&&this._containsCenterOfCanvas(l,u,s)},_getImageLines:function(s){var l={topline:{o:s.tl,d:s.tr},rightline:{o:s.tr,d:s.br},bottomline:{o:s.br,d:s.bl},leftline:{o:s.bl,d:s.tl}};return l},_findCrossPoints:function(s,l){var u,d,f,p,v,w=0,C;for(var b in l)if(C=l[b],!(C.o.y<s.y&&C.d.y<s.y)&&!(C.o.y>=s.y&&C.d.y>=s.y)&&(C.o.x===C.d.x&&C.o.x>=s.x?v=C.o.x:(u=0,d=(C.d.y-C.o.y)/(C.d.x-C.o.x),f=s.y-u*s.x,p=C.o.y-d*C.o.x,v=-(f-p)/(u-d)),v>=s.x&&(w+=1),w===2))break;return w},getBoundingRect:function(s,l){var u=this.getCoords(s,l);return i.makeBoundingBoxFromPoints(u)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(s){return Math.abs(s)<this.minScaleLimit?s<0?-this.minScaleLimit:this.minScaleLimit:s===0?1e-4:s},scale:function(s){return this._set("scaleX",s),this._set("scaleY",s),this.setCoords()},scaleToWidth:function(s,l){var u=this.getBoundingRect(l).width/this.getScaledWidth();return this.scale(s/this.width/u)},scaleToHeight:function(s,l){var u=this.getBoundingRect(l).height/this.getScaledHeight();return this.scale(s/this.height/u)},calcCoords:function(s){return s?this.calcACoords():this.calcOCoords()},calcLineCoords:function(){var s=this.getViewportTransform(),l=this.padding,u=r(this.angle),d=i.cos(u),f=i.sin(u),p=d*l,v=f*l,w=p+v,C=p-v,b=this.calcACoords(),P={tl:n(b.tl,s),tr:n(b.tr,s),bl:n(b.bl,s),br:n(b.br,s)};return l&&(P.tl.x-=C,P.tl.y-=w,P.tr.x+=w,P.tr.y-=C,P.bl.x-=w,P.bl.y+=C,P.br.x+=C,P.br.y+=w),P},calcOCoords:function(){var s=this._calcRotateMatrix(),l=this._calcTranslateMatrix(),u=this.getViewportTransform(),d=o(u,l),f=o(d,s),f=o(f,[1/u[0],0,0,1/u[3],0,0]),p=this._calculateCurrentDimensions(),v={};return this.forEachControl(function(w,C,b){v[C]=w.positionHandler(p,f,b)}),v},calcACoords:function(){var s=this._calcRotateMatrix(),l=this._calcTranslateMatrix(),u=o(l,s),d=this._getTransformedDimensions(),f=d.x/2,p=d.y/2;return{tl:n({x:-f,y:-p},u),tr:n({x:f,y:-p},u),bl:n({x:-f,y:p},u),br:n({x:f,y:p},u)}},setCoords:function(s){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),s?this:(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords(),this)},_calcRotateMatrix:function(){return i.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var s=this.getCenterPoint();return[1,0,0,1,s.x,s.y]},transformMatrixKey:function(s){var l="_",u="";return!s&&this.group&&(u=this.group.transformMatrixKey(s)+l),u+this.top+l+this.left+l+this.scaleX+l+this.scaleY+l+this.skewX+l+this.skewY+l+this.angle+l+this.originX+l+this.originY+l+this.width+l+this.height+l+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(s){var l=this.calcOwnMatrix();if(s||!this.group)return l;var u=this.transformMatrixKey(s),d=this.matrixCache||(this.matrixCache={});return d.key===u?d.value:(this.group&&(l=o(this.group.calcTransformMatrix(!1),l)),d.key=u,d.value=l,l)},calcOwnMatrix:function(){var s=this.transformMatrixKey(!0),l=this.ownMatrixCache||(this.ownMatrixCache={});if(l.key===s)return l.value;var u=this._calcTranslateMatrix(),d={angle:this.angle,translateX:u[4],translateY:u[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return l.key=s,l.value=i.composeMatrix(d),l.value},_calcDimensionsTransformMatrix:function(s,l,u){return i.calcDimensionsMatrix({skewX:s,skewY:l,scaleX:this.scaleX*(u&&this.flipX?-1:1),scaleY:this.scaleY*(u&&this.flipY?-1:1)})},_getNonTransformedDimensions:function(){var s=this.strokeWidth,l=this.width+s,u=this.height+s;return{x:l,y:u}},_getTransformedDimensions:function(s,l){typeof s=="undefined"&&(s=this.skewX),typeof l=="undefined"&&(l=this.skewY);var u,d,f,p=s===0&&l===0;if(this.strokeUniform?(d=this.width,f=this.height):(u=this._getNonTransformedDimensions(),d=u.x,f=u.y),p)return this._finalizeDimensions(d*this.scaleX,f*this.scaleY);var v=i.sizeAfterTransform(d,f,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:s,skewY:l});return this._finalizeDimensions(v.x,v.y)},_finalizeDimensions:function(s,l){return this.strokeUniform?{x:s+this.strokeWidth,y:l+this.strokeWidth}:{x:s,y:l}},_calculateCurrentDimensions:function(){var s=this.getViewportTransform(),l=this._getTransformedDimensions(),u=n(l,s,!0);return u.scalarAdd(2*this.padding)}})}(),h.util.object.extend(h.Object.prototype,{sendToBack:function(){return this.group?h.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?h.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(a){return this.group?h.StaticCanvas.prototype.sendBackwards.call(this.group,this,a):this.canvas&&this.canvas.sendBackwards(this,a),this},bringForward:function(a){return this.group?h.StaticCanvas.prototype.bringForward.call(this.group,this,a):this.canvas&&this.canvas.bringForward(this,a),this},moveTo:function(a){return this.group&&this.group.type!=="activeSelection"?h.StaticCanvas.prototype.moveTo.call(this.group,this,a):this.canvas&&this.canvas.moveTo(this,a),this}}),function(){function a(r,o){if(o){if(o.toLive)return r+": url(#SVGID_"+o.id+"); ";var n=new h.Color(o),s=r+": "+n.toRgb()+"; ",l=n.getAlpha();return l!==1&&(s+=r+"-opacity: "+l.toString()+"; "),s}else return r+": none; "}var i=h.util.toFixed;h.util.object.extend(h.Object.prototype,{getSvgStyles:function(r){var o=this.fillRule?this.fillRule:"nonzero",n=this.strokeWidth?this.strokeWidth:"0",s=this.strokeDashArray?this.strokeDashArray.join(" "):"none",l=this.strokeDashOffset?this.strokeDashOffset:"0",u=this.strokeLineCap?this.strokeLineCap:"butt",d=this.strokeLineJoin?this.strokeLineJoin:"miter",f=this.strokeMiterLimit?this.strokeMiterLimit:"4",p=typeof this.opacity!="undefined"?this.opacity:"1",v=this.visible?"":" visibility: hidden;",w=r?"":this.getSvgFilter(),C=a("fill",this.fill),b=a("stroke",this.stroke);return[b,"stroke-width: ",n,"; ","stroke-dasharray: ",s,"; ","stroke-linecap: ",u,"; ","stroke-dashoffset: ",l,"; ","stroke-linejoin: ",d,"; ","stroke-miterlimit: ",f,"; ",C,"fill-rule: ",o,"; ","opacity: ",p,";",w,v].join("")},getSvgSpanStyles:function(r,o){var n="; ",l=r.fontFamily?"font-family: "+(r.fontFamily.indexOf("'")===-1&&r.fontFamily.indexOf('"')===-1?"'"+r.fontFamily+"'":r.fontFamily)+n:"",s=r.strokeWidth?"stroke-width: "+r.strokeWidth+n:"",l=l,u=r.fontSize?"font-size: "+r.fontSize+"px"+n:"",d=r.fontStyle?"font-style: "+r.fontStyle+n:"",f=r.fontWeight?"font-weight: "+r.fontWeight+n:"",p=r.fill?a("fill",r.fill):"",v=r.stroke?a("stroke",r.stroke):"",w=this.getSvgTextDecoration(r),C=r.deltaY?"baseline-shift: "+-r.deltaY+"; ":"";return w&&(w="text-decoration: "+w+n),[v,s,l,u,d,f,w,p,C,o?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(r){return["overline","underline","line-through"].filter(function(o){return r[o.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(r,o){var n=r?this.calcTransformMatrix():this.calcOwnMatrix(),s='transform="'+h.util.matrixToSVG(n);return s+(o||"")+'" '},_setSVGBg:function(r){if(this.backgroundColor){var o=h.Object.NUM_FRACTION_DIGITS;r.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',i(-this.width/2,o),'" y="',i(-this.height/2,o),'" width="',i(this.width,o),'" height="',i(this.height,o),`"></rect>
`)}},toSVG:function(r){return this._createBaseSVGMarkup(this._toSVG(r),{reviver:r})},toClipPathSVG:function(r){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(r),{reviver:r})},_createBaseClipPathSVGMarkup:function(r,o){o=o||{};var n=o.reviver,s=o.additionalTransform||"",l=[this.getSvgTransform(!0,s),this.getSvgCommons()].join(""),u=r.indexOf("COMMON_PARTS");return r[u]=l,n?n(r.join("")):r.join("")},_createBaseSVGMarkup:function(r,o){o=o||{};var n=o.noStyle,s=o.reviver,l=n?"":'style="'+this.getSvgStyles()+'" ',u=o.withShadow?'style="'+this.getSvgFilter()+'" ':"",d=this.clipPath,f=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",p=d&&d.absolutePositioned,v=this.stroke,w=this.fill,C=this.shadow,b,P=[],R,A=r.indexOf("COMMON_PARTS"),W=o.additionalTransform;return d&&(d.clipPathId="CLIPPATH_"+h.Object.__uid++,R='<clipPath id="'+d.clipPathId+`" >
`+d.toClipPathSVG(s)+`</clipPath>
`),p&&P.push("<g ",u,this.getSvgCommons(),` >
`),P.push("<g ",this.getSvgTransform(!1),p?"":u+this.getSvgCommons(),` >
`),b=[l,f,n?"":this.addPaintOrder()," ",W?'transform="'+W+'" ':""].join(""),r[A]=b,w&&w.toLive&&P.push(w.toSVG(this)),v&&v.toLive&&P.push(v.toSVG(this)),C&&P.push(C.toSVG(this)),d&&P.push(R),P.push(r.join("")),P.push(`</g>
`),p&&P.push(`</g>
`),s?s(P.join("")):P.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var a=h.util.object.extend,i="stateProperties";function r(n,s,l){var u={},d=!0;l.forEach(function(f){u[f]=n[f]}),a(n[s],u,d)}function o(n,s,l){if(n===s)return!0;if(Array.isArray(n)){if(!Array.isArray(s)||n.length!==s.length)return!1;for(var u=0,d=n.length;u<d;u++)if(!o(n[u],s[u]))return!1;return!0}else if(n&&typeof n=="object"){var f=Object.keys(n),p;if(!s||typeof s!="object"||!l&&f.length!==Object.keys(s).length)return!1;for(var u=0,d=f.length;u<d;u++)if(p=f[u],!(p==="canvas"||p==="group")&&!o(n[p],s[p]))return!1;return!0}}h.util.object.extend(h.Object.prototype,{hasStateChanged:function(n){n=n||i;var s="_"+n;return Object.keys(this[s]).length<this[n].length?!0:!o(this[s],this,!0)},saveState:function(n){var s=n&&n.propertySet||i,l="_"+s;return this[l]?(r(this,l,this[s]),n&&n.stateProperties&&r(this,l,n.stateProperties),this):this.setupState(n)},setupState:function(n){n=n||{};var s=n.propertySet||i;return n.propertySet=s,this["_"+s]={},this.saveState(n),this}})}(),function(){var a=h.util.degreesToRadians;h.util.object.extend(h.Object.prototype,{_findTargetCorner:function(i,r){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var o=i.x,n=i.y,s,l,u=Object.keys(this.oCoords),d=u.length-1,f;for(this.__corner=0;d>=0;d--)if(f=u[d],!!this.isControlVisible(f)&&(l=this._getImageLines(r?this.oCoords[f].touchCorner:this.oCoords[f].corner),s=this._findCrossPoints({x:o,y:n},l),s!==0&&s%2===1))return this.__corner=f,f;return!1},forEachControl:function(i){for(var r in this.controls)i(this.controls[r],r,this)},_setCornerCoords:function(){var i=this.oCoords;for(var r in i){var o=this.controls[r];i[r].corner=o.calcCornerCoords(this.angle,this.cornerSize,i[r].x,i[r].y,!1),i[r].touchCorner=o.calcCornerCoords(this.angle,this.touchCornerSize,i[r].x,i[r].y,!0)}},drawSelectionBackground:function(i){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;i.save();var r=this.getCenterPoint(),o=this._calculateCurrentDimensions(),n=this.canvas.viewportTransform;return i.translate(r.x,r.y),i.scale(1/n[0],1/n[3]),i.rotate(a(this.angle)),i.fillStyle=this.selectionBackgroundColor,i.fillRect(-o.x/2,-o.y/2,o.x,o.y),i.restore(),this},drawBorders:function(i,r){r=r||{};var o=this._calculateCurrentDimensions(),n=this.borderScaleFactor,s=o.x+n,l=o.y+n,u=typeof r.hasControls!="undefined"?r.hasControls:this.hasControls,d=!1;return i.save(),i.strokeStyle=r.borderColor||this.borderColor,this._setLineDash(i,r.borderDashArray||this.borderDashArray),i.strokeRect(-s/2,-l/2,s,l),u&&(i.beginPath(),this.forEachControl(function(f,p,v){f.withConnection&&f.getVisibility(v,p)&&(d=!0,i.moveTo(f.x*s,f.y*l),i.lineTo(f.x*s+f.offsetX,f.y*l+f.offsetY))}),d&&i.stroke()),i.restore(),this},drawBordersInGroup:function(i,r,o){o=o||{};var n=h.util.sizeAfterTransform(this.width,this.height,r),s=this.strokeWidth,l=this.strokeUniform,u=this.borderScaleFactor,d=n.x+s*(l?this.canvas.getZoom():r.scaleX)+u,f=n.y+s*(l?this.canvas.getZoom():r.scaleY)+u;return i.save(),this._setLineDash(i,o.borderDashArray||this.borderDashArray),i.strokeStyle=o.borderColor||this.borderColor,i.strokeRect(-d/2,-f/2,d,f),i.restore(),this},drawControls:function(i,r){r=r||{},i.save();var o=this.canvas.getRetinaScaling(),n,s;return i.setTransform(o,0,0,o,0,0),i.strokeStyle=i.fillStyle=r.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=r.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,r.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(n=this.group.calcTransformMatrix()),this.forEachControl(function(l,u,d){s=d.oCoords[u],l.getVisibility(d,u)&&(n&&(s=h.util.transformPoint(s,n)),l.render(i,s.x,s.y,r,d))}),i.restore(),this},isControlVisible:function(i){return this.controls[i]&&this.controls[i].getVisibility(this,i)},setControlVisible:function(i,r){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[i]=r,this},setControlsVisibility:function(i){i||(i={});for(var r in i)this.setControlVisible(r,i[r]);return this},onDeselect:function(){},onSelect:function(){}})}(),h.util.object.extend(h.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(a,i){i=i||{};var r=function(){},o=i.onComplete||r,n=i.onChange||r,s=this;return h.util.animate({startValue:a.left,endValue:this.getCenter().left,duration:this.FX_DURATION,onChange:function(l){a.set("left",l),s.requestRenderAll(),n()},onComplete:function(){a.setCoords(),o()}}),this},fxCenterObjectV:function(a,i){i=i||{};var r=function(){},o=i.onComplete||r,n=i.onChange||r,s=this;return h.util.animate({startValue:a.top,endValue:this.getCenter().top,duration:this.FX_DURATION,onChange:function(l){a.set("top",l),s.requestRenderAll(),n()},onComplete:function(){a.setCoords(),o()}}),this},fxRemove:function(a,i){i=i||{};var r=function(){},o=i.onComplete||r,n=i.onChange||r,s=this;return h.util.animate({startValue:a.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(l){a.set("opacity",l),s.requestRenderAll(),n()},onComplete:function(){s.remove(a),o()}}),this}}),h.util.object.extend(h.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var a=[],i,r;for(i in arguments[0])a.push(i);for(var o=0,n=a.length;o<n;o++)i=a[o],r=o!==n-1,this._animate(i,arguments[0][i],arguments[1],r)}else this._animate.apply(this,arguments);return this},_animate:function(a,i,r,o){var n=this,s;i=i.toString(),r?r=h.util.object.clone(r):r={},~a.indexOf(".")&&(s=a.split("."));var l=n.colorProperties.indexOf(a)>-1||s&&n.colorProperties.indexOf(s[1])>-1,u=s?this.get(s[0])[s[1]]:this.get(a);"from"in r||(r.from=u),l||(~i.indexOf("=")?i=u+parseFloat(i.replace("=","")):i=parseFloat(i));var d={startValue:r.from,endValue:i,byValue:r.by,easing:r.easing,duration:r.duration,abort:r.abort&&function(f,p,v){return r.abort.call(n,f,p,v)},onChange:function(f,p,v){s?n[s[0]][s[1]]=f:n.set(a,f),!o&&r.onChange&&r.onChange(f,p,v)},onComplete:function(f,p,v){o||(n.setCoords(),r.onComplete&&r.onComplete(f,p,v))}};return l?h.util.animateColor(d.startValue,d.endValue,d.duration,d):h.util.animate(d)}}),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.extend,o=i.util.object.clone,n={x1:1,x2:1,y1:1,y2:1};if(i.Line){i.warn("fabric.Line is already defined");return}i.Line=i.util.createClass(i.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:i.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(l,u){l||(l=[0,0,0,0]),this.callSuper("initialize",u),this.set("x1",l[0]),this.set("y1",l[1]),this.set("x2",l[2]),this.set("y2",l[3]),this._setWidthHeight(u)},_setWidthHeight:function(l){l||(l={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in l?l.left:this._getLeftToOriginX(),this.top="top"in l?l.top:this._getTopToOriginY()},_set:function(l,u){return this.callSuper("_set",l,u),typeof n[l]!="undefined"&&this._setWidthHeight(),this},_getLeftToOriginX:s({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:s({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(l){l.beginPath();var u=this.calcLinePoints();l.moveTo(u.x1,u.y1),l.lineTo(u.x2,u.y2),l.lineWidth=this.strokeWidth;var d=l.strokeStyle;l.strokeStyle=this.stroke||l.fillStyle,this.stroke&&this._renderStroke(l),l.strokeStyle=d},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(l){return r(this.callSuper("toObject",l),this.calcLinePoints())},_getNonTransformedDimensions:function(){var l=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(l.y-=this.strokeWidth),this.height===0&&(l.x-=this.strokeWidth)),l},calcLinePoints:function(){var l=this.x1<=this.x2?-1:1,u=this.y1<=this.y2?-1:1,d=l*this.width*.5,f=u*this.height*.5,p=l*this.width*-.5,v=u*this.height*-.5;return{x1:d,x2:p,y1:f,y2:v}},_toSVG:function(){var l=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',l.x1,'" y1="',l.y1,'" x2="',l.x2,'" y2="',l.y2,`" />
`]}}),i.Line.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),i.Line.fromElement=function(l,u,d){d=d||{};var f=i.parseAttributes(l,i.Line.ATTRIBUTE_NAMES),p=[f.x1||0,f.y1||0,f.x2||0,f.y2||0];u(new i.Line(p,r(f,d)))},i.Line.fromObject=function(l,u){function d(p){delete p.points,u&&u(p)}var f=o(l,!0);f.points=[l.x1,l.y1,l.x2,l.y2],i.Object._fromObject("Line",f,d,"points")};function s(l,u){var d=l.origin,f=l.axis1,p=l.axis2,v=l.dimension,w=u.nearest,C=u.center,b=u.farthest;return function(){switch(this.get(d)){case w:return Math.min(this.get(f),this.get(p));case C:return Math.min(this.get(f),this.get(p))+.5*this.get(v);case b:return Math.max(this.get(f),this.get(p))}}}}(e),function(a){var i=a.fabric||(a.fabric={}),r=Math.PI;if(i.Circle){i.warn("fabric.Circle is already defined.");return}i.Circle=i.util.createClass(i.Object,{type:"circle",radius:0,startAngle:0,endAngle:r*2,cacheProperties:i.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(n,s){return this.callSuper("_set",n,s),n==="radius"&&this.setRadius(s),this},toObject:function(n){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(n))},_toSVG:function(){var n,s=0,l=0,u=(this.endAngle-this.startAngle)%(2*r);if(u===0)n=["<circle ","COMMON_PARTS",'cx="'+s+'" cy="'+l+'" ','r="',this.radius,`" />
`];else{var d=i.util.cos(this.startAngle)*this.radius,f=i.util.sin(this.startAngle)*this.radius,p=i.util.cos(this.endAngle)*this.radius,v=i.util.sin(this.endAngle)*this.radius,w=u>r?"1":"0";n=['<path d="M '+d+" "+f," A "+this.radius+" "+this.radius," 0 ",+w+" 1"," "+p+" "+v,'" ',"COMMON_PARTS",` />
`]}return n},_render:function(n){n.beginPath(),n.arc(0,0,this.radius,this.startAngle,this.endAngle,!1),this._renderPaintInOrder(n)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(n){return this.radius=n,this.set("width",n*2).set("height",n*2)}}),i.Circle.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),i.Circle.fromElement=function(n,s){var l=i.parseAttributes(n,i.Circle.ATTRIBUTE_NAMES);if(!o(l))throw new Error("value of `r` attribute is required and can not be negative");l.left=(l.left||0)-l.radius,l.top=(l.top||0)-l.radius,s(new i.Circle(l))};function o(n){return"radius"in n&&n.radius>=0}i.Circle.fromObject=function(n,s){i.Object._fromObject("Circle",n,s)}}(e),function(a){var i=a.fabric||(a.fabric={});if(i.Triangle){i.warn("fabric.Triangle is already defined");return}i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(r){var o=this.width/2,n=this.height/2;r.beginPath(),r.moveTo(-o,n),r.lineTo(0,-n),r.lineTo(o,n),r.closePath(),this._renderPaintInOrder(r)},_toSVG:function(){var r=this.width/2,o=this.height/2,n=[-r+" "+o,"0 "+-o,r+" "+o].join(",");return["<polygon ","COMMON_PARTS",'points="',n,'" />']}}),i.Triangle.fromObject=function(r,o){return i.Object._fromObject("Triangle",r,o)}}(e),function(a){var i=a.fabric||(a.fabric={}),r=Math.PI*2;if(i.Ellipse){i.warn("fabric.Ellipse is already defined.");return}i.Ellipse=i.util.createClass(i.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(o){this.callSuper("initialize",o),this.set("rx",o&&o.rx||0),this.set("ry",o&&o.ry||0)},_set:function(o,n){switch(this.callSuper("_set",o,n),o){case"rx":this.rx=n,this.set("width",n*2);break;case"ry":this.ry=n,this.set("height",n*2);break}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(o){return this.callSuper("toObject",["rx","ry"].concat(o))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(o){o.beginPath(),o.save(),o.transform(1,0,0,this.ry/this.rx,0,0),o.arc(0,0,this.rx,0,r,!1),o.restore(),this._renderPaintInOrder(o)}}),i.Ellipse.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),i.Ellipse.fromElement=function(o,n){var s=i.parseAttributes(o,i.Ellipse.ATTRIBUTE_NAMES);s.left=(s.left||0)-s.rx,s.top=(s.top||0)-s.ry,n(new i.Ellipse(s))},i.Ellipse.fromObject=function(o,n){i.Object._fromObject("Ellipse",o,n)}}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.extend;if(i.Rect){i.warn("fabric.Rect is already defined");return}i.Rect=i.util.createClass(i.Object,{stateProperties:i.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(o){this.callSuper("initialize",o),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(o){var n=this.rx?Math.min(this.rx,this.width/2):0,s=this.ry?Math.min(this.ry,this.height/2):0,l=this.width,u=this.height,d=-this.width/2,f=-this.height/2,p=n!==0||s!==0,v=1-.5522847498;o.beginPath(),o.moveTo(d+n,f),o.lineTo(d+l-n,f),p&&o.bezierCurveTo(d+l-v*n,f,d+l,f+v*s,d+l,f+s),o.lineTo(d+l,f+u-s),p&&o.bezierCurveTo(d+l,f+u-v*s,d+l-v*n,f+u,d+l-n,f+u),o.lineTo(d+n,f+u),p&&o.bezierCurveTo(d+v*n,f+u,d,f+u-v*s,d,f+u-s),o.lineTo(d,f+s),p&&o.bezierCurveTo(d,f+v*s,d+v*n,f,d+n,f),o.closePath(),this._renderPaintInOrder(o)},toObject:function(o){return this.callSuper("toObject",["rx","ry"].concat(o))},_toSVG:function(){var o=-this.width/2,n=-this.height/2;return["<rect ","COMMON_PARTS",'x="',o,'" y="',n,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),i.Rect.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),i.Rect.fromElement=function(o,n,s){if(!o)return n(null);s=s||{};var l=i.parseAttributes(o,i.Rect.ATTRIBUTE_NAMES);l.left=l.left||0,l.top=l.top||0,l.height=l.height||0,l.width=l.width||0;var u=new i.Rect(r(s?i.util.object.clone(s):{},l));u.visible=u.visible&&u.width>0&&u.height>0,n(u)},i.Rect.fromObject=function(o,n){return i.Object._fromObject("Rect",o,n)}}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.extend,o=i.util.array.min,n=i.util.array.max,s=i.util.toFixed;if(i.Polyline){i.warn("fabric.Polyline is already defined");return}i.Polyline=i.util.createClass(i.Object,{type:"polyline",points:null,cacheProperties:i.Object.prototype.cacheProperties.concat("points"),initialize:function(l,u){u=u||{},this.points=l||[],this.callSuper("initialize",u),this._setPositionDimensions(u)},_setPositionDimensions:function(l){var u=this._calcDimensions(l),d;this.width=u.width,this.height=u.height,l.fromSVG||(d=this.translateToGivenOrigin({x:u.left-this.strokeWidth/2,y:u.top-this.strokeWidth/2},"left","top",this.originX,this.originY)),typeof l.left=="undefined"&&(this.left=l.fromSVG?u.left:d.x),typeof l.top=="undefined"&&(this.top=l.fromSVG?u.top:d.y),this.pathOffset={x:u.left+this.width/2,y:u.top+this.height/2}},_calcDimensions:function(){var l=this.points,u=o(l,"x")||0,d=o(l,"y")||0,f=n(l,"x")||0,p=n(l,"y")||0,v=f-u,w=p-d;return{left:u,top:d,width:v,height:w}},toObject:function(l){return r(this.callSuper("toObject",l),{points:this.points.concat()})},_toSVG:function(){for(var l=[],u=this.pathOffset.x,d=this.pathOffset.y,f=i.Object.NUM_FRACTION_DIGITS,p=0,v=this.points.length;p<v;p++)l.push(s(this.points[p].x-u,f),",",s(this.points[p].y-d,f)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',l.join(""),`" />
`]},commonRender:function(l){var u,d=this.points.length,f=this.pathOffset.x,p=this.pathOffset.y;if(!d||isNaN(this.points[d-1].y))return!1;l.beginPath(),l.moveTo(this.points[0].x-f,this.points[0].y-p);for(var v=0;v<d;v++)u=this.points[v],l.lineTo(u.x-f,u.y-p);return!0},_render:function(l){!this.commonRender(l)||this._renderPaintInOrder(l)},complexity:function(){return this.get("points").length}}),i.Polyline.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polyline.fromElementGenerator=function(l){return function(u,d,f){if(!u)return d(null);f||(f={});var p=i.parsePointsAttribute(u.getAttribute("points")),v=i.parseAttributes(u,i[l].ATTRIBUTE_NAMES);v.fromSVG=!0,d(new i[l](p,r(v,f)))}},i.Polyline.fromElement=i.Polyline.fromElementGenerator("Polyline"),i.Polyline.fromObject=function(l,u){return i.Object._fromObject("Polyline",l,u,"points")}}(e),function(a){var i=a.fabric||(a.fabric={});if(i.Polygon){i.warn("fabric.Polygon is already defined");return}i.Polygon=i.util.createClass(i.Polyline,{type:"polygon",_render:function(r){!this.commonRender(r)||(r.closePath(),this._renderPaintInOrder(r))}}),i.Polygon.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polygon.fromElement=i.Polyline.fromElementGenerator("Polygon"),i.Polygon.fromObject=function(r,o){i.Object._fromObject("Polygon",r,o,"points")}}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.array.min,o=i.util.array.max,n=i.util.object.extend,s=Object.prototype.toString,l=i.util.toFixed;if(i.Path){i.warn("fabric.Path is already defined");return}i.Path=i.util.createClass(i.Object,{type:"path",path:null,cacheProperties:i.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:i.Object.prototype.stateProperties.concat("path"),initialize:function(u,d){d=d||{},this.callSuper("initialize",d),u||(u=[]);var f=s.call(u)==="[object Array]";this.path=i.util.makePathSimpler(f?u:i.util.parsePath(u)),this.path&&i.Polyline.prototype._setPositionDimensions.call(this,d)},_renderPathCommands:function(u){var d,f=0,p=0,v=0,w=0,C=0,b=0,P=-this.pathOffset.x,R=-this.pathOffset.y;u.beginPath();for(var A=0,W=this.path.length;A<W;++A)switch(d=this.path[A],d[0]){case"L":v=d[1],w=d[2],u.lineTo(v+P,w+R);break;case"M":v=d[1],w=d[2],f=v,p=w,u.moveTo(v+P,w+R);break;case"C":v=d[5],w=d[6],C=d[3],b=d[4],u.bezierCurveTo(d[1]+P,d[2]+R,C+P,b+R,v+P,w+R);break;case"Q":u.quadraticCurveTo(d[1]+P,d[2]+R,d[3]+P,d[4]+R),v=d[3],w=d[4],C=d[1],b=d[2];break;case"z":case"Z":v=f,w=p,u.closePath();break}},_render:function(u){this._renderPathCommands(u),this._renderPaintInOrder(u)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(u){return n(this.callSuper("toObject",u),{path:this.path.map(function(d){return d.slice()})})},toDatalessObject:function(u){var d=this.toObject(["sourcePath"].concat(u));return d.sourcePath&&delete d.path,d},_toSVG:function(){var u=i.util.joinPath(this.path);return["<path ","COMMON_PARTS",'d="',u,'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var u=i.Object.NUM_FRACTION_DIGITS;return" translate("+l(-this.pathOffset.x,u)+", "+l(-this.pathOffset.y,u)+")"},toClipPathSVG:function(u){var d=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:u,additionalTransform:d})},toSVG:function(u){var d=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:u,additionalTransform:d})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var u=[],d=[],f,p=0,v=0,w=0,C=0,b,P=0,R=this.path.length;P<R;++P){switch(f=this.path[P],f[0]){case"L":w=f[1],C=f[2],b=[];break;case"M":w=f[1],C=f[2],p=w,v=C,b=[];break;case"C":b=i.util.getBoundsOfCurve(w,C,f[1],f[2],f[3],f[4],f[5],f[6]),w=f[5],C=f[6];break;case"Q":b=i.util.getBoundsOfCurve(w,C,f[1],f[2],f[1],f[2],f[3],f[4]),w=f[3],C=f[4];break;case"z":case"Z":w=p,C=v;break}b.forEach(function(ne){u.push(ne.x),d.push(ne.y)}),u.push(w),d.push(C)}var A=r(u)||0,W=r(d)||0,$=o(u)||0,X=o(d)||0,re=$-A,he=X-W;return{left:A,top:W,width:re,height:he}}}),i.Path.fromObject=function(u,d){if(typeof u.sourcePath=="string"){var f=u.sourcePath;i.loadSVGFromURL(f,function(p){var v=p[0];v.setOptions(u),d&&d(v)})}else i.Object._fromObject("Path",u,d,"path")},i.Path.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(["d"]),i.Path.fromElement=function(u,d,f){var p=i.parseAttributes(u,i.Path.ATTRIBUTE_NAMES);p.fromSVG=!0,d(new i.Path(p.d,n(p,f)))}}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.array.min,o=i.util.array.max;i.Group||(i.Group=i.util.createClass(i.Object,i.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(n,s,l){s=s||{},this._objects=[],l&&this.callSuper("initialize",s),this._objects=n||[];for(var u=this._objects.length;u--;)this._objects[u].group=this;if(l)this._updateObjectsACoords();else{var d=s&&s.centerPoint;s.originX!==void 0&&(this.originX=s.originX),s.originY!==void 0&&(this.originY=s.originY),d||this._calcBounds(),this._updateObjectsCoords(d),delete s.centerPoint,this.callSuper("initialize",s)}this.setCoords()},_updateObjectsACoords:function(){for(var n=!0,s=this._objects.length;s--;)this._objects[s].setCoords(n)},_updateObjectsCoords:function(s){for(var s=s||this.getCenterPoint(),l=this._objects.length;l--;)this._updateObjectCoords(this._objects[l],s)},_updateObjectCoords:function(n,s){var l=n.left,u=n.top,d=!0;n.set({left:l-s.x,top:u-s.y}),n.group=this,n.setCoords(d)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(n){var s=!!this.group;return this._restoreObjectsState(),i.util.resetObjectTransform(this),n&&(s&&i.util.removeTransformFromObject(n,this.group.calcTransformMatrix()),this._objects.push(n),n.group=this,n._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,s?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(n){return this._restoreObjectsState(),i.util.resetObjectTransform(this),this.remove(n),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(n){this.dirty=!0,n.group=this,n._set("canvas",this.canvas)},_onObjectRemoved:function(n){this.dirty=!0,delete n.group},_set:function(n,s){var l=this._objects.length;if(this.useSetOnGroup)for(;l--;)this._objects[l].setOnGroup(n,s);if(n==="canvas")for(;l--;)this._objects[l]._set(n,s);i.Object.prototype._set.call(this,n,s)},toObject:function(n){var s=this.includeDefaultValues,l=this._objects.filter(function(d){return!d.excludeFromExport}).map(function(d){var f=d.includeDefaultValues;d.includeDefaultValues=s;var p=d.toObject(n);return d.includeDefaultValues=f,p}),u=i.Object.prototype.toObject.call(this,n);return u.objects=l,u},toDatalessObject:function(n){var s,l=this.sourcePath;if(l)s=l;else{var u=this.includeDefaultValues;s=this._objects.map(function(f){var p=f.includeDefaultValues;f.includeDefaultValues=u;var v=f.toDatalessObject(n);return f.includeDefaultValues=p,v})}var d=i.Object.prototype.toDatalessObject.call(this,n);return d.objects=s,d},render:function(n){this._transformDone=!0,this.callSuper("render",n),this._transformDone=!1},shouldCache:function(){var n=i.Object.prototype.shouldCache.call(this);if(n){for(var s=0,l=this._objects.length;s<l;s++)if(this._objects[s].willDrawShadow())return this.ownCaching=!1,!1}return n},willDrawShadow:function(){if(i.Object.prototype.willDrawShadow.call(this))return!0;for(var n=0,s=this._objects.length;n<s;n++)if(this._objects[n].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(n){for(var s=0,l=this._objects.length;s<l;s++)this._objects[s].render(n);this._drawClipPath(n)},isCacheDirty:function(n){if(this.callSuper("isCacheDirty",n))return!0;if(!this.statefullCache)return!1;for(var s=0,l=this._objects.length;s<l;s++)if(this._objects[s].isCacheDirty(!0)){if(this._cacheCanvas){var u=this.cacheWidth/this.zoomX,d=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-u/2,-d/2,u,d)}return!0}return!1},_restoreObjectsState:function(){var n=this.calcOwnMatrix();return this._objects.forEach(function(s){i.util.addTransformToObject(s,n),delete s.group,s.setCoords()}),this},realizeTransform:function(n,s){return i.util.addTransformToObject(n,s),n},destroy:function(){return this._objects.forEach(function(n){n.set("dirty",!0)}),this._restoreObjectsState()},toActiveSelection:function(){if(!!this.canvas){var n=this._objects,s=this.canvas;this._objects=[];var l=this.toObject();delete l.objects;var u=new i.ActiveSelection([]);return u.set(l),u.type="activeSelection",s.remove(this),n.forEach(function(d){d.group=u,d.dirty=!0,s.add(d)}),u.canvas=s,u._objects=n,s._activeObject=u,u.setCoords(),u}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){var n=!0;return this.forEachObject(function(s){s.setCoords(n)}),this},_calcBounds:function(n){for(var s=[],l=[],u,d,f,p=["tr","br","bl","tl"],v=0,w=this._objects.length,C,b=p.length;v<w;++v){for(u=this._objects[v],f=u.calcACoords(),C=0;C<b;C++)d=p[C],s.push(f[d].x),l.push(f[d].y);u.aCoords=f}this._getBounds(s,l,n)},_getBounds:function(n,s,l){var u=new i.Point(r(n),r(s)),d=new i.Point(o(n),o(s)),f=u.y||0,p=u.x||0,v=d.x-u.x||0,w=d.y-u.y||0;this.width=v,this.height=w,l||this.setPositionByOrigin({x:p,y:f},"left","top")},_toSVG:function(n){for(var s=["<g ","COMMON_PARTS",` >
`],l=0,u=this._objects.length;l<u;l++)s.push("		",this._objects[l].toSVG(n));return s.push(`</g>
`),s},getSvgStyles:function(){var n=typeof this.opacity!="undefined"&&this.opacity!==1?"opacity: "+this.opacity+";":"",s=this.visible?"":" visibility: hidden;";return[n,this.getSvgFilter(),s].join("")},toClipPathSVG:function(n){for(var s=[],l=0,u=this._objects.length;l<u;l++)s.push("	",this._objects[l].toClipPathSVG(n));return this._createBaseClipPathSVGMarkup(s,{reviver:n})}}),i.Group.fromObject=function(n,s){var l=n.objects,u=i.util.object.clone(n,!0);if(delete u.objects,typeof l=="string"){i.loadSVGFromURL(l,function(d){var f=i.util.groupSVGElements(d,n,l);f.set(u),s&&s(f)});return}i.util.enlivenObjects(l,function(d){i.util.enlivenObjects([n.clipPath],function(f){var p=i.util.object.clone(n,!0);p.clipPath=f[0],delete p.objects,s&&s(new i.Group(d,p,!0))})})})}(e),function(a){var i=a.fabric||(a.fabric={});i.ActiveSelection||(i.ActiveSelection=i.util.createClass(i.Group,{type:"activeSelection",initialize:function(r,o){o=o||{},this._objects=r||[];for(var n=this._objects.length;n--;)this._objects[n].group=this;o.originX&&(this.originX=o.originX),o.originY&&(this.originY=o.originY),this._calcBounds(),this._updateObjectsCoords(),i.Object.prototype.initialize.call(this,o),this.setCoords()},toGroup:function(){var r=this._objects.concat();this._objects=[];var o=i.Object.prototype.toObject.call(this),n=new i.Group([]);if(delete o.type,n.set(o),r.forEach(function(l){l.canvas.remove(l),l.group=n}),n._objects=r,!this.canvas)return n;var s=this.canvas;return s.add(n),s._activeObject=n,n.setCoords(),n},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(r,o,n){r.save(),r.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",r,o),n=n||{},typeof n.hasControls=="undefined"&&(n.hasControls=!1),n.forActiveSelection=!0;for(var s=0,l=this._objects.length;s<l;s++)this._objects[s]._renderControls(r,n);r.restore()}}),i.ActiveSelection.fromObject=function(r,o){i.util.enlivenObjects(r.objects,function(n){delete r.objects,o&&o(new i.ActiveSelection(n,r,!0))})})}(e),function(a){var i=h.util.object.extend;if(a.fabric||(a.fabric={}),a.fabric.Image){h.warn("fabric.Image is already defined.");return}h.Image=h.util.createClass(h.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:h.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:h.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(r,o){o||(o={}),this.filters=[],this.cacheKey="texture"+h.Object.__uid++,this.callSuper("initialize",o),this._initElement(r,o)},getElement:function(){return this._element||{}},setElement:function(r,o){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=r,this._originalElement=r,this._initConfig(o),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(r){var o=h.filterBackend;o&&o.evictCachesForKey&&o.evictCachesForKey(r)},dispose:function(){this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(function(r){h.util.cleanUpJsdomNode(this[r]),this[r]=void 0}.bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var r=this.getElement();return{width:r.naturalWidth||r.width,height:r.naturalHeight||r.height}},_stroke:function(r){if(!(!this.stroke||this.strokeWidth===0)){var o=this.width/2,n=this.height/2;r.beginPath(),r.moveTo(-o,-n),r.lineTo(o,-n),r.lineTo(o,n),r.lineTo(-o,n),r.lineTo(-o,-n),r.closePath()}},toObject:function(r){var o=[];this.filters.forEach(function(s){s&&o.push(s.toObject())});var n=i(this.callSuper("toObject",["cropX","cropY"].concat(r)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:o});return this.resizeFilter&&(n.resizeFilter=this.resizeFilter.toObject()),n},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var r=[],o=[],n,s=this._element,l=-this.width/2,u=-this.height/2,d="",f="";if(!s)return[];if(this.hasCrop()){var p=h.Object.__uid++;r.push('<clipPath id="imageCrop_'+p+`">
`,'	<rect x="'+l+'" y="'+u+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),d=' clip-path="url(#imageCrop_'+p+')" '}if(this.imageSmoothing||(f='" image-rendering="optimizeSpeed'),o.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',l-this.cropX,'" y="',u-this.cropY,'" width="',s.width||s.naturalWidth,'" height="',s.height||s.height,f,'"',d,`></image>
`),this.stroke||this.strokeDashArray){var v=this.fill;this.fill=null,n=["	<rect ",'x="',l,'" y="',u,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=v}return this.paintFirst!=="fill"?r=r.concat(n,o):r=r.concat(o,n),r},getSrc:function(r){var o=r?this._element:this._originalElement;return o?o.toDataURL?o.toDataURL():this.srcFromAttribute?o.getAttribute("src"):o.src:this.src||""},setSrc:function(r,o,n){return h.util.loadImage(r,function(s,l){this.setElement(s,n),this._setWidthHeight(),o&&o(this,l)},this,n&&n.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var r=this.resizeFilter,o=this.minimumScaleTrigger,n=this.getTotalObjectScaling(),s=n.scaleX,l=n.scaleY,u=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!r||s>o&&l>o){this._element=u,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=s,this._lastScaleY=l;return}h.filterBackend||(h.filterBackend=h.initFilterBackend());var d=h.util.createCanvasElement(),f=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,p=u.width,v=u.height;d.width=p,d.height=v,this._element=d,this._lastScaleX=r.scaleX=s,this._lastScaleY=r.scaleY=l,h.filterBackend.applyFilters([r],u,p,v,this._element,f),this._filterScalingX=d.width/this._originalElement.width,this._filterScalingY=d.height/this._originalElement.height},applyFilters:function(r){if(r=r||this.filters||[],r=r.filter(function(u){return u&&!u.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),r.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var o=this._originalElement,n=o.naturalWidth||o.width,s=o.naturalHeight||o.height;if(this._element===this._originalElement){var l=h.util.createCanvasElement();l.width=n,l.height=s,this._element=l,this._filteredEl=l}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,n,s),this._lastScaleX=1,this._lastScaleY=1;return h.filterBackend||(h.filterBackend=h.initFilterBackend()),h.filterBackend.applyFilters(r,this._originalElement,n,s,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(r){h.util.setImageSmoothing(r,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(r),this._renderPaintInOrder(r)},drawCacheOnCanvas:function(r){h.util.setImageSmoothing(r,this.imageSmoothing),h.Object.prototype.drawCacheOnCanvas.call(this,r)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(r){var o=this._element;if(!!o){var n=this._filterScalingX,s=this._filterScalingY,l=this.width,u=this.height,d=Math.min,f=Math.max,p=f(this.cropX,0),v=f(this.cropY,0),w=o.naturalWidth||o.width,C=o.naturalHeight||o.height,b=p*n,P=v*s,R=d(l*n,w-b),A=d(u*s,C-P),W=-l/2,$=-u/2,X=d(l,w/n-p),re=d(u,C/s-v);o&&r.drawImage(o,b,P,R,A,W,$,X,re)}},_needsResize:function(){var r=this.getTotalObjectScaling();return r.scaleX!==this._lastScaleX||r.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(r,o){this.setElement(h.util.getById(r),o),h.util.addClass(this.getElement(),h.Image.CSS_CANVAS)},_initConfig:function(r){r||(r={}),this.setOptions(r),this._setWidthHeight(r)},_initFilters:function(r,o){r&&r.length?h.util.enlivenObjects(r,function(n){o&&o(n)},"fabric.Image.filters"):o&&o()},_setWidthHeight:function(r){r||(r={});var o=this.getElement();this.width=r.width||o.naturalWidth||o.width||0,this.height=r.height||o.naturalHeight||o.height||0},parsePreserveAspectRatioAttribute:function(){var r=h.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),o=this._element.width,n=this._element.height,s=1,l=1,u=0,d=0,f=0,p=0,v,w=this.width,C=this.height,b={width:w,height:C};return r&&(r.alignX!=="none"||r.alignY!=="none")?(r.meetOrSlice==="meet"&&(s=l=h.util.findScaleToFit(this._element,b),v=(w-o*s)/2,r.alignX==="Min"&&(u=-v),r.alignX==="Max"&&(u=v),v=(C-n*l)/2,r.alignY==="Min"&&(d=-v),r.alignY==="Max"&&(d=v)),r.meetOrSlice==="slice"&&(s=l=h.util.findScaleToCover(this._element,b),v=o-w/s,r.alignX==="Mid"&&(f=v/2),r.alignX==="Max"&&(f=v),v=n-C/l,r.alignY==="Mid"&&(p=v/2),r.alignY==="Max"&&(p=v),o=w/s,n=C/l)):(s=w/o,l=C/n),{width:o,height:n,scaleX:s,scaleY:l,offsetLeft:u,offsetTop:d,cropX:f,cropY:p}}}),h.Image.CSS_CANVAS="canvas-img",h.Image.prototype.getSvgSrc=h.Image.prototype.getSrc,h.Image.fromObject=function(r,o){var n=h.util.object.clone(r);h.util.loadImage(n.src,function(s,l){if(l){o&&o(null,!0);return}h.Image.prototype._initFilters.call(n,n.filters,function(u){n.filters=u||[],h.Image.prototype._initFilters.call(n,[n.resizeFilter],function(d){n.resizeFilter=d[0],h.util.enlivenObjects([n.clipPath],function(f){n.clipPath=f[0];var p=new h.Image(s,n);o(p,!1)})})})},null,n.crossOrigin)},h.Image.fromURL=function(r,o,n){h.util.loadImage(r,function(s,l){o&&o(new h.Image(s,n),l)},null,n&&n.crossOrigin)},h.Image.ATTRIBUTE_NAMES=h.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),h.Image.fromElement=function(r,o,n){var s=h.parseAttributes(r,h.Image.ATTRIBUTE_NAMES);h.Image.fromURL(s["xlink:href"],o,i(n?h.util.object.clone(n):{},s))}}(e),h.util.object.extend(h.Object.prototype,{_getAngleValueForStraighten:function(){var a=this.angle%360;return a>0?Math.round((a-1)/90)*90:Math.round(a/90)*90},straighten:function(){return this.rotate(this._getAngleValueForStraighten()),this},fxStraighten:function(a){a=a||{};var i=function(){},r=a.onComplete||i,o=a.onChange||i,n=this;return h.util.animate({startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(s){n.rotate(s),o()},onComplete:function(){n.setCoords(),r()}}),this}}),h.util.object.extend(h.StaticCanvas.prototype,{straightenObject:function(a){return a.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(a){return a.fxStraighten({onChange:this.requestRenderAllBound}),this}}),function(){function a(r,o){var n="precision "+o+` float;
void main(){}`,s=r.createShader(r.FRAGMENT_SHADER);return r.shaderSource(s,n),r.compileShader(s),!!r.getShaderParameter(s,r.COMPILE_STATUS)}h.isWebglSupported=function(r){if(h.isLikelyNode)return!1;r=r||h.WebglFilterBackend.prototype.tileSize;var o=document.createElement("canvas"),n=o.getContext("webgl")||o.getContext("experimental-webgl"),s=!1;if(n){h.maxTextureSize=n.getParameter(n.MAX_TEXTURE_SIZE),s=h.maxTextureSize>=r;for(var l=["highp","mediump","lowp"],u=0;u<3;u++)if(a(n,l[u])){h.webGlPrecision=l[u];break}}return this.isSupported=s,s},h.WebglFilterBackend=i;function i(r){r&&r.tileSize&&(this.tileSize=r.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}i.prototype={tileSize:2048,resources:{},setupGLContext:function(r,o){this.dispose(),this.createWebGLCanvas(r,o),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(r,o)},chooseFastestCopyGLTo2DMethod:function(r,o){var n=typeof window.performance!="undefined",s;try{new ImageData(1,1),s=!0}catch{s=!1}var l=typeof ArrayBuffer!="undefined",u=typeof Uint8ClampedArray!="undefined";if(!!(n&&s&&l&&u)){var d=h.util.createCanvasElement(),f=new ArrayBuffer(r*o*4);if(h.forceGLPutImageData){this.imageBuffer=f,this.copyGLTo2D=y;return}var p={imageBuffer:f,destinationWidth:r,destinationHeight:o,targetCanvas:d},v,w,C;d.width=r,d.height=o,v=window.performance.now(),m.call(p,this.gl,p),w=window.performance.now()-v,v=window.performance.now(),y.call(p,this.gl,p),C=window.performance.now()-v,w>C?(this.imageBuffer=f,this.copyGLTo2D=y):this.copyGLTo2D=m}},createWebGLCanvas:function(r,o){var n=h.util.createCanvasElement();n.width=r,n.height=o;var s={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},l=n.getContext("webgl",s);l||(l=n.getContext("experimental-webgl",s)),l&&(l.clearColor(0,0,0,0),this.canvas=n,this.gl=l)},applyFilters:function(r,o,n,s,l,u){var d=this.gl,f;u&&(f=this.getCachedTexture(u,o));var p={originalWidth:o.width||o.originalWidth,originalHeight:o.height||o.originalHeight,sourceWidth:n,sourceHeight:s,destinationWidth:n,destinationHeight:s,context:d,sourceTexture:this.createTexture(d,n,s,!f&&o),targetTexture:this.createTexture(d,n,s),originalTexture:f||this.createTexture(d,n,s,!f&&o),passes:r.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:l},v=d.createFramebuffer();return d.bindFramebuffer(d.FRAMEBUFFER,v),r.forEach(function(w){w&&w.applyTo(p)}),g(p),this.copyGLTo2D(d,p),d.bindTexture(d.TEXTURE_2D,null),d.deleteTexture(p.sourceTexture),d.deleteTexture(p.targetTexture),d.deleteFramebuffer(v),l.getContext("2d").setTransform(1,0,0,1,0,0),p},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(r,o,n,s){var l=r.createTexture();return r.bindTexture(r.TEXTURE_2D,l),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),s?r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,s):r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,n,0,r.RGBA,r.UNSIGNED_BYTE,null),l},getCachedTexture:function(r,o){if(this.textureCache[r])return this.textureCache[r];var n=this.createTexture(this.gl,o.width,o.height,o);return this.textureCache[r]=n,n},evictCachesForKey:function(r){this.textureCache[r]&&(this.gl.deleteTexture(this.textureCache[r]),delete this.textureCache[r])},copyGLTo2D:m,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var r=this.gl,o={renderer:"",vendor:""};if(!r)return o;var n=r.getExtension("WEBGL_debug_renderer_info");if(n){var s=r.getParameter(n.UNMASKED_RENDERER_WEBGL),l=r.getParameter(n.UNMASKED_VENDOR_WEBGL);s&&(o.renderer=s.toLowerCase()),l&&(o.vendor=l.toLowerCase())}return this.gpuInfo=o,o}}}();function g(a){var i=a.targetCanvas,r=i.width,o=i.height,n=a.destinationWidth,s=a.destinationHeight;(r!==n||o!==s)&&(i.width=n,i.height=s)}function m(a,i){var r=a.canvas,o=i.targetCanvas,n=o.getContext("2d");n.translate(0,o.height),n.scale(1,-1);var s=r.height-o.height;n.drawImage(r,0,s,o.width,o.height,0,0,o.width,o.height)}function y(a,i){var r=i.targetCanvas,o=r.getContext("2d"),n=i.destinationWidth,s=i.destinationHeight,l=n*s*4,u=new Uint8Array(this.imageBuffer,0,l),d=new Uint8ClampedArray(this.imageBuffer,0,l);a.readPixels(0,0,n,s,a.RGBA,a.UNSIGNED_BYTE,u);var f=new ImageData(d,n,s);o.putImageData(f,0,0)}(function(){var a=function(){};h.Canvas2dFilterBackend=i;function i(){}i.prototype={evictCachesForKey:a,dispose:a,clearWebGLCaches:a,resources:{},applyFilters:function(r,o,n,s,l){var u=l.getContext("2d");u.drawImage(o,0,0,n,s);var d=u.getImageData(0,0,n,s),f=u.getImageData(0,0,n,s),p={sourceWidth:n,sourceHeight:s,imageData:d,originalEl:o,originalImageData:f,canvasEl:l,ctx:u,filterBackend:this};return r.forEach(function(v){v.applyTo(p)}),(p.imageData.width!==n||p.imageData.height!==s)&&(l.width=p.imageData.width,l.height=p.imageData.height),u.putImageData(p.imageData,0,0),p}}})(),h.Image=h.Image||{},h.Image.filters=h.Image.filters||{},h.Image.filters.BaseFilter=h.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(a){a&&this.setOptions(a)},setOptions:function(a){for(var i in a)this[i]=a[i]},createProgram:function(a,i,r){i=i||this.fragmentSource,r=r||this.vertexSource,h.webGlPrecision!=="highp"&&(i=i.replace(/precision highp float/g,"precision "+h.webGlPrecision+" float"));var o=a.createShader(a.VERTEX_SHADER);if(a.shaderSource(o,r),a.compileShader(o),!a.getShaderParameter(o,a.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+a.getShaderInfoLog(o));var n=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(n,i),a.compileShader(n),!a.getShaderParameter(n,a.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+a.getShaderInfoLog(n));var s=a.createProgram();if(a.attachShader(s,o),a.attachShader(s,n),a.linkProgram(s),!a.getProgramParameter(s,a.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+a.getProgramInfoLog(s));var l=this.getAttributeLocations(a,s),u=this.getUniformLocations(a,s)||{};return u.uStepW=a.getUniformLocation(s,"uStepW"),u.uStepH=a.getUniformLocation(s,"uStepH"),{program:s,attributeLocations:l,uniformLocations:u}},getAttributeLocations:function(a,i){return{aPosition:a.getAttribLocation(i,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(a,i,r){var o=i.aPosition,n=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,n),a.enableVertexAttribArray(o),a.vertexAttribPointer(o,2,a.FLOAT,!1,0,0),a.bufferData(a.ARRAY_BUFFER,r,a.STATIC_DRAW)},_setupFrameBuffer:function(a){var i=a.context,r,o;a.passes>1?(r=a.destinationWidth,o=a.destinationHeight,(a.sourceWidth!==r||a.sourceHeight!==o)&&(i.deleteTexture(a.targetTexture),a.targetTexture=a.filterBackend.createTexture(i,r,o)),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,a.targetTexture,0)):(i.bindFramebuffer(i.FRAMEBUFFER,null),i.finish())},_swapTextures:function(a){a.passes--,a.pass++;var i=a.targetTexture;a.targetTexture=a.sourceTexture,a.sourceTexture=i},isNeutralState:function(){var a=this.mainParameter,i=h.Image.filters[this.type].prototype;if(a)if(Array.isArray(i[a])){for(var r=i[a].length;r--;)if(this[a][r]!==i[a][r])return!1;return!0}else return i[a]===this[a];else return!1},applyTo:function(a){a.webgl?(this._setupFrameBuffer(a),this.applyToWebGL(a),this._swapTextures(a)):this.applyTo2d(a)},retrieveShader:function(a){return a.programCache.hasOwnProperty(this.type)||(a.programCache[this.type]=this.createProgram(a.context)),a.programCache[this.type]},applyToWebGL:function(a){var i=a.context,r=this.retrieveShader(a);a.pass===0&&a.originalTexture?i.bindTexture(i.TEXTURE_2D,a.originalTexture):i.bindTexture(i.TEXTURE_2D,a.sourceTexture),i.useProgram(r.program),this.sendAttributeData(i,r.attributeLocations,a.aPosition),i.uniform1f(r.uniformLocations.uStepW,1/a.sourceWidth),i.uniform1f(r.uniformLocations.uStepH,1/a.sourceHeight),this.sendUniformData(i,r.uniformLocations),i.viewport(0,0,a.destinationWidth,a.destinationHeight),i.drawArrays(i.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(a,i,r){a.activeTexture(r),a.bindTexture(a.TEXTURE_2D,i),a.activeTexture(a.TEXTURE0)},unbindAdditionalTexture:function(a,i){a.activeTexture(i),a.bindTexture(a.TEXTURE_2D,null),a.activeTexture(a.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(a){this[this.mainParameter]=a},sendUniformData:function(){},createHelpLayer:function(a){if(!a.helpLayer){var i=document.createElement("canvas");i.width=a.sourceWidth,i.height=a.sourceHeight,a.helpLayer=i}},toObject:function(){var a={type:this.type},i=this.mainParameter;return i&&(a[i]=this[i]),a},toJSON:function(){return this.toObject()}}),h.Image.filters.BaseFilter.fromObject=function(a,i){var r=new h.Image.filters[a.type](a);return i&&i(r),r},function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.ColorMatrix=o(r.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(n){this.callSuper("initialize",n),this.matrix=this.matrix.slice(0)},applyTo2d:function(n){var s=n.imageData,l=s.data,u=l.length,d=this.matrix,f,p,v,w,C,b=this.colorsOnly;for(C=0;C<u;C+=4)f=l[C],p=l[C+1],v=l[C+2],b?(l[C]=f*d[0]+p*d[1]+v*d[2]+d[4]*255,l[C+1]=f*d[5]+p*d[6]+v*d[7]+d[9]*255,l[C+2]=f*d[10]+p*d[11]+v*d[12]+d[14]*255):(w=l[C+3],l[C]=f*d[0]+p*d[1]+v*d[2]+w*d[3]+d[4]*255,l[C+1]=f*d[5]+p*d[6]+v*d[7]+w*d[8]+d[9]*255,l[C+2]=f*d[10]+p*d[11]+v*d[12]+w*d[13]+d[14]*255,l[C+3]=f*d[15]+p*d[16]+v*d[17]+w*d[18]+d[19]*255)},getUniformLocations:function(n,s){return{uColorMatrix:n.getUniformLocation(s,"uColorMatrix"),uConstants:n.getUniformLocation(s,"uConstants")}},sendUniformData:function(n,s){var l=this.matrix,u=[l[0],l[1],l[2],l[3],l[5],l[6],l[7],l[8],l[10],l[11],l[12],l[13],l[15],l[16],l[17],l[18]],d=[l[4],l[9],l[14],l[19]];n.uniformMatrix4fv(s.uColorMatrix,!1,u),n.uniform4fv(s.uConstants,d)}}),i.Image.filters.ColorMatrix.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Brightness=o(r.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(n){if(this.brightness!==0){var s=n.imageData,l=s.data,u,d=l.length,f=Math.round(this.brightness*255);for(u=0;u<d;u+=4)l[u]=l[u]+f,l[u+1]=l[u+1]+f,l[u+2]=l[u+2]+f}},getUniformLocations:function(n,s){return{uBrightness:n.getUniformLocation(s,"uBrightness")}},sendUniformData:function(n,s){n.uniform1f(s.uBrightness,this.brightness)}}),i.Image.filters.Brightness.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.extend,o=i.Image.filters,n=i.util.createClass;o.Convolute=n(o.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(s){var l=Math.sqrt(this.matrix.length),u=this.type+"_"+l+"_"+(this.opaque?1:0),d=this.fragmentSource[u];return s.programCache.hasOwnProperty(u)||(s.programCache[u]=this.createProgram(s.context,d)),s.programCache[u]},applyTo2d:function(s){var l=s.imageData,u=l.data,d=this.matrix,f=Math.round(Math.sqrt(d.length)),p=Math.floor(f/2),v=l.width,w=l.height,C=s.ctx.createImageData(v,w),b=C.data,P=this.opaque?1:0,R,A,W,$,X,re,he,ne,ce,ue,de,fe,L;for(de=0;de<w;de++)for(ue=0;ue<v;ue++){for(X=(de*v+ue)*4,R=0,A=0,W=0,$=0,L=0;L<f;L++)for(fe=0;fe<f;fe++)he=de+L-p,re=ue+fe-p,!(he<0||he>=w||re<0||re>=v)&&(ne=(he*v+re)*4,ce=d[L*f+fe],R+=u[ne]*ce,A+=u[ne+1]*ce,W+=u[ne+2]*ce,P||($+=u[ne+3]*ce));b[X]=R,b[X+1]=A,b[X+2]=W,P?b[X+3]=u[X+3]:b[X+3]=$}s.imageData=C},getUniformLocations:function(s,l){return{uMatrix:s.getUniformLocation(l,"uMatrix"),uOpaque:s.getUniformLocation(l,"uOpaque"),uHalfSize:s.getUniformLocation(l,"uHalfSize"),uSize:s.getUniformLocation(l,"uSize")}},sendUniformData:function(s,l){s.uniform1fv(l.uMatrix,this.matrix)},toObject:function(){return r(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),i.Image.filters.Convolute.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Grayscale=o(r.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(n){var s=n.imageData,l=s.data,u,d=l.length,f,p=this.mode;for(u=0;u<d;u+=4)p==="average"?f=(l[u]+l[u+1]+l[u+2])/3:p==="lightness"?f=(Math.min(l[u],l[u+1],l[u+2])+Math.max(l[u],l[u+1],l[u+2]))/2:p==="luminosity"&&(f=.21*l[u]+.72*l[u+1]+.07*l[u+2]),l[u]=f,l[u+1]=f,l[u+2]=f},retrieveShader:function(n){var s=this.type+"_"+this.mode;if(!n.programCache.hasOwnProperty(s)){var l=this.fragmentSource[this.mode];n.programCache[s]=this.createProgram(n.context,l)}return n.programCache[s]},getUniformLocations:function(n,s){return{uMode:n.getUniformLocation(s,"uMode")}},sendUniformData:function(n,s){var l=1;n.uniform1i(s.uMode,l)},isNeutralState:function(){return!1}}),i.Image.filters.Grayscale.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Invert=o(r.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(n){var s=n.imageData,l=s.data,u,d=l.length;for(u=0;u<d;u+=4)l[u]=255-l[u],l[u+1]=255-l[u+1],l[u+2]=255-l[u+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(n,s){return{uInvert:n.getUniformLocation(s,"uInvert")}},sendUniformData:function(n,s){n.uniform1i(s.uInvert,this.invert)}}),i.Image.filters.Invert.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.extend,o=i.Image.filters,n=i.util.createClass;o.Noise=n(o.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(s){if(this.noise!==0){var l=s.imageData,u=l.data,d,f=u.length,p=this.noise,v;for(d=0,f=u.length;d<f;d+=4)v=(.5-Math.random())*p,u[d]+=v,u[d+1]+=v,u[d+2]+=v}},getUniformLocations:function(s,l){return{uNoise:s.getUniformLocation(l,"uNoise"),uSeed:s.getUniformLocation(l,"uSeed")}},sendUniformData:function(s,l){s.uniform1f(l.uNoise,this.noise/255),s.uniform1f(l.uSeed,Math.random())},toObject:function(){return r(this.callSuper("toObject"),{noise:this.noise})}}),i.Image.filters.Noise.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Pixelate=o(r.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(n){var s=n.imageData,l=s.data,u=s.height,d=s.width,f,p,v,w,C,b,P,R,A,W,$;for(p=0;p<u;p+=this.blocksize)for(v=0;v<d;v+=this.blocksize)for(f=p*4*d+v*4,w=l[f],C=l[f+1],b=l[f+2],P=l[f+3],W=Math.min(p+this.blocksize,u),$=Math.min(v+this.blocksize,d),R=p;R<W;R++)for(A=v;A<$;A++)f=R*4*d+A*4,l[f]=w,l[f+1]=C,l[f+2]=b,l[f+3]=P},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(n,s){return{uBlocksize:n.getUniformLocation(s,"uBlocksize"),uStepW:n.getUniformLocation(s,"uStepW"),uStepH:n.getUniformLocation(s,"uStepH")}},sendUniformData:function(n,s){n.uniform1f(s.uBlocksize,this.blocksize)}}),i.Image.filters.Pixelate.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.extend,o=i.Image.filters,n=i.util.createClass;o.RemoveColor=n(o.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(s){var l=s.imageData,u=l.data,d,f=this.distance*255,p,v,w,C=new i.Color(this.color).getSource(),b=[C[0]-f,C[1]-f,C[2]-f],P=[C[0]+f,C[1]+f,C[2]+f];for(d=0;d<u.length;d+=4)p=u[d],v=u[d+1],w=u[d+2],p>b[0]&&v>b[1]&&w>b[2]&&p<P[0]&&v<P[1]&&w<P[2]&&(u[d+3]=0)},getUniformLocations:function(s,l){return{uLow:s.getUniformLocation(l,"uLow"),uHigh:s.getUniformLocation(l,"uHigh")}},sendUniformData:function(s,l){var u=new i.Color(this.color).getSource(),d=parseFloat(this.distance),f=[0+u[0]/255-d,0+u[1]/255-d,0+u[2]/255-d,1],p=[u[0]/255+d,u[1]/255+d,u[2]/255+d,1];s.uniform4fv(l.uLow,f),s.uniform4fv(l.uHigh,p)},toObject:function(){return r(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),i.Image.filters.RemoveColor.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass,n={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var s in n)r[s]=o(r.ColorMatrix,{type:s,matrix:n[s],mainParameter:!1,colorsOnly:!0}),i.Image.filters[s].fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric,r=i.Image.filters,o=i.util.createClass;r.BlendColor=o(r.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(n){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[n]+`}
}`},retrieveShader:function(n){var s=this.type+"_"+this.mode,l;return n.programCache.hasOwnProperty(s)||(l=this.buildSource(this.mode),n.programCache[s]=this.createProgram(n.context,l)),n.programCache[s]},applyTo2d:function(n){var s=n.imageData,l=s.data,u=l.length,d,f,p,v,w,C,b,P=1-this.alpha;b=new i.Color(this.color).getSource(),d=b[0]*this.alpha,f=b[1]*this.alpha,p=b[2]*this.alpha;for(var R=0;R<u;R+=4)switch(v=l[R],w=l[R+1],C=l[R+2],this.mode){case"multiply":l[R]=v*d/255,l[R+1]=w*f/255,l[R+2]=C*p/255;break;case"screen":l[R]=255-(255-v)*(255-d)/255,l[R+1]=255-(255-w)*(255-f)/255,l[R+2]=255-(255-C)*(255-p)/255;break;case"add":l[R]=v+d,l[R+1]=w+f,l[R+2]=C+p;break;case"diff":case"difference":l[R]=Math.abs(v-d),l[R+1]=Math.abs(w-f),l[R+2]=Math.abs(C-p);break;case"subtract":l[R]=v-d,l[R+1]=w-f,l[R+2]=C-p;break;case"darken":l[R]=Math.min(v,d),l[R+1]=Math.min(w,f),l[R+2]=Math.min(C,p);break;case"lighten":l[R]=Math.max(v,d),l[R+1]=Math.max(w,f),l[R+2]=Math.max(C,p);break;case"overlay":l[R]=d<128?2*v*d/255:255-2*(255-v)*(255-d)/255,l[R+1]=f<128?2*w*f/255:255-2*(255-w)*(255-f)/255,l[R+2]=p<128?2*C*p/255:255-2*(255-C)*(255-p)/255;break;case"exclusion":l[R]=d+v-2*d*v/255,l[R+1]=f+w-2*f*w/255,l[R+2]=p+C-2*p*C/255;break;case"tint":l[R]=d+v*P,l[R+1]=f+w*P,l[R+2]=p+C*P}},getUniformLocations:function(n,s){return{uColor:n.getUniformLocation(s,"uColor")}},sendUniformData:function(n,s){var l=new i.Color(this.color).getSource();l[0]=this.alpha*l[0]/255,l[1]=this.alpha*l[1]/255,l[2]=this.alpha*l[2]/255,l[3]=this.alpha,n.uniform4fv(s.uColor,l)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendColor.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric,r=i.Image.filters,o=i.util.createClass;r.BlendImage=o(r.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(n){var s=this.type+"_"+this.mode,l=this.fragmentSource[this.mode];return n.programCache.hasOwnProperty(s)||(n.programCache[s]=this.createProgram(n.context,l)),n.programCache[s]},applyToWebGL:function(n){var s=n.context,l=this.createTexture(n.filterBackend,this.image);this.bindAdditionalTexture(s,l,s.TEXTURE1),this.callSuper("applyToWebGL",n),this.unbindAdditionalTexture(s,s.TEXTURE1)},createTexture:function(n,s){return n.getCachedTexture(s.cacheKey,s._element)},calculateMatrix:function(){var n=this.image,s=n._element.width,l=n._element.height;return[1/n.scaleX,0,0,0,1/n.scaleY,0,-n.left/s,-n.top/l,1]},applyTo2d:function(n){var s=n.imageData,l=n.filterBackend.resources,u=s.data,d=u.length,f=s.width,p=s.height,v,w,C,b,P,R,A,W,$,X,re=this.image,he;l.blendImage||(l.blendImage=i.util.createCanvasElement()),$=l.blendImage,X=$.getContext("2d"),$.width!==f||$.height!==p?($.width=f,$.height=p):X.clearRect(0,0,f,p),X.setTransform(re.scaleX,0,0,re.scaleY,re.left,re.top),X.drawImage(re._element,0,0,f,p),he=X.getImageData(0,0,f,p).data;for(var ne=0;ne<d;ne+=4)switch(P=u[ne],R=u[ne+1],A=u[ne+2],W=u[ne+3],v=he[ne],w=he[ne+1],C=he[ne+2],b=he[ne+3],this.mode){case"multiply":u[ne]=P*v/255,u[ne+1]=R*w/255,u[ne+2]=A*C/255,u[ne+3]=W*b/255;break;case"mask":u[ne+3]=b;break}},getUniformLocations:function(n,s){return{uTransformMatrix:n.getUniformLocation(s,"uTransformMatrix"),uImage:n.getUniformLocation(s,"uImage")}},sendUniformData:function(n,s){var l=this.calculateMatrix();n.uniform1i(s.uImage,1),n.uniformMatrix3fv(s.uTransformMatrix,!1,l)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendImage.fromObject=function(n,s){i.Image.fromObject(n.image,function(l){var u=i.util.object.clone(n);u.image=l,s(new i.Image.filters.BlendImage(u))})}}(e),function(a){var i=a.fabric||(a.fabric={}),r=Math.pow,o=Math.floor,n=Math.sqrt,s=Math.abs,l=Math.round,u=Math.sin,d=Math.ceil,f=i.Image.filters,p=i.util.createClass;f.Resize=p(f.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(v,w){return{uDelta:v.getUniformLocation(w,"uDelta"),uTaps:v.getUniformLocation(w,"uTaps")}},sendUniformData:function(v,w){v.uniform2fv(w.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),v.uniform1fv(w.uTaps,this.taps)},retrieveShader:function(v){var w=this.getFilterWindow(),C=this.type+"_"+w;if(!v.programCache.hasOwnProperty(C)){var b=this.generateShader(w);v.programCache[C]=this.createProgram(v.context,b)}return v.programCache[C]},getFilterWindow:function(){var v=this.tempScale;return Math.ceil(this.lanczosLobes/v)},getTaps:function(){for(var v=this.lanczosCreate(this.lanczosLobes),w=this.tempScale,C=this.getFilterWindow(),b=new Array(C),P=1;P<=C;P++)b[P-1]=v(P*w);return b},generateShader:function(b){for(var w=new Array(b),C=this.fragmentSourceTOP,b,P=1;P<=b;P++)w[P-1]=P+".0 * uDelta";return C+="uniform float uTaps["+b+`];
`,C+=`void main() {
`,C+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,C+=`  float sum = 1.0;
`,w.forEach(function(R,A){C+="  color += texture2D(uTexture, vTexCoord + "+R+") * uTaps["+A+`];
`,C+="  color += texture2D(uTexture, vTexCoord - "+R+") * uTaps["+A+`];
`,C+="  sum += 2.0 * uTaps["+A+`];
`}),C+=`  gl_FragColor = color / sum;
`,C+="}",C},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(v){v.webgl?(v.passes++,this.width=v.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=v.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),v.destinationWidth=this.dW,this._setupFrameBuffer(v),this.applyToWebGL(v),this._swapTextures(v),v.sourceWidth=v.destinationWidth,this.height=v.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),v.destinationHeight=this.dH,this._setupFrameBuffer(v),this.applyToWebGL(v),this._swapTextures(v),v.sourceHeight=v.destinationHeight):this.applyTo2d(v)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(v){return function(w){if(w>=v||w<=-v)return 0;if(w<11920929e-14&&w>-11920929e-14)return 1;w*=Math.PI;var C=w/v;return u(w)/w*u(C)/C}},applyTo2d:function(v){var w=v.imageData,C=this.scaleX,b=this.scaleY;this.rcpScaleX=1/C,this.rcpScaleY=1/b;var P=w.width,R=w.height,A=l(P*C),W=l(R*b),$;this.resizeType==="sliceHack"?$=this.sliceByTwo(v,P,R,A,W):this.resizeType==="hermite"?$=this.hermiteFastResize(v,P,R,A,W):this.resizeType==="bilinear"?$=this.bilinearFiltering(v,P,R,A,W):this.resizeType==="lanczos"&&($=this.lanczosResize(v,P,R,A,W)),v.imageData=$},sliceByTwo:function(v,w,C,b,P){var R=v.imageData,A=.5,W=!1,$=!1,X=w*A,re=C*A,he=i.filterBackend.resources,ne,ce,ue=0,de=0,fe=w,L=0;for(he.sliceByTwo||(he.sliceByTwo=document.createElement("canvas")),ne=he.sliceByTwo,(ne.width<w*1.5||ne.height<C)&&(ne.width=w*1.5,ne.height=C),ce=ne.getContext("2d"),ce.clearRect(0,0,w*1.5,C),ce.putImageData(R,0,0),b=o(b),P=o(P);!W||!$;)w=X,C=re,b<o(X*A)?X=o(X*A):(X=b,W=!0),P<o(re*A)?re=o(re*A):(re=P,$=!0),ce.drawImage(ne,ue,de,w,C,fe,L,X,re),ue=fe,de=L,L+=re;return ce.getImageData(ue,de,b,P)},lanczosResize:function(v,w,C,b,P){function R(N){var j,G,D,k,H,F,K,V,te,J,ie;for(L.x=(N+.5)*re,U.x=o(L.x),j=0;j<P;j++){for(L.y=(j+.5)*he,U.y=o(L.y),H=0,F=0,K=0,V=0,te=0,G=U.x-ue;G<=U.x+ue;G++)if(!(G<0||G>=w)){J=o(1e3*s(G-L.x)),fe[J]||(fe[J]={});for(var Y=U.y-de;Y<=U.y+de;Y++)Y<0||Y>=C||(ie=o(1e3*s(Y-L.y)),fe[J][ie]||(fe[J][ie]=X(n(r(J*ne,2)+r(ie*ce,2))/1e3)),D=fe[J][ie],D>0&&(k=(Y*w+G)*4,H+=D,F+=D*A[k],K+=D*A[k+1],V+=D*A[k+2],te+=D*A[k+3]))}k=(j*b+N)*4,$[k]=F/H,$[k+1]=K/H,$[k+2]=V/H,$[k+3]=te/H}return++N<b?R(N):W}var A=v.imageData.data,W=v.ctx.createImageData(b,P),$=W.data,X=this.lanczosCreate(this.lanczosLobes),re=this.rcpScaleX,he=this.rcpScaleY,ne=2/this.rcpScaleX,ce=2/this.rcpScaleY,ue=d(re*this.lanczosLobes/2),de=d(he*this.lanczosLobes/2),fe={},L={},U={};return R(0)},bilinearFiltering:function(v,w,C,b,P){var R,A,W,$,X,re,he,ne,ce,ue,de,fe,L=0,U,N=this.rcpScaleX,j=this.rcpScaleY,G=4*(w-1),D=v.imageData,k=D.data,H=v.ctx.createImageData(b,P),F=H.data;for(he=0;he<P;he++)for(ne=0;ne<b;ne++)for(X=o(N*ne),re=o(j*he),ce=N*ne-X,ue=j*he-re,U=4*(re*w+X),de=0;de<4;de++)R=k[U+de],A=k[U+4+de],W=k[U+G+de],$=k[U+G+4+de],fe=R*(1-ce)*(1-ue)+A*ce*(1-ue)+W*ue*(1-ce)+$*ce*ue,F[L++]=fe;return H},hermiteFastResize:function(v,w,C,b,P){for(var R=this.rcpScaleX,A=this.rcpScaleY,W=d(R/2),$=d(A/2),X=v.imageData,re=X.data,he=v.ctx.createImageData(b,P),ne=he.data,ce=0;ce<P;ce++)for(var ue=0;ue<b;ue++){for(var de=(ue+ce*b)*4,fe=0,L=0,U=0,N=0,j=0,G=0,D=0,k=(ce+.5)*A,H=o(ce*A);H<(ce+1)*A;H++)for(var F=s(k-(H+.5))/$,K=(ue+.5)*R,V=F*F,te=o(ue*R);te<(ue+1)*R;te++){var J=s(K-(te+.5))/W,ie=n(V+J*J);ie>1&&ie<-1||(fe=2*ie*ie*ie-3*ie*ie+1,fe>0&&(J=4*(te+H*w),D+=fe*re[J+3],U+=fe,re[J+3]<255&&(fe=fe*re[J+3]/250),N+=fe*re[J],j+=fe*re[J+1],G+=fe*re[J+2],L+=fe))}ne[de]=N/L,ne[de+1]=j/L,ne[de+2]=G/L,ne[de+3]=D/U}return he},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),i.Image.filters.Resize.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Contrast=o(r.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(n){if(this.contrast!==0){var s=n.imageData,l,d,u=s.data,d=u.length,f=Math.floor(this.contrast*255),p=259*(f+255)/(255*(259-f));for(l=0;l<d;l+=4)u[l]=p*(u[l]-128)+128,u[l+1]=p*(u[l+1]-128)+128,u[l+2]=p*(u[l+2]-128)+128}},getUniformLocations:function(n,s){return{uContrast:n.getUniformLocation(s,"uContrast")}},sendUniformData:function(n,s){n.uniform1f(s.uContrast,this.contrast)}}),i.Image.filters.Contrast.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Saturation=o(r.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(n){if(this.saturation!==0){var s=n.imageData,l=s.data,u=l.length,d=-this.saturation,f,p;for(f=0;f<u;f+=4)p=Math.max(l[f],l[f+1],l[f+2]),l[f]+=p!==l[f]?(p-l[f])*d:0,l[f+1]+=p!==l[f+1]?(p-l[f+1])*d:0,l[f+2]+=p!==l[f+2]?(p-l[f+2])*d:0}},getUniformLocations:function(n,s){return{uSaturation:n.getUniformLocation(s,"uSaturation")}},sendUniformData:function(n,s){n.uniform1f(s.uSaturation,-this.saturation)}}),i.Image.filters.Saturation.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Vibrance=o(r.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(n){if(this.vibrance!==0){var s=n.imageData,l=s.data,u=l.length,d=-this.vibrance,f,p,v,w;for(f=0;f<u;f+=4)p=Math.max(l[f],l[f+1],l[f+2]),v=(l[f]+l[f+1]+l[f+2])/3,w=Math.abs(p-v)*2/255*d,l[f]+=p!==l[f]?(p-l[f])*w:0,l[f+1]+=p!==l[f+1]?(p-l[f+1])*w:0,l[f+2]+=p!==l[f+2]?(p-l[f+2])*w:0}},getUniformLocations:function(n,s){return{uVibrance:n.getUniformLocation(s,"uVibrance")}},sendUniformData:function(n,s){n.uniform1f(s.uVibrance,-this.vibrance)}}),i.Image.filters.Vibrance.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Blur=o(r.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(n){n.webgl?(this.aspectRatio=n.sourceWidth/n.sourceHeight,n.passes++,this._setupFrameBuffer(n),this.horizontal=!0,this.applyToWebGL(n),this._swapTextures(n),this._setupFrameBuffer(n),this.horizontal=!1,this.applyToWebGL(n),this._swapTextures(n)):this.applyTo2d(n)},applyTo2d:function(n){n.imageData=this.simpleBlur(n)},simpleBlur:function(n){var s=n.filterBackend.resources,l,u,d=n.imageData.width,f=n.imageData.height;s.blurLayer1||(s.blurLayer1=i.util.createCanvasElement(),s.blurLayer2=i.util.createCanvasElement()),l=s.blurLayer1,u=s.blurLayer2,(l.width!==d||l.height!==f)&&(u.width=l.width=d,u.height=l.height=f);var p=l.getContext("2d"),v=u.getContext("2d"),w=15,C,b,P,R,A=this.blur*.06*.5;for(p.putImageData(n.imageData,0,0),v.clearRect(0,0,d,f),R=-w;R<=w;R++)C=(Math.random()-.5)/4,b=R/w,P=A*b*d+C,v.globalAlpha=1-Math.abs(b),v.drawImage(l,P,C),p.drawImage(u,0,0),v.globalAlpha=1,v.clearRect(0,0,u.width,u.height);for(R=-w;R<=w;R++)C=(Math.random()-.5)/4,b=R/w,P=A*b*f+C,v.globalAlpha=1-Math.abs(b),v.drawImage(l,C,P),p.drawImage(u,0,0),v.globalAlpha=1,v.clearRect(0,0,u.width,u.height);n.ctx.drawImage(l,0,0);var W=n.ctx.getImageData(0,0,l.width,l.height);return p.globalAlpha=1,p.clearRect(0,0,l.width,l.height),W},getUniformLocations:function(n,s){return{delta:n.getUniformLocation(s,"uDelta")}},sendUniformData:function(n,s){var l=this.chooseRightDelta();n.uniform2fv(s.delta,l)},chooseRightDelta:function(){var n=1,s=[0,0],l;return this.horizontal?this.aspectRatio>1&&(n=1/this.aspectRatio):this.aspectRatio<1&&(n=this.aspectRatio),l=n*this.blur*.12,this.horizontal?s[0]=l:s[1]=l,s}}),r.Blur.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Gamma=o(r.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(n){this.gamma=[1,1,1],r.BaseFilter.prototype.initialize.call(this,n)},applyTo2d:function(n){var s=n.imageData,l=s.data,u=this.gamma,d=l.length,f=1/u[0],p=1/u[1],v=1/u[2],w;for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),w=0,d=256;w<d;w++)this.rVals[w]=Math.pow(w/255,f)*255,this.gVals[w]=Math.pow(w/255,p)*255,this.bVals[w]=Math.pow(w/255,v)*255;for(w=0,d=l.length;w<d;w+=4)l[w]=this.rVals[l[w]],l[w+1]=this.gVals[l[w+1]],l[w+2]=this.bVals[l[w+2]]},getUniformLocations:function(n,s){return{uGamma:n.getUniformLocation(s,"uGamma")}},sendUniformData:function(n,s){n.uniform3fv(s.uGamma,this.gamma)}}),i.Image.filters.Gamma.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Composed=o(r.BaseFilter,{type:"Composed",subFilters:[],initialize:function(n){this.callSuper("initialize",n),this.subFilters=this.subFilters.slice(0)},applyTo:function(n){n.passes+=this.subFilters.length-1,this.subFilters.forEach(function(s){s.applyTo(n)})},toObject:function(){return i.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(n){return n.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(n){return!n.isNeutralState()})}}),i.Image.filters.Composed.fromObject=function(n,s){var l=n.subFilters||[],u=l.map(function(f){return new i.Image.filters[f.type](f)}),d=new i.Image.filters.Composed({subFilters:u});return s&&s(d),d}}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.Image.filters,o=i.util.createClass;r.HueRotation=o(r.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var n=this.rotation*Math.PI,s=i.util.cos(n),l=i.util.sin(n),u=1/3,d=Math.sqrt(u)*l,f=1-s;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=s+f/3,this.matrix[1]=u*f-d,this.matrix[2]=u*f+d,this.matrix[5]=u*f+d,this.matrix[6]=s+u*f,this.matrix[7]=u*f-d,this.matrix[10]=u*f-d,this.matrix[11]=u*f+d,this.matrix[12]=s+u*f},isNeutralState:function(n){return this.calculateMatrix(),r.BaseFilter.prototype.isNeutralState.call(this,n)},applyTo:function(n){this.calculateMatrix(),r.BaseFilter.prototype.applyTo.call(this,n)}}),i.Image.filters.HueRotation.fromObject=i.Image.filters.BaseFilter.fromObject}(e),function(a){var i=a.fabric||(a.fabric={}),r=i.util.object.clone;if(i.Text){i.warn("fabric.Text is already defined");return}var o="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide".split(" ");i.Text=i.util.createClass(i.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:i.Object.prototype.stateProperties.concat(o),cacheProperties:i.Object.prototype.cacheProperties.concat(o),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(n,s){this.styles=s?s.styles||{}:{},this.text=n,this.__skipDimension=!0,this.callSuper("initialize",s),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var n=this.path;n&&(n.segmentsInfo=i.util.getPathSegmentsInfo(n.path))},getMeasuringContext:function(){return i._measuringContext||(i._measuringContext=this.canvas&&this.canvas.contextCache||i.util.createCanvasElement().getContext("2d")),i._measuringContext},_splitText:function(){var n=this._splitTextIntoLines(this.text);return this.textLines=n.lines,this._textLines=n.graphemeLines,this._unwrappedTextLines=n._unwrappedLines,this._text=n.graphemeText,n},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var n,s,l,u,d,f,p,v=0,w=this._textLines.length;v<w;v++)if(!(this.textAlign!=="justify"&&(v===w-1||this.isEndOfWrapping(v)))&&(u=0,d=this._textLines[v],s=this.getLineWidth(v),s<this.width&&(p=this.textLines[v].match(this._reSpacesAndTabs)))){l=p.length,n=(this.width-s)/l;for(var C=0,b=d.length;C<=b;C++)f=this.__charBounds[v][C],this._reSpaceAndTab.test(d[C])?(f.width+=n,f.kernedWidth+=n,f.left+=u,u+=n):f.left+=u}},isEndOfWrapping:function(n){return n===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var n=this.callSuper("_getCacheCanvasDimensions"),s=this.fontSize;return n.width+=s*n.zoomX,n.height+=s*n.zoomY,n},_render:function(n){var s=this.path;s&&!s.isNotVisible()&&s._render(n),this._setTextStyles(n),this._renderTextLinesBackground(n),this._renderTextDecoration(n,"underline"),this._renderText(n),this._renderTextDecoration(n,"overline"),this._renderTextDecoration(n,"linethrough")},_renderText:function(n){this.paintFirst==="stroke"?(this._renderTextStroke(n),this._renderTextFill(n)):(this._renderTextFill(n),this._renderTextStroke(n))},_setTextStyles:function(n,s,l){n.textBaseline="alphabetic",n.font=this._getFontDeclaration(s,l)},calcTextWidth:function(){for(var n=this.getLineWidth(0),s=1,l=this._textLines.length;s<l;s++){var u=this.getLineWidth(s);u>n&&(n=u)}return n},_renderTextLine:function(n,s,l,u,d,f){this._renderChars(n,s,l,u,d,f)},_renderTextLinesBackground:function(n){if(!(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))){for(var s,l,u=n.fillStyle,d,f,p=this._getLeftOffset(),v=this._getTopOffset(),w=0,C=0,b,P,R=this.path,A,W=0,$=this._textLines.length;W<$;W++){if(s=this.getHeightOfLine(W),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",W)){v+=s;continue}d=this._textLines[W],l=this._getLineLeftOffset(W),C=0,w=0,f=this.getValueOfPropertyAt(W,0,"textBackgroundColor");for(var X=0,re=d.length;X<re;X++)b=this.__charBounds[W][X],P=this.getValueOfPropertyAt(W,X,"textBackgroundColor"),R?(n.save(),n.translate(b.renderLeft,b.renderTop),n.rotate(b.angle),n.fillStyle=P,P&&n.fillRect(-b.width/2,-s/this.lineHeight*(1-this._fontSizeFraction),b.width,s/this.lineHeight),n.restore()):P!==f?(A=p+l+w,this.direction==="rtl"&&(A=this.width-A-C),n.fillStyle=f,f&&n.fillRect(A,v,C,s/this.lineHeight),w=b.left,C=b.width,f=P):C+=b.kernedWidth;P&&!R&&(A=p+l+w,this.direction==="rtl"&&(A=this.width-A-C),n.fillStyle=P,n.fillRect(A,v,C,s/this.lineHeight)),v+=s}n.fillStyle=u,this._removeShadow(n)}},getFontCache:function(n){var s=n.fontFamily.toLowerCase();i.charWidthsCache[s]||(i.charWidthsCache[s]={});var l=i.charWidthsCache[s],u=n.fontStyle.toLowerCase()+"_"+(n.fontWeight+"").toLowerCase();return l[u]||(l[u]={}),l[u]},_measureChar:function(n,s,l,u){var d=this.getFontCache(s),f=this._getFontDeclaration(s),p=this._getFontDeclaration(u),v=l+n,w=f===p,C,b,P,R=s.fontSize/this.CACHE_FONT_SIZE,A;if(l&&d[l]!==void 0&&(P=d[l]),d[n]!==void 0&&(A=C=d[n]),w&&d[v]!==void 0&&(b=d[v],A=b-P),C===void 0||P===void 0||b===void 0){var W=this.getMeasuringContext();this._setTextStyles(W,s,!0)}return C===void 0&&(A=C=W.measureText(n).width,d[n]=C),P===void 0&&w&&l&&(P=W.measureText(l).width,d[l]=P),w&&b===void 0&&(b=W.measureText(v).width,d[v]=b,A=b-P),{width:C*R,kernedWidth:A*R}},getHeightOfChar:function(n,s){return this.getValueOfPropertyAt(n,s,"fontSize")},measureLine:function(n){var s=this._measureLine(n);return this.charSpacing!==0&&(s.width-=this._getWidthOfCharSpacing()),s.width<0&&(s.width=0),s},_measureLine:function(n){var s=0,l,u,d=this._textLines[n],f,p,v=0,w=new Array(d.length),C=0,b,P,R=this.path,A=this.pathSide==="right";for(this.__charBounds[n]=w,l=0;l<d.length;l++)u=d[l],p=this._getGraphemeBox(u,n,l,f),w[l]=p,s+=p.kernedWidth,f=u;if(w[l]={left:p?p.left+p.width:0,width:0,kernedWidth:0,height:this.fontSize},R){switch(P=R.segmentsInfo[R.segmentsInfo.length-1].length,b=i.util.getPointOnPath(R.path,0,R.segmentsInfo),b.x+=R.pathOffset.x,b.y+=R.pathOffset.y,this.textAlign){case"left":C=A?P-s:0;break;case"center":C=(P-s)/2;break;case"right":C=A?0:P-s;break}for(C+=this.pathStartOffset*(A?-1:1),l=A?d.length-1:0;A?l>=0:l<d.length;A?l--:l++)p=w[l],C>P?C%=P:C<0&&(C+=P),this._setGraphemeOnPath(C,p,b),C+=p.kernedWidth}return{width:s,numOfSpaces:v}},_setGraphemeOnPath:function(n,s,l){var u=n+s.kernedWidth/2,d=this.path,f=i.util.getPointOnPath(d.path,u,d.segmentsInfo);s.renderLeft=f.x-l.x,s.renderTop=f.y-l.y,s.angle=f.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(n,s,l,u,d){var f=this.getCompleteStyleDeclaration(s,l),p=u?this.getCompleteStyleDeclaration(s,l-1):{},v=this._measureChar(n,f,u,p),w=v.kernedWidth,C=v.width,b;this.charSpacing!==0&&(b=this._getWidthOfCharSpacing(),C+=b,w+=b);var P={width:C,left:0,height:f.fontSize,kernedWidth:w,deltaY:f.deltaY};if(l>0&&!d){var R=this.__charBounds[s][l-1];P.left=R.left+R.width+v.kernedWidth-v.width}return P},getHeightOfLine:function(n){if(this.__lineHeights[n])return this.__lineHeights[n];for(var s=this._textLines[n],l=this.getHeightOfChar(n,0),u=1,d=s.length;u<d;u++)l=Math.max(this.getHeightOfChar(n,u),l);return this.__lineHeights[n]=l*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var n,s=0,l=0,u=this._textLines.length;l<u;l++)n=this.getHeightOfLine(l),s+=l===u-1?n/this.lineHeight:n;return s},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(n,s){n.save();for(var l=0,u=this._getLeftOffset(),d=this._getTopOffset(),f=0,p=this._textLines.length;f<p;f++){var v=this.getHeightOfLine(f),w=v/this.lineHeight,C=this._getLineLeftOffset(f);this._renderTextLine(s,n,this._textLines[f],u+C,d+l+w,f),l+=v}n.restore()},_renderTextFill:function(n){!this.fill&&!this.styleHas("fill")||this._renderTextCommon(n,"fillText")},_renderTextStroke:function(n){(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(n),n.save(),this._setLineDash(n,this.strokeDashArray),n.beginPath(),this._renderTextCommon(n,"strokeText"),n.closePath(),n.restore())},_renderChars:function(n,s,l,u,d,f){var p=this.getHeightOfLine(f),v=this.textAlign.indexOf("justify")!==-1,w,C,b="",P,R=0,A,W=this.path,$=!v&&this.charSpacing===0&&this.isEmptyStyles(f)&&!W,X=this.direction==="ltr",re=this.direction==="ltr"?1:-1,he;if(s.save(),d-=p*this._fontSizeFraction/this.lineHeight,$){s.canvas.setAttribute("dir",X?"ltr":"rtl"),s.direction=X?"ltr":"rtl",s.textAlign=X?"left":"right",this._renderChar(n,s,f,0,l.join(""),u,d,p),s.restore();return}for(var ne=0,ce=l.length-1;ne<=ce;ne++)A=ne===ce||this.charSpacing||W,b+=l[ne],P=this.__charBounds[f][ne],R===0?(u+=re*(P.kernedWidth-P.width),R+=P.width):R+=P.kernedWidth,v&&!A&&this._reSpaceAndTab.test(l[ne])&&(A=!0),A||(w=w||this.getCompleteStyleDeclaration(f,ne),C=this.getCompleteStyleDeclaration(f,ne+1),A=this._hasStyleChanged(w,C)),A&&(W?(s.save(),s.translate(P.renderLeft,P.renderTop),s.rotate(P.angle),this._renderChar(n,s,f,ne,b,-R/2,0,p),s.restore()):(he=u,s.canvas.setAttribute("dir",X?"ltr":"rtl"),s.direction=X?"ltr":"rtl",s.textAlign=X?"left":"right",this._renderChar(n,s,f,ne,b,he,d,p)),b="",w=C,u+=re*R,R=0);s.restore()},_applyPatternGradientTransformText:function(n){var s=i.util.createCanvasElement(),l,u=this.width+this.strokeWidth,d=this.height+this.strokeWidth;return s.width=u,s.height=d,l=s.getContext("2d"),l.beginPath(),l.moveTo(0,0),l.lineTo(u,0),l.lineTo(u,d),l.lineTo(0,d),l.closePath(),l.translate(u/2,d/2),l.fillStyle=n.toLive(l),this._applyPatternGradientTransform(l,n),l.fill(),l.createPattern(s,"no-repeat")},handleFiller:function(n,s,l){var u,d;return l.toLive?l.gradientUnits==="percentage"||l.gradientTransform||l.patternTransform?(u=-this.width/2,d=-this.height/2,n.translate(u,d),n[s]=this._applyPatternGradientTransformText(l),{offsetX:u,offsetY:d}):(n[s]=l.toLive(n,this),this._applyPatternGradientTransform(n,l)):(n[s]=l,{offsetX:0,offsetY:0})},_setStrokeStyles:function(n,s){return n.lineWidth=s.strokeWidth,n.lineCap=this.strokeLineCap,n.lineDashOffset=this.strokeDashOffset,n.lineJoin=this.strokeLineJoin,n.miterLimit=this.strokeMiterLimit,this.handleFiller(n,"strokeStyle",s.stroke)},_setFillStyles:function(n,s){return this.handleFiller(n,"fillStyle",s.fill)},_renderChar:function(n,s,l,u,d,f,p){var v=this._getStyleDeclaration(l,u),w=this.getCompleteStyleDeclaration(l,u),C=n==="fillText"&&w.fill,b=n==="strokeText"&&w.stroke&&w.strokeWidth,P,R;!b&&!C||(s.save(),C&&(P=this._setFillStyles(s,w)),b&&(R=this._setStrokeStyles(s,w)),s.font=this._getFontDeclaration(w),v&&v.textBackgroundColor&&this._removeShadow(s),v&&v.deltaY&&(p+=v.deltaY),C&&s.fillText(d,f-P.offsetX,p-P.offsetY),b&&s.strokeText(d,f-R.offsetX,p-R.offsetY),s.restore())},setSuperscript:function(n,s){return this._setScript(n,s,this.superscript)},setSubscript:function(n,s){return this._setScript(n,s,this.subscript)},_setScript:function(n,s,l){var u=this.get2DCursorLocation(n,!0),d=this.getValueOfPropertyAt(u.lineIndex,u.charIndex,"fontSize"),f=this.getValueOfPropertyAt(u.lineIndex,u.charIndex,"deltaY"),p={fontSize:d*l.size,deltaY:f+d*l.baseline};return this.setSelectionStyles(p,n,s),this},_hasStyleChanged:function(n,s){return n.fill!==s.fill||n.stroke!==s.stroke||n.strokeWidth!==s.strokeWidth||n.fontSize!==s.fontSize||n.fontFamily!==s.fontFamily||n.fontWeight!==s.fontWeight||n.fontStyle!==s.fontStyle||n.deltaY!==s.deltaY},_hasStyleChangedForSvg:function(n,s){return this._hasStyleChanged(n,s)||n.overline!==s.overline||n.underline!==s.underline||n.linethrough!==s.linethrough},_getLineLeftOffset:function(n){var s=this.getLineWidth(n),l=this.width-s,u=this.textAlign,d=this.direction,p,f=0,p=this.isEndOfWrapping(n);return u==="justify"||u==="justify-center"&&!p||u==="justify-right"&&!p||u==="justify-left"&&!p?0:(u==="center"&&(f=l/2),u==="right"&&(f=l),u==="justify-center"&&(f=l/2),u==="justify-right"&&(f=l),d==="rtl"&&(f-=l),f)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var n=this._forceClearCache;return n||(n=this.hasStateChanged("_dimensionAffectingProps")),n&&(this.dirty=!0,this._forceClearCache=!1),n},getLineWidth:function(n){if(this.__lineWidths[n])return this.__lineWidths[n];var s,l=this._textLines[n],u;return l===""?s=0:(u=this.measureLine(n),s=u.width),this.__lineWidths[n]=s,s},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(n,s,l){var u=this._getStyleDeclaration(n,s);return u&&typeof u[l]!="undefined"?u[l]:this[l]},_renderTextDecoration:function(n,s){if(!(!this[s]&&!this.styleHas(s))){for(var l,u,d,f,p,v,w,C,b=this._getLeftOffset(),P=this._getTopOffset(),R,A,W,$,X,re,he,ne,ce=this.path,ue=this._getWidthOfCharSpacing(),de=this.offsets[s],fe=0,L=this._textLines.length;fe<L;fe++){if(l=this.getHeightOfLine(fe),!this[s]&&!this.styleHas(s,fe)){P+=l;continue}w=this._textLines[fe],re=l/this.lineHeight,f=this._getLineLeftOffset(fe),A=0,W=0,C=this.getValueOfPropertyAt(fe,0,s),ne=this.getValueOfPropertyAt(fe,0,"fill"),R=P+re*(1-this._fontSizeFraction),u=this.getHeightOfChar(fe,0),p=this.getValueOfPropertyAt(fe,0,"deltaY");for(var U=0,N=w.length;U<N;U++)if($=this.__charBounds[fe][U],X=this.getValueOfPropertyAt(fe,U,s),he=this.getValueOfPropertyAt(fe,U,"fill"),d=this.getHeightOfChar(fe,U),v=this.getValueOfPropertyAt(fe,U,"deltaY"),ce&&X&&he)n.save(),n.fillStyle=ne,n.translate($.renderLeft,$.renderTop),n.rotate($.angle),n.fillRect(-$.kernedWidth/2,de*d+v,$.kernedWidth,this.fontSize/15),n.restore();else if((X!==C||he!==ne||d!==u||v!==p)&&W>0){var j=b+f+A;this.direction==="rtl"&&(j=this.width-j-W),C&&ne&&(n.fillStyle=ne,n.fillRect(j,R+de*u+p,W,this.fontSize/15)),A=$.left,W=$.width,C=X,ne=he,u=d,p=v}else W+=$.kernedWidth;var j=b+f+A;this.direction==="rtl"&&(j=this.width-j-W),n.fillStyle=he,X&&he&&n.fillRect(j,R+de*u+p,W-ue,this.fontSize/15),P+=l}this._removeShadow(n)}},_getFontDeclaration:function(n,s){var l=n||this,u=this.fontFamily,d=i.Text.genericFonts.indexOf(u.toLowerCase())>-1,f=u===void 0||u.indexOf("'")>-1||u.indexOf(",")>-1||u.indexOf('"')>-1||d?l.fontFamily:'"'+l.fontFamily+'"';return[i.isLikelyNode?l.fontWeight:l.fontStyle,i.isLikelyNode?l.fontStyle:l.fontWeight,s?this.CACHE_FONT_SIZE+"px":l.fontSize+"px",f].join(" ")},render:function(n){!this.visible||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",n))},_splitTextIntoLines:function(n){for(var s=n.split(this._reNewline),l=new Array(s.length),u=[`
`],d=[],f=0;f<s.length;f++)l[f]=i.util.string.graphemeSplit(s[f]),d=d.concat(l[f],u);return d.pop(),{_unwrappedLines:l,lines:s,graphemeText:d,graphemeLines:l}},toObject:function(n){var s=o.concat(n),l=this.callSuper("toObject",s);return l.styles=r(this.styles,!0),l.path&&(l.path=this.path.toObject()),l},set:function(n,s){this.callSuper("set",n,s);var l=!1,u=!1;if(typeof n=="object")for(var d in n)d==="path"&&this.setPathInfo(),l=l||this._dimensionAffectingProps.indexOf(d)!==-1,u=u||d==="path";else l=this._dimensionAffectingProps.indexOf(n)!==-1,u=n==="path";return u&&this.setPathInfo(),l&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),i.Text.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),i.Text.DEFAULT_SVG_FONT_SIZE=16,i.Text.fromElement=function(n,s,l){if(!n)return s(null);var u=i.parseAttributes(n,i.Text.ATTRIBUTE_NAMES),d=u.textAnchor||"left";if(l=i.util.object.extend(l?r(l):{},u),l.top=l.top||0,l.left=l.left||0,u.textDecoration){var f=u.textDecoration;f.indexOf("underline")!==-1&&(l.underline=!0),f.indexOf("overline")!==-1&&(l.overline=!0),f.indexOf("line-through")!==-1&&(l.linethrough=!0),delete l.textDecoration}"dx"in u&&(l.left+=u.dx),"dy"in u&&(l.top+=u.dy),"fontSize"in l||(l.fontSize=i.Text.DEFAULT_SVG_FONT_SIZE);var p="";"textContent"in n?p=n.textContent:"firstChild"in n&&n.firstChild!==null&&"data"in n.firstChild&&n.firstChild.data!==null&&(p=n.firstChild.data),p=p.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var v=l.strokeWidth;l.strokeWidth=0;var w=new i.Text(p,l),C=w.getScaledHeight()/w.height,b=(w.height+w.strokeWidth)*w.lineHeight-w.height,P=b*C,R=w.getScaledHeight()+P,A=0;d==="center"&&(A=w.getScaledWidth()/2),d==="right"&&(A=w.getScaledWidth()),w.set({left:w.left-A,top:w.top-(R-w.fontSize*(.07+w._fontSizeFraction))/w.lineHeight,strokeWidth:typeof v!="undefined"?v:1}),s(w)},i.Text.fromObject=function(n,s){var l=r(n),u=n.path;return delete l.path,i.Object._fromObject("Text",l,function(d){u?i.Object._fromObject("Path",u,function(f){d.set("path",f),s(d)},"path"):s(d)},"text")},i.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],i.util.createAccessors&&i.util.createAccessors(i.Text)}(e),function(){h.util.object.extend(h.Text.prototype,{isEmptyStyles:function(a){if(!this.styles||typeof a!="undefined"&&!this.styles[a])return!0;var i=typeof a=="undefined"?this.styles:{line:this.styles[a]};for(var r in i)for(var o in i[r])for(var n in i[r][o])return!1;return!0},styleHas:function(a,i){if(!this.styles||!a||a===""||typeof i!="undefined"&&!this.styles[i])return!1;var r=typeof i=="undefined"?this.styles:{0:this.styles[i]};for(var o in r)for(var n in r[o])if(typeof r[o][n][a]!="undefined")return!0;return!1},cleanStyle:function(a){if(!this.styles||!a||a==="")return!1;var i=this.styles,r=0,o,n,s=!0,l=0,u;for(var d in i){o=0;for(var f in i[d]){var u=i[d][f],p=u.hasOwnProperty(a);r++,p?(n?u[a]!==n&&(s=!1):n=u[a],u[a]===this[a]&&delete u[a]):s=!1,Object.keys(u).length!==0?o++:delete i[d][f]}o===0&&delete i[d]}for(var v=0;v<this._textLines.length;v++)l+=this._textLines[v].length;s&&r===l&&(this[a]=n,this.removeStyle(a))},removeStyle:function(a){if(!(!this.styles||!a||a==="")){var i=this.styles,r,o,n;for(o in i){r=i[o];for(n in r)delete r[n][a],Object.keys(r[n]).length===0&&delete r[n];Object.keys(r).length===0&&delete i[o]}}},_extendStyles:function(a,i){var r=this.get2DCursorLocation(a);this._getLineStyle(r.lineIndex)||this._setLineStyle(r.lineIndex),this._getStyleDeclaration(r.lineIndex,r.charIndex)||this._setStyleDeclaration(r.lineIndex,r.charIndex,{}),h.util.object.extend(this._getStyleDeclaration(r.lineIndex,r.charIndex),i)},get2DCursorLocation:function(a,i){typeof a=="undefined"&&(a=this.selectionStart);for(var r=i?this._unwrappedTextLines:this._textLines,o=r.length,n=0;n<o;n++){if(a<=r[n].length)return{lineIndex:n,charIndex:a};a-=r[n].length+this.missingNewlineOffset(n)}return{lineIndex:n-1,charIndex:r[n-1].length<a?r[n-1].length:a}},getSelectionStyles:function(a,i,r){typeof a=="undefined"&&(a=this.selectionStart||0),typeof i=="undefined"&&(i=this.selectionEnd||a);for(var o=[],n=a;n<i;n++)o.push(this.getStyleAtPosition(n,r));return o},getStyleAtPosition:function(a,i){var r=this.get2DCursorLocation(a),o=i?this.getCompleteStyleDeclaration(r.lineIndex,r.charIndex):this._getStyleDeclaration(r.lineIndex,r.charIndex);return o||{}},setSelectionStyles:function(a,i,r){typeof i=="undefined"&&(i=this.selectionStart||0),typeof r=="undefined"&&(r=this.selectionEnd||i);for(var o=i;o<r;o++)this._extendStyles(o,a);return this._forceClearCache=!0,this},_getStyleDeclaration:function(a,i){var r=this.styles&&this.styles[a];return r?r[i]:null},getCompleteStyleDeclaration:function(a,i){for(var r=this._getStyleDeclaration(a,i)||{},o={},n,s=0;s<this._styleProperties.length;s++)n=this._styleProperties[s],o[n]=typeof r[n]=="undefined"?this[n]:r[n];return o},_setStyleDeclaration:function(a,i,r){this.styles[a][i]=r},_deleteStyleDeclaration:function(a,i){delete this.styles[a][i]},_getLineStyle:function(a){return!!this.styles[a]},_setLineStyle:function(a){this.styles[a]={}},_deleteLineStyle:function(a){delete this.styles[a]}})}(),function(){function a(i){i.textDecoration&&(i.textDecoration.indexOf("underline")>-1&&(i.underline=!0),i.textDecoration.indexOf("line-through")>-1&&(i.linethrough=!0),i.textDecoration.indexOf("overline")>-1&&(i.overline=!0),delete i.textDecoration)}h.IText=h.util.createClass(h.Text,h.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(i,r){this.callSuper("initialize",i,r),this.initBehavior()},setSelectionStart:function(i){i=Math.max(i,0),this._updateAndFire("selectionStart",i)},setSelectionEnd:function(i){i=Math.min(i,this.text.length),this._updateAndFire("selectionEnd",i)},_updateAndFire:function(i,r){this[i]!==r&&(this._fireSelectionChanged(),this[i]=r),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(i){this.clearContextTop(),this.callSuper("render",i),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(i){this.callSuper("_render",i)},clearContextTop:function(i){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var r=this.canvas.contextTop,o=this.canvas.viewportTransform;r.save(),r.transform(o[0],o[1],o[2],o[3],o[4],o[5]),this.transform(r),this._clearTextArea(r),i||r.restore()}},renderCursorOrSelection:function(){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var i=this._getCursorBoundaries(),r=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(i,r):this.renderSelection(i,r),r.restore()}},_clearTextArea:function(i){var r=this.width+4,o=this.height+4;i.clearRect(-r/2,-o/2,r,o)},_getCursorBoundaries:function(i){typeof i=="undefined"&&(i=this.selectionStart);var r=this._getLeftOffset(),o=this._getTopOffset(),n=this._getCursorBoundariesOffsets(i);return{left:r,top:o,leftOffset:n.left,topOffset:n.top}},_getCursorBoundariesOffsets:function(i){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var r,o,n,s=0,l=0,u,d=this.get2DCursorLocation(i);n=d.charIndex,o=d.lineIndex;for(var f=0;f<o;f++)s+=this.getHeightOfLine(f);r=this._getLineLeftOffset(o);var p=this.__charBounds[o][n];return p&&(l=p.left),this.charSpacing!==0&&n===this._textLines[o].length&&(l-=this._getWidthOfCharSpacing()),u={top:s,left:r+(l>0?l:0)},this.direction==="rtl"&&(u.left*=-1),this.cursorOffsetCache=u,this.cursorOffsetCache},renderCursor:function(i,r){var o=this.get2DCursorLocation(),n=o.lineIndex,s=o.charIndex>0?o.charIndex-1:0,l=this.getValueOfPropertyAt(n,s,"fontSize"),u=this.scaleX*this.canvas.getZoom(),d=this.cursorWidth/u,f=i.topOffset,p=this.getValueOfPropertyAt(n,s,"deltaY");f+=(1-this._fontSizeFraction)*this.getHeightOfLine(n)/this.lineHeight-l*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(i,r),r.fillStyle=this.cursorColor||this.getValueOfPropertyAt(n,s,"fill"),r.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,r.fillRect(i.left+i.leftOffset-d/2,f+i.top+p,d,l)},renderSelection:function(i,r){for(var o=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,n=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,s=this.textAlign.indexOf("justify")!==-1,l=this.get2DCursorLocation(o),u=this.get2DCursorLocation(n),d=l.lineIndex,f=u.lineIndex,p=l.charIndex<0?0:l.charIndex,v=u.charIndex<0?0:u.charIndex,w=d;w<=f;w++){var C=this._getLineLeftOffset(w)||0,b=this.getHeightOfLine(w),P=0,R=0,A=0;if(w===d&&(R=this.__charBounds[d][p].left),w>=d&&w<f)A=s&&!this.isEndOfWrapping(w)?this.width:this.getLineWidth(w)||5;else if(w===f)if(v===0)A=this.__charBounds[f][v].left;else{var W=this._getWidthOfCharSpacing();A=this.__charBounds[f][v-1].left+this.__charBounds[f][v-1].width-W}P=b,(this.lineHeight<1||w===f&&this.lineHeight>1)&&(b/=this.lineHeight);var $=i.left+C+R,X=A-R,re=b,he=0;this.inCompositionMode?(r.fillStyle=this.compositionColor||"black",re=1,he=b):r.fillStyle=this.selectionColor,this.direction==="rtl"&&($=this.width-$-X),r.fillRect($,i.top+i.topOffset+he,X,re),i.topOffset+=P}},getCurrentCharFontSize:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fontSize")},getCurrentCharColor:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fill")},_getCurrentCharIndex:function(){var i=this.get2DCursorLocation(this.selectionStart,!0),r=i.charIndex>0?i.charIndex-1:0;return{l:i.lineIndex,c:r}}}),h.IText.fromObject=function(i,r){if(a(i),i.styles)for(var o in i.styles)for(var n in i.styles[o])a(i.styles[o][n]);h.Object._fromObject("IText",i,r,"text")}}(),function(){var a=h.util.object.clone;h.util.object.extend(h.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var i=this;this.on("added",function(){var r=i.canvas;r&&(r._hasITextHandlers||(r._hasITextHandlers=!0,i._initCanvasHandlers(r)),r._iTextInstances=r._iTextInstances||[],r._iTextInstances.push(i))})},initRemovedHandler:function(){var i=this;this.on("removed",function(){var r=i.canvas;r&&(r._iTextInstances=r._iTextInstances||[],h.util.removeFromArray(r._iTextInstances,i),r._iTextInstances.length===0&&(r._hasITextHandlers=!1,i._removeCanvasHandlers(r)))})},_initCanvasHandlers:function(i){i._mouseUpITextHandler=function(){i._iTextInstances&&i._iTextInstances.forEach(function(r){r.__isMousedown=!1})},i.on("mouse:up",i._mouseUpITextHandler)},_removeCanvasHandlers:function(i){i.off("mouse:up",i._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(i,r,o,n){var s;return s={isAborted:!1,abort:function(){this.isAborted=!0}},i.animate("_currentCursorOpacity",r,{duration:o,onComplete:function(){s.isAborted||i[n]()},onChange:function(){i.canvas&&i.selectionStart===i.selectionEnd&&i.renderCursorOrSelection()},abort:function(){return s.isAborted}}),s},_onTickComplete:function(){var i=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){i._currentTickCompleteState=i._animateCursor(i,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(i){var r=this,o=i?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){r._tick()},o)},abortCursorAnimation:function(){var i=this._currentTickState||this._currentTickCompleteState,r=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,i&&r&&r.clearContext(r.contextTop||r.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(i){var r=0,o=i-1;if(this._reSpace.test(this._text[o]))for(;this._reSpace.test(this._text[o]);)r++,o--;for(;/\S/.test(this._text[o])&&o>-1;)r++,o--;return i-r},findWordBoundaryRight:function(i){var r=0,o=i;if(this._reSpace.test(this._text[o]))for(;this._reSpace.test(this._text[o]);)r++,o++;for(;/\S/.test(this._text[o])&&o<this._text.length;)r++,o++;return i+r},findLineBoundaryLeft:function(i){for(var r=0,o=i-1;!/\n/.test(this._text[o])&&o>-1;)r++,o--;return i-r},findLineBoundaryRight:function(i){for(var r=0,o=i;!/\n/.test(this._text[o])&&o<this._text.length;)r++,o++;return i+r},searchWordBoundary:function(i,r){for(var o=this._text,n=this._reSpace.test(o[i])?i-1:i,s=o[n],l=h.reNonWord;!l.test(s)&&n>0&&n<o.length;)n+=r,s=o[n];return l.test(s)&&(n+=r===1?0:1),n},selectWord:function(i){i=i||this.selectionStart;var r=this.searchWordBoundary(i,-1),o=this.searchWordBoundary(i,1);this.selectionStart=r,this.selectionEnd=o,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(i){i=i||this.selectionStart;var r=this.findLineBoundaryLeft(i),o=this.findLineBoundaryRight(i);return this.selectionStart=r,this.selectionEnd=o,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(i){if(!(this.isEditing||!this.editable))return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(i),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(i){i._iTextInstances&&i._iTextInstances.forEach(function(r){r.selected=!1,r.isEditing&&r.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(i){if(!(!this.__isMousedown||!this.isEditing)){var r=this.getSelectionStartFromPointer(i.e),o=this.selectionStart,n=this.selectionEnd;(r!==this.__selectionStartOnMouseDown||o===n)&&(o===r||n===r)||(r>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=r):(this.selectionStart=r,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==o||this.selectionEnd!==n)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(i,r,o){var n=o.slice(0,i),s=h.util.string.graphemeSplit(n).length;if(i===r)return{selectionStart:s,selectionEnd:s};var l=o.slice(i,r),u=h.util.string.graphemeSplit(l).length;return{selectionStart:s,selectionEnd:s+u}},fromGraphemeToStringSelection:function(i,r,o){var n=o.slice(0,i),s=n.join("").length;if(i===r)return{selectionStart:s,selectionEnd:s};var l=o.slice(i,r),u=l.join("").length;return{selectionStart:s,selectionEnd:s+u}},_updateTextarea:function(){if(this.cursorOffsetCache={},!!this.hiddenTextarea){if(!this.inCompositionMode){var i=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=i.selectionStart,this.hiddenTextarea.selectionEnd=i.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(!!this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var i=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=i.selectionEnd,this.inCompositionMode||(this.selectionStart=i.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var i=this._calcTextareaPosition();this.hiddenTextarea.style.left=i.left,this.hiddenTextarea.style.top=i.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var i=this.inCompositionMode?this.compositionStart:this.selectionStart,r=this._getCursorBoundaries(i),o=this.get2DCursorLocation(i),n=o.lineIndex,s=o.charIndex,l=this.getValueOfPropertyAt(n,s,"fontSize")*this.lineHeight,u=r.leftOffset,d=this.calcTransformMatrix(),f={x:r.left+u,y:r.top+r.topOffset+l},p=this.canvas.getRetinaScaling(),v=this.canvas.upperCanvasEl,w=v.width/p,C=v.height/p,b=w-l,P=C-l,R=v.clientWidth/w,A=v.clientHeight/C;return f=h.util.transformPoint(f,d),f=h.util.transformPoint(f,this.canvas.viewportTransform),f.x*=R,f.y*=A,f.x<0&&(f.x=0),f.x>b&&(f.x=b),f.y<0&&(f.y=0),f.y>P&&(f.y=P),f.x+=this.canvas._offset.left,f.y+=this.canvas._offset.top,{left:f.x+"px",top:f.y+"px",fontSize:l+"px",charHeight:l}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){!this._savedProps||(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var i=this._textBeforeEdit!==this.text,r=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,r&&(r.blur&&r.blur(),r.parentNode&&r.parentNode.removeChild(r)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),i&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),i&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var i in this.styles)this._textLines[i]||delete this.styles[i]},removeStyleFromTo:function(i,r){var o=this.get2DCursorLocation(i,!0),n=this.get2DCursorLocation(r,!0),s=o.lineIndex,l=o.charIndex,u=n.lineIndex,d=n.charIndex,f,p;if(s!==u){if(this.styles[s])for(f=l;f<this._unwrappedTextLines[s].length;f++)delete this.styles[s][f];if(this.styles[u])for(f=d;f<this._unwrappedTextLines[u].length;f++)p=this.styles[u][f],p&&(this.styles[s]||(this.styles[s]={}),this.styles[s][l+f-d]=p);for(f=s+1;f<=u;f++)delete this.styles[f];this.shiftLineStyles(u,s-u)}else if(this.styles[s]){p=this.styles[s];var v=d-l,w,C;for(f=l;f<d;f++)delete p[f];for(C in this.styles[s])w=parseInt(C,10),w>=d&&(p[w-v]=p[C],delete p[C])}},shiftLineStyles:function(i,r){var o=a(this.styles);for(var n in this.styles){var s=parseInt(n,10);s>i&&(this.styles[s+r]=o[s],o[s-r]||delete this.styles[s])}},restartCursorIfNeeded:function(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()},insertNewlineStyleObject:function(i,r,o,n){var s,l={},u=!1,d=this._unwrappedTextLines[i].length===r;o||(o=1),this.shiftLineStyles(i,o),this.styles[i]&&(s=this.styles[i][r===0?r:r-1]);for(var f in this.styles[i]){var p=parseInt(f,10);p>=r&&(u=!0,l[p-r]=this.styles[i][f],d&&r===0||delete this.styles[i][f])}var v=!1;for(u&&!d&&(this.styles[i+o]=l,v=!0),v&&o--;o>0;)n&&n[o-1]?this.styles[i+o]={0:a(n[o-1])}:s?this.styles[i+o]={0:a(s)}:delete this.styles[i+o],o--;this._forceClearCache=!0},insertCharStyleObject:function(i,r,o,n){this.styles||(this.styles={});var s=this.styles[i],l=s?a(s):{};o||(o=1);for(var u in l){var d=parseInt(u,10);d>=r&&(s[d+o]=l[d],l[d-o]||delete s[d])}if(this._forceClearCache=!0,n){for(;o--;)!Object.keys(n[o]).length||(this.styles[i]||(this.styles[i]={}),this.styles[i][r+o]=a(n[o]));return}if(!!s)for(var f=s[r?r-1:1];f&&o--;)this.styles[i][r+o]=a(f)},insertNewStyleBlock:function(i,r,o){for(var n=this.get2DCursorLocation(r,!0),s=[0],l=0,u=0;u<i.length;u++)i[u]===`
`?(l++,s[l]=0):s[l]++;s[0]>0&&(this.insertCharStyleObject(n.lineIndex,n.charIndex,s[0],o),o=o&&o.slice(s[0]+1)),l&&this.insertNewlineStyleObject(n.lineIndex,n.charIndex+s[0],l);for(var u=1;u<l;u++)s[u]>0?this.insertCharStyleObject(n.lineIndex+u,0,s[u],o):o&&(this.styles[n.lineIndex+u][0]=o[0]),o=o&&o.slice(s[u]+1);s[u]>0&&this.insertCharStyleObject(n.lineIndex+u,0,s[u],o)},setSelectionStartEndWithShift:function(i,r,o){o<=i?(r===i?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=i),this.selectionStart=o):o>i&&o<r?this._selectionDirection==="right"?this.selectionEnd=o:this.selectionStart=o:(r===i?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=r),this.selectionEnd=o)},setSelectionInBoundaries:function(){var i=this.text.length;this.selectionStart>i?this.selectionStart=i:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>i?this.selectionEnd=i:this.selectionEnd<0&&(this.selectionEnd=0)}})}(),h.util.object.extend(h.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(a){if(!!this.canvas){this.__newClickTime=+new Date;var i=a.pointer;this.isTripleClick(i)&&(this.fire("tripleclick",a),this._stopEvent(a.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=i,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(a){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===a.x&&this.__lastPointer.y===a.y},_stopEvent:function(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(a){!this.isEditing||this.selectWord(this.getSelectionStartFromPointer(a.e))},tripleClickHandler:function(a){!this.isEditing||this.selectLine(this.getSelectionStartFromPointer(a.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(a){!this.canvas||!this.editable||a.e.button&&a.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(a.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(a){!this.canvas||!this.editable||a.e.button&&a.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(a){if(this.__isMousedown=!1,!(!this.editable||this.group||a.transform&&a.transform.actionPerformed||a.e.button&&a.e.button!==1)){if(this.canvas){var i=this.canvas._activeObject;if(i&&i!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(a.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(a){var i=this.getSelectionStartFromPointer(a),r=this.selectionStart,o=this.selectionEnd;a.shiftKey?this.setSelectionStartEndWithShift(r,o,i):(this.selectionStart=i,this.selectionEnd=i),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(a){for(var i=this.getLocalPointer(a),r=0,o=0,n=0,s=0,l=0,u,d,f=0,p=this._textLines.length;f<p&&n<=i.y;f++)n+=this.getHeightOfLine(f)*this.scaleY,l=f,f>0&&(s+=this._textLines[f-1].length+this.missingNewlineOffset(f-1));u=this._getLineLeftOffset(l),o=u*this.scaleX,d=this._textLines[l],this.direction==="rtl"&&(i.x=this.width*this.scaleX-i.x+o);for(var v=0,w=d.length;v<w&&(r=o,o+=this.__charBounds[l][v].kernedWidth*this.scaleX,o<=i.x);v++)s++;return this._getNewSelectionStartFromOffset(i,r,o,s,w)},_getNewSelectionStartFromOffset:function(a,i,r,o,n){var s=a.x-i,l=r-a.x,u=l>s||l<0?0:1,d=o+u;return this.flipX&&(d=n-d),d>this._text.length&&(d=this._text.length),d}}),h.util.object.extend(h.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=h.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var a=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+a.top+"; left: "+a.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding\uFF70top: "+a.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):h.document.body.appendChild(this.hiddenTextarea),h.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),h.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),h.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),h.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),h.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),h.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),h.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),h.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),h.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(h.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(a){if(!!this.isEditing){var i=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(a.keyCode in i)this[i[a.keyCode]](a);else if(a.keyCode in this.ctrlKeysMapDown&&(a.ctrlKey||a.metaKey))this[this.ctrlKeysMapDown[a.keyCode]](a);else return;a.stopImmediatePropagation(),a.preventDefault(),a.keyCode>=33&&a.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(a){if(!this.isEditing||this._copyDone||this.inCompositionMode){this._copyDone=!1;return}if(a.keyCode in this.ctrlKeysMapUp&&(a.ctrlKey||a.metaKey))this[this.ctrlKeysMapUp[a.keyCode]](a);else return;a.stopImmediatePropagation(),a.preventDefault(),this.canvas&&this.canvas.requestRenderAll()},onInput:function(a){var i=this.fromPaste;if(this.fromPaste=!1,a&&a.stopPropagation(),!!this.isEditing){var r=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,o=this._text.length,n=r.length,s,l,u=n-o,d=this.selectionStart,f=this.selectionEnd,p=d!==f,v,w,C;if(this.hiddenTextarea.value===""){this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}var b=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),P=d>b.selectionStart;p?(s=this._text.slice(d,f),u+=f-d):n<o&&(P?s=this._text.slice(f+u,f):s=this._text.slice(d,d-u)),l=r.slice(b.selectionEnd-u,b.selectionEnd),s&&s.length&&(l.length&&(v=this.getSelectionStyles(d,d+1,!1),v=l.map(function(){return v[0]})),p?(w=d,C=f):P?(w=f-s.length,C=f):(w=f,C=f+s.length),this.removeStyleFromTo(w,C)),l.length&&(i&&l.join("")===h.copiedText&&!h.disableStyleCopyPaste&&(v=h.copiedTextStyle),this.insertNewStyleBlock(l,d,v)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(a){this.compositionStart=a.target.selectionStart,this.compositionEnd=a.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(h.copiedText=this.getSelectedText(),h.disableStyleCopyPaste?h.copiedTextStyle=null:h.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(a){return a&&a.clipboardData||h.window.clipboardData},_getWidthBeforeCursor:function(a,i){var r=this._getLineLeftOffset(a),o;return i>0&&(o=this.__charBounds[a][i-1],r+=o.left+o.width),r},getDownCursorOffset:function(a,i){var r=this._getSelectionForOffset(a,i),o=this.get2DCursorLocation(r),n=o.lineIndex;if(n===this._textLines.length-1||a.metaKey||a.keyCode===34)return this._text.length-r;var s=o.charIndex,l=this._getWidthBeforeCursor(n,s),u=this._getIndexOnLine(n+1,l),d=this._textLines[n].slice(s);return d.length+u+1+this.missingNewlineOffset(n)},_getSelectionForOffset:function(a,i){return a.shiftKey&&this.selectionStart!==this.selectionEnd&&i?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(a,i){var r=this._getSelectionForOffset(a,i),o=this.get2DCursorLocation(r),n=o.lineIndex;if(n===0||a.metaKey||a.keyCode===33)return-r;var s=o.charIndex,l=this._getWidthBeforeCursor(n,s),u=this._getIndexOnLine(n-1,l),d=this._textLines[n].slice(0,s),f=this.missingNewlineOffset(n-1);return-this._textLines[n-1].length+u-d.length+(1-f)},_getIndexOnLine:function(a,i){for(var r=this._textLines[a],o=this._getLineLeftOffset(a),n=o,s=0,l,u,d=0,f=r.length;d<f;d++)if(l=this.__charBounds[a][d].width,n+=l,n>i){u=!0;var p=n-l,v=n,w=Math.abs(p-i),C=Math.abs(v-i);s=C<w?d:d-1;break}return u||(s=r.length-1),s},moveCursorDown:function(a){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",a)},moveCursorUp:function(a){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",a)},_moveCursorUpOrDown:function(a,i){var r="get"+a+"CursorOffset",o=this[r](i,this._selectionDirection==="right");i.shiftKey?this.moveCursorWithShift(o):this.moveCursorWithoutShift(o),o!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(a){var i=this._selectionDirection==="left"?this.selectionStart+a:this.selectionEnd+a;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,i),a!==0},moveCursorWithoutShift:function(a){return a<0?(this.selectionStart+=a,this.selectionEnd=this.selectionStart):(this.selectionEnd+=a,this.selectionStart=this.selectionEnd),a!==0},moveCursorLeft:function(a){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",a)},_move:function(a,i,r){var o;if(a.altKey)o=this["findWordBoundary"+r](this[i]);else if(a.metaKey||a.keyCode===35||a.keyCode===36)o=this["findLineBoundary"+r](this[i]);else return this[i]+=r==="Left"?-1:1,!0;if(typeof o!==void 0&&this[i]!==o)return this[i]=o,!0},_moveLeft:function(a,i){return this._move(a,i,"Left")},_moveRight:function(a,i){return this._move(a,i,"Right")},moveCursorLeftWithoutShift:function(a){var i=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(i=this._moveLeft(a,"selectionStart")),this.selectionEnd=this.selectionStart,i},moveCursorLeftWithShift:function(a){if(this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd)return this._moveLeft(a,"selectionEnd");if(this.selectionStart!==0)return this._selectionDirection="left",this._moveLeft(a,"selectionStart")},moveCursorRight:function(a){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",a)},_moveCursorLeftOrRight:function(a,i){var r="moveCursor"+a+"With";this._currentCursorOpacity=1,i.shiftKey?r+="Shift":r+="outShift",this[r](i)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(a){if(this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd)return this._moveRight(a,"selectionStart");if(this.selectionEnd!==this._text.length)return this._selectionDirection="right",this._moveRight(a,"selectionEnd")},moveCursorRightWithoutShift:function(a){var i=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(i=this._moveRight(a,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,i},removeChars:function(a,i){typeof i=="undefined"&&(i=a+1),this.removeStyleFromTo(a,i),this._text.splice(a,i-a),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(a,i,r,o){typeof o=="undefined"&&(o=r),o>r&&this.removeStyleFromTo(r,o);var n=h.util.string.graphemeSplit(a);this.insertNewStyleBlock(n,r,i),this._text=[].concat(this._text.slice(0,r),n,this._text.slice(o)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var a=h.util.toFixed,i=/  +/g;h.util.object.extend(h.Text.prototype,{_toSVG:function(){var r=this._getSVGLeftTopOffsets(),o=this._getSVGTextAndBg(r.textTop,r.textLeft);return this._wrapSVGTextAndBg(o)},toSVG:function(r){return this._createBaseSVGMarkup(this._toSVG(),{reviver:r,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(r){var o=!0,n=this.getSvgTextDecoration(this);return[r.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",n?'text-decoration="'+n+'" ':"",'style="',this.getSvgStyles(o),'"',this.addPaintOrder()," >",r.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(r,o){var n=[],s=[],l=r,u;this._setSVGBg(s);for(var d=0,f=this._textLines.length;d<f;d++)u=this._getLineLeftOffset(d),(this.textBackgroundColor||this.styleHas("textBackgroundColor",d))&&this._setSVGTextLineBg(s,d,o+u,l),this._setSVGTextLineText(n,d,o+u,l),l+=this.getHeightOfLine(d);return{textSpans:n,textBgRects:s}},_createTextCharSpan:function(r,o,n,s){var l=r!==r.trim()||r.match(i),u=this.getSvgSpanStyles(o,l),d=u?'style="'+u+'"':"",f=o.deltaY,p="",v=h.Object.NUM_FRACTION_DIGITS;return f&&(p=' dy="'+a(f,v)+'" '),['<tspan x="',a(n,v),'" y="',a(s,v),'" ',p,d,">",h.util.string.escapeXml(r),"</tspan>"].join("")},_setSVGTextLineText:function(r,o,n,s){var l=this.getHeightOfLine(o),u=this.textAlign.indexOf("justify")!==-1,d,f,p="",v,w,C=0,b=this._textLines[o],P;s+=l*(1-this._fontSizeFraction)/this.lineHeight;for(var R=0,A=b.length-1;R<=A;R++)P=R===A||this.charSpacing,p+=b[R],v=this.__charBounds[o][R],C===0?(n+=v.kernedWidth-v.width,C+=v.width):C+=v.kernedWidth,u&&!P&&this._reSpaceAndTab.test(b[R])&&(P=!0),P||(d=d||this.getCompleteStyleDeclaration(o,R),f=this.getCompleteStyleDeclaration(o,R+1),P=this._hasStyleChangedForSvg(d,f)),P&&(w=this._getStyleDeclaration(o,R)||{},r.push(this._createTextCharSpan(p,w,n,s)),p="",d=f,n+=C,C=0)},_pushTextBgRect:function(r,o,n,s,l,u){var d=h.Object.NUM_FRACTION_DIGITS;r.push("		<rect ",this._getFillAttributes(o),' x="',a(n,d),'" y="',a(s,d),'" width="',a(l,d),'" height="',a(u,d),`"></rect>
`)},_setSVGTextLineBg:function(r,o,n,s){for(var l=this._textLines[o],u=this.getHeightOfLine(o)/this.lineHeight,d=0,f=0,p,v,w=this.getValueOfPropertyAt(o,0,"textBackgroundColor"),C=0,b=l.length;C<b;C++)p=this.__charBounds[o][C],v=this.getValueOfPropertyAt(o,C,"textBackgroundColor"),v!==w?(w&&this._pushTextBgRect(r,w,n+f,s,d,u),f=p.left,d=p.width,w=v):d+=p.kernedWidth;v&&this._pushTextBgRect(r,v,n+f,s,d,u)},_getFillAttributes:function(r){var o=r&&typeof r=="string"?new h.Color(r):"";return!o||!o.getSource()||o.getAlpha()===1?'fill="'+r+'"':'opacity="'+o.getAlpha()+'" fill="'+o.setAlpha(1).toRgb()+'"'},_getSVGLineTopOffset:function(r){for(var o=0,n=0,s=0;s<r;s++)o+=this.getHeightOfLine(s);return n=this.getHeightOfLine(s),{lineTop:o,offset:(this._fontSizeMult-this._fontSizeFraction)*n/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(r){var o=h.Object.prototype.getSvgStyles.call(this,r);return o+" white-space: pre;"}})}(),function(a){var i=a.fabric||(a.fabric={});i.Textbox=i.util.createClass(i.IText,i.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:i.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(r){for(var o=0,n=0,s=0,l={},u=0;u<r.graphemeLines.length;u++)r.graphemeText[s]===`
`&&u>0?(n=0,s++,o++):!this.splitByGrapheme&&this._reSpaceAndTab.test(r.graphemeText[s])&&u>0&&(n++,s++),l[u]={line:o,offset:n},s+=r.graphemeLines[u].length,n+=r.graphemeLines[u].length;return l},styleHas:function(r,o){if(this._styleMap&&!this.isWrapping){var n=this._styleMap[o];n&&(o=n.line)}return i.Text.prototype.styleHas.call(this,r,o)},isEmptyStyles:function(r){if(!this.styles)return!0;var o=0,n=r+1,s,l,u=!1,d=this._styleMap[r],f=this._styleMap[r+1];d&&(r=d.line,o=d.offset),f&&(n=f.line,u=n===r,s=f.offset),l=typeof r=="undefined"?this.styles:{line:this.styles[r]};for(var p in l)for(var v in l[p])if(v>=o&&(!u||v<s))for(var w in l[p][v])return!1;return!0},_getStyleDeclaration:function(r,o){if(this._styleMap&&!this.isWrapping){var n=this._styleMap[r];if(!n)return null;r=n.line,o=n.offset+o}return this.callSuper("_getStyleDeclaration",r,o)},_setStyleDeclaration:function(r,o,n){var s=this._styleMap[r];r=s.line,o=s.offset+o,this.styles[r][o]=n},_deleteStyleDeclaration:function(r,o){var n=this._styleMap[r];r=n.line,o=n.offset+o,delete this.styles[r][o]},_getLineStyle:function(r){var o=this._styleMap[r];return!!this.styles[o.line]},_setLineStyle:function(r){var o=this._styleMap[r];this.styles[o.line]={}},_wrapText:function(r,o){var n=[],s;for(this.isWrapping=!0,s=0;s<r.length;s++)n=n.concat(this._wrapLine(r[s],s,o));return this.isWrapping=!1,n},_measureWord:function(r,o,n){var s=0,l,u=!0;n=n||0;for(var d=0,f=r.length;d<f;d++){var p=this._getGraphemeBox(r[d],o,d+n,l,u);s+=p.kernedWidth,l=r[d]}return s},_wrapLine:function(r,o,n,$){var l=0,u=this.splitByGrapheme,d=[],f=[],p=u?i.util.string.graphemeSplit(r):r.split(this._wordJoiners),v="",w=0,C=u?"":" ",b=0,P=0,R=0,A=!0,W=this._getWidthOfCharSpacing(),$=$||0;p.length===0&&p.push([]),n-=$;for(var X=0;X<p.length;X++)v=u?p[X]:i.util.string.graphemeSplit(p[X]),b=this._measureWord(v,o,w),w+=v.length,l+=P+b-W,l>n&&!A?(d.push(f),f=[],l=b,A=!0):l+=W,!A&&!u&&f.push(C),f=f.concat(v),P=u?0:this._measureWord([C],o,w),w++,A=!1,b>R&&(R=b);return X&&d.push(f),R+$>this.dynamicMinWidth&&(this.dynamicMinWidth=R-W+$),d},isEndOfWrapping:function(r){return!this._styleMap[r+1]||this._styleMap[r+1].line!==this._styleMap[r].line},missingNewlineOffset:function(r){return this.splitByGrapheme?this.isEndOfWrapping(r)?1:0:1},_splitTextIntoLines:function(r){for(var o=i.Text.prototype._splitTextIntoLines.call(this,r),n=this._wrapText(o.lines,this.width),s=new Array(n.length),l=0;l<n.length;l++)s[l]=n[l].join("");return o.lines=s,o.graphemeLines=n,o},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var r={};for(var o in this._styleMap)this._textLines[o]&&(r[this._styleMap[o].line]=1);for(var o in this.styles)r[o]||delete this.styles[o]},toObject:function(r){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(r))}}),i.Textbox.fromObject=function(r,o){return i.Object._fromObject("Textbox",r,o,"text")}}(e),function(){var a=h.controlsUtils,i=a.scaleSkewCursorStyleHandler,r=a.scaleCursorStyleHandler,o=a.scalingEqually,n=a.scalingYOrSkewingX,s=a.scalingXOrSkewingY,l=a.scaleOrSkewActionName,u=h.Object.prototype.controls;if(u.ml=new h.Control({x:-.5,y:0,cursorStyleHandler:i,actionHandler:s,getActionName:l}),u.mr=new h.Control({x:.5,y:0,cursorStyleHandler:i,actionHandler:s,getActionName:l}),u.mb=new h.Control({x:0,y:.5,cursorStyleHandler:i,actionHandler:n,getActionName:l}),u.mt=new h.Control({x:0,y:-.5,cursorStyleHandler:i,actionHandler:n,getActionName:l}),u.tl=new h.Control({x:-.5,y:-.5,cursorStyleHandler:r,actionHandler:o}),u.tr=new h.Control({x:.5,y:-.5,cursorStyleHandler:r,actionHandler:o}),u.bl=new h.Control({x:-.5,y:.5,cursorStyleHandler:r,actionHandler:o}),u.br=new h.Control({x:.5,y:.5,cursorStyleHandler:r,actionHandler:o}),u.mtr=new h.Control({x:0,y:-.5,actionHandler:a.rotationWithSnapping,cursorStyleHandler:a.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),h.Textbox){var d=h.Textbox.prototype.controls={};d.mtr=u.mtr,d.tr=u.tr,d.br=u.br,d.tl=u.tl,d.bl=u.bl,d.mt=u.mt,d.mb=u.mb,d.mr=new h.Control({x:.5,y:0,actionHandler:a.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),d.ml=new h.Control({x:-.5,y:0,actionHandler:a.changeWidth,cursorStyleHandler:i,actionName:"resizing"})}}()})(gn);function pn(e,h){return e<h?-1:e>h?1:e>=h?0:NaN}function sr(e){return e.length===1&&(e=ar(e)),{left:function(h,t,c,g){for(c==null&&(c=0),g==null&&(g=h.length);c<g;){var m=c+g>>>1;e(h[m],t)<0?c=m+1:g=m}return c},right:function(h,t,c,g){for(c==null&&(c=0),g==null&&(g=h.length);c<g;){var m=c+g>>>1;e(h[m],t)>0?g=m:c=m+1}return c}}}function ar(e){return function(h,t){return pn(e(h),t)}}var or=sr(pn),lr=or.right,Jt=Math.sqrt(50),$t=Math.sqrt(10),ei=Math.sqrt(2);function hr(e,h,t){var c,g=-1,m,y,a;if(h=+h,e=+e,t=+t,e===h&&t>0)return[e];if((c=h<e)&&(m=e,e=h,h=m),(a=wt(e,h,t))===0||!isFinite(a))return[];if(a>0)for(e=Math.ceil(e/a),h=Math.floor(h/a),y=new Array(m=Math.ceil(h-e+1));++g<m;)y[g]=(e+g)*a;else for(e=Math.floor(e*a),h=Math.ceil(h*a),y=new Array(m=Math.ceil(e-h+1));++g<m;)y[g]=(e-g)/a;return c&&y.reverse(),y}function wt(e,h,t){var c=(h-e)/Math.max(0,t),g=Math.floor(Math.log(c)/Math.LN10),m=c/Math.pow(10,g);return g>=0?(m>=Jt?10:m>=$t?5:m>=ei?2:1)*Math.pow(10,g):-Math.pow(10,-g)/(m>=Jt?10:m>=$t?5:m>=ei?2:1)}function cr(e,h,t){var c=Math.abs(h-e)/Math.max(0,t),g=Math.pow(10,Math.floor(Math.log(c)/Math.LN10)),m=c/g;return m>=Jt?g*=10:m>=$t?g*=5:m>=ei&&(g*=2),h<e?-g:g}var jt=Array.prototype.slice;function ur(e){return e}var Wt=1,Ut=2,ti=3,at=4,Ei=1e-6;function fr(e){return"translate("+(e+.5)+",0)"}function dr(e){return"translate(0,"+(e+.5)+")"}function gr(e){return function(h){return+e(h)}}function pr(e){var h=Math.max(0,e.bandwidth()-1)/2;return e.round()&&(h=Math.round(h)),function(t){return+e(t)+h}}function mr(){return!this.__axis}function mn(e,h){var t=[],c=null,g=null,m=6,y=6,a=3,i=e===Wt||e===at?-1:1,r=e===at||e===Ut?"x":"y",o=e===Wt||e===ti?fr:dr;function n(s){var l=c==null?h.ticks?h.ticks.apply(h,t):h.domain():c,u=g==null?h.tickFormat?h.tickFormat.apply(h,t):ur:g,d=Math.max(m,0)+a,f=h.range(),p=+f[0]+.5,v=+f[f.length-1]+.5,w=(h.bandwidth?pr:gr)(h.copy()),C=s.selection?s.selection():s,b=C.selectAll(".domain").data([null]),P=C.selectAll(".tick").data(l,h).order(),R=P.exit(),A=P.enter().append("g").attr("class","tick"),W=P.select("line"),$=P.select("text");b=b.merge(b.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),P=P.merge(A),W=W.merge(A.append("line").attr("stroke","currentColor").attr(r+"2",i*m)),$=$.merge(A.append("text").attr("fill","currentColor").attr(r,i*d).attr("dy",e===Wt?"0em":e===ti?"0.71em":"0.32em")),s!==C&&(b=b.transition(s),P=P.transition(s),W=W.transition(s),$=$.transition(s),R=R.transition(s).attr("opacity",Ei).attr("transform",function(X){return isFinite(X=w(X))?o(X):this.getAttribute("transform")}),A.attr("opacity",Ei).attr("transform",function(X){var re=this.parentNode.__axis;return o(re&&isFinite(re=re(X))?re:w(X))})),R.remove(),b.attr("d",e===at||e==Ut?y?"M"+i*y+","+p+"H0.5V"+v+"H"+i*y:"M0.5,"+p+"V"+v:y?"M"+p+","+i*y+"V0.5H"+v+"V"+i*y:"M"+p+",0.5H"+v),P.attr("opacity",1).attr("transform",function(X){return o(w(X))}),W.attr(r+"2",i*m),$.attr(r,i*d).text(u),C.filter(mr).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",e===Ut?"start":e===at?"end":"middle"),C.each(function(){this.__axis=w})}return n.scale=function(s){return arguments.length?(h=s,n):h},n.ticks=function(){return t=jt.call(arguments),n},n.tickArguments=function(s){return arguments.length?(t=s==null?[]:jt.call(s),n):t.slice()},n.tickValues=function(s){return arguments.length?(c=s==null?null:jt.call(s),n):c&&c.slice()},n.tickFormat=function(s){return arguments.length?(g=s,n):g},n.tickSize=function(s){return arguments.length?(m=y=+s,n):m},n.tickSizeInner=function(s){return arguments.length?(m=+s,n):m},n.tickSizeOuter=function(s){return arguments.length?(y=+s,n):y},n.tickPadding=function(s){return arguments.length?(a=+s,n):a},n}function vr(e){return mn(ti,e)}function yr(e){return mn(at,e)}var wr={value:function(){}};function vn(){for(var e=0,h=arguments.length,t={},c;e<h;++e){if(!(c=arguments[e]+"")||c in t||/[\s.]/.test(c))throw new Error("illegal type: "+c);t[c]=[]}return new _t(t)}function _t(e){this._=e}function _r(e,h){return e.trim().split(/^|\s+/).map(function(t){var c="",g=t.indexOf(".");if(g>=0&&(c=t.slice(g+1),t=t.slice(0,g)),t&&!h.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:c}})}_t.prototype=vn.prototype={constructor:_t,on:function(e,h){var t=this._,c=_r(e+"",t),g,m=-1,y=c.length;if(arguments.length<2){for(;++m<y;)if((g=(e=c[m]).type)&&(g=xr(t[g],e.name)))return g;return}if(h!=null&&typeof h!="function")throw new Error("invalid callback: "+h);for(;++m<y;)if(g=(e=c[m]).type)t[g]=Pi(t[g],e.name,h);else if(h==null)for(g in t)t[g]=Pi(t[g],e.name,null);return this},copy:function(){var e={},h=this._;for(var t in h)e[t]=h[t].slice();return new _t(e)},call:function(e,h){if((g=arguments.length-2)>0)for(var t=new Array(g),c=0,g,m;c<g;++c)t[c]=arguments[c+2];if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(m=this._[e],c=0,g=m.length;c<g;++c)m[c].value.apply(h,t)},apply:function(e,h,t){if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(var c=this._[e],g=0,m=c.length;g<m;++g)c[g].value.apply(h,t)}};function xr(e,h){for(var t=0,c=e.length,g;t<c;++t)if((g=e[t]).name===h)return g.value}function Pi(e,h,t){for(var c=0,g=e.length;c<g;++c)if(e[c].name===h){e[c]=wr,e=e.slice(0,c).concat(e.slice(c+1));break}return t!=null&&e.push({name:h,value:t}),e}var ii="http://www.w3.org/1999/xhtml",Oi={svg:"http://www.w3.org/2000/svg",xhtml:ii,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function Ft(e){var h=e+="",t=h.indexOf(":");return t>=0&&(h=e.slice(0,t))!=="xmlns"&&(e=e.slice(t+1)),Oi.hasOwnProperty(h)?{space:Oi[h],local:e}:e}function Cr(e){return function(){var h=this.ownerDocument,t=this.namespaceURI;return t===ii&&h.documentElement.namespaceURI===ii?h.createElement(e):h.createElementNS(t,e)}}function br(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}function yn(e){var h=Ft(e);return(h.local?br:Cr)(h)}function Tr(){}function fi(e){return e==null?Tr:function(){return this.querySelector(e)}}function Sr(e){typeof e!="function"&&(e=fi(e));for(var h=this._groups,t=h.length,c=new Array(t),g=0;g<t;++g)for(var m=h[g],y=m.length,a=c[g]=new Array(y),i,r,o=0;o<y;++o)(i=m[o])&&(r=e.call(i,i.__data__,o,m))&&("__data__"in i&&(r.__data__=i.__data__),a[o]=r);return new Re(c,this._parents)}function Er(){return[]}function wn(e){return e==null?Er:function(){return this.querySelectorAll(e)}}function Pr(e){typeof e!="function"&&(e=wn(e));for(var h=this._groups,t=h.length,c=[],g=[],m=0;m<t;++m)for(var y=h[m],a=y.length,i,r=0;r<a;++r)(i=y[r])&&(c.push(e.call(i,i.__data__,r,y)),g.push(i));return new Re(c,g)}function _n(e){return function(){return this.matches(e)}}function Or(e){typeof e!="function"&&(e=_n(e));for(var h=this._groups,t=h.length,c=new Array(t),g=0;g<t;++g)for(var m=h[g],y=m.length,a=c[g]=[],i,r=0;r<y;++r)(i=m[r])&&e.call(i,i.__data__,r,m)&&a.push(i);return new Re(c,this._parents)}function xn(e){return new Array(e.length)}function Rr(){return new Re(this._enter||this._groups.map(xn),this._parents)}function Tt(e,h){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=h}Tt.prototype={constructor:Tt,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,h){return this._parent.insertBefore(e,h)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}};function Dr(e){return function(){return e}}var Ri="$";function Mr(e,h,t,c,g,m){for(var y=0,a,i=h.length,r=m.length;y<r;++y)(a=h[y])?(a.__data__=m[y],c[y]=a):t[y]=new Tt(e,m[y]);for(;y<i;++y)(a=h[y])&&(g[y]=a)}function kr(e,h,t,c,g,m,y){var a,i,r={},o=h.length,n=m.length,s=new Array(o),l;for(a=0;a<o;++a)(i=h[a])&&(s[a]=l=Ri+y.call(i,i.__data__,a,h),l in r?g[a]=i:r[l]=i);for(a=0;a<n;++a)l=Ri+y.call(e,m[a],a,m),(i=r[l])?(c[a]=i,i.__data__=m[a],r[l]=null):t[a]=new Tt(e,m[a]);for(a=0;a<o;++a)(i=h[a])&&r[s[a]]===i&&(g[a]=i)}function Ir(e,h){if(!e)return l=new Array(this.size()),r=-1,this.each(function(P){l[++r]=P}),l;var t=h?kr:Mr,c=this._parents,g=this._groups;typeof e!="function"&&(e=Dr(e));for(var m=g.length,y=new Array(m),a=new Array(m),i=new Array(m),r=0;r<m;++r){var o=c[r],n=g[r],s=n.length,l=e.call(o,o&&o.__data__,r,c),u=l.length,d=a[r]=new Array(u),f=y[r]=new Array(u),p=i[r]=new Array(s);t(o,n,d,f,p,l,h);for(var v=0,w=0,C,b;v<u;++v)if(C=d[v]){for(v>=w&&(w=v+1);!(b=f[w])&&++w<u;);C._next=b||null}}return y=new Re(y,c),y._enter=a,y._exit=i,y}function Ar(){return new Re(this._exit||this._groups.map(xn),this._parents)}function Fr(e,h,t){var c=this.enter(),g=this,m=this.exit();return c=typeof e=="function"?e(c):c.append(e+""),h!=null&&(g=h(g)),t==null?m.remove():t(m),c&&g?c.merge(g).order():g}function Lr(e){for(var h=this._groups,t=e._groups,c=h.length,g=t.length,m=Math.min(c,g),y=new Array(c),a=0;a<m;++a)for(var i=h[a],r=t[a],o=i.length,n=y[a]=new Array(o),s,l=0;l<o;++l)(s=i[l]||r[l])&&(n[l]=s);for(;a<c;++a)y[a]=h[a];return new Re(y,this._parents)}function Br(){for(var e=this._groups,h=-1,t=e.length;++h<t;)for(var c=e[h],g=c.length-1,m=c[g],y;--g>=0;)(y=c[g])&&(m&&y.compareDocumentPosition(m)^4&&m.parentNode.insertBefore(y,m),m=y);return this}function Hr(e){e||(e=Nr);function h(n,s){return n&&s?e(n.__data__,s.__data__):!n-!s}for(var t=this._groups,c=t.length,g=new Array(c),m=0;m<c;++m){for(var y=t[m],a=y.length,i=g[m]=new Array(a),r,o=0;o<a;++o)(r=y[o])&&(i[o]=r);i.sort(h)}return new Re(g,this._parents).order()}function Nr(e,h){return e<h?-1:e>h?1:e>=h?0:NaN}function zr(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this}function jr(){var e=new Array(this.size()),h=-1;return this.each(function(){e[++h]=this}),e}function Wr(){for(var e=this._groups,h=0,t=e.length;h<t;++h)for(var c=e[h],g=0,m=c.length;g<m;++g){var y=c[g];if(y)return y}return null}function Ur(){var e=0;return this.each(function(){++e}),e}function Gr(){return!this.node()}function Vr(e){for(var h=this._groups,t=0,c=h.length;t<c;++t)for(var g=h[t],m=0,y=g.length,a;m<y;++m)(a=g[m])&&e.call(a,a.__data__,m,g);return this}function Xr(e){return function(){this.removeAttribute(e)}}function Yr(e){return function(){this.removeAttributeNS(e.space,e.local)}}function qr(e,h){return function(){this.setAttribute(e,h)}}function Zr(e,h){return function(){this.setAttributeNS(e.space,e.local,h)}}function Kr(e,h){return function(){var t=h.apply(this,arguments);t==null?this.removeAttribute(e):this.setAttribute(e,t)}}function Qr(e,h){return function(){var t=h.apply(this,arguments);t==null?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,t)}}function Jr(e,h){var t=Ft(e);if(arguments.length<2){var c=this.node();return t.local?c.getAttributeNS(t.space,t.local):c.getAttribute(t)}return this.each((h==null?t.local?Yr:Xr:typeof h=="function"?t.local?Qr:Kr:t.local?Zr:qr)(t,h))}function Cn(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function $r(e){return function(){this.style.removeProperty(e)}}function es(e,h,t){return function(){this.style.setProperty(e,h,t)}}function ts(e,h,t){return function(){var c=h.apply(this,arguments);c==null?this.style.removeProperty(e):this.style.setProperty(e,c,t)}}function is(e,h,t){return arguments.length>1?this.each((h==null?$r:typeof h=="function"?ts:es)(e,h,t==null?"":t)):Ze(this.node(),e)}function Ze(e,h){return e.style.getPropertyValue(h)||Cn(e).getComputedStyle(e,null).getPropertyValue(h)}function ns(e){return function(){delete this[e]}}function rs(e,h){return function(){this[e]=h}}function ss(e,h){return function(){var t=h.apply(this,arguments);t==null?delete this[e]:this[e]=t}}function as(e,h){return arguments.length>1?this.each((h==null?ns:typeof h=="function"?ss:rs)(e,h)):this.node()[e]}function bn(e){return e.trim().split(/^|\s+/)}function di(e){return e.classList||new Tn(e)}function Tn(e){this._node=e,this._names=bn(e.getAttribute("class")||"")}Tn.prototype={add:function(e){var h=this._names.indexOf(e);h<0&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var h=this._names.indexOf(e);h>=0&&(this._names.splice(h,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};function Sn(e,h){for(var t=di(e),c=-1,g=h.length;++c<g;)t.add(h[c])}function En(e,h){for(var t=di(e),c=-1,g=h.length;++c<g;)t.remove(h[c])}function os(e){return function(){Sn(this,e)}}function ls(e){return function(){En(this,e)}}function hs(e,h){return function(){(h.apply(this,arguments)?Sn:En)(this,e)}}function cs(e,h){var t=bn(e+"");if(arguments.length<2){for(var c=di(this.node()),g=-1,m=t.length;++g<m;)if(!c.contains(t[g]))return!1;return!0}return this.each((typeof h=="function"?hs:h?os:ls)(t,h))}function us(){this.textContent=""}function fs(e){return function(){this.textContent=e}}function ds(e){return function(){var h=e.apply(this,arguments);this.textContent=h==null?"":h}}function gs(e){return arguments.length?this.each(e==null?us:(typeof e=="function"?ds:fs)(e)):this.node().textContent}function ps(){this.innerHTML=""}function ms(e){return function(){this.innerHTML=e}}function vs(e){return function(){var h=e.apply(this,arguments);this.innerHTML=h==null?"":h}}function ys(e){return arguments.length?this.each(e==null?ps:(typeof e=="function"?vs:ms)(e)):this.node().innerHTML}function ws(){this.nextSibling&&this.parentNode.appendChild(this)}function _s(){return this.each(ws)}function xs(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function Cs(){return this.each(xs)}function bs(e){var h=typeof e=="function"?e:yn(e);return this.select(function(){return this.appendChild(h.apply(this,arguments))})}function Ts(){return null}function Ss(e,h){var t=typeof e=="function"?e:yn(e),c=h==null?Ts:typeof h=="function"?h:fi(h);return this.select(function(){return this.insertBefore(t.apply(this,arguments),c.apply(this,arguments)||null)})}function Es(){var e=this.parentNode;e&&e.removeChild(this)}function Ps(){return this.each(Es)}function Os(){var e=this.cloneNode(!1),h=this.parentNode;return h?h.insertBefore(e,this.nextSibling):e}function Rs(){var e=this.cloneNode(!0),h=this.parentNode;return h?h.insertBefore(e,this.nextSibling):e}function Ds(e){return this.select(e?Rs:Os)}function Ms(e){return arguments.length?this.property("__data__",e):this.node().__data__}var Pn={},xt=null;if(typeof document!="undefined"){var ks=document.documentElement;"onmouseenter"in ks||(Pn={mouseenter:"mouseover",mouseleave:"mouseout"})}function Is(e,h,t){return e=On(e,h,t),function(c){var g=c.relatedTarget;(!g||g!==this&&!(g.compareDocumentPosition(this)&8))&&e.call(this,c)}}function On(e,h,t){return function(c){var g=xt;xt=c;try{e.call(this,this.__data__,h,t)}finally{xt=g}}}function As(e){return e.trim().split(/^|\s+/).map(function(h){var t="",c=h.indexOf(".");return c>=0&&(t=h.slice(c+1),h=h.slice(0,c)),{type:h,name:t}})}function Fs(e){return function(){var h=this.__on;if(!!h){for(var t=0,c=-1,g=h.length,m;t<g;++t)m=h[t],(!e.type||m.type===e.type)&&m.name===e.name?this.removeEventListener(m.type,m.listener,m.capture):h[++c]=m;++c?h.length=c:delete this.__on}}}function Ls(e,h,t){var c=Pn.hasOwnProperty(e.type)?Is:On;return function(g,m,y){var a=this.__on,i,r=c(h,m,y);if(a){for(var o=0,n=a.length;o<n;++o)if((i=a[o]).type===e.type&&i.name===e.name){this.removeEventListener(i.type,i.listener,i.capture),this.addEventListener(i.type,i.listener=r,i.capture=t),i.value=h;return}}this.addEventListener(e.type,r,t),i={type:e.type,name:e.name,value:h,listener:r,capture:t},a?a.push(i):this.__on=[i]}}function Bs(e,h,t){var c=As(e+""),g,m=c.length,y;if(arguments.length<2){var a=this.node().__on;if(a){for(var i=0,r=a.length,o;i<r;++i)for(g=0,o=a[i];g<m;++g)if((y=c[g]).type===o.type&&y.name===o.name)return o.value}return}for(a=h?Ls:Fs,t==null&&(t=!1),g=0;g<m;++g)this.each(a(c[g],h,t));return this}function Rn(e,h,t){var c=Cn(e),g=c.CustomEvent;typeof g=="function"?g=new g(h,t):(g=c.document.createEvent("Event"),t?(g.initEvent(h,t.bubbles,t.cancelable),g.detail=t.detail):g.initEvent(h,!1,!1)),e.dispatchEvent(g)}function Hs(e,h){return function(){return Rn(this,e,h)}}function Ns(e,h){return function(){return Rn(this,e,h.apply(this,arguments))}}function zs(e,h){return this.each((typeof h=="function"?Ns:Hs)(e,h))}var Dn=[null];function Re(e,h){this._groups=e,this._parents=h}function gt(){return new Re([[document.documentElement]],Dn)}Re.prototype=gt.prototype={constructor:Re,select:Sr,selectAll:Pr,filter:Or,data:Ir,enter:Rr,exit:Ar,join:Fr,merge:Lr,order:Br,sort:Hr,call:zr,nodes:jr,node:Wr,size:Ur,empty:Gr,each:Vr,attr:Jr,style:is,property:as,classed:cs,text:gs,html:ys,raise:_s,lower:Cs,append:bs,insert:Ss,remove:Ps,clone:Ds,datum:Ms,on:Bs,dispatch:zs};function $e(e){return typeof e=="string"?new Re([[document.querySelector(e)]],[document.documentElement]):new Re([[e]],Dn)}function js(){for(var e=xt,h;h=e.sourceEvent;)e=h;return e}function Ws(e,h){var t=e.ownerSVGElement||e;if(t.createSVGPoint){var c=t.createSVGPoint();return c.x=h.clientX,c.y=h.clientY,c=c.matrixTransform(e.getScreenCTM().inverse()),[c.x,c.y]}var g=e.getBoundingClientRect();return[h.clientX-g.left-e.clientLeft,h.clientY-g.top-e.clientTop]}function Di(e){var h=js();return h.changedTouches&&(h=h.changedTouches[0]),Ws(e,h)}function gi(e,h,t){e.prototype=h.prototype=t,t.constructor=e}function Mn(e,h){var t=Object.create(e.prototype);for(var c in h)t[c]=h[c];return t}function pt(){}var ct=.7,St=1/ct,Xe="\\s*([+-]?\\d+)\\s*",ut="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\s*",Fe="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Us=/^#([0-9a-f]{3,8})$/,Gs=new RegExp("^rgb\\("+[Xe,Xe,Xe]+"\\)$"),Vs=new RegExp("^rgb\\("+[Fe,Fe,Fe]+"\\)$"),Xs=new RegExp("^rgba\\("+[Xe,Xe,Xe,ut]+"\\)$"),Ys=new RegExp("^rgba\\("+[Fe,Fe,Fe,ut]+"\\)$"),qs=new RegExp("^hsl\\("+[ut,Fe,Fe]+"\\)$"),Zs=new RegExp("^hsla\\("+[ut,Fe,Fe,ut]+"\\)$"),Mi={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};gi(pt,ze,{copy:function(e){return Object.assign(new this.constructor,this,e)},displayable:function(){return this.rgb().displayable()},hex:ki,formatHex:ki,formatHsl:Ks,formatRgb:Ii,toString:Ii});function ki(){return this.rgb().formatHex()}function Ks(){return kn(this).formatHsl()}function Ii(){return this.rgb().formatRgb()}function ze(e){var h,t;return e=(e+"").trim().toLowerCase(),(h=Us.exec(e))?(t=h[1].length,h=parseInt(h[1],16),t===6?Ai(h):t===3?new Oe(h>>8&15|h>>4&240,h>>4&15|h&240,(h&15)<<4|h&15,1):t===8?mt(h>>24&255,h>>16&255,h>>8&255,(h&255)/255):t===4?mt(h>>12&15|h>>8&240,h>>8&15|h>>4&240,h>>4&15|h&240,((h&15)<<4|h&15)/255):null):(h=Gs.exec(e))?new Oe(h[1],h[2],h[3],1):(h=Vs.exec(e))?new Oe(h[1]*255/100,h[2]*255/100,h[3]*255/100,1):(h=Xs.exec(e))?mt(h[1],h[2],h[3],h[4]):(h=Ys.exec(e))?mt(h[1]*255/100,h[2]*255/100,h[3]*255/100,h[4]):(h=qs.exec(e))?Bi(h[1],h[2]/100,h[3]/100,1):(h=Zs.exec(e))?Bi(h[1],h[2]/100,h[3]/100,h[4]):Mi.hasOwnProperty(e)?Ai(Mi[e]):e==="transparent"?new Oe(NaN,NaN,NaN,0):null}function Ai(e){return new Oe(e>>16&255,e>>8&255,e&255,1)}function mt(e,h,t,c){return c<=0&&(e=h=t=NaN),new Oe(e,h,t,c)}function Qs(e){return e instanceof pt||(e=ze(e)),e?(e=e.rgb(),new Oe(e.r,e.g,e.b,e.opacity)):new Oe}function ni(e,h,t,c){return arguments.length===1?Qs(e):new Oe(e,h,t,c==null?1:c)}function Oe(e,h,t,c){this.r=+e,this.g=+h,this.b=+t,this.opacity=+c}gi(Oe,ni,Mn(pt,{brighter:function(e){return e=e==null?St:Math.pow(St,e),new Oe(this.r*e,this.g*e,this.b*e,this.opacity)},darker:function(e){return e=e==null?ct:Math.pow(ct,e),new Oe(this.r*e,this.g*e,this.b*e,this.opacity)},rgb:function(){return this},displayable:function(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Fi,formatHex:Fi,formatRgb:Li,toString:Li}));function Fi(){return"#"+Gt(this.r)+Gt(this.g)+Gt(this.b)}function Li(){var e=this.opacity;return e=isNaN(e)?1:Math.max(0,Math.min(1,e)),(e===1?"rgb(":"rgba(")+Math.max(0,Math.min(255,Math.round(this.r)||0))+", "+Math.max(0,Math.min(255,Math.round(this.g)||0))+", "+Math.max(0,Math.min(255,Math.round(this.b)||0))+(e===1?")":", "+e+")")}function Gt(e){return e=Math.max(0,Math.min(255,Math.round(e)||0)),(e<16?"0":"")+e.toString(16)}function Bi(e,h,t,c){return c<=0?e=h=t=NaN:t<=0||t>=1?e=h=NaN:h<=0&&(e=NaN),new Ae(e,h,t,c)}function kn(e){if(e instanceof Ae)return new Ae(e.h,e.s,e.l,e.opacity);if(e instanceof pt||(e=ze(e)),!e)return new Ae;if(e instanceof Ae)return e;e=e.rgb();var h=e.r/255,t=e.g/255,c=e.b/255,g=Math.min(h,t,c),m=Math.max(h,t,c),y=NaN,a=m-g,i=(m+g)/2;return a?(h===m?y=(t-c)/a+(t<c)*6:t===m?y=(c-h)/a+2:y=(h-t)/a+4,a/=i<.5?m+g:2-m-g,y*=60):a=i>0&&i<1?0:y,new Ae(y,a,i,e.opacity)}function Js(e,h,t,c){return arguments.length===1?kn(e):new Ae(e,h,t,c==null?1:c)}function Ae(e,h,t,c){this.h=+e,this.s=+h,this.l=+t,this.opacity=+c}gi(Ae,Js,Mn(pt,{brighter:function(e){return e=e==null?St:Math.pow(St,e),new Ae(this.h,this.s,this.l*e,this.opacity)},darker:function(e){return e=e==null?ct:Math.pow(ct,e),new Ae(this.h,this.s,this.l*e,this.opacity)},rgb:function(){var e=this.h%360+(this.h<0)*360,h=isNaN(e)||isNaN(this.s)?0:this.s,t=this.l,c=t+(t<.5?t:1-t)*h,g=2*t-c;return new Oe(Vt(e>=240?e-240:e+120,g,c),Vt(e,g,c),Vt(e<120?e+240:e-120,g,c),this.opacity)},displayable:function(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl:function(){var e=this.opacity;return e=isNaN(e)?1:Math.max(0,Math.min(1,e)),(e===1?"hsl(":"hsla(")+(this.h||0)+", "+(this.s||0)*100+"%, "+(this.l||0)*100+"%"+(e===1?")":", "+e+")")}}));function Vt(e,h,t){return(e<60?h+(t-h)*e/60:e<180?t:e<240?h+(t-h)*(240-e)/60:h)*255}function pi(e){return function(){return e}}function $s(e,h){return function(t){return e+t*h}}function ea(e,h,t){return e=Math.pow(e,t),h=Math.pow(h,t)-e,t=1/t,function(c){return Math.pow(e+c*h,t)}}function ta(e){return(e=+e)==1?In:function(h,t){return t-h?ea(h,t,e):pi(isNaN(h)?t:h)}}function In(e,h){var t=h-e;return t?$s(e,t):pi(isNaN(e)?h:e)}var Et=function e(h){var t=ta(h);function c(g,m){var y=t((g=ni(g)).r,(m=ni(m)).r),a=t(g.g,m.g),i=t(g.b,m.b),r=In(g.opacity,m.opacity);return function(o){return g.r=y(o),g.g=a(o),g.b=i(o),g.opacity=r(o),g+""}}return c.gamma=e,c}(1);function ia(e,h){h||(h=[]);var t=e?Math.min(h.length,e.length):0,c=h.slice(),g;return function(m){for(g=0;g<t;++g)c[g]=e[g]*(1-m)+h[g]*m;return c}}function na(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function ra(e,h){var t=h?h.length:0,c=e?Math.min(t,e.length):0,g=new Array(c),m=new Array(t),y;for(y=0;y<c;++y)g[y]=mi(e[y],h[y]);for(;y<t;++y)m[y]=h[y];return function(a){for(y=0;y<c;++y)m[y]=g[y](a);return m}}function sa(e,h){var t=new Date;return e=+e,h=+h,function(c){return t.setTime(e*(1-c)+h*c),t}}function Me(e,h){return e=+e,h=+h,function(t){return e*(1-t)+h*t}}function aa(e,h){var t={},c={},g;(e===null||typeof e!="object")&&(e={}),(h===null||typeof h!="object")&&(h={});for(g in h)g in e?t[g]=mi(e[g],h[g]):c[g]=h[g];return function(m){for(g in t)c[g]=t[g](m);return c}}var ri=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Xt=new RegExp(ri.source,"g");function oa(e){return function(){return e}}function la(e){return function(h){return e(h)+""}}function An(e,h){var t=ri.lastIndex=Xt.lastIndex=0,c,g,m,y=-1,a=[],i=[];for(e=e+"",h=h+"";(c=ri.exec(e))&&(g=Xt.exec(h));)(m=g.index)>t&&(m=h.slice(t,m),a[y]?a[y]+=m:a[++y]=m),(c=c[0])===(g=g[0])?a[y]?a[y]+=g:a[++y]=g:(a[++y]=null,i.push({i:y,x:Me(c,g)})),t=Xt.lastIndex;return t<h.length&&(m=h.slice(t),a[y]?a[y]+=m:a[++y]=m),a.length<2?i[0]?la(i[0].x):oa(h):(h=i.length,function(r){for(var o=0,n;o<h;++o)a[(n=i[o]).i]=n.x(r);return a.join("")})}function mi(e,h){var t=typeof h,c;return h==null||t==="boolean"?pi(h):(t==="number"?Me:t==="string"?(c=ze(h))?(h=c,Et):An:h instanceof ze?Et:h instanceof Date?sa:na(h)?ia:Array.isArray(h)?ra:typeof h.valueOf!="function"&&typeof h.toString!="function"||isNaN(h)?aa:Me)(e,h)}function ha(e,h){return e=+e,h=+h,function(t){return Math.round(e*(1-t)+h*t)}}var Hi=180/Math.PI,si={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function Fn(e,h,t,c,g,m){var y,a,i;return(y=Math.sqrt(e*e+h*h))&&(e/=y,h/=y),(i=e*t+h*c)&&(t-=e*i,c-=h*i),(a=Math.sqrt(t*t+c*c))&&(t/=a,c/=a,i/=a),e*c<h*t&&(e=-e,h=-h,i=-i,y=-y),{translateX:g,translateY:m,rotate:Math.atan2(h,e)*Hi,skewX:Math.atan(i)*Hi,scaleX:y,scaleY:a}}var et,Yt,Ni,vt;function ca(e){return e==="none"?si:(et||(et=document.createElement("DIV"),Yt=document.documentElement,Ni=document.defaultView),et.style.transform=e,e=Ni.getComputedStyle(Yt.appendChild(et),null).getPropertyValue("transform"),Yt.removeChild(et),e=e.slice(7,-1).split(","),Fn(+e[0],+e[1],+e[2],+e[3],+e[4],+e[5]))}function ua(e){return e==null||(vt||(vt=document.createElementNS("http://www.w3.org/2000/svg","g")),vt.setAttribute("transform",e),!(e=vt.transform.baseVal.consolidate()))?si:(e=e.matrix,Fn(e.a,e.b,e.c,e.d,e.e,e.f))}function Ln(e,h,t,c){function g(r){return r.length?r.pop()+" ":""}function m(r,o,n,s,l,u){if(r!==n||o!==s){var d=l.push("translate(",null,h,null,t);u.push({i:d-4,x:Me(r,n)},{i:d-2,x:Me(o,s)})}else(n||s)&&l.push("translate("+n+h+s+t)}function y(r,o,n,s){r!==o?(r-o>180?o+=360:o-r>180&&(r+=360),s.push({i:n.push(g(n)+"rotate(",null,c)-2,x:Me(r,o)})):o&&n.push(g(n)+"rotate("+o+c)}function a(r,o,n,s){r!==o?s.push({i:n.push(g(n)+"skewX(",null,c)-2,x:Me(r,o)}):o&&n.push(g(n)+"skewX("+o+c)}function i(r,o,n,s,l,u){if(r!==n||o!==s){var d=l.push(g(l)+"scale(",null,",",null,")");u.push({i:d-4,x:Me(r,n)},{i:d-2,x:Me(o,s)})}else(n!==1||s!==1)&&l.push(g(l)+"scale("+n+","+s+")")}return function(r,o){var n=[],s=[];return r=e(r),o=e(o),m(r.translateX,r.translateY,o.translateX,o.translateY,n,s),y(r.rotate,o.rotate,n,s),a(r.skewX,o.skewX,n,s),i(r.scaleX,r.scaleY,o.scaleX,o.scaleY,n,s),r=o=null,function(l){for(var u=-1,d=s.length,f;++u<d;)n[(f=s[u]).i]=f.x(l);return n.join("")}}}var fa=Ln(ca,"px, ","px)","deg)"),da=Ln(ua,", ",")",")"),Ke=0,ot=0,tt=0,Bn=1e3,Pt,lt,Ot=0,je=0,Lt=0,ft=typeof performance=="object"&&performance.now?performance:Date,Hn=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function Bt(){return je||(Hn(ga),je=ft.now()+Lt)}function ga(){je=0}function Rt(){this._call=this._time=this._next=null}Rt.prototype=Nn.prototype={constructor:Rt,restart:function(e,h,t){if(typeof e!="function")throw new TypeError("callback is not a function");t=(t==null?Bt():+t)+(h==null?0:+h),!this._next&&lt!==this&&(lt?lt._next=this:Pt=this,lt=this),this._call=e,this._time=t,ai()},stop:function(){this._call&&(this._call=null,this._time=1/0,ai())}};function Nn(e,h,t){var c=new Rt;return c.restart(e,h,t),c}function pa(){Bt(),++Ke;for(var e=Pt,h;e;)(h=je-e._time)>=0&&e._call.call(null,h),e=e._next;--Ke}function zi(){je=(Ot=ft.now())+Lt,Ke=ot=0;try{pa()}finally{Ke=0,va(),je=0}}function ma(){var e=ft.now(),h=e-Ot;h>Bn&&(Lt-=h,Ot=e)}function va(){for(var e,h=Pt,t,c=1/0;h;)h._call?(c>h._time&&(c=h._time),e=h,h=h._next):(t=h._next,h._next=null,h=e?e._next=t:Pt=t);lt=e,ai(c)}function ai(e){if(!Ke){ot&&(ot=clearTimeout(ot));var h=e-je;h>24?(e<1/0&&(ot=setTimeout(zi,e-ft.now()-Lt)),tt&&(tt=clearInterval(tt))):(tt||(Ot=ft.now(),tt=setInterval(ma,Bn)),Ke=1,Hn(zi))}}function ji(e,h,t){var c=new Rt;return h=h==null?0:+h,c.restart(function(g){c.stop(),e(g+h)},h,t),c}var ya=vn("start","end","cancel","interrupt"),wa=[],zn=0,Wi=1,oi=2,Ct=3,Ui=4,li=5,bt=6;function Ht(e,h,t,c,g,m){var y=e.__transition;if(!y)e.__transition={};else if(t in y)return;_a(e,t,{name:h,index:c,group:g,on:ya,tween:wa,time:m.time,delay:m.delay,duration:m.duration,ease:m.ease,timer:null,state:zn})}function vi(e,h){var t=ke(e,h);if(t.state>zn)throw new Error("too late; already scheduled");return t}function Be(e,h){var t=ke(e,h);if(t.state>Ct)throw new Error("too late; already running");return t}function ke(e,h){var t=e.__transition;if(!t||!(t=t[h]))throw new Error("transition not found");return t}function _a(e,h,t){var c=e.__transition,g;c[h]=t,t.timer=Nn(m,0,t.time);function m(r){t.state=Wi,t.timer.restart(y,t.delay,t.time),t.delay<=r&&y(r-t.delay)}function y(r){var o,n,s,l;if(t.state!==Wi)return i();for(o in c)if(l=c[o],l.name===t.name){if(l.state===Ct)return ji(y);l.state===Ui?(l.state=bt,l.timer.stop(),l.on.call("interrupt",e,e.__data__,l.index,l.group),delete c[o]):+o<h&&(l.state=bt,l.timer.stop(),l.on.call("cancel",e,e.__data__,l.index,l.group),delete c[o])}if(ji(function(){t.state===Ct&&(t.state=Ui,t.timer.restart(a,t.delay,t.time),a(r))}),t.state=oi,t.on.call("start",e,e.__data__,t.index,t.group),t.state===oi){for(t.state=Ct,g=new Array(s=t.tween.length),o=0,n=-1;o<s;++o)(l=t.tween[o].value.call(e,e.__data__,t.index,t.group))&&(g[++n]=l);g.length=n+1}}function a(r){for(var o=r<t.duration?t.ease.call(null,r/t.duration):(t.timer.restart(i),t.state=li,1),n=-1,s=g.length;++n<s;)g[n].call(e,o);t.state===li&&(t.on.call("end",e,e.__data__,t.index,t.group),i())}function i(){t.state=bt,t.timer.stop(),delete c[h];for(var r in c)return;delete e.__transition}}function xa(e,h){var t=e.__transition,c,g,m=!0,y;if(!!t){h=h==null?null:h+"";for(y in t){if((c=t[y]).name!==h){m=!1;continue}g=c.state>oi&&c.state<li,c.state=bt,c.timer.stop(),c.on.call(g?"interrupt":"cancel",e,e.__data__,c.index,c.group),delete t[y]}m&&delete e.__transition}}function Ca(e){return this.each(function(){xa(this,e)})}function ba(e,h){var t,c;return function(){var g=Be(this,e),m=g.tween;if(m!==t){c=t=m;for(var y=0,a=c.length;y<a;++y)if(c[y].name===h){c=c.slice(),c.splice(y,1);break}}g.tween=c}}function Ta(e,h,t){var c,g;if(typeof t!="function")throw new Error;return function(){var m=Be(this,e),y=m.tween;if(y!==c){g=(c=y).slice();for(var a={name:h,value:t},i=0,r=g.length;i<r;++i)if(g[i].name===h){g[i]=a;break}i===r&&g.push(a)}m.tween=g}}function Sa(e,h){var t=this._id;if(e+="",arguments.length<2){for(var c=ke(this.node(),t).tween,g=0,m=c.length,y;g<m;++g)if((y=c[g]).name===e)return y.value;return null}return this.each((h==null?ba:Ta)(t,e,h))}function yi(e,h,t){var c=e._id;return e.each(function(){var g=Be(this,c);(g.value||(g.value={}))[h]=t.apply(this,arguments)}),function(g){return ke(g,c).value[h]}}function jn(e,h){var t;return(typeof h=="number"?Me:h instanceof ze?Et:(t=ze(h))?(h=t,Et):An)(e,h)}function Ea(e){return function(){this.removeAttribute(e)}}function Pa(e){return function(){this.removeAttributeNS(e.space,e.local)}}function Oa(e,h,t){var c,g=t+"",m;return function(){var y=this.getAttribute(e);return y===g?null:y===c?m:m=h(c=y,t)}}function Ra(e,h,t){var c,g=t+"",m;return function(){var y=this.getAttributeNS(e.space,e.local);return y===g?null:y===c?m:m=h(c=y,t)}}function Da(e,h,t){var c,g,m;return function(){var y,a=t(this),i;return a==null?void this.removeAttribute(e):(y=this.getAttribute(e),i=a+"",y===i?null:y===c&&i===g?m:(g=i,m=h(c=y,a)))}}function Ma(e,h,t){var c,g,m;return function(){var y,a=t(this),i;return a==null?void this.removeAttributeNS(e.space,e.local):(y=this.getAttributeNS(e.space,e.local),i=a+"",y===i?null:y===c&&i===g?m:(g=i,m=h(c=y,a)))}}function ka(e,h){var t=Ft(e),c=t==="transform"?da:jn;return this.attrTween(e,typeof h=="function"?(t.local?Ma:Da)(t,c,yi(this,"attr."+e,h)):h==null?(t.local?Pa:Ea)(t):(t.local?Ra:Oa)(t,c,h))}function Ia(e,h){return function(t){this.setAttribute(e,h.call(this,t))}}function Aa(e,h){return function(t){this.setAttributeNS(e.space,e.local,h.call(this,t))}}function Fa(e,h){var t,c;function g(){var m=h.apply(this,arguments);return m!==c&&(t=(c=m)&&Aa(e,m)),t}return g._value=h,g}function La(e,h){var t,c;function g(){var m=h.apply(this,arguments);return m!==c&&(t=(c=m)&&Ia(e,m)),t}return g._value=h,g}function Ba(e,h){var t="attr."+e;if(arguments.length<2)return(t=this.tween(t))&&t._value;if(h==null)return this.tween(t,null);if(typeof h!="function")throw new Error;var c=Ft(e);return this.tween(t,(c.local?Fa:La)(c,h))}function Ha(e,h){return function(){vi(this,e).delay=+h.apply(this,arguments)}}function Na(e,h){return h=+h,function(){vi(this,e).delay=h}}function za(e){var h=this._id;return arguments.length?this.each((typeof e=="function"?Ha:Na)(h,e)):ke(this.node(),h).delay}function ja(e,h){return function(){Be(this,e).duration=+h.apply(this,arguments)}}function Wa(e,h){return h=+h,function(){Be(this,e).duration=h}}function Ua(e){var h=this._id;return arguments.length?this.each((typeof e=="function"?ja:Wa)(h,e)):ke(this.node(),h).duration}function Ga(e,h){if(typeof h!="function")throw new Error;return function(){Be(this,e).ease=h}}function Va(e){var h=this._id;return arguments.length?this.each(Ga(h,e)):ke(this.node(),h).ease}function Xa(e){typeof e!="function"&&(e=_n(e));for(var h=this._groups,t=h.length,c=new Array(t),g=0;g<t;++g)for(var m=h[g],y=m.length,a=c[g]=[],i,r=0;r<y;++r)(i=m[r])&&e.call(i,i.__data__,r,m)&&a.push(i);return new Le(c,this._parents,this._name,this._id)}function Ya(e){if(e._id!==this._id)throw new Error;for(var h=this._groups,t=e._groups,c=h.length,g=t.length,m=Math.min(c,g),y=new Array(c),a=0;a<m;++a)for(var i=h[a],r=t[a],o=i.length,n=y[a]=new Array(o),s,l=0;l<o;++l)(s=i[l]||r[l])&&(n[l]=s);for(;a<c;++a)y[a]=h[a];return new Le(y,this._parents,this._name,this._id)}function qa(e){return(e+"").trim().split(/^|\s+/).every(function(h){var t=h.indexOf(".");return t>=0&&(h=h.slice(0,t)),!h||h==="start"})}function Za(e,h,t){var c,g,m=qa(h)?vi:Be;return function(){var y=m(this,e),a=y.on;a!==c&&(g=(c=a).copy()).on(h,t),y.on=g}}function Ka(e,h){var t=this._id;return arguments.length<2?ke(this.node(),t).on.on(e):this.each(Za(t,e,h))}function Qa(e){return function(){var h=this.parentNode;for(var t in this.__transition)if(+t!==e)return;h&&h.removeChild(this)}}function Ja(){return this.on("end.remove",Qa(this._id))}function $a(e){var h=this._name,t=this._id;typeof e!="function"&&(e=fi(e));for(var c=this._groups,g=c.length,m=new Array(g),y=0;y<g;++y)for(var a=c[y],i=a.length,r=m[y]=new Array(i),o,n,s=0;s<i;++s)(o=a[s])&&(n=e.call(o,o.__data__,s,a))&&("__data__"in o&&(n.__data__=o.__data__),r[s]=n,Ht(r[s],h,t,s,r,ke(o,t)));return new Le(m,this._parents,h,t)}function eo(e){var h=this._name,t=this._id;typeof e!="function"&&(e=wn(e));for(var c=this._groups,g=c.length,m=[],y=[],a=0;a<g;++a)for(var i=c[a],r=i.length,o,n=0;n<r;++n)if(o=i[n]){for(var s=e.call(o,o.__data__,n,i),l,u=ke(o,t),d=0,f=s.length;d<f;++d)(l=s[d])&&Ht(l,h,t,d,s,u);m.push(s),y.push(o)}return new Le(m,y,h,t)}var to=gt.prototype.constructor;function io(){return new to(this._groups,this._parents)}function no(e,h){var t,c,g;return function(){var m=Ze(this,e),y=(this.style.removeProperty(e),Ze(this,e));return m===y?null:m===t&&y===c?g:g=h(t=m,c=y)}}function Wn(e){return function(){this.style.removeProperty(e)}}function ro(e,h,t){var c,g=t+"",m;return function(){var y=Ze(this,e);return y===g?null:y===c?m:m=h(c=y,t)}}function so(e,h,t){var c,g,m;return function(){var y=Ze(this,e),a=t(this),i=a+"";return a==null&&(i=a=(this.style.removeProperty(e),Ze(this,e))),y===i?null:y===c&&i===g?m:(g=i,m=h(c=y,a))}}function ao(e,h){var t,c,g,m="style."+h,y="end."+m,a;return function(){var i=Be(this,e),r=i.on,o=i.value[m]==null?a||(a=Wn(h)):void 0;(r!==t||g!==o)&&(c=(t=r).copy()).on(y,g=o),i.on=c}}function oo(e,h,t){var c=(e+="")=="transform"?fa:jn;return h==null?this.styleTween(e,no(e,c)).on("end.style."+e,Wn(e)):typeof h=="function"?this.styleTween(e,so(e,c,yi(this,"style."+e,h))).each(ao(this._id,e)):this.styleTween(e,ro(e,c,h),t).on("end.style."+e,null)}function lo(e,h,t){return function(c){this.style.setProperty(e,h.call(this,c),t)}}function ho(e,h,t){var c,g;function m(){var y=h.apply(this,arguments);return y!==g&&(c=(g=y)&&lo(e,y,t)),c}return m._value=h,m}function co(e,h,t){var c="style."+(e+="");if(arguments.length<2)return(c=this.tween(c))&&c._value;if(h==null)return this.tween(c,null);if(typeof h!="function")throw new Error;return this.tween(c,ho(e,h,t==null?"":t))}function uo(e){return function(){this.textContent=e}}function fo(e){return function(){var h=e(this);this.textContent=h==null?"":h}}function go(e){return this.tween("text",typeof e=="function"?fo(yi(this,"text",e)):uo(e==null?"":e+""))}function po(e){return function(h){this.textContent=e.call(this,h)}}function mo(e){var h,t;function c(){var g=e.apply(this,arguments);return g!==t&&(h=(t=g)&&po(g)),h}return c._value=e,c}function vo(e){var h="text";if(arguments.length<1)return(h=this.tween(h))&&h._value;if(e==null)return this.tween(h,null);if(typeof e!="function")throw new Error;return this.tween(h,mo(e))}function yo(){for(var e=this._name,h=this._id,t=Un(),c=this._groups,g=c.length,m=0;m<g;++m)for(var y=c[m],a=y.length,i,r=0;r<a;++r)if(i=y[r]){var o=ke(i,h);Ht(i,e,t,r,y,{time:o.time+o.delay+o.duration,delay:0,duration:o.duration,ease:o.ease})}return new Le(c,this._parents,e,t)}function wo(){var e,h,t=this,c=t._id,g=t.size();return new Promise(function(m,y){var a={value:y},i={value:function(){--g===0&&m()}};t.each(function(){var r=Be(this,c),o=r.on;o!==e&&(h=(e=o).copy(),h._.cancel.push(a),h._.interrupt.push(a),h._.end.push(i)),r.on=h})})}var _o=0;function Le(e,h,t,c){this._groups=e,this._parents=h,this._name=t,this._id=c}function Un(){return++_o}var Ue=gt.prototype;Le.prototype={constructor:Le,select:$a,selectAll:eo,filter:Xa,merge:Ya,selection:io,transition:yo,call:Ue.call,nodes:Ue.nodes,node:Ue.node,size:Ue.size,empty:Ue.empty,each:Ue.each,on:Ka,attr:ka,attrTween:Ba,style:oo,styleTween:co,text:go,textTween:vo,remove:Ja,tween:Sa,delay:za,duration:Ua,ease:Va,end:wo};function xo(e){return((e*=2)<=1?e*e*e:(e-=2)*e*e+2)/2}var hi={time:null,delay:0,duration:250,ease:xo};function Co(e,h){for(var t;!(t=e.__transition)||!(t=t[h]);)if(!(e=e.parentNode))return hi.time=Bt(),hi;return t}function bo(e){var h,t;e instanceof Le?(h=e._id,e=e._name):(h=Un(),(t=hi).time=Bt(),e=e==null?null:e+"");for(var c=this._groups,g=c.length,m=0;m<g;++m)for(var y=c[m],a=y.length,i,r=0;r<a;++r)(i=y[r])&&Ht(i,e,h,r,y,t||Co(i,h));return new Le(c,this._parents,e,h)}gt.prototype.interrupt=Ca;gt.prototype.transition=bo;var De="$";function Dt(){}Dt.prototype=Gn.prototype={constructor:Dt,has:function(e){return De+e in this},get:function(e){return this[De+e]},set:function(e,h){return this[De+e]=h,this},remove:function(e){var h=De+e;return h in this&&delete this[h]},clear:function(){for(var e in this)e[0]===De&&delete this[e]},keys:function(){var e=[];for(var h in this)h[0]===De&&e.push(h.slice(1));return e},values:function(){var e=[];for(var h in this)h[0]===De&&e.push(this[h]);return e},entries:function(){var e=[];for(var h in this)h[0]===De&&e.push({key:h.slice(1),value:this[h]});return e},size:function(){var e=0;for(var h in this)h[0]===De&&++e;return e},empty:function(){for(var e in this)if(e[0]===De)return!1;return!0},each:function(e){for(var h in this)h[0]===De&&e(this[h],h.slice(1),this)}};function Gn(e,h){var t=new Dt;if(e instanceof Dt)e.each(function(a,i){t.set(i,a)});else if(Array.isArray(e)){var c=-1,g=e.length,m;if(h==null)for(;++c<g;)t.set(c,e[c]);else for(;++c<g;)t.set(h(m=e[c],c,e),m)}else if(e)for(var y in e)t.set(y,e[y]);return t}function Gi(){}var Ne=Gn.prototype;Gi.prototype={constructor:Gi,has:Ne.has,add:function(e){return e+="",this[De+e]=e,this},remove:Ne.remove,clear:Ne.clear,values:Ne.keys,size:Ne.size,empty:Ne.empty,each:Ne.each};function To(e){return Math.abs(e=Math.round(e))>=1e21?e.toLocaleString("en").replace(/,/g,""):e.toString(10)}function Mt(e,h){if((t=(e=h?e.toExponential(h-1):e.toExponential()).indexOf("e"))<0)return null;var t,c=e.slice(0,t);return[c.length>1?c[0]+c.slice(2):c,+e.slice(t+1)]}function Qe(e){return e=Mt(Math.abs(e)),e?e[1]:NaN}function So(e,h){return function(t,c){for(var g=t.length,m=[],y=0,a=e[0],i=0;g>0&&a>0&&(i+a+1>c&&(a=Math.max(1,c-i)),m.push(t.substring(g-=a,g+a)),!((i+=a+1)>c));)a=e[y=(y+1)%e.length];return m.reverse().join(h)}}function Eo(e){return function(h){return h.replace(/[0-9]/g,function(t){return e[+t]})}}var Po=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function kt(e){if(!(h=Po.exec(e)))throw new Error("invalid format: "+e);var h;return new wi({fill:h[1],align:h[2],sign:h[3],symbol:h[4],zero:h[5],width:h[6],comma:h[7],precision:h[8]&&h[8].slice(1),trim:h[9],type:h[10]})}kt.prototype=wi.prototype;function wi(e){this.fill=e.fill===void 0?" ":e.fill+"",this.align=e.align===void 0?">":e.align+"",this.sign=e.sign===void 0?"-":e.sign+"",this.symbol=e.symbol===void 0?"":e.symbol+"",this.zero=!!e.zero,this.width=e.width===void 0?void 0:+e.width,this.comma=!!e.comma,this.precision=e.precision===void 0?void 0:+e.precision,this.trim=!!e.trim,this.type=e.type===void 0?"":e.type+""}wi.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function Oo(e){e:for(var h=e.length,t=1,c=-1,g;t<h;++t)switch(e[t]){case".":c=g=t;break;case"0":c===0&&(c=t),g=t;break;default:if(!+e[t])break e;c>0&&(c=0);break}return c>0?e.slice(0,c)+e.slice(g+1):e}var Vn;function Ro(e,h){var t=Mt(e,h);if(!t)return e+"";var c=t[0],g=t[1],m=g-(Vn=Math.max(-8,Math.min(8,Math.floor(g/3)))*3)+1,y=c.length;return m===y?c:m>y?c+new Array(m-y+1).join("0"):m>0?c.slice(0,m)+"."+c.slice(m):"0."+new Array(1-m).join("0")+Mt(e,Math.max(0,h+m-1))[0]}function Vi(e,h){var t=Mt(e,h);if(!t)return e+"";var c=t[0],g=t[1];return g<0?"0."+new Array(-g).join("0")+c:c.length>g+1?c.slice(0,g+1)+"."+c.slice(g+1):c+new Array(g-c.length+2).join("0")}var Xi={"%":function(e,h){return(e*100).toFixed(h)},b:function(e){return Math.round(e).toString(2)},c:function(e){return e+""},d:To,e:function(e,h){return e.toExponential(h)},f:function(e,h){return e.toFixed(h)},g:function(e,h){return e.toPrecision(h)},o:function(e){return Math.round(e).toString(8)},p:function(e,h){return Vi(e*100,h)},r:Vi,s:Ro,X:function(e){return Math.round(e).toString(16).toUpperCase()},x:function(e){return Math.round(e).toString(16)}};function Yi(e){return e}var qi=Array.prototype.map,Zi=["y","z","a","f","p","n","\xB5","m","","k","M","G","T","P","E","Z","Y"];function Do(e){var h=e.grouping===void 0||e.thousands===void 0?Yi:So(qi.call(e.grouping,Number),e.thousands+""),t=e.currency===void 0?"":e.currency[0]+"",c=e.currency===void 0?"":e.currency[1]+"",g=e.decimal===void 0?".":e.decimal+"",m=e.numerals===void 0?Yi:Eo(qi.call(e.numerals,String)),y=e.percent===void 0?"%":e.percent+"",a=e.minus===void 0?"-":e.minus+"",i=e.nan===void 0?"NaN":e.nan+"";function r(n){n=kt(n);var s=n.fill,l=n.align,u=n.sign,d=n.symbol,f=n.zero,p=n.width,v=n.comma,w=n.precision,C=n.trim,b=n.type;b==="n"?(v=!0,b="g"):Xi[b]||(w===void 0&&(w=12),C=!0,b="g"),(f||s==="0"&&l==="=")&&(f=!0,s="0",l="=");var P=d==="$"?t:d==="#"&&/[boxX]/.test(b)?"0"+b.toLowerCase():"",R=d==="$"?c:/[%p]/.test(b)?y:"",A=Xi[b],W=/[defgprs%]/.test(b);w=w===void 0?6:/[gprs]/.test(b)?Math.max(1,Math.min(21,w)):Math.max(0,Math.min(20,w));function $(X){var re=P,he=R,ne,ce,ue;if(b==="c")he=A(X)+he,X="";else{X=+X;var de=X<0||1/X<0;if(X=isNaN(X)?i:A(Math.abs(X),w),C&&(X=Oo(X)),de&&+X==0&&u!=="+"&&(de=!1),re=(de?u==="("?u:a:u==="-"||u==="("?"":u)+re,he=(b==="s"?Zi[8+Vn/3]:"")+he+(de&&u==="("?")":""),W){for(ne=-1,ce=X.length;++ne<ce;)if(ue=X.charCodeAt(ne),48>ue||ue>57){he=(ue===46?g+X.slice(ne+1):X.slice(ne))+he,X=X.slice(0,ne);break}}}v&&!f&&(X=h(X,1/0));var fe=re.length+X.length+he.length,L=fe<p?new Array(p-fe+1).join(s):"";switch(v&&f&&(X=h(L+X,L.length?p-he.length:1/0),L=""),l){case"<":X=re+X+he+L;break;case"=":X=re+L+X+he;break;case"^":X=L.slice(0,fe=L.length>>1)+re+X+he+L.slice(fe);break;default:X=L+re+X+he;break}return m(X)}return $.toString=function(){return n+""},$}function o(n,s){var l=r((n=kt(n),n.type="f",n)),u=Math.max(-8,Math.min(8,Math.floor(Qe(s)/3)))*3,d=Math.pow(10,-u),f=Zi[8+u/3];return function(p){return l(d*p)+f}}return{format:r,formatPrefix:o}}var yt,Xn,Yn;Mo({decimal:".",thousands:",",grouping:[3],currency:["$",""],minus:"-"});function Mo(e){return yt=Do(e),Xn=yt.format,Yn=yt.formatPrefix,yt}function ko(e){return Math.max(0,-Qe(Math.abs(e)))}function Io(e,h){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(Qe(h)/3)))*3-Qe(Math.abs(e)))}function Ao(e,h){return e=Math.abs(e),h=Math.abs(h)-e,Math.max(0,Qe(h)-Qe(e))+1}function Je(){return Math.random()}(function e(h){function t(c,g){return c=c==null?0:+c,g=g==null?1:+g,arguments.length===1?(g=c,c=0):g-=c,function(){return h()*g+c}}return t.source=e,t})(Je);var Fo=function e(h){function t(c,g){var m,y;return c=c==null?0:+c,g=g==null?1:+g,function(){var a;if(m!=null)a=m,m=null;else do m=h()*2-1,a=h()*2-1,y=m*m+a*a;while(!y||y>1);return c+g*a*Math.sqrt(-2*Math.log(y)/y)}}return t.source=e,t}(Je);(function e(h){function t(){var c=Fo.source(h).apply(this,arguments);return function(){return Math.exp(c())}}return t.source=e,t})(Je);var Lo=function e(h){function t(c){return function(){for(var g=0,m=0;m<c;++m)g+=h();return g}}return t.source=e,t}(Je);(function e(h){function t(c){var g=Lo.source(h)(c);return function(){return g()/c}}return t.source=e,t})(Je);(function e(h){function t(c){return function(){return-Math.log(1-h())/c}}return t.source=e,t})(Je);function Bo(e,h){switch(arguments.length){case 0:break;case 1:this.range(e);break;default:this.range(h).domain(e);break}return this}var qn=Array.prototype,Ho=qn.map,Ki=qn.slice;function No(e){return function(){return e}}function zo(e){return+e}var Qi=[0,1];function He(e){return e}function ci(e,h){return(h-=e=+e)?function(t){return(t-e)/h}:No(isNaN(h)?NaN:.5)}function Ji(e){var h=e[0],t=e[e.length-1],c;return h>t&&(c=h,h=t,t=c),function(g){return Math.max(h,Math.min(t,g))}}function jo(e,h,t){var c=e[0],g=e[1],m=h[0],y=h[1];return g<c?(c=ci(g,c),m=t(y,m)):(c=ci(c,g),m=t(m,y)),function(a){return m(c(a))}}function Wo(e,h,t){var c=Math.min(e.length,h.length)-1,g=new Array(c),m=new Array(c),y=-1;for(e[c]<e[0]&&(e=e.slice().reverse(),h=h.slice().reverse());++y<c;)g[y]=ci(e[y],e[y+1]),m[y]=t(h[y],h[y+1]);return function(a){var i=lr(e,a,1,c)-1;return m[i](g[i](a))}}function Uo(e,h){return h.domain(e.domain()).range(e.range()).interpolate(e.interpolate()).clamp(e.clamp()).unknown(e.unknown())}function Go(){var e=Qi,h=Qi,t=mi,c,g,m,y=He,a,i,r;function o(){return a=Math.min(e.length,h.length)>2?Wo:jo,i=r=null,n}function n(s){return isNaN(s=+s)?m:(i||(i=a(e.map(c),h,t)))(c(y(s)))}return n.invert=function(s){return y(g((r||(r=a(h,e.map(c),Me)))(s)))},n.domain=function(s){return arguments.length?(e=Ho.call(s,zo),y===He||(y=Ji(e)),o()):e.slice()},n.range=function(s){return arguments.length?(h=Ki.call(s),o()):h.slice()},n.rangeRound=function(s){return h=Ki.call(s),t=ha,o()},n.clamp=function(s){return arguments.length?(y=s?Ji(e):He,n):y!==He},n.interpolate=function(s){return arguments.length?(t=s,o()):t},n.unknown=function(s){return arguments.length?(m=s,n):m},function(s,l){return c=s,g=l,o()}}function Vo(e,h,t,c){var g=cr(e,h,t),m;switch(c=kt(c==null?",f":c),c.type){case"s":{var y=Math.max(Math.abs(e),Math.abs(h));return c.precision==null&&!isNaN(m=Io(g,y))&&(c.precision=m),Yn(c,y)}case"":case"e":case"g":case"p":case"r":{c.precision==null&&!isNaN(m=Ao(g,Math.max(Math.abs(e),Math.abs(h))))&&(c.precision=m-(c.type==="e"));break}case"f":case"%":{c.precision==null&&!isNaN(m=ko(g))&&(c.precision=m-(c.type==="%")*2);break}}return Xn(c)}function Xo(e){var h=e.domain;return e.ticks=function(t){var c=h();return hr(c[0],c[c.length-1],t==null?10:t)},e.tickFormat=function(t,c){var g=h();return Vo(g[0],g[g.length-1],t==null?10:t,c)},e.nice=function(t){t==null&&(t=10);var c=h(),g=0,m=c.length-1,y=c[g],a=c[m],i;return a<y&&(i=y,y=a,a=i,i=g,g=m,m=i),i=wt(y,a,t),i>0?(y=Math.floor(y/i)*i,a=Math.ceil(a/i)*i,i=wt(y,a,t)):i<0&&(y=Math.ceil(y*i)/i,a=Math.floor(a*i)/i,i=wt(y,a,t)),i>0?(c[g]=Math.floor(y/i)*i,c[m]=Math.ceil(a/i)*i,h(c)):i<0&&(c[g]=Math.ceil(y*i)/i,c[m]=Math.floor(a*i)/i,h(c)),e},e}function $i(e){return function(h){return h<0?-Math.pow(-h,e):Math.pow(h,e)}}function Yo(e){return e<0?-Math.sqrt(-e):Math.sqrt(e)}function qo(e){return e<0?-e*e:e*e}function Zo(e){var h=e(He,He),t=1;function c(){return t===1?e(He,He):t===.5?e(Yo,qo):e($i(t),$i(1/t))}return h.exponent=function(g){return arguments.length?(t=+g,c()):t},Xo(h)}function Zn(){var e=Zo(Go());return e.copy=function(){return Uo(e,Zn()).exponent(e.exponent())},Bo.apply(e,arguments),e}function en(){return Zn.apply(null,arguments).exponent(.5)}function It(){this._=null}function Nt(e){e.U=e.C=e.L=e.R=e.P=e.N=null}It.prototype={constructor:It,insert:function(e,h){var t,c,g;if(e){if(h.P=e,h.N=e.N,e.N&&(e.N.P=h),e.N=h,e.R){for(e=e.R;e.L;)e=e.L;e.L=h}else e.R=h;t=e}else this._?(e=tn(this._),h.P=null,h.N=e,e.P=e.L=h,t=e):(h.P=h.N=null,this._=h,t=null);for(h.L=h.R=null,h.U=t,h.C=!0,e=h;t&&t.C;)c=t.U,t===c.L?(g=c.R,g&&g.C?(t.C=g.C=!1,c.C=!0,e=c):(e===t.R&&(it(this,t),e=t,t=e.U),t.C=!1,c.C=!0,nt(this,c))):(g=c.L,g&&g.C?(t.C=g.C=!1,c.C=!0,e=c):(e===t.L&&(nt(this,t),e=t,t=e.U),t.C=!1,c.C=!0,it(this,c))),t=e.U;this._.C=!1},remove:function(e){e.N&&(e.N.P=e.P),e.P&&(e.P.N=e.N),e.N=e.P=null;var h=e.U,t,c=e.L,g=e.R,m,y;if(c?g?m=tn(g):m=c:m=g,h?h.L===e?h.L=m:h.R=m:this._=m,c&&g?(y=m.C,m.C=e.C,m.L=c,c.U=m,m!==g?(h=m.U,m.U=e.U,e=m.R,h.L=e,m.R=g,g.U=m):(m.U=h,h=m,e=m.R)):(y=e.C,e=m),e&&(e.U=h),!y){if(e&&e.C){e.C=!1;return}do{if(e===this._)break;if(e===h.L){if(t=h.R,t.C&&(t.C=!1,h.C=!0,it(this,h),t=h.R),t.L&&t.L.C||t.R&&t.R.C){(!t.R||!t.R.C)&&(t.L.C=!1,t.C=!0,nt(this,t),t=h.R),t.C=h.C,h.C=t.R.C=!1,it(this,h),e=this._;break}}else if(t=h.L,t.C&&(t.C=!1,h.C=!0,nt(this,h),t=h.L),t.L&&t.L.C||t.R&&t.R.C){(!t.L||!t.L.C)&&(t.R.C=!1,t.C=!0,it(this,t),t=h.L),t.C=h.C,h.C=t.L.C=!1,nt(this,h),e=this._;break}t.C=!0,e=h,h=h.U}while(!e.C);e&&(e.C=!1)}}};function it(e,h){var t=h,c=h.R,g=t.U;g?g.L===t?g.L=c:g.R=c:e._=c,c.U=g,t.U=c,t.R=c.L,t.R&&(t.R.U=t),c.L=t}function nt(e,h){var t=h,c=h.L,g=t.U;g?g.L===t?g.L=c:g.R=c:e._=c,c.U=g,t.U=c,t.L=c.R,t.L&&(t.L.U=t),c.R=t}function tn(e){for(;e.L;)e=e.L;return e}function ht(e,h,t,c){var g=[null,null],m=Se.push(g)-1;return g.left=e,g.right=h,t&&At(g,e,h,t),c&&At(g,h,e,c),Pe[e.index].halfedges.push(m),Pe[h.index].halfedges.push(m),g}function rt(e,h,t){var c=[h,t];return c.left=e,c}function At(e,h,t,c){!e[0]&&!e[1]?(e[0]=c,e.left=h,e.right=t):e.left===t?e[1]=c:e[0]=c}function Ko(e,h,t,c,g){var m=e[0],y=e[1],a=m[0],i=m[1],r=y[0],o=y[1],n=0,s=1,l=r-a,u=o-i,d;if(d=h-a,!(!l&&d>0)){if(d/=l,l<0){if(d<n)return;d<s&&(s=d)}else if(l>0){if(d>s)return;d>n&&(n=d)}if(d=c-a,!(!l&&d<0)){if(d/=l,l<0){if(d>s)return;d>n&&(n=d)}else if(l>0){if(d<n)return;d<s&&(s=d)}if(d=t-i,!(!u&&d>0)){if(d/=u,u<0){if(d<n)return;d<s&&(s=d)}else if(u>0){if(d>s)return;d>n&&(n=d)}if(d=g-i,!(!u&&d<0)){if(d/=u,u<0){if(d>s)return;d>n&&(n=d)}else if(u>0){if(d<n)return;d<s&&(s=d)}return!(n>0)&&!(s<1)||(n>0&&(e[0]=[a+n*l,i+n*u]),s<1&&(e[1]=[a+s*l,i+s*u])),!0}}}}}function Qo(e,h,t,c,g){var m=e[1];if(m)return!0;var y=e[0],a=e.left,i=e.right,r=a[0],o=a[1],n=i[0],s=i[1],l=(r+n)/2,u=(o+s)/2,d,f;if(s===o){if(l<h||l>=c)return;if(r>n){if(!y)y=[l,t];else if(y[1]>=g)return;m=[l,g]}else{if(!y)y=[l,g];else if(y[1]<t)return;m=[l,t]}}else if(d=(r-n)/(s-o),f=u-d*l,d<-1||d>1)if(r>n){if(!y)y=[(t-f)/d,t];else if(y[1]>=g)return;m=[(g-f)/d,g]}else{if(!y)y=[(g-f)/d,g];else if(y[1]<t)return;m=[(t-f)/d,t]}else if(o<s){if(!y)y=[h,d*h+f];else if(y[0]>=c)return;m=[c,d*c+f]}else{if(!y)y=[c,d*c+f];else if(y[0]<h)return;m=[h,d*h+f]}return e[0]=y,e[1]=m,!0}function Jo(e,h,t,c){for(var g=Se.length,m;g--;)(!Qo(m=Se[g],e,h,t,c)||!Ko(m,e,h,t,c)||!(Math.abs(m[0][0]-m[1][0])>xe||Math.abs(m[0][1]-m[1][1])>xe))&&delete Se[g]}function $o(e){return Pe[e.index]={site:e,halfedges:[]}}function el(e,h){var t=e.site,c=h.left,g=h.right;return t===g&&(g=c,c=t),g?Math.atan2(g[1]-c[1],g[0]-c[0]):(t===c?(c=h[1],g=h[0]):(c=h[0],g=h[1]),Math.atan2(c[0]-g[0],g[1]-c[1]))}function Kn(e,h){return h[+(h.left!==e.site)]}function tl(e,h){return h[+(h.left===e.site)]}function il(){for(var e=0,h=Pe.length,t,c,g,m;e<h;++e)if((t=Pe[e])&&(m=(c=t.halfedges).length)){var y=new Array(m),a=new Array(m);for(g=0;g<m;++g)y[g]=g,a[g]=el(t,Se[c[g]]);for(y.sort(function(i,r){return a[r]-a[i]}),g=0;g<m;++g)a[g]=c[y[g]];for(g=0;g<m;++g)c[g]=a[g]}}function nl(e,h,t,c){var g=Pe.length,m,y,a,i,r,o,n,s,l,u,d,f,p=!0;for(m=0;m<g;++m)if(y=Pe[m]){for(a=y.site,r=y.halfedges,i=r.length;i--;)Se[r[i]]||r.splice(i,1);for(i=0,o=r.length;i<o;)u=tl(y,Se[r[i]]),d=u[0],f=u[1],n=Kn(y,Se[r[++i%o]]),s=n[0],l=n[1],(Math.abs(d-s)>xe||Math.abs(f-l)>xe)&&(r.splice(i,0,Se.push(rt(a,u,Math.abs(d-e)<xe&&c-f>xe?[e,Math.abs(s-e)<xe?l:c]:Math.abs(f-c)<xe&&t-d>xe?[Math.abs(l-c)<xe?s:t,c]:Math.abs(d-t)<xe&&f-h>xe?[t,Math.abs(s-t)<xe?l:h]:Math.abs(f-h)<xe&&d-e>xe?[Math.abs(l-h)<xe?s:e,h]:null))-1),++o);o&&(p=!1)}if(p){var v,w,C,b=1/0;for(m=0,p=null;m<g;++m)(y=Pe[m])&&(a=y.site,v=a[0]-e,w=a[1]-h,C=v*v+w*w,C<b&&(b=C,p=y));if(p){var P=[e,h],R=[e,c],A=[t,c],W=[t,h];p.halfedges.push(Se.push(rt(a=p.site,P,R))-1,Se.push(rt(a,R,A))-1,Se.push(rt(a,A,W))-1,Se.push(rt(a,W,P))-1)}}for(m=0;m<g;++m)(y=Pe[m])&&(y.halfedges.length||delete Pe[m])}var Qn=[],_i;function rl(){Nt(this),this.x=this.y=this.arc=this.site=this.cy=null}function Ge(e){var h=e.P,t=e.N;if(!(!h||!t)){var c=h.site,g=e.site,m=t.site;if(c!==m){var y=g[0],a=g[1],i=c[0]-y,r=c[1]-a,o=m[0]-y,n=m[1]-a,s=2*(i*n-r*o);if(!(s>=-hl)){var l=i*i+r*r,u=o*o+n*n,d=(n*l-r*u)/s,f=(i*u-o*l)/s,p=Qn.pop()||new rl;p.arc=e,p.site=g,p.x=d+y,p.y=(p.cy=f+a)+Math.sqrt(d*d+f*f),e.circle=p;for(var v=null,w=dt._;w;)if(p.y<w.y||p.y===w.y&&p.x<=w.x)if(w.L)w=w.L;else{v=w.P;break}else if(w.R)w=w.R;else{v=w;break}dt.insert(v,p),v||(_i=p)}}}}function Ye(e){var h=e.circle;h&&(h.P||(_i=h.N),dt.remove(h),Qn.push(h),Nt(h),e.circle=null)}var Jn=[];function sl(){Nt(this),this.edge=this.site=this.circle=null}function nn(e){var h=Jn.pop()||new sl;return h.site=e,h}function qt(e){Ye(e),qe.remove(e),Jn.push(e),Nt(e)}function al(e){var h=e.circle,t=h.x,c=h.cy,g=[t,c],m=e.P,y=e.N,a=[e];qt(e);for(var i=m;i.circle&&Math.abs(t-i.circle.x)<xe&&Math.abs(c-i.circle.cy)<xe;)m=i.P,a.unshift(i),qt(i),i=m;a.unshift(i),Ye(i);for(var r=y;r.circle&&Math.abs(t-r.circle.x)<xe&&Math.abs(c-r.circle.cy)<xe;)y=r.N,a.push(r),qt(r),r=y;a.push(r),Ye(r);var o=a.length,n;for(n=1;n<o;++n)r=a[n],i=a[n-1],At(r.edge,i.site,r.site,g);i=a[0],r=a[o-1],r.edge=ht(i.site,r.site,null,g),Ge(i),Ge(r)}function ol(e){for(var h=e[0],t=e[1],c,g,m,y,a=qe._;a;)if(m=$n(a,t)-h,m>xe)a=a.L;else if(y=h-ll(a,t),y>xe){if(!a.R){c=a;break}a=a.R}else{m>-xe?(c=a.P,g=a):y>-xe?(c=a,g=a.N):c=g=a;break}$o(e);var i=nn(e);if(qe.insert(c,i),!(!c&&!g)){if(c===g){Ye(c),g=nn(c.site),qe.insert(i,g),i.edge=g.edge=ht(c.site,i.site),Ge(c),Ge(g);return}if(!g){i.edge=ht(c.site,i.site);return}Ye(c),Ye(g);var r=c.site,o=r[0],n=r[1],s=e[0]-o,l=e[1]-n,u=g.site,d=u[0]-o,f=u[1]-n,p=2*(s*f-l*d),v=s*s+l*l,w=d*d+f*f,C=[(f*v-l*w)/p+o,(s*w-d*v)/p+n];At(g.edge,r,u,C),i.edge=ht(r,e,null,C),g.edge=ht(e,u,null,C),Ge(c),Ge(g)}}function $n(e,h){var t=e.site,c=t[0],g=t[1],m=g-h;if(!m)return c;var y=e.P;if(!y)return-1/0;t=y.site;var a=t[0],i=t[1],r=i-h;if(!r)return a;var o=a-c,n=1/m-1/r,s=o/r;return n?(-s+Math.sqrt(s*s-2*n*(o*o/(-2*r)-i+r/2+g-m/2)))/n+c:(c+a)/2}function ll(e,h){var t=e.N;if(t)return $n(t,h);var c=e.site;return c[1]===h?c[0]:1/0}var xe=1e-6,hl=1e-12,qe,Pe,dt,Se;function cl(e,h,t){return(e[0]-t[0])*(h[1]-e[1])-(e[0]-h[0])*(t[1]-e[1])}function ul(e,h){return h[1]-e[1]||h[0]-e[0]}function rn(e,h){var t=e.sort(ul).pop(),c,g,m;for(Se=[],Pe=new Array(e.length),qe=new It,dt=new It;;)if(m=_i,t&&(!m||t[1]<m.y||t[1]===m.y&&t[0]<m.x))(t[0]!==c||t[1]!==g)&&(ol(t),c=t[0],g=t[1]),t=e.pop();else if(m)al(m.arc);else break;if(il(),h){var y=+h[0][0],a=+h[0][1],i=+h[1][0],r=+h[1][1];Jo(y,a,i,r),nl(y,a,i,r)}this.edges=Se,this.cells=Pe,qe=dt=Se=Pe=null}rn.prototype={constructor:rn,polygons:function(){var e=this.edges;return this.cells.map(function(h){var t=h.halfedges.map(function(c){return Kn(h,e[c])});return t.data=h.site.data,t})},triangles:function(){var e=[],h=this.edges;return this.cells.forEach(function(t,c){if(!!(a=(m=t.halfedges).length))for(var g=t.site,m,y=-1,a,i,r=h[m[a-1]],o=r.left===g?r.right:r.left;++y<a;)i=o,r=h[m[y]],o=r.left===g?r.right:r.left,i&&o&&c<i.index&&c<o.index&&cl(g,i,o)<0&&e.push([g.data,i.data,o.data])}),e},links:function(){return this.edges.filter(function(e){return e.right}).map(function(e){return{source:e.left.data,target:e.right.data}})},find:function(e,h,t){for(var c=this,g,m=c._found||0,y=c.cells.length,a;!(a=c.cells[m]);)if(++m>=y)return null;var i=e-a.site[0],r=h-a.site[1],o=i*i+r*r;do a=c.cells[g=m],m=null,a.halfedges.forEach(function(n){var s=c.edges[n],l=s.left;if(!((l===a.site||!l)&&!(l=s.right))){var u=e-l[0],d=h-l[1],f=u*u+d*d;f<o&&(o=f,m=l.index)}});while(m!==null);return c._found=g,t==null||o<=t*t?a.site:null}};function Ve(e,h,t){this.k=e,this.x=h,this.y=t}Ve.prototype={constructor:Ve,scale:function(e){return e===1?this:new Ve(this.k*e,this.x,this.y)},translate:function(e,h){return e===0&h===0?this:new Ve(this.k,this.x+this.k*e,this.y+this.k*h)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};new Ve(1,0,0);Ve.prototype;var fl=function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("div",{staticClass:"smoothScatter"},[t("div",{ref:`chart${e.channelx}${e.channely}`,staticClass:"chart",style:`height: ${e.width+e.margin}px; width: ${e.width+e.margin}px`,attrs:{id:`chart${e.channelx}${e.channely}`}})])},dl=[];const gl={name:"smoothScatter",props:["sample","channelx","channely","thresholdx","thresholdy","canEdit","tumorChannel","cellType"],computed:{...fn({ifquantDensities:"ifquantDensities"}),cursor(){return this.ifquantDensities.cursor},xData(){const e=this;return _.uniq(_.map(e.data,t=>t[0]))},yData(){const e=this;return _.uniq(_.map(e.data,t=>t[1]))}},data(){return{margin:30,width:100,maxX:1,maxY:1,xThreshold:1,yThreshold:1,xScale:null,yScale:null,xDomain:[],yDomain:[],xName:"",yName:""}},methods:{renderGraph(){const e=this,h=e.margin,t=e.width+h,c=e.width+h;var g=$e(`#chart${e.channelx}${e.channely}`).append("svg").attr("width",t).attr("height",c);e.xDomain=[0,e.maxX],e.yDomain=[0,e.maxY];var m=e.xDomain,y=e.yDomain;e.xScale=en().range([0,e.width]).domain(m),e.yScale=en().range([e.width,0]).domain(y);var a=e.xScale,i=e.yScale;const r=yr(i).ticks(5);g.append("g").attr("transform","translate("+h+",0)").call(r);const o=vr(a).ticks(5);g.append("g").attr("transform","translate("+h+","+e.width+")").call(o);var n=g.append("g");n.append("text").attr("x",t-5).attr("y",c-5).style("text-anchor","end").style("fill","#FFF").text(e.xName);var s=n.append("text").attr("x",35).attr("y",c-5).style("text-anchor","start").style("fill","#FFF"),l=n.append("g").attr("class","line");l.append("line").attr("id","crosshairX"+e.channelx+e.channely).attr("class","crosshair crosshairX").style("stroke-dasharray","3, 3").attr("x1",a(m[0])+h).attr("y1",i(e.yThreshold)).attr("x2",a(m[1])+h).attr("y2",i(e.yThreshold)),l.append("line").attr("id","crosshairLive"+e.channelx+e.channely).attr("class","crosshair crosshairLive"),l.append("line").attr("id","crosshairY"+e.channelx+e.channely).attr("class","crosshair crosshairY").style("stroke-dasharray","3, 3").attr("x1",a(e.xThreshold)+h).attr("y1",i(y[0])).attr("x2",a(e.xThreshold)+h).attr("y2",i(y[1])-h),n.append("rect").attr("class","overlay").attr("width",t).attr("height",c).on("mouseover",function(){l.style("display",null)}).on("mouseout",function(){l.select("#crosshairLive"+e.channelx+e.channely).style("display","none"),s.text(""),e.$store.commit("SET_CURSOR_X",0)}).on("mousemove",function(){var u=Di(this),d=u[0],f=u[1];d<h||f<h?l.select("#crosshairLive"+e.channelx+e.channely).style("display","none"):l.select("#crosshairLive"+e.channelx+e.channely).style("display",null),s.text(function(){return e.xName+"="+Math.round(a.invert(d-h)*100)/100}),d!==e.cursor.posX&&e.$store.commit("SET_CURSOR_X",d)}).on("click",function(){if(!e.canEdit)e.$snotify.warning("Threshold update forbidden");else if(e.cellType===e.tumorChannel)e.$snotify.warning("Please use the tissue segmentation panel to adjust "+e.tumorChannel+" thresholds");else{const u=Math.round(a.invert(Di(this)[0]-h)*100)/100;e.$store.commit("SET_DENSITY_THRESHOLD",u),e.$emit("set-threshold",u)}})}},mounted(){const e=this;let h=document.querySelector("#imagePanel").offsetWidth,t=document.querySelector("#leftPanel").offsetWidth;e.width=(h-t)/6,e.width>200&&(e.width=200),be.get(`/${this.sample}/density_data?channelX=${this.channelx}&channelY=${this.channely}`).then(c=>{e.maxX=+c.data.score_x_max,e.maxY=+c.data.score_y_max,e.xName=c.data.channel_x,e.yName=c.data.channel_y,e.xThreshold=this.thresholdx,e.yThreshold=this.thresholdy,e.$store.commit("SET_DENSITY_THRESHOLD",e.xThreshold),e.renderGraph()}),be.get(`/${this.sample}/density?channelX=${this.channelx}&channelY=${this.channely}`,{responseType:"arraybuffer",headers:{Accept:"application/png"}}).then(c=>{let g=btoa(new Uint8Array(c.data).reduce(function(y,a){return y+String.fromCharCode(a)},""));var m=c.headers["content-type"].toLowerCase();e.$refs[`chart${e.channelx}${e.channely}`].style.backgroundImage="url(data:"+m+";base64,"+g+")",e.$refs[`chart${e.channelx}${e.channely}`].style.backgroundRepeat="no-repeat",e.$refs[`chart${e.channelx}${e.channely}`].style.backgroundSize=`${e.width}px ${e.width}px`,e.$refs[`chart${e.channelx}${e.channely}`].style.backgroundPosition="30px 0px"})},watch:{cursor:{handler(e){e.posX>=30?$e("#crosshairLive"+this.channelx+this.channely).style("display",null):$e("#crosshairLive"+this.channelx+this.channely).style("display","none"),$e("#crosshairLive"+this.channelx+this.channely).attr("x1",e.posX).attr("y1",this.yScale(this.yDomain[0])).attr("x2",e.posX).attr("y2",this.yScale(this.yDomain[1])-30)},deep:!0},"ifquantDensities.threshold"(e){this.xThreshold=e,this.xScale&&$e("#crosshairY"+this.channelx+this.channely).attr("x1",this.xScale(this.xThreshold)+30).attr("x2",this.xScale(this.xThreshold)+30)},thresholdx(e,h){e&&e!==h&&this.$store.commit("SET_DENSITY_THRESHOLD",e)}}},sn={};var pl=ui(gl,fl,dl,!1,ml,null,null,null);function ml(e){for(let h in sn)this[h]=sn[h]}var vl=function(){return pl.exports}(),yl=function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("div",{staticClass:"channelDensities px-3"},[t("button",{staticClass:"btn btn-link text-light",staticStyle:{position:"absolute",top:"0",right:"0","z-index":"101"},on:{click:function(c){return e.$emit("close-density")}}},[t("v-icon",{attrs:{name:"times"}})],1),t("div",{staticClass:"row"},[e.dataReady?[e._l(e.channels,function(c,g){return[g!==e.cellType?t("div",{key:`data${c}`,staticClass:"col mt-3"},[t("h5",{staticClass:"text-left"},[e._v(e._s(g))]),t("smooth-scatter",{attrs:{channelx:c,channely:e.channelx,sample:e.sample,thresholdx:e.thresholds[e.cellType].value,thresholdy:e.thresholds[g].value,canEdit:e.canEdit,cellType:e.cellType,tumorChannel:e.tumorChannel},on:{"set-threshold":function(m){return e.$emit("set-threshold",m)}}})],1):e._e()]})]:t("div",[t("p",{staticClass:"text-center text-info h4"},[e._v("loading...")])])],2)])},wl=[];const _l={name:"channelDensities",components:{smoothScatter:vl},props:["sample","cellType","thresholds","tumorChannel","canEdit"],data(){return{testData:[],dataReady:!1,channelx:""}},computed:{...fn({ifquantDensities:"ifquantDensities"}),channels(){let e={};return _.forEach(this.ifquantDensities.channels,(h,t)=>{+h>0&&+h<7&&t!=="autofluorescence"&&(e[t]=h)}),e}},methods:{},mounted(){this.$store.dispatch("getIfquantDensitiesData",{sample:this.sample,cellType:this.cellType}).then(()=>{this.dataReady=!0,this.channelx=this.ifquantDensities.channels[this.cellType]!==void 0?this.ifquantDensities.channels[this.cellType]:null})}},an={};var xl=ui(_l,yl,wl,!1,Cl,null,null,null);function Cl(e){for(let h in an)this[h]=an[h]}var bl=function(){return xl.exports}(),Tl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAYAAABzyUiPAAAAAXNSR0IArs4c6QAAAv5JREFUWMPtl01IFGEYx/+zX7MfMzu7q+uurgraqiEldCqiOiRBIETX0g4GdSiCPASRpw56MqygEDpkhzoEEXmQwlRMC1Mhy0zb0rXaVcuPVlvJ/dC3d8bdytjZ9SMPsj7wDO+88zzMvL/5v888w5SfJwQrsHt3c2G0pCE7KxsqlRIerxeT4x4cLx1GUlsigBrBRgTnHlJy4hxp6egiQyNfiPuzl3T39pMzF6uJOX8v0Qh2kqzsGPFw+yrDxApgzemET88HxxlQcboMJiO/7Hp4YQE36+/jk8eLH6MuBL6PMWt9UZvNRGbimhTxgkyOAhgMHFRKFZ53vcbT9pfLvKWjG4FgCJyek2KT0WQBClmFpCBPg56mJtRcfoWBD25UXbqGyoob6B8cRvmxO7hefQWtDx+hraEVJ0unYaI5WwCjAFPs4DkdzEIQAk+gVqvpeUBy0B1v0NN54zwam/JgoTEXzg4ixW5d84PcqmVkx1FPFCt3/u+c3Hyse60ZoFEwQ6fVSmOlQgG9Tidyo85IY4ViKbW9cxtm/Sy07AIslpQNecunKojkcguLzscCEiv373m5e60bIM9x0LERgEol9BJMZgkgHSsjAOtqGmCzztEa6QRnSN0QgFFVyC0sCijW9USKiqfudQEMBgNUgWwEYAwFUqii1dYdQWVVGerqS+D3+zdUgYli/kfuatQXF6B/Zkqqe0tbmCpQpxX1B4UE8I8CXR+d8Izm0i+1FrO+iU1R+KOKjaXa1dZA2T7QlJFDDh4+ikLanYRCOvh8At2qU6CtI75NWmAxz0CjCeHrhAXhMMHE9DTanjyAb8zNbPWB1HyjbsY1+B5j46l0C+fA4ciAmi2CRrsTmZkO6A2FUKmLkGa1gVEwGHK9k4WXlG2MaG9fNDJ9fb1YXAzDbrNKEDMiLkLMdKSDZVUY6H8jxSZjIx33Vy5qO3YXk30HirG9IB88z0t18Of8PEZG3HjW1ozO5oakhPf7X3ilCa2Pd9H+0CR9TOb8s9h/qAfJbr8Azc1CH5ASx4wAAAAASUVORK5CYII=",Sl=function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("div",{staticClass:"ifquant container-fluid",staticStyle:{position:"relative",margin:"0 !important","padding-top":"40px","padding-bottom":"120px"},attrs:{id:"IFQuantContainer"},on:{click:e.checkAnnotationStatus,keyup:function(c){return!c.type.indexOf("key")&&e._k(c.keyCode,"delete",[8,46],c.key,["Backspace","Delete","Del"])?null:e.removePath.apply(null,arguments)}}},[t("div",{ref:"ROIannotation",staticClass:"p-3",attrs:{id:"ROIannotation"}},[t("div",{staticClass:"input-group mb-3"},[e.showOtherROItitle?e._e():t("select",{directives:[{name:"model",rawName:"v-model",value:e.ROItitle,expression:"ROItitle"}],staticClass:"form-control form-control-sm",on:{change:function(c){var g=Array.prototype.filter.call(c.target.options,function(m){return m.selected}).map(function(m){var y="_value"in m?m._value:m.value;return y});e.ROItitle=c.target.multiple?g:g[0]}}},[t("option",{domProps:{value:null}},[e._v("-- select --")]),e._l(e.cvROItitles,function(c){return t("option",{key:c,domProps:{value:c}},[e._v(e._s(c))])}),t("option",{attrs:{value:"other..."}},[e._v("other...")])],2),e.showOtherROItitle?t("input",{directives:[{name:"model",rawName:"v-model",value:e.ROItitle,expression:"ROItitle"}],staticClass:"form-control form-control-sm",attrs:{type:"text",placeholder:"Name","aria-label":"ROItitle","aria-describedby":"button-roi-title"},domProps:{value:e.ROItitle},on:{input:function(c){c.target.composing||(e.ROItitle=c.target.value)}}}):e._e(),t("div",{staticClass:"input-group-append"},[t("button",{staticClass:"btn btn-primary btn-sm",attrs:{type:"button",id:"button-roi-title",disabled:!e.ROItitle},on:{click:function(c){return e.saveAnnotations(!0)}}},[e._v("Save")])])])]),t("div",{attrs:{id:"ifquantTooltip"}}),t("div",{staticStyle:{position:"absolute",left:"10px",top:"10px",width:"500px","z-index":"10"}},[t("router-link",{attrs:{to:"/"}},[t("button",{staticClass:"btn btn-outline-light btn-sm"},[e._v("back to the list of samples")])])],1),t("div",{staticClass:"row",staticStyle:{"margin-top":"200px"}},[e.sampleIds.sample_id?e._e():t("div",{attrs:{id:"leftPanelLoading"}},[t("h1",{staticClass:"mt-3 h4"},[e._v(" "+e._s(e.sample)+" ")]),e._m(0)]),t("div",{style:`visibility: ${e.sampleIds.sample_id?"visible":"hidden"}`,attrs:{id:"leftPanel"}},[t("h1",{staticClass:"mt-3 h4"},[e._v(" "+e._s(e.sample)+" ")]),e.processingStep==="processing"?[t("h5",{staticClass:"text-warning"},[e._v("Processing in progress...")])]:[t("div",{staticClass:"card",staticStyle:{"margin-top":"20px","background-color":"#000",color:"#FFF","border-color":"#999"}},[t("div",{staticClass:"card-body"},[e.isExclusion?e._e():t("div",{staticClass:"btn-group d-flex justify-content-between",attrs:{role:"group","aria-label":"cell types"}},e._l(e.cellTypes,function(c){return t("button",{key:c,staticClass:"btn btn-sm",class:c===e.cellType?"btn-primary active":"btn-outline-primary",style:e.getCellTypeStyle(c),attrs:{type:"button"},on:{click:function(g){return e.toggleCellType(c)}}},[e._v(" "+e._s(c)+" ")])}),0),e.isExclusion?e._e():t("div",{staticClass:"p-3",style:`border: 1px solid rgb(${e.cellType?e.colorMaps[e.cellType].color:"0,0,0"}); position: relative;`},[e.cellType?t("div",{staticStyle:{"font-size":"0.8rem"}},[t("div",{staticClass:"row"},[t("div",{staticClass:"h5",class:`${e.showCells?"col-8 text-right":"col-12 text-center"}`,style:`color: rgb(${e.colorMaps[e.cellType].color}`},[e._v(e._s(e.showCells?`Visible ${e.cellType} cells`:e.cellType))]),e.showCells?[e.loading?e._e():t("div",{staticClass:"h5 col-4",style:`color: rgb(${e.colorMaps[e.cellType].color}`},[e._v(e._s(e.total))]),e.loading?t("div",{staticClass:"h5 col-4 text-muted"},[e._m(1)]):e._e()]:e._e(),t("span",{staticClass:"badge badge-dark",staticStyle:{position:"absolute",top:"2px",left:"2px"}},[e._v(e._s(e.colorMaps[e.cellType].marker))])],2),t("p",{staticClass:"w-100 text-center",style:`visibility:${e.factor>1&&e.cells.length?"visible":"hidden"}`},[t("span",{staticClass:"text-faded"},[e._v("("+e._s(e.cells.length)+" displayed)")])]),e.cellType!=="DAPI"?t("div",{staticClass:"row"},[t("div",{staticClass:"col-4 text-right pl-1 pr-0"},[t("label",{staticClass:"w-100",attrs:{for:"threshold"}},[e._v(e._s(e.cellType)+" Threshold")])]),t("div",{staticClass:"col-4"},[e.canEdit&&e.cellType!==e.tumorChannel?t("b-form-input",{attrs:{id:"threshold",type:"range",min:"0",max:"40",step:"0.1"},on:{change:e.updateThreshold},model:{value:e.thresholds[e.cellType].value,callback:function(c){e.$set(e.thresholds[e.cellType],"value",c)},expression:"thresholds[cellType].value"}}):t("p",{staticClass:"text-center"},[e._v(e._s(Math.round(e.thresholds[e.cellType].value*10)/10))])],1),t("div",{staticClass:"col-4 px-0"},[e.hasDensities?t("button",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],staticClass:"btn btn-sm py-0 px-1 m-0",class:e.showDensity?"btn-info":"btn-outline-info",staticStyle:{"line-height":"0.9rem","font-size":"0.75rem"},attrs:{type:"button",title:e.thresholds[e.cellType].method},on:{click:e.toggleDensity}},[t("v-icon",{attrs:{name:"chart-area",scale:"0.6"}}),e._v(" "+e._s(Math.round(e.threshold*100)/100))],1):t("span",{staticClass:"badge badge-info"},[e._v(e._s(Math.round(e.threshold*100)/100))]),e.originalThresholds[e.cellType].value!==e.thresholds[e.cellType].value&&e.canEdit?t("button",{staticClass:"btn btn-sm btn-link py-0 px-1 my-0",attrs:{type:"button"},on:{click:e.resetThreshold}},[t("v-icon",{attrs:{name:"undo-alt",scale:"0.7"}})],1):e._e()])]):e._e(),e.canEdit&&e.cellType!==e.tumorChannel?t("p",{staticClass:"text-center"},[t("button",{staticClass:"btn btn-sm btn-success",class:e.originalThresholds[e.cellType].value===e.thresholds[e.cellType].value?"btn-outline-success":"btn-success",staticStyle:{"line-height":"0.9rem","font-size":"0.75rem"},attrs:{type:"button",disabled:e.originalThresholds[e.cellType].value===e.thresholds[e.cellType].value},on:{click:function(c){return e.saveThreshold(e.cellType)}}},[t("v-icon",{attrs:{name:"save",scale:"0.9"}}),t("span",{staticClass:"ml-2"},[e._v("save threshold")])],1)]):e._e()]):e._e()]),e.cellType&&e.hasCellsDb&&!e.tissueDisplayed&&!e.tlsDisplayed&&!e.isExclusion?t("div",{staticClass:"p-2",staticStyle:{border:"1px solid #FFF"},style:`visibility:${e.showCells?"visible":"hidden"}`},[t("p",[e._v("Highlight cells "),t("button",{staticClass:"btn btn-sm btn-link p-0 ml-2 my-0",attrs:{type:"button"},on:{click:function(c){e.showHighlightCells=!e.showHighlightCells}}},[t("v-icon",{attrs:{name:e.showHighlightCells?"chevron-down":"chevron-right"}})],1)]),e.showHighlightCells?t("div",{staticClass:"d-flex justify-content-between",attrs:{role:"group","aria-label":"cell types"}},e._l(e.cellTypes,function(c){return t("div",{key:`highlight${c}`},[t("p",{staticClass:"text-center mb-0 px-1 py-0",style:`background-color: rgb(${c===e.cellType?e.colorMaps[c].color:"0,0,0"});color: ${c===e.cellType?e.getTextColor(e.colorMaps[c].color):"rgb("+e.colorMaps[c].color+")"}`},[e._v(e._s(c))]),e.loadingNotifications?e._e():t("div",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],staticClass:"progress my-1 mx-2",staticStyle:{height:"6px","background-color":"#333"},attrs:{title:`${e.notifications[c].count} (${e.notifications[c].percent}%)`}},[t("div",{staticClass:"progress-bar",style:`width: ${e.notifications[c].percent}%; background-color:rgb(${e.colorMaps[c].color})`,attrs:{role:"progressbar","aria-valuenow":e.notifications[c].percent,"aria-valuemin":"0","aria-valuemax":"100"}})]),t("div",{staticClass:"btn-group-vertical w-100 px-2"},[t("button",{staticClass:"btn btn-sm px-1 py-0",class:e.highlightCells[c]===!0?"btn-success":"btn-outline-success",attrs:{type:"button",disabled:c===e.cellType},on:{click:function(g){return e.setHighlightCells(c,!0)}}},[e._v("pos")]),c!==e.cellType?t("button",{staticClass:"btn btn-sm px-1 py-0",class:e.highlightCells[c]===!1?"btn-danger":"btn-outline-danger",attrs:{type:"button"},on:{click:function(g){return e.setHighlightCells(c,!1)}}},[e._v("neg")]):e._e()])])}),0):e._e()]):e._e(),!e.cellType&&!e.isExclusion?t("div",{staticClass:"row mt-2"},[e._m(2)]):e._e(),e.isExclusion?e._e():t("div",{staticClass:"d-flex justify-content-between mt-3"},[e.cellType?t("h5",{staticClass:"w-100"},[e.showCells&&!e.loading?t("span",{staticClass:"badge mt-2",class:e.factor===1?"badge-success":e.factor>3?"badge-danger":"badge-warning"},[e._v(e._s(`${e.factor===1?"all":"1/"+e.factor} cells displayed`))]):e._e(),t("button",{staticClass:"btn btn-outline-info btn-sm py-1 float-right",attrs:{type:"button",disabled:e.loading},on:{click:e.toggleCells}},[e.loading?e._e():t("v-icon",{attrs:{name:e.showCells?"eye-slash":"eye",scale:"1"}}),e._v("\xA0"+e._s(e.loading?"loading":e.showCells?"hide":"show")+" cells"),e.loading?t("span",[e._v("...")]):e._e()],1)]):e._e()])]),t("div",{staticClass:"p-3 mt-0 mb-3 mx-3",staticStyle:{border:"1px solid white"}},[e._l(e.channels,function(c,g){return[t("div",{key:`channel${g}`,staticClass:"row"},[t("div",{staticClass:"col-4"},[t("div",{staticClass:"form-check"},[t("label",{staticClass:"form-check-label pointer",style:e.getChannelStyle(c),on:{click:function(m){return e.toggleChannelVisibility(g)}}},[e._v(" "+e._s(c.marker)+" ")])])]),t("div",{staticClass:"col-5"},[t("b-form-input",{attrs:{id:`${g}_intensity`,type:"range",min:"0",max:"5",step:"0.1"},model:{value:c.intensity,callback:function(m){e.$set(c,"intensity",m)},expression:"channel.intensity"}})],1),t("div",{staticClass:"col-3"},[t("span",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],staticClass:"badge badge-info pointer",attrs:{title:"reset"},on:{click:function(m){c.intensity=1}}},[e._v(e._s(c.intensity))])])])]}),e._m(3)],2)]),t("div",{staticClass:"card",staticStyle:{"margin-top":"20px","background-color":"#000",color:"#FFF","border-color":"#999"}},[t("div",{staticClass:"card-body"},[!e.loading&&(e.tissueDisplayed||e.tlsDisplayed)?t("a",{staticClass:"btn btn-link float-right",staticStyle:{position:"absolute",top:"5px",right:"2px"},on:{click:e.toggleTissueMask}},[t("v-icon",{attrs:{name:e.showTissueMask?"eye-slash":"eye",scale:"1"}})],1):e._e(),e.isExclusion?e._e():t("h6",[e._v("Percent tumor tissue: "),t("strong",[e._v(e._s(e.percentTumor)+"%")]),e._v(" "),e.warningPercentTumor?t("span",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],staticClass:"text-warning ml-2",attrs:{title:"Does NOT consider excluded regions"}},[t("v-icon",{attrs:{name:"exclamation-triangle"}})],1):e._e(),e._v(" "),e.warningThreshold?t("span",{directives:[{name:"b-modal",rawName:"v-b-modal.ckModal",modifiers:{ckModal:!0}}],staticClass:"float-right badge badge-danger"},[e._v("check segmentation")]):e._e()]),e.tissueDisplayed||e.sharpnessDisplayed||e.saturationDisplayed||e.tlsDisplayed?t("div",{staticClass:"p-3"},[t("div",{staticClass:"row"},[t("div",{staticClass:"col-5 text-right"},[t("label",{staticClass:"px-1",style:`background-color:${e.tlsDisplayed?"rgb(204,0,204)":""}`},[e._v(e._s(e.tissueDisplayed?"Tissue":e.sharpnessDisplayed?"Sharpness":e.saturationDisplayed?"Saturation":"TLS")+" opacity")])]),t("div",{staticClass:"col-4"},[t("b-form-input",{attrs:{id:"opacity",type:"range",min:"0",max:"1",step:"0.1"},model:{value:e.opacity,callback:function(c){e.opacity=c},expression:"opacity"}})],1),t("div",{staticClass:"col-3"},[t("span",{staticClass:"badge badge-info"},[e._v(e._s(e.opacity*100)+"%")])])]),e.saturationDisplayed?t("p",{staticClass:"p-2 text-center"},[e._m(4)]):e._e(),e.sharpnessDisplayed?t("p",{staticClass:"p-2 text-center",staticStyle:{"line-height":"2em"}},[e._m(5)]):e._e()]):e._e(),t("div",{staticClass:"btn-group d-flex"},[e.QCs.indexOf("saturation")>-1&&!e.tissueDisplayed&&!e.sharpnessDisplayed&&!e.tlsDisplayed?t("button",{staticClass:"btn btn-sm flex-fill",class:e.saturationDisplayed?"btn-light":"btn-outline-light",attrs:{type:"button"},on:{click:function(c){return e.toggleOverlay("saturation")}}},[e._v(e._s(`${e.saturationDisplayed?"hide":"show"} saturation`))]):e._e(),e.QCs.indexOf("sharpness")>-1&&!e.tissueDisplayed&&!e.saturationDisplayed&&!e.tlsDisplayed?t("button",{staticClass:"btn btn-sm flex-fill",class:e.sharpnessDisplayed?"btn-light":"btn-outline-light",attrs:{type:"button"},on:{click:function(c){return e.toggleOverlay("sharpness")}}},[e._v(e._s(`${e.sharpnessDisplayed?"hide":"show"} sharpness`))]):e._e(),e.QCs.indexOf("tls")>-1&&!e.tissueDisplayed&&!e.saturationDisplayed&&!e.sharpnessDisplayed?t("button",{staticClass:"btn btn-sm flex-fill",class:e.tlsDisplayed?"btn-light":"btn-outline-light",attrs:{type:"button"},on:{click:function(c){return e.toggleOverlay("tls")}}},[e._v(e._s(`${e.tlsDisplayed?"hide":"show"} TLS`)),e.TLS.total>-1?t("span",{staticClass:"badge ml-2",class:e.TLS.total>0?"badge-info":"badge-danger"},[e._v(e._s(e.TLS.total))]):e._e()]):e._e(),!e.saturationDisplayed&&!e.sharpnessDisplayed&&!e.tlsDisplayed?t("button",{staticClass:"btn btn-sm flex-fill",class:e.warningThreshold?e.tissueDisplayed?"btn-danger":"btn-outline-danger":e.tissueDisplayed?"btn-light":"btn-outline-light",attrs:{type:"button"},on:{click:function(c){return e.toggleOverlay("tissue")}}},[e._v(e._s(`${e.tissueDisplayed?"hide":"show"} tissue segmentation`))]):e._e(),e.canEdit&&e.tissueSegmentations.length&&e.tissueDisplayed&&(!e.cellType||e.cellType===e.tumorChannel)?t("button",{staticClass:"btn btn-sm btn-outline-light flex-fill",on:{click:function(c){e.tissueThresholdAdjust=!e.tissueThresholdAdjust}}},[e._v(e._s(e.tissueThresholdAdjust?"close":"adjust")+" segmentation")]):e._e()])])]),t("div",{staticClass:"card mt-3",staticStyle:{"margin-top":"20px","background-color":"#000",color:"#FFF","border-color":"#999"},attrs:{id:"annots"}},[t("div",{staticClass:"card-body"},[t("div",{staticClass:"card-title"},[e._v(" ROIs "),e.cellTypes.indexOf("CD20")>-1&&!e.confirmResetAnnotation&&!e.isExclusion&&+e.TLS.total!=-1?t("div",{staticClass:"float-right"},[e._m(6),t("span",{staticClass:"h5",class:e.TLS.total>0?"text-success":"text-danger"},[e._v(e._s(+e.TLS.total?"YES":"NO"))])]):e._e()]),e.confirmResetAnnotation?t("div",{staticClass:"card text-danger bg-primary",staticStyle:{"margin-top":"20px","background-color":"#000",color:"#FFF","border-color":"#999"}},[t("div",{staticClass:"card-body"},[e._m(7),t("p",{staticClass:"text-center"},[t("button",{staticClass:"btn btn-sm btn-danger mr-1",attrs:{type:"button"},on:{click:e.resetAnnotations}},[e._v("confirm")]),t("button",{staticClass:"btn btn-sm btn-outline-light ml-1",attrs:{type:"button"},on:{click:function(c){e.confirmResetAnnotation=!1}}},[e._v("cancel")])])])]):[e.isExclusion&&e.openSeadragonReady&&!e.fabricOverlay.fabricCanvas().getObjects().length?t("h5",{staticClass:"text-warning"},[e._v("Please first select regions to exclude")]):e._e(),e.canEdit||e.isExclusion?t("div",{staticClass:"btn-group"},[t("button",{staticClass:"btn",class:e.annotateMode&&!e.shiftKey?"btn-light":"btn-outline-dark",attrs:{type:"button"},on:{click:e.toggleAnnotate}},[t("v-icon",{attrs:{name:"mouse-pointer"}})],1),t("button",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],staticClass:"btn",class:e.drawMode==="exclusion"&&!e.shiftKey?"btn-danger":"btn-outline-danger",attrs:{type:"button",disabled:!e.openSeadragonReady,title:"EXCLUSION (CTRL+x)"},on:{click:function(c){return e.toggleDraw("exclusion")}}},[t("v-icon",{attrs:{name:"draw-polygon"}})],1),t("button",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],staticClass:"btn",class:e.drawMode==="roi"&&!e.shiftKey?"btn-success":"btn-outline-success",attrs:{type:"button",disabled:!e.openSeadragonReady,title:"ROI (CTRL+r)"},on:{click:function(c){return e.toggleDraw("roi")}}},[t("v-icon",{attrs:{name:"draw-polygon"}})],1)]):e._e(),e.isAnnotationSelected&&e.canEdit?t("button",{staticClass:"btn btn-danger ml-2",attrs:{type:"button"},on:{click:e.removePath}},[t("v-icon",{attrs:{name:"trash-alt"}})],1):e._e(),e.openSeadragonReady?e._e():t("span",{staticClass:"float-right badge badge-info"},[e._v("loading...")]),e.openSeadragonReady&&e.isExclusion?t("button",{staticClass:"btn btn-light float-right",attrs:{type:"button",disabled:e.reportInPreparation},on:{click:function(c){return e.saveAnnotations("SUBMIT")}}},[e._v(e._s(`${e.reportInPreparation?"preparing...":"save and compute statistics"}`))]):e._e(),e.processingStep!=="annotation"&&e.openSeadragonReady&&!e.isExclusion&&e.canEdit?t("button",{staticClass:"btn btn-sm btn-outline-danger float-right",attrs:{type:"button"},on:{click:e.resetAnnotations}},[e._v("reset...")]):e._e()]],2),e.ROIs.length&&!e.confirmResetAnnotation?t("table",{staticClass:"table table-sm table-hover",attrs:{id:"ROItable"}},[t("thead",[t("tr",[t("th",{staticClass:"text-center"},[e._v("ID")]),t("th",[e._v("Type")]),e.canEdit?t("th"):e._e()])]),t("tbody",e._l(e.ROIs,function(c){return t("tr",{key:c.id,on:{mouseenter:function(g){return e.highlightROI(c.id,!0)},mouseleave:function(g){return e.highlightROI(c.id,!1)},click:function(g){return e.selectROI(c.id)}}},[t("td",{staticClass:"text-center"},[e._v(e._s(c.id))]),t("td",[c.id!==e.activeROIidx?[e._v(e._s(c.title))]:[t("select",{directives:[{name:"model",rawName:"v-model",value:e.ROItitle,expression:"ROItitle"}],staticClass:"form-control form-control-sm",on:{change:function(g){var m=Array.prototype.filter.call(g.target.options,function(y){return y.selected}).map(function(y){var a="_value"in y?y._value:y.value;return a});e.ROItitle=g.target.multiple?m:m[0]}}},[t("option",{domProps:{value:null}},[e._v("-- select --")]),e._l(e.cvROItitles,function(g){return t("option",{key:g,domProps:{value:g}},[e._v(e._s(g))])})],2)]],2),e.canEdit?t("td",{staticClass:"text-center"},[c.id!==e.activeROIidx?[t("button",{staticClass:"btn btn-sm btn-link text-info",attrs:{type:"button"},on:{click:function(g){return e.editROI(c.id)}}},[t("v-icon",{attrs:{name:"pencil-alt"}})],1)]:[t("button",{staticClass:"btn btn-sm btn-link text-success",attrs:{type:"button"},on:{click:function(g){return e.saveAnnotations(!0)}}},[t("v-icon",{attrs:{name:"save"}})],1),t("button",{staticClass:"btn btn-sm btn-link",attrs:{type:"button"},on:{click:function(g){return e.cancelROI()}}},[e._v("cancel")])]],2):e._e()])}),0)]):e._e()]),e.stats.ifquant.DAPI&&!e.isExclusion&&e.showCells?t("div",{staticClass:"card mt-3",staticStyle:{"margin-top":"20px","background-color":"#000",color:"#FFF","border-color":"#999"},attrs:{id:"stats"}},[t("div",{staticClass:"card-body"},[e.quantType.indexOf("Q")>-1?[t("div",{staticClass:"card-title"},[e._v(e._s(e.quantType.indexOf("I")>-1?"IFQuant":"View")+" counts "),e.loadingStats?e._e():[t("span",{staticClass:"float-right"},[e._v(e._s(Number(e.stats.ifquant.DAPI).toLocaleString()))])]],2),e.stats.ifquant.DAPI?t("table",{staticClass:"table table-sm text-right"},[t("thead",e._l(e.cellTypes,function(c){return t("th",{key:`thIFQuant${c}`,style:e.getTableStyle(c)},[e._v(e._s(c))])}),0),e.loadingStats?t("tbody",[t("tr",[t("td",{staticClass:"text-center text-muted",attrs:{rowspan:"2",colspan:e.cellTypes.length}},[e._v("fetching counts...")])])]):t("tbody",[t("tr",e._l(e.cellTypes,function(c){return t("td",{key:`tdIFQuantCounts${c}`,style:e.getTableStyle(c)},[e._v(e._s(e.stats.ifquant[c]))])}),0),t("tr",e._l(e.cellTypes,function(c){return t("td",{key:`tdIFQuantPct${c}`,style:e.getTableStyle(c)},[e._v(e._s(Math.round(e.stats.ifquant[c]/e.stats.ifquant.DAPI*1e3)/10)+"%")])}),0)])]):e._e()]:e._e()],2)]):e._e(),!e.loadingNotifications&&e.cellType&&!e.isExclusion?t("div",{staticClass:"card mt-3",staticStyle:{"margin-top":"20px","background-color":"#222",color:"#EEE"},style:`border: 1px solid rgb(${e.cellType?e.colorMaps[e.cellType].color:"0,0,0"}); position: relative;`,attrs:{id:"notifications"}},[t("div",{staticClass:"card-body"},[t("div",{staticClass:"card-title",style:`font-weight: bold; color: rgb(${e.cellType?e.colorMaps[e.cellType].color:"0,0,0"});`},[e._v(e._s(e.cellType)+" positive cells"),t("span",{staticClass:"float-right"},[e._v(e._s(Number(e.notifications[e.cellType].count)))])]),t("table",{staticClass:"table table-sm text-right"},[t("thead",e._l(e.otherCellTypes,function(c){return t("th",{key:`thIFQuantNotifs${c}`,style:e.getTableStyle(c)},[e._v(e._s(c))])}),0),t("tbody",[t("tr",e._l(e.otherCellTypes,function(c){return t("td",{key:`tdIFQuantNotifs${c}`,style:e.getTableStyle(c)},[e._v(e._s(e.notifications[c].count))])}),0),t("tr",e._l(e.otherCellTypes,function(c){return t("td",{key:`tdIFQuantNotifPcts${c}`,style:e.getTableStyle(c)},[e._v(e._s(e.notifications[c].percent)+"%")])}),0)])])])]):e._e(),e.sampleIds.panel&&!e.isExclusion?t("div",{staticClass:"card mt-3",staticStyle:{"margin-top":"20px","background-color":"#000",color:"#FFF","border-color":"#999"},attrs:{id:"reports"}},[t("div",{staticClass:"card-body"},[t("div",{staticClass:"card-title"},[e._v("Report "),e.sampleIds.reporter?t("small",{staticClass:"float-right"},[e._v(e._s(`${e.sampleIds.reporter} `)+" "),e.sampleIds.report_date?[e._v(e._s(e.sampleIds.report_date))]:e._e()],2):e._e()]),e.downloadingReport?[t("p",{staticClass:"text-faded text-center"},[e._v("downloading report...")])]:[e.reportInPreparation?t("div",{staticClass:"card-text"},[t("p",{staticClass:"text-info text-center"},[e._v("We are preparing your report.")])]):t("div",{staticClass:"card-text"},[e.sampleIds.pdf_report?t("p",[e.sampleIds.pdf_report?t("a",{staticClass:"pointer",on:{click:function(c){return e.download(e.sampleIds.pdf_report,e.sample+".pdf")}}},[t("span",{staticClass:"text-danger mr-2"},[t("v-icon",{attrs:{name:"file-pdf"}})],1),e._v(" "+e._s(e.sample)+".pdf")]):e._e()]):e._e(),e.sampleIds.pdf_report_neotil?t("p",[e.sampleIds.pdf_report_neotil?t("a",{staticClass:"pointer",on:{click:function(c){return e.download(e.sampleIds.pdf_report_neotil,e.sample+"_immune_classification.pdf")}}},[t("span",{staticClass:"text-warning mr-2"},[t("v-icon",{attrs:{name:"file-pdf"}})],1),e._v(" "+e._s(e.sample)+"_immune_classification.pdf")]):e._e()]):e._e(),e.sampleIds.xlsx_data?t("p",[e.sampleIds.xlsx_data?t("a",{staticClass:"pointer",on:{click:function(c){return e.download(e.sampleIds.xlsx_data,e.sample+".xlsx")}}},[t("span",{staticClass:"text-success mr-2"},[t("v-icon",{attrs:{name:"file-excel"}})],1),e._v(" "+e._s(e.sample)+".xlsx")]):e._e()]):e._e(),e._l(e.sampleIds.xlsx_rois,function(c,g){return t("p",{key:c.file},[e.sampleIds.xlsx_data?t("a",{staticClass:"pointer",on:{click:function(m){e.download(c.file,`${e.sample}_${c.name.indexOf("&")>-1?"all_ROIs":isNaN(+c.name)?c.name:"ROI"+(g+1)}.xlsx`)}}},[t("span",{staticClass:"text-success mr-2"},[t("v-icon",{attrs:{name:"file-excel"}})],1),e._v(" "+e._s(`${e.sample}_${c.name.indexOf("&")>-1?"all_ROIs":isNaN(+c.name)?c.name:"ROI"+(g+1)}.xlsx`))]):e._e()])}),e.sampleIds.cells_properties_data?t("p",[e.sampleIds.cells_properties_data?t("a",{staticClass:"pointer",on:{click:function(c){return e.download(e.sampleIds.cells_properties_data,e.sample+".tsv.gz")}}},[t("span",{staticClass:"text-info mr-2"},[t("v-icon",{attrs:{name:"file-archive"}})],1),e._v(" "+e._s(e.sample)+".tsv.gz")]):e._e()]):e._e(),t("div",{staticClass:"text-center"},[e.confirmReport?t("span",{staticClass:"text-warning mr-2"},[e._v("Really delete this report?")]):e._e(),!e.sampleIds.pdf_report&&e.ROIwithoutLabel?t("p",{staticClass:"text-warning text-center"},[e._v("Please assign a type to all ROIs ("+e._s(e.ROIwithoutLabel)+" missing)")]):e._e(),e.sampleIds.pdf_report?e._e():t("button",{staticClass:"btn btn-sm btn-outline-info",attrs:{type:"button",disabled:e.reportInPreparation||e.ROIwithoutLabel>0},on:{click:e.createReport}},[e._v(e._s(e.reportInPreparation?"preparing...":"create report"))]),e.sampleIds.pdf_report?t("button",{staticClass:"btn btn-sm",class:e.confirmReport?"btn-danger":"btn-outline-danger",attrs:{type:"button",disabled:e.reportDeletionInProgress},on:{click:e.deleteReport}},[e._v(e._s(e.confirmReport?e.reportDeletionInProgress?"request submitted...":"confirm":"delete report..."))]):e._e(),e.confirmReport?t("button",{staticClass:"btn btn-sm btn-outline-light ml-2",attrs:{type:"button"},on:{click:function(c){e.confirmReport=!1}}},[e._v("cancel")]):e._e()])],2)]],2)]):e._e()]],2),t("div",{attrs:{id:"imagePanel"}},[e._m(8),e.showDensity?t("div",{style:`border-color:rgb(${e.cellType?e.colorMaps[e.cellType].color:"0,0,0"}); min-width: 1200px; overflow: auto;`,attrs:{id:"densityContainer"}},[t("channel-densities",{attrs:{sample:e.sample,cellType:e.cellType,canEdit:e.canEdit,thresholds:e.thresholds,tumorChannel:e.tumorChannel},on:{"set-threshold":function(c){return e.updateThreshold(c)},"close-density":function(c){e.showDensity=!1}}})],1):e._e(),t("div",{attrs:{id:"coordinates"}},[t("div",{attrs:{id:"navigator"}}),t("div",{attrs:{id:"topleft"}},[e._v(e._s(Math.round(e.coordinates.x))+":"+e._s(Math.round(e.coordinates.y)))]),t("div",{attrs:{id:"bottomright"}},[e._v(e._s(Math.round(e.coordinates.x+e.coordinates.width))+":"+e._s(Math.round(e.coordinates.y+e.coordinates.height)))]),e.openSeadragonReady?e._e():t("span",{staticClass:"badge badge-info",staticStyle:{position:"absolute",top:"5px",right:"5px"}},[e._v("loading...")])]),t("div",{attrs:{id:"cells"}},e._l(e.cells,function(c,g){return t("svg",{key:g,staticStyle:{"z-index":"99999"},attrs:{height:"9",width:"9",id:`cell${g}`}},[t("circle",{attrs:{cx:"5",cy:"5",r:e.getRadius(c[e.cellType]),fill:e.showCells?e.getColor(c[e.cellType]):"transparent",stroke:e.getStrokeColor(c[e.cellType]),"stroke-width":`${e.showCells?1:0}`}})])}),0),t("div",{attrs:{id:"openseadragon"}})])]),e.tissueThresholdAdjust&&!e.tissueSegmentationsLoaded?t("div",{attrs:{id:"divTissueThresholdLoading"}},[t("h1",{staticClass:"h5 text-muted"},[e._v("Loading...")]),t("b-progress",{attrs:{value:e.nbTissueSegmentationsImgs,max:e.tissueSegmentations.length,animated:""}})],1):e._e(),t("div",{style:`display:${e.tissueThresholdAdjust&&e.tissueSegmentationsLoaded?"block":"none"}`,attrs:{id:"divTissueThreshold"}},[t("h1",{staticClass:"h5"},[e._v("Adjust segmentation "),t("b-button",{directives:[{name:"b-modal",rawName:"v-b-modal.tumorModal",modifiers:{tumorModal:!0}},{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],attrs:{variant:"outline-light",size:"sm",title:`Show ${e.tumorChannel} intensity distribution`}},[t("v-icon",{attrs:{name:"chart-area"}})],1),t("button",{staticClass:"close float-right",attrs:{type:"button","aria-label":"Close"},on:{click:function(c){e.tissueThresholdAdjust=!1}}},[t("span",{attrs:{"aria-hidden":"true"}},[e._v("\xD7")])])],1),t("div",{staticClass:"list-group",staticStyle:{height:"100%",overflow:"auto"}},e._l(e.tissueSegmentations,function(c){return t("a",{key:c.cutoff,staticClass:"list-group-item list-group-item-action",class:e.tissueThreshold===c.cutoff?"":"active",attrs:{id:`${e.tissueThreshold===c.cutoff?"default"+e.tumorChannel:""}`},on:{click:function(g){return e.displayOverlay("tissue",c.cutoff)}}},[t("div",{staticClass:"d-flex w-100 justify-content-between"},[t("h5",{staticClass:"mb-1 w-100",style:`color: ${e.tissueThreshold===c.cutoff?"#000":"#FFF"}`},[e._v(" "+e._s(Math.round(c.cutoff.replace(e.tissueRegExp,"")*100)/100)+" "),e.defaultCutoff(e.tumorChannel,c.cutoff.replace(e.tissueRegExp,""))?t("span",{staticClass:"badge badge-info mx-1"},[e._v("INITIAL")]):e._e(),e.originalCutoff(e.tumorChannel,c.cutoff.replace(e.tissueRegExp,""))?t("span",{staticClass:"badge badge-info mx-1"},[e._v("AUTOMATIC")]):e._e(),t("span",{staticClass:"float-right"},[e.originalCutoff(e.tumorChannel,c.cutoff.replace(e.tissueRegExp,""))||e.defaultCutoff(e.tumorChannel,c.cutoff.replace(e.tissueRegExp,""))?t("b-button",{directives:[{name:"b-modal",rawName:"v-b-modal.tumorModal",modifiers:{tumorModal:!0}},{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],attrs:{variant:"outline-light",size:"sm",title:`Show ${e.tumorChannel} intensity distribution`}},[t("v-icon",{attrs:{name:"chart-area"}})],1):e._e()],1)])]),t("img",{attrs:{src:c.img}})])}),0)]),t("b-modal",{ref:"tumorModal",attrs:{id:"tumorModal",title:`${e.tumorChannel} intensities distribution`,"hide-footer":!0,"hide-header":!0,size:"xl"}},[e.qcPDF?t("div",[t("img",{staticClass:"img-fluid",attrs:{src:e.qcPDF}})]):e._e()]),t("b-modal",{ref:"ifquantCmdModal",attrs:{id:"ifquantCmdModal",title:e.cmdTitle,"hide-footer":!0,"title-class":"text-dark",size:"xl"}},[t("div",{staticClass:"container"},[t("div",{staticClass:"p-2 border pt-4",staticStyle:{position:"relative"}},[t("button",{directives:[{name:"clipboard",rawName:"v-clipboard",value:function(){return e.ifquantCmd},expression:"() => ifquantCmd"},{name:"clipboard",rawName:"v-clipboard:success",value:e.clipboardSuccessHandler,expression:"clipboardSuccessHandler",arg:"success"},{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],staticClass:"btn btn-outline-secondary btn-sm",staticStyle:{position:"absolute",top:"4px",right:"4px"},attrs:{type:"button",title:"Copy Docker CMD"}},[t("v-icon",{attrs:{name:"clipboard",scale:"0.9"}})],1),t("pre",[e._v(e._s(e.ifquantCmd))]),t("ul",{staticClass:"bg-secondary text-light p-1 pl-4"},[t("li",[e._v("The "),t("code",[e._v("nprocesses")]),e._v(" parameter can be adapted depending on the number of available CPUs. Be aware that the process will also consume more memory.")]),t("li",[e._v("The "),t("code",[e._v("--tmpdir=<TEMPORARY_DIR>")]),e._v(" parameter can be specified (the default is "),t("code",[e._v("<ANALYSIS_DIR>/tmp")]),e._v("). If enough memory is available, "),t("code",[e._v("/dev/shm")]),e._v(" is an option to speed up the process.")])]),t("p",{staticClass:"bg-info p-2"},[e._v("Reload the page once the process is finished.")])])])])],1)},El=[function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("h5",{staticClass:"text-center text-muted"},[t("i",[e._v("loading...")])])},function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("small",[t("i",[e._v("...")])])},function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("p",{staticClass:"text-center w-100"},[t("strong",[e._v("Select a cell type to highlight it and display its channel")])])},function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("p",{staticClass:"text-center mb-0 pb-0"},[t("small",[t("em",[e._v("SHIFT-click to toggle ALL channels at once")])])])},function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("small",[t("span",{staticClass:"px-2 py-1",staticStyle:{"background-color":"#0F0",border:"1px solid #0C0",color:"#000"}},[e._v("ok")]),e._v(" "),t("span",{staticClass:"ml-1 px-2 py-1",staticStyle:{"background-color":"#F00",border:"1px solid #C00",color:"#000"}},[e._v("saturating")]),e._v(" "),t("br"),e._v(" "),t("span",{staticClass:"text-warning"},[e._v("unmixing might be problematic in saturating regions")])])},function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("small",[t("span",{staticClass:"px-2 py-1",staticStyle:{"background-color":"#FFF",color:"#000"}},[e._v("empty")]),e._v(" "),t("span",{staticClass:"px-2 py-1",staticStyle:{"background-color":"#CCC",color:"#000"}},[e._v("low dapi")]),e._v(" "),t("span",{staticClass:"px-2 py-1",staticStyle:{"background-color":"#F00",color:"#000"}},[e._v("DAPI out of focus")]),e._v(" "),t("br"),e._v(" "),t("span",{staticClass:"px-2 py-1",staticStyle:{"background-color":"#FF0",color:"#000"}},[e._v("DAPI focus warning")]),e._v(" "),t("span",{staticClass:"px-2 py-1",staticStyle:{"background-color":"#0F0",color:"#000"}},[e._v("DAPI focus OK")])])},function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("label",{staticClass:"mr-2"},[t("strong",[e._v("has TLS: ")])])},function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("div",{staticClass:"card-title"},[t("strong",[e._v("This action will reset all ROIs and exclusions")])])},function(){var e=this,h=e.$createElement,t=e._self._c||h;return t("div",{staticStyle:{position:"absolute",right:"10px",bottom:"-15px",width:"300px","z-index":"10","text-align":"right",align:"right",color:"rgb(90,101,120)"}},[t("small",[e._v("powered by: "),t("a",{attrs:{href:"https://iipimage.sourceforge.io/",target:"_blank"}},[t("img",{attrs:{src:Tl,width:"80",height:"15",alt:"Iip Badge"}})])])])}];var Zt;const on=ir.CancelToken;let Kt,st,Qt=!0;function Pl(e){return`?FIF=${`analyses/${e}/sqrt_unmixed_images/image_unmixed.tiff`}&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number&obj=Resolutions`}function ln(e){let h={height:0,width:0,tileSize:0,maxLevel:0,resolutions:[]},t=e.split(/\r\n/);return _.forEach(t,c=>{let g=c.split(":");const m=g[0],y=g[1];if(m==="Max-size"){const i=y.split(" ");h.width=+i[0],h.height=+i[1]}else if(m==="Tile-size"){const i=y.split(" ");h.tileSize=+i[0]}else if(m==="Resolution-number")h.maxLevel=+y;else if(m==="Resolutions"){var a=y.split(/,/);_.forEach(a,i=>{let r=i.split(/ /),o=Math.ceil(r[0]/h.tileSize),n=Math.ceil(r[1]/h.tileSize);h.resolutions.push({nx:o,ny:n})})}}),h}function Ol(e){var h=[],t=[],c=[],g,m;for(let y=0;y<e.length;y++)g=+e[y].intensity,m=Math.round(e[y].color[0]/255*100*g)/100,h.push(m),m=Math.round(e[y].color[1]/255*100*g)/100,t.push(m),m=Math.round(e[y].color[2]/255*100*g)/100,c.push(m);return"["+h.join(",")+";"+t.join(",")+";"+c.join(",")+"]"}var Rl=function(e,h){if(h=+h,h<0)throw new Error("Contrast adjustment must be positive.");for(var t={r:[],g:[],b:[]},c=0;c<256;c++)t.r[c]=Math.min(c*e[0]/255*h,255),t.g[c]=Math.min(c*e[1]/255*h,255),t.b[c]=Math.min(c*e[2]/255*h,255);return function(g,m){for(var y=g.getImageData(0,0,g.canvas.width,g.canvas.height),a=y.data,i=0;i<a.length;i+=4)a[i]=t.r[a[i]],a[i+1]=t.g[a[i+1]],a[i+2]=t.b[a[i+2]];g.putImageData(y,0,0),m()}},hn=1,cn=1;const Dl={name:"ifquantApp",components:{channelDensities:bl},data(){return{imageParams:{height:0,width:0,tileSize:0,maxLevel:0,resolutions:[]},prevRoute:{path:"",query:{}},processingStep:"annotation",sample:"",sampleIds:{cells_properties_data:null,panel:null,pdf_report:null,report_date:null,report_status:null,reporter:null,sample_id:null,status:null,xlsx_data:null,xlsx_rois:[]},viewer:null,bounds:{x:0,y:0,height:1,width:1},tumorChannel:"CK",nucleusChannel:"",fabricOverlay:{},existingUnlabelledRoiIdx:[],overlaySet:[],cellType:"",thresholds:{},originalThresholds:{},autoThresholds:{},highlightCells:{},showHighlightCells:!1,hasDensities:!1,hasCellsDb:!0,opacity:.5,tissueOpacity:.5,recomputeDisplayedROIs:0,factor:1,cells:[],total:0,loading:!1,loadingStats:!1,loadingSampleIds:!1,loadingNotifications:!1,saturationDisplayed:!1,sharpnessDisplayed:!1,tissueDisplayed:!1,tlsDisplayed:!1,tissueThresholdAdjust:!1,showCells:!1,showTissueMask:!0,tissueThreshold:0,tissueSegmentations:[],colorMaps:{},channels:[],TLS:{},qcPDF:null,backgroundImage:"composite",showNegatives:!1,showStats:!0,stats:{ifquant:{},ifquant_tumor:{},ifquant_stroma:{},inform:{}},notifications:{},coordinates:{x:0,y:0,width:0,height:0},cvROItitles:["Tumor tissue","Next to tumor tissue","TLS","Host tissue","Adipose tissue","Necrosis"],ROItitle:null,activeROIidx:-1,showOtherROItitle:!1,annotateMode:!1,drawMode:"",isAnnotationSelected:!1,shiftKey:!1,ctrlKey:!1,openSeadragonReady:!1,confirmReport:!1,reportInPreparation:!1,downloadingReport:!1,confirmPublishAnalysis:!1,confirmUnpublish:!1,loadingOtherPhenotypes:!1,QCs:[],showDensity:!1,reportDeletionInProgress:!1,confirmResetAnnotation:!1,densityCellType:"",reviewedCellTypes:{},ifquantCmd:"",cmdTitle:""}},methods:{clipboardSuccessHandler(){this.$snotify.success("Command copied successfully to the clipboard")},toggleChannelVisibility(e){let h;this.channels[e].intensity?(Te.set(this.channels[e],"previousIntensity",+this.channels[e].intensity+0),h=0):h=this.channels[e].previousIntensity!==void 0?Math.round(this.channels[e].previousIntensity*10)/10:1,this.channels[e].intensity=h,(this.ctrlKey||this.shiftKey)&&(h?_.forEach(this.channels,(t,c)=>{if(c!==e&&!t.intensity&&t.marker!=="DAPI"&&t.marker!==this.cellType){let g=t.previousIntensity!==void 0&&t.previousIntensity>0?t.previousIntensity:1;Te.set(this.channels[c],"intensity",g)}}):_.forEach(this.channels,(t,c)=>{c!==e&&t.marker!=="DAPI"&&t.marker!==this.cellType&&(+this.channels[c].intensity&&Te.set(this.channels[c],"previousIntensity",this.channels[c].intensity+0),Te.set(this.channels[c],"intensity",0))}))},getTextColor(e){let h=[];_.isArray(e)?h=e:h=e.split(",");var t=Math.round((parseInt(h[0])*299+parseInt(h[1])*587+parseInt(h[2])*114)/1e3);return t>125?"black":"white"},getCellTypeStyle(e){let h=this.colorMaps[e].color;if(e===this.cellType){let t=this.getTextColor(h);return`background-color: rgb(${h}); color: ${t}; width: 100%; padding-left: 5px; font-size: 1rem`}else return`background-color: transparent; color: rgb(${h}); width: 100%; padding-left: 5px; border: 1px solid rgb(${h}); font-size: 1rem`},getChannelStyle(e){if(+e.intensity){let h=this.getTextColor(e.color);return`background-color: rgb(${e.color.join(",")}); color: ${h}; width: 100%; padding-left: 5px;`}else return`background-color: transparent; color: white; width: 100%; padding-left: 5px; border: 1px solid rgb(${e.color.join(",")})`},backToList(){this.prevRoute.path!=="/"?this.$router.push({path:"/",query:{}}):this.$router.push({path:this.prevRoute.path,query:this.prevRoute.query})},createViewer(){const e=this;let h=this.getTileSources();this.viewer=Ie({id:"openseadragon",loadTilesWithAjax:!0,prefixUrl:"../../openseadragon-icons/",tileSources:[{x:0,y:0,width:this.imageParams.width,tileSource:h}],imageSmoothingEnabled:!1,showNavigator:!0,sequenceMode:!1,navigatorId:"navigator",navigatorAutoFade:!1,maxZoomPixelRatio:10,showFullPageControl:!1}),this.fabricOverlay=this.viewer.fabricjsOverlay({scale:1}),this.fabricOverlay.fabricCanvas().freeDrawingBrush.width=10,this.fabricOverlay.fabricCanvas().freeDrawingBrush.color="#FFF",this.fabricOverlay.fabricCanvas().on("mouse:up",function(){Te.nextTick().then(()=>{e.fabricOverlay.fabricCanvas().getObjects().forEach(t=>{t.path.length<20?(e.fabricOverlay.fabricCanvas().remove(t),e.saveAnnotations()):t.stroke==="#F00"&&(t.fill||(t.fill="rgba(16,0,0,0.8)",e.processingStep="annotation"))}),e.fabricOverlay.fabricCanvas().renderAll(),e.viewer.forceRedraw()})}),this.fabricOverlay.fabricCanvas().on("selection:created",function(t){if(e.drawMode==="roi"){let y=e.fabricOverlay.fabricCanvas().getActiveObject();var c=e.fabricOverlay.fabricCanvas().getPointer(t.e,!0);const a=document.getElementById("leftPanel").offsetWidth;var g=c.x+a,m=c.y;if(this.activeROIidx===-1){let i=document.getElementById("ROIannotation");i.style.left=g-40+"px",i.style.top=m+10+"px",i.style.visibility="visible"}y.title!==void 0&&(e.ROItitle=y.title)}if(t.target.path!==void 0){let y=e.fabricOverlay.fabricCanvas().getActiveObject();y.title!==void 0&&(e.ROItitle=y.title),t&&t.target!==void 0&&(e.showAnnotationTitle(t),t.target.set({hasControls:!1,lockScalingX:!0,lockScalingY:!0}))}else t.target.set({hasControls:!0,hasRotatingPoint:!1})}),this.fabricOverlay.fabricCanvas().on("selection:updated",function(t){if(e.drawMode==="roi"){let y=e.fabricOverlay.fabricCanvas().getActiveObject();var c=e.fabricOverlay.fabricCanvas().getPointer(t.e,!0);const a=document.getElementById("leftPanel").offsetWidth;var g=c.x+a,m=c.y;if(this.activeROIidx===-1){let i=document.getElementById("ROIannotation");i.style.left=g-40+"px",i.style.top=m+10+"px",i.style.visibility="visible"}e.ROItitle=y.title}if(t.target.path!==void 0){let y=e.fabricOverlay.fabricCanvas().getActiveObject();y.title!==void 0&&(e.ROItitle=y.title),t&&t.target!==void 0&&(e.showAnnotationTitle(t),t.target.set({hasControls:!1,lockScalingX:!0,lockScalingY:!0}))}else t.target.set({hasControls:!0,hasRotatingPoint:!1})}),this.fabricOverlay.fabricCanvas().on("selection:cleared",function(){e.ROItitle=null;let t=document.getElementById("ROIannotation");t.style.left="0px",t.style.top="0px",t.style.visibility="hidden",e.fabricOverlay.fabricCanvas().discardActiveObject().renderAll()}),this.fabricOverlay.fabricCanvas().on("object:modified",function(){e.saveAnnotations()}),this.fabricOverlay.fabricCanvas().on("path:created",function(t){e.showAnnotationTitle(t)}),this.viewer.addHandler("open",()=>{let t=e.viewer.viewport.getBoundsNoRotate();if(e.bounds.x=t.x,e.bounds.y=t.y,e.bounds.height=t.height,e.bounds.width=t.width,e.getCells(),e.viewer.world.getItemCount()){let g=e.viewer.world.getItemAt(0);if(!g)return;g&&(e.openSeadragonReady=!0,e.loadQC())}be.get("/"+this.sample+"/annotations").then(g=>{if(g.data)if(g.data==="processing")e.processingStep="processing";else{e.processingStep="analysis",_.forEach(g.data.objects,(y,a)=>{y.fill==="rgba(255,0,0,0.4)"&&(g.data.objects[a].fill="rgba(16,0,0,0.8)")}),e.fabricOverlay.fabricCanvas().loadFromJSON(g.data);let m=e.fabricOverlay.fabricCanvas().getObjects();_.forEach(m,(y,a)=>{y.stroke!==void 0&&y.stroke!=="#F00"&&(y.title===void 0||!y.title)&&e.existingUnlabelledRoiIdx.push(a)})}}).catch(()=>{e.processingStep="annotation",e.toggleOverlay("tissue"),e.toggleDraw("exclusion")});let c=Math.sqrt(this.tissueSegmentations[0].data.tumor_px/this.tissueSegmentations[0].data.tumor_area)*1e6;e.viewer.scalebar({type:Ie.ScalebarType.MICROSCOPY,location:Ie.ScalebarLocation.BOTTOM_LEFT,pixelsPerMeter:c,stayInsideImage:!1,color:"#FFF",fontColor:"#FFF",width:"150px",barThickness:2})}),this.viewer.addHandler("viewport-change",()=>{Zt&&clearTimeout(Zt),Zt=setTimeout(()=>{let t=document.getElementById("ifquantTooltip");t.style.visibility="hidden";let c=e.viewer.viewport.getBoundsNoRotate();e.bounds.x=c.x,e.bounds.y=c.y,e.bounds.height=c.height,e.bounds.width=c.width,e.recomputeDisplayedROIs++,e.viewer.clearOverlays()},200)}),this.viewer.addHandler("clear-overlay",()=>{let t=document.getElementById("ifquantTooltip");t&&(t.style.visibility="hidden"),this.cells=[],Te.nextTick().then(()=>{e.getCells()})}),window.addEventListener("keydown",function(t){e.shiftKey=t.shiftKey,e.ctrlKey=t.ctrlKey,e.annotateMode&&t.shiftKey&&(e.viewer.setMouseNavEnabled(!0),e.viewer.outerTracker.setTracking(!0)),t.key==="r"&&t.ctrlKey?e.openSeadragonReady&&e.toggleDraw("roi"):(t.key==="x"||t.key==="e")&&t.ctrlKey?e.openSeadragonReady&&e.toggleDraw("exclusion"):t.key==="a"&&t.ctrlKey&&e.openSeadragonReady&&e.toggleAnnotate()}),window.addEventListener("keyup",function(t){e.annotateMode&&e.shiftKey&&(e.viewer.setMouseNavEnabled(!1),e.viewer.outerTracker.setTracking(!1)),e.shiftKey=t.shiftKey,e.ctrlKey=t.ctrlKey})},updateViewer(){const e=this,h=this.viewer.viewport.getBounds();let t=this.getTileSources();this.viewer.addTiledImage({tileSource:t,opacity:1,index:1,width:this.imageParams.width,success(){e.viewer.viewport.fitBounds(h);const c=e.viewer.world.getItemAt(0);e.viewer.world.removeItem(c)}})},loadTissueSegmentations(){if(!this.canEdit)return;const e=this;let h=[];return _.forEach(this.tissueSegmentations,(t,c)=>{h.push(new Promise((g,m)=>{e.tissueSegmentations[c].img&&g(e.tissueSegmentations[c].img);let y="?",a="analyses/"+e.sample+"/tissue_segmentation/"+t.cutoff+"/tissue_type_mask.tiff",i="WID=200&",r=y+"FIF="+a+"&"+i+"CVT=jpeg";return be.get(`/${e.sample}/tissue_sementation_thumbnail${r}`,{responseType:"arraybuffer",headers:{Accept:"image/jpeg"}}).then(o=>{let n=btoa(new Uint8Array(o.data).reduce(function(l,u){return l+String.fromCharCode(u)},""));var s=o.headers["content-type"].toLowerCase();e.tissueSegmentations[c].img="data:"+s+";base64,"+n,g(e.tissueSegmentations[c].img)}).catch(o=>m(o))}))}),Promise.all(h)},loadQC(){const e=this;if(e.qcPDF)return;be.get("/"+e.sample+"/qcpdf",{responseType:"arraybuffer",headers:{Accept:"application/png"}}).then(t=>{let c=btoa(new Uint8Array(t.data).reduce(function(m,y){return m+String.fromCharCode(y)},""));var g=t.headers["content-type"].toLowerCase();e.qcPDF="data:"+g+";base64,"+c});let h=["saturation","sharpness"];this.cellTypes.indexOf("CD20")>-1&&h.push("tls"),_.forEach(h,t=>{const c=t==="tls"?"TLS":"cell_segmentation",g=t==="tls"?"TLS_mask":t;let y=`?FIF=${"analyses/"+e.sample+"/"+c+"/"+g+".tiff"}&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number&obj=Resolutions`;return Ti.get(y).then(a=>{ln(a.data),e.QCs.indexOf(t)===-1&&e.QCs.push(t)}).catch(()=>{const a=e.QCs.indexOf(t);a>-1&&e.QCs.splice(a,1)})})},init(e){return new Promise(h=>{const t=this;hn=e.width,cn=e.height,this.bounds={x:0,y:0,width:hn,height:cn},this.sample=e.sample,this.colorMaps=e.colorMaps,_.forEach(e.colorMaps,(c,g)=>{Te.set(t.channels,+c.channel,{marker:g,color:c.color.split(","),intensity:1})}),_.forEach(e.colorMaps,(c,g)=>{c.type.indexOf("tumor")>-1&&(t.tumorChannel=g),c.type!=="nucleus"&&(t.highlightCells[g]=null),c.type.indexOf("nucleus2")>-1&&(t.nucleusChannel=g)}),this.TLS=e.TLS,this.thresholds=e.thresholds,this.originalThresholds=e.originalThresholds,this.imageParams=Object.assign({},this.imageParams,e.imageParams),this.hasDensities=e.hasDensities,this.hasCellsDb=e.hasCellsDb,_.forEach(Object.keys(this.colorMaps),c=>{c!=="DAPI"&&(this.highlightCells[c]=null)}),_.forEach(Object.keys(e.thresholds),c=>{Te.set(t.stats.ifquant,c,0),Te.set(t.stats.inform,c,0)}),this.autoThresholds=JSON.parse(JSON.stringify(e.thresholds)),this.tissueThreshold=t.tumorChannel.toLowerCase()+"_"+e.thresholds[t.tumorChannel].value,this.tissueSegmentations=e.tissue_segmentations,h(!0)})},defaultCutoff(e,h){return this.autoThresholds[e].value===+h},originalCutoff(e,h){return this.originalThresholds[e].value===+h},notify(e,h){this.$snotify[h](e)},getRadius(e){return this.showNegatives?Math.abs(e)>0?4:2:4},getStrokeColor(e){return this.showNegatives?Math.abs(e)>0?"#FFF":"#888":"#FFF"},getColor(e){return this.showNegatives?Math.abs(e)>0?"#F00":"#888":"#F00"},getTableStyle(e){return e===this.cellType?`width: ${100/this.cellTypes.length}%; background-color: rgb(${this.colorMaps[e].color}); color:${this.getTextColor(this.colorMaps[e].color)}; font-weight:bold"}`:`width: ${100/this.cellTypes.length}%;color: rgb(${this.colorMaps[e].color})`},addOverlay(e,h){const t=this,c=t.viewer.world.getItemAt(0);if(!c)return;let g={x:+e.x,y:+e.y,id:`cell${h}`,checkResize:!1,placement:"CENTER"},m=c.imageToViewportCoordinates(g.x,g.y);g.x=m.x,g.y=m.y,document.getElementById(g.id)&&!isNaN(g.x)&&t.viewer.addOverlay(g)},getImageParams(){return this.imageParams},getTileSources(){const e=this;let h=this.sample,t=this.getImageParams();return{height:t.height,width:t.width,preload:!0,tileSize:t.tileSize,maxLevel:t.maxLevel,minLevel:1,getTileUrl:function(c,g,m){c--;let y,a;y=t.resolutions[c].nx*m+g,a=Ol(e.channels);let i=`analyses/${h}/sqrt_unmixed_images/image_unmixed.tiff`;return`${Si}?FIF=${i}&CTW=${a}&GAM=2&JTL=${c},${y}`}}},getStats(){if(!this.showStats)return;let e=this;return st!==void 0&&st(),new Promise((h,t)=>{let c="";this.loadingStats=!0,be.get(`/${this.sample}/stats?x=${Math.round(this.coordinates.x)}&y=${Math.round(this.coordinates.y)}&width=${Math.round(this.coordinates.width)}&height=${Math.round(this.coordinates.height)}&marker=${this.cellType}&threshold=${this.threshold}&type=${this.quantType}${c}`,{cancelToken:new on(function(m){st=m})}).then(g=>{e.loadingStats=!1,_.forEach(g.data,(m,y)=>{_.forEach(m,(a,i)=>{e.stats[y][i]=+a})}),h(e.stats)}).catch(()=>{e.loadingStats=!1,t("error")})})},getCells(){const e=this;Qt=!0,Kt!==void 0&&Kt(),st!==void 0&&st();const h=e.viewer.world.getItemAt(0);if(!!h&&!e.loading){let t=new Ie.Point(e.bounds.x,e.bounds.y),c=h.viewportToImageCoordinates(t),g=new Ie.Point(e.bounds.x+e.bounds.width,e.bounds.y+e.bounds.height),m=h.viewportToImageCoordinates(g);if(this.coordinates.x=c.x,this.coordinates.y=c.y,this.coordinates.width=m.x-this.coordinates.x,this.coordinates.height=m.y-this.coordinates.y,this.cellType==="tissue"||!this.cellType||!this.showCells)return;this.loading=!0,this.loadingStats=!0;let y=[];_.forEach(this.highlightCells,(i,r)=>{i!==null&&y.push({marker:r,threshold:e.thresholds[r].value,status:i})});let a={x:Math.round(this.coordinates.x),y:Math.round(this.coordinates.y),width:Math.round(this.coordinates.width),height:Math.round(this.coordinates.height),thresholds:y,marker:this.cellType,threshold:this.threshold,type:this.quantType};be.post(`/${this.sample}/cells`,{params:a,cancelToken:new on(function(r){Kt=r})}).then(i=>{e.total=i.data.total,e.cells=i.data.cells,e.factor=i.data.factor,e.showNegatives=i.data.showNegatives,Te.nextTick().then(function(){_.forEach(e.cells,(r,o)=>{document.getElementById(`cell${o}`)&&r.x!==void 0&&(e.addOverlay(r,o),new Ie.MouseTracker({element:`cell${o}`,clickHandler:function(n){if(e.cellType){let s=e.cellType.length>8?e.cellType.substr(0,8)+".":e.cellType,l=new Ie.Point(n.originalEvent.x,n.originalEvent.y),u=document.getElementById("ifquantTooltip");u.style.left=l.x-50+"px",u.style.top=l.y+10+"px",u.innerHTML="<strong>"+s+": "+Math.round(e.cells[o].tooltip*10)/10,u.style.visibility="visible"}}}))}),e.loading=!1}),e.getStats().then(()=>{e.loadingStats=!1})}).catch(i=>this.$snotify.error(i))}},toggleDensity(){this.showDensity=!this.showDensity},toggleTissueMask(){this.viewer.world.getItemCount()!==1&&(this.opacity?(this.viewer.world.getItemAt(1).setOpacity(0),this.opacity=0):(this.viewer.world.getItemAt(1).setOpacity(.5),this.opacity=.5))},toggleSaturation(){this.saturationDisplayed=!this.saturationDisplayed},toggleSharpness(){this.sharpnessDisplayed=!this.sharpnessDisplayed},toggleOverlay(e){const h=this;this[`${e}Displayed`]=!this[`${e}Displayed`];let t;if(this[`${e}Displayed`])e==="tissue"?(this.showCells=!1,h.toggleCellType(this.tumorChannel),_.forEach(this.channels,(c,g)=>{c.marker!==this.tumorChannel&&c.marker!=="DAPI"?(this.channels[g].intensity&&Te.set(this.channels[g],"previousIntensity",+this.channels[g].intensity+0),this.channels[g].intensity=0):(t=this.channels[g].previousIntensity!==void 0?Math.round(this.channels[g].previousIntensity*10)/10:1,this.channels[g].intensity=t)}),this.$store.commit("RESET_DENSITIES")):e==="tls"&&this.cellTypes.indexOf("CD20")>-1&&(this.showCells=!1,_.forEach(this.channels,(c,g)=>{c.marker!=="CD20"&&c.marker!=="DAPI"?(this.channels[g].intensity&&Te.set(this.channels[g],"previousIntensity",+this.channels[g].intensity+0),this.channels[g].intensity=0):(t=this.channels[g].previousIntensity!==void 0?Math.round(this.channels[g].previousIntensity*10)/10:1,this.channels[g].intensity=t)})),this.displayOverlay(e);else{e==="tissue"?(h.toggleCellType(this.tumorChannel),this.showCells=!1):e==="tls"&&this.cellTypes.indexOf("CD20")>-1&&this.toggleCellType("CD20");const c=h.viewer.world.getItemAt(1);h.viewer.world.removeItem(c),this.tissueThresholdAdjust=!1,this.opacity=.5,this.tissueOpacity=.5}},displayOverlay(e,h){const t=this;h&&(this[`${e}Threshold`]=h,this.thresholds[this.tumorChannel].value=+h.replace(t.tissueRegExp,""),this.saveThreshold(this.tumorChannel),this.viewer.clearOverlays());const c=1;if(t.viewer.world.getItemCount()>c){const i=t.viewer.world.getItemAt(c);t.viewer.world.removeItem(i)}const g=this.viewer.viewport.getBounds(),m=e==="tls"?"TLS":"cell_segmentation",y=e==="tls"?"TLS_mask":e,a=e==="tissue"?`analyses/${this.sample}/tissue_segmentation/${this.tissueThreshold}/tissue_type_mask.tiff.dzi`:`analyses/${this.sample}/${m}/${y}.tiff.dzi`;this.viewer.addTiledImage({x:0,y:0,width:this.imageParams.width,tileSource:`${Si}?DeepZoom=${a}`,opacity:this.opacity,index:1,preserveViewport:!0,error(i){t.$snotify.error(i.message)},success(){t.viewer.viewport.fitBounds(g),t.updateViewerFilters(1)}})},toggleCellType(e){this.showDensity=!1,this.cellType===e?(this.cellType=null,this.viewer.clearOverlays()):(this.cellType=e,this.$store.commit("RESET_DENSITIES")),_.forEach(this.highlightCells,(h,t)=>{this.highlightCells[t]=t===e?!0:null}),this.updateThreshold()},toggleCells(){this.showCells=!this.showCells,this.showCells?Qt&&this.getCells():Qt=!1},toggleInform(e){this.quantType=e,this.viewer.clearOverlays()},displayCellType(e){let h;e?_.forEach(this.channels,(t,c)=>{t.marker!==e&&t.marker!=="DAPI"?this.channels[c].intensity=0:(h=this.channels[c].previousIntensity!==void 0?Math.round(this.channels[c].previousIntensity*10)/10:1,this.channels[c].intensity=h)}):_.forEach(this.channels,(t,c)=>{t.marker!=="DAPI"?this.channels[c].intensity=0:(h=this.channels[c].previousIntensity!==void 0?Math.round(this.channels[c].previousIntensity*10)/10:1,this.channels[c].intensity=h)}),this.viewer.clearOverlays()},updateViewerFilters(e){const h=this;let t;if(e===1&&this.tlsDisplayed){let c=[204,0,204];t=[{items:h.viewer.world.getItemAt(1),processors:[Ie.Filters.GAMMA(2),Rl(c,5)]}]}t&&this.viewer.setFilterOptions({filters:t,loadMode:"sync"})},resetThreshold(){this.showDensity=!1,this.updateThreshold(this.originalThresholds[this.cellType].value)},setHighlightCells(e,h){this.highlightCells[e]=this.highlightCells[e]===h?null:h,this.updateThreshold()},updateThreshold(e){e!==void 0&&(this.thresholds[this.cellType].value=e);const h=this;this.loadingNotifications=!0,this.thresholds[this.cellType]!==void 0&&(be.get("/"+this.sample+"/notifications?marker="+this.cellType+"&threshold="+this.thresholds[this.cellType].value).then(t=>{this.loadingNotifications=!1,_.forEach(t.data.thresholds,(c,g)=>{Te.set(h.notifications,g,c)})}).catch(t=>this.$snotify.error(t)),this.viewer.clearOverlays())},saveThreshold(e){let h=this;e||(e=this.cellType),e&&be.patch("/"+this.sample+"/thresholds",{marker:e,threshold:this.thresholds[e].value+""}).then(()=>{h.$snotify.success("Threshold saved successfully")}).catch(t=>h.$snotify.error(t))},toggleAnnotate(){this.annotateMode=!this.annotateMode,this.annotateMode?(this.viewer.setMouseNavEnabled(!1),this.viewer.outerTracker.setTracking(!1),this.drawMode==="exclusion"&&(this.fabricOverlay.fabricCanvas().isDrawingMode=!0,this.fabricOverlay.fabricCanvas().freeDrawingBrush.color="#F00"),this.drawMode==="roi"&&(this.fabricOverlay.fabricCanvas().isDrawingMode=!0,this.fabricOverlay.fabricCanvas().freeDrawingBrush.color="#0F0")):(this.drawMode&&this.toggleDraw(this.drawMode),this.viewer.setMouseNavEnabled(!0),this.viewer.outerTracker.setTracking(!0),this.fabricOverlay.fabricCanvas().discardActiveObject(),this.fabricOverlay.fabricCanvas().requestRenderAll())},toggleDraw(e){let h=this;if(this.drawMode=this.drawMode===e?"":e,this.drawMode){if(this.annotateMode||this.toggleAnnotate(),this.drawMode==="exclusion")this.fabricOverlay.fabricCanvas().isDrawingMode=!0,this.fabricOverlay.fabricCanvas().freeDrawingBrush.color="#F00";else if(this.drawMode==="roi")this.fabricOverlay.fabricCanvas().isDrawingMode=!0,this.fabricOverlay.fabricCanvas().freeDrawingBrush.color="#0F0";else if(this.drawMode==="roir"){var t,c,g,m;this.fabricOverlay.fabricCanvas().on("mouse:down",function(y){c=!0;var a=h.fabricOverlay.fabricCanvas().getPointer(y.e);g=a.x,m=a.y,t=new gn.fabric.Rect({left:g,top:m,originX:"left",originY:"top",width:a.x-g,height:a.y-m,angle:0,fill:"transparent",stroke:"rgb(30,255,01)",strokeWidth:"5",hasControls:!0,hasRotatingPoint:!1,transparentCorners:!1}),h.fabricOverlay.fabricCanvas().add(t),h.fabricOverlay.fabricCanvas().setActiveObject(t)}),h.fabricOverlay.fabricCanvas().on("mouse:move",function(y){if(!!c){var a=h.fabricOverlay.fabricCanvas().getPointer(y.e);g>a.x&&t.set({left:Math.abs(a.x)}),m>a.y&&t.set({top:Math.abs(a.y)}),t.set({width:Math.abs(g-a.x)}),t.set({height:Math.abs(m-a.y)}),h.fabricOverlay.fabricCanvas().renderAll()}}),this.fabricOverlay.fabricCanvas().on("mouse:up",function(){c=!1,h.fabricOverlay.fabricCanvas().off("mouse:down").off("mouse:move").off("mouse:up"),h.fabricOverlay.fabricCanvas().setActiveObject(t),h.toggleDraw("roir"),h.saveAnnotations()})}}this.drawMode!=="roi"&&this.drawMode!=="exclusion"&&(this.fabricOverlay.fabricCanvas().isDrawingMode=!1)},removePath(){if(this.isAnnotationSelected){const e=this.fabricOverlay.fabricCanvas().getActiveObject();e.stroke==="#F00"&&(this.processingStep="annotation");let h=this.fabricOverlay.fabricCanvas().getObjects().indexOf(e);if(h>-1){let t=this.existingUnlabelledRoiIdx.indexOf(h);t>-1&&this.existingUnlabelledRoiIdx.splice(t,1)}this.fabricOverlay.fabricCanvas().remove(e)}this.checkAnnotationStatus(),this.isExclusion||this.saveAnnotations()},checkAnnotationStatus(){if(this.fabricOverlay&&this.fabricOverlay.fabricCanvas&&{}.toString.call(this.fabricOverlay.fabricCanvas)==="[object Function]"&&this.fabricOverlay.fabricCanvas().getActiveObject()){this.isAnnotationSelected=!0;let t=this.fabricOverlay.fabricCanvas().getActiveObject(),c=document.getElementById("ROIannotation");if(c.style.visibility!=="visible"&&this.drawMode==="roi"){if(this.activeROIidx===-1){var e=event.clientX,h=event.clientY;c.style.left=e-100+"px",c.style.top=h-85+"px",c.style.visibility="visible"}this.ROItitle=t.title}}else this.isAnnotationSelected=!1},showAnnotationTitle(e){let h;if(this.drawMode==="exclusion"||e&&e.target&&e.target.stroke==="#F00"||this.activeROIidx>-1)return;h=this.fabricOverlay.fabricCanvas().getPointer(e.e,!0);const t=document.getElementById("leftPanel").offsetWidth;var c=h.x+t,g=h.y;let m=document.getElementById("ROIannotation");m.style.left=c-40+"px",m.style.top=g+10+"px",m.style.visibility="visible",this.showOtherROItitle=this.ROItitle&&this.cvROItitles.indexOf(this.ROItitle)===-1},saveAnnotations(e){const h=this;let t;this.activeROIidx=-1;let c=this.fabricOverlay.fabricCanvas().toJSON(["title"]),g=this.fabricOverlay.fabricCanvas().getActiveObject();if(e){let m=this.fabricOverlay.fabricCanvas().getActiveObject();if(!m){t=this.fabricOverlay.fabricCanvas().getObjects();let a=t[t.length-1];this.fabricOverlay.fabricCanvas().setActiveObject(a)}m=this.fabricOverlay.fabricCanvas().getActiveObject();let y=-1;m?(m.set("title",this.ROItitle),y=_.findIndex(c.objects,a=>a.top===m.top&&a.left===m.left)):y=c.objects.length-1,y>-1&&(c.objects[y].title=this.ROItitle)}t=this.fabricOverlay.fabricCanvas().getObjects(),this.fabricOverlay.fabricCanvas().getObjects().forEach((m,y)=>{m.stroke==="#0F0"&&(m.title===void 0||m.title==="")&&h.existingUnlabelledRoiIdx.indexOf(y)===-1&&h.fabricOverlay.fabricCanvas().remove(m)}),this.fabricOverlay.fabricCanvas().renderAll(),this.viewer.forceRedraw(),this.ROItitle&&this.cvROItitles.indexOf(this.ROItitle)===-1&&this.cvROItitles.push(this.ROItitle),c=this.fabricOverlay.fabricCanvas().toJSON(["title"]),(this.processingStep!=="annotation"||e==="SUBMIT")&&(e==="SUBMIT"&&(this.reportInPreparation=!0),be.post("/"+this.sample+"/annotations",c).then(m=>{this.reportInPreparation=!1,this.ROItitle=null;let y=document.getElementById("ROIannotation");y.style.left="0px",y.style.top="0px",y.style.visibility="hidden",this.fabricOverlay.fabricCanvas().discardActiveObject().renderAll(),this.processingStep=m.data.status,m.data.cmd&&(h.ifquantCmd=m.data.cmd,h.cmdTitle="Run IFQuant analysis",h.$refs.ifquantCmdModal.show()),be.get("/"+this.sample+"/annotations").then(a=>{a.data&&(a.data==="processing"?h.processingStep="processing":(h.processingStep="analysis",_.forEach(a.data.objects,(i,r)=>{i.fill==="rgba(255,0,0,0.4)"&&(a.data.objects[r].fill="rgba(16,0,0,0.8)")})),h.fabricOverlay.fabricCanvas().loadFromJSON(a.data))}).catch(()=>{h.processingStep="annotation",h.toggleOverlay("tissue"),h.toggleDraw("exclusion")})}).catch(m=>this.$snotify.error(m))),g&&this.fabricOverlay.fabricCanvas().discardActiveObject().renderAll(),this.isAnnotationSelected=!1},createReport(){const e=this;this.sampleIds.report_date&&!this.confirmReport?this.confirmReport=!0:(this.reportInPreparation=!0,be.put("/"+this.sample+"/report").then(h=>{e.ifquantCmd=h.data,e.cmdTitle="Create IFQuant Report",e.$refs.ifquantCmdModal.show()}).catch(h=>{e.$snotify.error(h)}))},deleteReport(){const e=this;this.sampleIds.report_date&&!this.confirmReport?this.confirmReport=!0:(this.reportDeletionInProgress=!0,be.delete("/"+this.sample+"/report").then(()=>{e.reportDeletionInProgress=!1,e.sampleIds.reporter=null,e.sampleIds.report_date=null,e.sampleIds.report_status=null,e.sampleIds.pdf_report=null,e.sampleIds.pdf_report_neotil=null,e.sampleIds.xlsx_data=null,e.sampleIds.cells_properties_data=null,e.sampleIds.xlsx_rois=[],e.confirmReport=!1,e.$snotify.success("Report deleted successfully")}).catch(h=>{e.$snotify.error(h),e.confirmReport=!1,e.reportDeletionInProgress=!1}))},download(e,h){const t=this;this.downloadingReport=!0,be.get("/"+this.sample+"/report/"+e,{responseType:"arraybuffer"}).then(c=>{let g=new Blob([c.data],{type:"application/binary"}),m=document.createElement("a");m.href=window.URL.createObjectURL(g),m.download=h,m.click(),t.downloadingReport=!1}).catch(c=>{t.$snotify.error(c),t.downloadingReport=!1})},formatPhenotype(e){const h=e.match(/(\w+)([+-])(\w+)?([+-])?(\w+)?([+-])?(\w+)?([+-])?(\w+)?([+-])?(\w+)?([+-])?/);let t=0;var c=0;for(c=0;c<h.length;c++)h[c]!==void 0&&(t=c+1);let g="",m="";for(c=1;c<t;c=c+2)m="",h[c+1]==="-"&&(m="danger"),h[c+1]==="+"&&(m="success"),g+="<small class='text-"+m+"'>"+h[c]+h[c+1]+"</small>";return g},highlightROI(e,h){let c=this.fabricOverlay.fabricCanvas().getObjects()[e];h?c.setOptions({fill:"rgba(255,255,255,0.1)",strokeWidth:20}):c.setOptions({fill:"transparent",strokeWidth:10}),this.fabricOverlay.fabricCanvas().renderAll()},selectROI(e){if(!this.canEdit||this.isExclusion)return;let t=this.fabricOverlay.fabricCanvas().getObjects()[e];this.fabricOverlay.fabricCanvas().setActiveObject(t).renderAll()},editROI(e){this.activeROIidx=e;let t=this.fabricOverlay.fabricCanvas().getObjects()[e];this.fabricOverlay.fabricCanvas().setActiveObject(t).renderAll(),this.ROItitle=t.title},cancelROI(){this.activeROIidx=-1,this.fabricOverlay.fabricCanvas().discardActiveObject().renderAll(),this.ROItitle="",this.isAnnotationSelected=!1},resetAnnotations(){const e=this;this.confirmResetAnnotation?(this.sampleIds.report_date&&(this.confirmReport=!0,this.deleteReport()),be.delete("/"+this.sampleIds.sample_id+"/annotations").then(h=>{e.reportInPreparation=!1,e.confirmResetAnnotation=!1,e.$snotify.success("Annotations reset successfully"),e.fabricOverlay.fabricCanvas().clear(),e.processingStep="annotation",e.toggleOverlay("tissue"),e.toggleDraw("exclusion")}).catch(h=>this.$snotify.error(h))):this.confirmResetAnnotation=!0},resetReviewedCellTypes(){_.forEach(_.filter(Object.keys(this.colorMaps),e=>e!=="DAPI"),e=>{this.densityCellType?this.$set(this.reviewedCellTypes,e,!1):(this.densityCellType=e,this.$set(this.reviewedCellTypes,e,!0))})},setDensityCellType(e){this.$set(this.reviewedCellTypes,e,!0),this.densityCellType=e}},computed:{cellTypes(){return _.filter(Object.keys(this.colorMaps),e=>e!=="DAPI")},otherCellTypes(){return _.filter(this.cellTypes,e=>e!==this.cellType)},threshold(){return this.thresholds[this.cellType]===void 0?0:this.thresholds[this.cellType].value},percentTumor(){const e=this;let h=_.filter(e.tissueSegmentations,t=>t.cutoff===e.tumorChannel.toLowerCase()+"_"+e.thresholds[e.tumorChannel].value);return h.length?Math.round(h[0].data.tumor_area/(h[0].data.stroma_area+h[0].data.tumor_area)*1e3)/10:""},warningThreshold(){return this.thresholds===void 0||this.thresholds[this.tumorChannel]===void 0?!0:this.thresholds[this.tumorChannel].status!=="SUCCESS"},isExclusion(){return this.processingStep==="annotation"||this.processingStep==="processing"},canEdit(){return!this.loadingSampleIds&&this.processingStep!=="annotation"&&!this.sampleIds.pdf_report&&this.sampleIds.report_status!=="PENDING"&&this.sampleIds.report_status!=="RUNING"&&!this.reportInPreparation},tissueRegExp(){return new RegExp(this.tumorChannel+"_","i")},warningPercentTumor(){const e=this.fabricOverlay.fabricCanvas().getObjects();let h=!1;return _.forEach(e,t=>{t.stroke!==void 0&&t.stroke==="#F00"&&(h=!0)}),h},ROIs(){let e=[];if(this.fabricOverlay.fabricCanvas!==void 0){let h=this.fabricOverlay.fabricCanvas().getObjects();return _.forEach(h,(t,c)=>{t.stroke!==void 0&&t.stroke!=="#F00"&&e.push({id:c,title:t.title})}),e}return[]},heROIs(){let e=[];if(this.HEcanvas.getObjects!==void 0){let h=this.HEcanvas.getObjects();return _.forEach(h,(t,c)=>{t.stroke!==void 0&&t.stroke!=="#F00"&&e.push({id:`${c}`,title:t.title})}),e}return[]},ROIwithoutLabel(){return _.filter(this.ROIs,e=>!e.title).length},tissueSegmentationsLoaded(){let e=!0;return _.forEach(this.tissueSegmentations,h=>{h.img||(e=!1)}),e},nbTissueSegmentationsImgs(){let e=0;return _.forEach(this.tissueSegmentations,h=>{h.img&&e++}),e}},mounted(){const e=this;this.sample||(this.sample=this.$route.params.sample),this.loadingSampleIds=!0,be.get("/"+this.sample+"/sample").then(t=>{this.loadingSampleIds=!1,this.sampleIds=t.data,t.data.cmd&&(e.ifquantCmd=t.data.cmd,e.cmdTitle="Run IFQuant analysis",e.$refs.ifquantCmdModal.show()),(t.data.report_status==="PENDING"||t.data.report_status==="RUNNING")&&(e.reportInPreparation=!0)}).catch(t=>{this.$snotify.error(t),this.$router.push("/")});let h=window.innerHeight;document.getElementById("openseadragon").style.height=h-120+"px",document.getElementById("leftPanel").style.height=h-180+"px",e.colorMaps.length?e.createViewer():be.get("/"+e.$route.params.sample+"/thresholds").then(t=>{let c={TLS:t.data.TLS,colorMaps:t.data.colorMaps,thresholds:t.data.thresholds,originalThresholds:t.data.original_thresholds,tissue_segmentations:[],sample:e.$route.params.sample,width:t.data.dimensions.width,height:t.data.dimensions.height,hasDensities:t.data.has_densities,hasCellsDb:t.data.has_cells_db},g="CK";_.forEach(t.data.colorMaps,(y,a)=>{y.type.indexOf("tumor")>-1&&(g=a)}),_.forEach(t.data.tissue_segmentations,y=>{c.tissue_segmentations.push({cutoff:y[g.toLowerCase()+"_threshold"],img:"",data:y})});const m=Pl(e.$route.params.sample);Ti.get(m).then(y=>{c.imageParams=ln(y.data),e.init(c).then(()=>{Te.nextTick().then(()=>{e.createViewer()})})}).catch(y=>{e.notify(y,"error")})}).catch(t=>{e.notify(t,"error")}),this.updateViewer=_.debounce(this.updateViewer,200)},watch:{sample:{handler(){if(this.viewer!==null){this.viewer.world.removeAll();let e=this.getTileSources();this.viewer.close(),this.viewer.open(e)}},deep:!0},cellType(e){this.displayCellType(e)},tissueThresholdAdjust(e){if(e){let h=window.innerHeight;document.getElementById("divTissueThresholdLoading")&&(document.getElementById("divTissueThresholdLoading").style.height=h-75+"px"),this.loadTissueSegmentations().then(()=>{Te.nextTick().then(()=>{let t=window.innerHeight;document.getElementById("divTissueThreshold")&&(document.getElementById("divTissueThreshold").style.height=t-75+"px");const c=document.getElementById("default"+this.tumorChannel);c&&c.previousSibling.scrollIntoView(),window.scrollTo(0,0)})})}},ROItitle(e){e==="other..."&&(this.ROItitle=null,this.showOtherROItitle=!0)},channels:{handler(e,h){this.viewer&&this.viewer.viewport!==void 0&&(_.forEach(e,(t,c)=>{t.intensity&&h[c].intensity!==e.intensity&&Te.set(this.channels[c],"previousIntensity",+this.channels[c].intensity+0)}),this.updateViewer())},deep:!0},opacity(e,h){e!==h&&this.viewer.world.getItemCount()>1&&this.viewer.world.getItemAt(1).setOpacity(e)}},beforeRouteEnter(e,h,t){t(c=>{c.prevRoute.path=h.path,c.prevRoute.query=h.query})},beforeDestroy(){this.viewer&&this.viewer.destroy()}},un={};var Ml=ui(Dl,Sl,El,!1,kl,null,null,null);function kl(e){for(let h in un)this[h]=un[h]}var Al=function(){return Ml.exports}();export{Al as default};
